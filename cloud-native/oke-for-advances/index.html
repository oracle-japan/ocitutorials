<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="ja-JP" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。サードパーティーとしてOSSのIstio、Prometheus、Grafana、Loki、Jaeger、Kialiを利用します。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-advances/">


  <meta property="og:description" content="OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。サードパーティーとしてOSSのIstio、Prometheus、Grafana、Loki、Jaeger、Kialiを利用します。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg">





  <meta property="article:published_time" content="2024-09-20T14:29:49+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-advances/">












<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-32.png" sizes="32x32">
<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-128.png" sizes="128x128">
<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.oracle.com/asset/web/favicons/favicon-120.png" sizes="120x120">
<link rel="apple-touch-icon" href="https://www.oracle.com/asset/web/favicons/favicon-152.png" sizes="152x152">
<link rel="apple-touch-icon" href="https://www.oracle.com/asset/web/favicons/favicon-180.png" sizes="180x180">
<link rel="shortcut icon" type="image/x-icon" href="/ocitutorials/assets/favicon/favicon.ico">
<link rel="manifest" href="/ocitutorials/assets/favicon/site.webmanifest">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/ocitutorials/#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E4%B8%80%E8%A6%A7"
                
                
              >チュートリアル一覧</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ocitutorials/about/"
                
                
              >このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: url('/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう

        
      </h1>
      
        <p class="page__lead">OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。サードパーティーとしてOSSのIstio、Prometheus、Grafana、Loki、Jaeger、Kialiを利用します。
</p>
      
      


      
    </div>
  
  
</div>






  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/cloud-native" itemprop="item"><span itemprop="name">Cloud native</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">Cloud Native編</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-commons/">Oracle Cloud Infrastructure(OCI) DevOps事前準備</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-beginners-compute/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ-Compute編-</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-beginners-oke/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ-OKE編-</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-beginners-functions/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ-Oracle Functions編-</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/ci-for-beginners/">OCI Container Instances をプロビジョニングしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-commons/">Oracle Container Engine for Kubernetes(OKE)をプロビジョニングしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-beginners/">Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-intermediates/">KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-advances/" class="active">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-observability-for-advances/">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/fn-for-beginners/">Fn Project ハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-for-beginners/">Oracle Functions ハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-apigateway-for-beginners/">Oracle Cloud Infrasturcture API Gateway + Oracle Functionsハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-vmshape-for-intermediates/">Oracle Functionsを利用した仮想マシン (VM) のシェイプ変更</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-ords-for-intermediates/">Oracle Functionsを利用したORDSでのデータベースアクセス</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-nosql-for-intermediates/">Oracle Functionsを利用したNoSQLデータベースアクセス</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-apigateway-for-intermediates/">Oracle Functionsを利用したAPI Gatewayの認証</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/apigateway-for-beginners/">OCI API Gatewayハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/osm-for-beginners/">OCI Service Meshを使ってサービスメッシュ環境を作ろう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/helidon-mp-for-beginners/">Helidon(MP)を始めてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/ocicache-for-beginners/">OCI Cacheを使ってみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/ocicache-for-commons/">OCI Cacheを使ってレスポンス・キャッシングをしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/helidon-se-for-beginners/">Helidon(SE)を始めてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/wls-for-oci-provisioning/">WebLogic Server for OCIをプロビジョニングしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/wls-for-oci-migration/">WebLogic Server for OCIにアプリケーションを移行してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/wls-for-oke-provisioning/">WebLogic Server for OKEをプロビジョニングしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/microtx-for-beginners/">Oracle Transaction Manager for Microservices(MicroTx)を体験してみよう</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう">
    <meta itemprop="description" content="OKEを使ってサンプルマイクロサービスアプリケーションのデプロイおよびオブザバビリティを体験していただけるコンテンツです。サードパーティーとしてOSSのIstio、Prometheus、Grafana、Loki、Jaeger、Kialiを利用します。">
    <meta itemprop="datePublished" content="2024-09-20T14:29:49+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#1okeクラスタ構築">1.OKEクラスタ構築</a><ul><li><a href="#1-1-ociダッシュボードからokeクラスタの構築">1-1 OCIダッシュボードからOKEクラスタの構築</a></li><li><a href="#1-2-cloud-shellを利用してクラスタを操作">1-2 Cloud Shellを利用してクラスタを操作</a></li></ul></li><li><a href="#2サービスメッシュとオブザバビリティ環境構築">2.サービスメッシュとオブザバビリティ環境構築</a><ul><li><a href="#2-1-istioaddon-prometheus-grafana-jaeger-kialiインストール">2-1 Istio（addon: Prometheus, Grafana, Jaeger, Kiali）インストール</a></li><li><a href="#2-2-grafana-loki-インストール">2-2 Grafana Loki インストール</a></li><li><a href="#2-3-grafana-lokiのセットアップ">2-3 Grafana Lokiのセットアップ</a></li><li><a href="#2-4-node-exporterのインストール">2-4 node exporterのインストール</a></li><li><a href="#2-5-prometheus-webuiからpromqlの実行">2-5 Prometheus WebUIからPromQLの実行</a></li></ul></li><li><a href="#3サンプルアプリケーションでobservabilityを体験してみよう">3.サンプルアプリケーションでObservabilityを体験してみよう</a><ul><li><a href="#3-1-サンプルアプリケーションの概要説明">3-1 サンプルアプリケーションの概要説明</a></li><li><a href="#3-2-サンプルアプリケーションのビルドとデプロイ">3-2 サンプルアプリケーションのビルドとデプロイ</a></li><li><a href="#3-3-grafana-lokiを利用したログ監視">3-3 Grafana Lokiを利用したログ監視</a></li><li><a href="#3-4-jaegerを利用したトレーシング">3-4 Jaegerを利用したトレーシング</a></li><li><a href="#3-5-kialiを利用したservice-meshの可視化">3-5 Kialiを利用したService Meshの可視化</a></li></ul></li><li><a href="#4istioを利用したカナリアリリースをやってみよう">4.Istioを利用したカナリアリリースをやってみよう</a><ul><li><a href="#4-1-カナリアリリース">4-1 カナリアリリース</a></li></ul></li><li><a href="#5oci-monitoringのメトリクスをgrafanaダッシュボードを利用して確認してみようオプション">5.OCI MonitoringのメトリクスをGrafanaダッシュボードを利用して確認してみよう【オプション】</a><ul><li><a href="#5-1-動的グループとポリシーの設定">5-1 動的グループとポリシーの設定</a></li><li><a href="#5-2-oci-monitoringプラグインのgrafanaへのインストール">5-2 OCI MonitoringプラグインのGrafanaへのインストール</a></li><li><a href="#5-3-grafanaダッシュボードの確認">5-3 Grafanaダッシュボードの確認</a></li></ul></li></ul>
            </nav>
          </aside>
        
        <p>このハンズオンでは、Oracle Container Engine for Kubernetes（以下OKE）上に、マイクロサービスアプリケーションをデプロイします。そして、OSSのオブザバビリティツールを利用して、モニタリング、ロギング、トレーシングを実践的に学びます。</p>

<p>オブザバビリティツールとして、以下を利用します。</p>

<p><strong><em>モニタリング</em></strong></p>

<ul>
  <li><a href="https://github.com/prometheus/prometheus">Prometheus</a> + <a href="https://github.com/grafana/grafana">Grafana</a></li>
</ul>

<p><strong><em>ロギング</em></strong></p>

<ul>
  <li><a href="https://github.com/grafana/loki">Grafana Loki</a></li>
</ul>

<p><strong><em>トレーシング</em></strong></p>

<ul>
  <li><a href="https://github.com/jaegertracing/jaeger">Jaeger</a></li>
</ul>

<p><strong><em>サービスメッシュオブザバビリティ</em></strong></p>

<ul>
  <li><a href="https://github.com/kiali/kiali">Kiali</a></li>
</ul>

<p>ハンズオンの流れは以下となります。</p>

<hr />
<ol>
  <li>OKEクラスタ構築
    <ol>
      <li>OCIダッシュボードからOKEクラスタの構築</li>
      <li>Cloud Shellを利用してクラスタを操作</li>
    </ol>
  </li>
  <li>サービスメッシュとオブザバビリティ環境構築
    <ol>
      <li>Istio（addon: Prometheus, Grafana, Jaeger, Kiali）インストール</li>
      <li>Grafana Loki インストール</li>
      <li>Grafana Lokiのセットアップ</li>
      <li>node exporterのインストール</li>
      <li>Prometheus WebUIからPromQLの実行</li>
    </ol>
  </li>
  <li>サンプルアプリケーションでObservabilityを体験してみよう
    <ol>
      <li>サンプルアプリケーションの概要説明</li>
      <li>サンプルアプリケーションのビルドとデプロイ</li>
      <li>Grafana Lokiを利用したログ監視</li>
      <li>Jaegerを利用したトレーシング</li>
      <li>Kialiを利用したService Meshの可視化</li>
    </ol>
  </li>
  <li>Istioを利用したカナリアリリース
    <ol>
      <li>カナリアリリース</li>
    </ol>
  </li>
</ol>

<hr />

<h2 id="1okeクラスタ構築">1.OKEクラスタ構築</h2>

<h3 id="1-1-ociダッシュボードからokeクラスタの構築">1-1 OCIダッシュボードからOKEクラスタの構築</h3>

<p>左上のハンバーガーメニューを展開して、「開発者サービス」から「Kubernetesクラスタ(OKE)」を選択します。</p>

<p><img src="1-001.png" alt="" /></p>

<p>「クラスタの作成」ボタンをクリックします。</p>

<p><img src="1-002.png" alt="" /></p>

<p>「クイック作成」が選択されていることを確認して、「ワークフローの起動」ボタンをクリックします。</p>

<p><img src="1-003.png" alt="" /></p>

<p>以下を設定します。</p>

<p>「Kubernetesワーカー・ノード」:「パブリック・ワーカー」
「シェイプ」：「VM Standard.E3.Flex」
「OCPU数の選択」:「2」
「メモリー量（GB）」：「32」</p>

<p><img src="1-004.png" alt="" /></p>

<p>画面左下の「次」ボタンをクリックします。</p>

<p><img src="1-005.png" alt="" /></p>

<p>画面左下の「クラスタ作成」ボタンをクリックします。</p>

<p><img src="1-006.png" alt="" /></p>

<p>画面左下の「閉じる」ボタンをクリックします。</p>

<p><img src="1-007.png" alt="" /></p>

<p>黄色の「作成中」から緑の「アクティブ」になることを確認します。「アクティブ」であればクラスタ作成は完了です。</p>

<p><img src="1-008.png" alt="" /></p>

<h3 id="1-2-cloud-shellを利用してクラスタを操作">1-2 Cloud Shellを利用してクラスタを操作</h3>

<p>Cloud Shellを利用して、作成したKubernetesクラスタに接続します。</p>

<p>「クラスタへのアクセス」ボタンをクリックします。</p>

<p><img src="1-009.png" alt="" /></p>

<p>「Cloud Shellの起動」ボタン、「コピー」リンクテキスト、「閉じる」ボタンの順にクリックします。</p>

<p><img src="1-010.png" alt="" /></p>

<p>Cloud Shell起動後、「コピー」した内容をペーストして、Enterキーを押します。</p>

<p><img src="1-011.png" alt="" /></p>

<p>以下コマンドを実行して、3ノードの「STATUS」が「Ready」になっていることを確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME          STATUS   ROLES   AGE   VERSION
10.0.10.111   Ready    node    61m   v1.20.8
10.0.10.254   Ready    node    61m   v1.20.8
10.0.10.87    Ready    node    61m   v1.20.8
</code></pre></div></div>

<h2 id="2サービスメッシュとオブザバビリティ環境構築">2.サービスメッシュとオブザバビリティ環境構築</h2>

<h3 id="2-1-istioaddon-prometheus-grafana-jaeger-kialiインストール">2-1 Istio（addon: Prometheus, Grafana, Jaeger, Kiali）インストール</h3>

<p><code class="language-plaintext highlighter-rouge">Istio 1.11.0</code> をインストールします。</p>

<p>バージョン値を変数にします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ISTIO_VERSION</span><span class="o">=</span>1.11.0
</code></pre></div></div>

<p>公式からインストールに必要なものをダウンロードします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> https://istio.io/downloadIstio | <span class="nv">ISTIO_VERSION</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">ISTIO_VERSION</span><span class="k">}</span><span class="s2">"</span> sh -
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   102  100   102    0     0    213      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--   212
100  4549  100  4549    0     0   6425      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  6425

Downloading istio-1.11.0 from https://github.com/istio/istio/releases/download/1.11.0/istio-1.11.0-linux-amd64.tar.gz ...

Istio 1.11.0 Download Complete!

Istio has been successfully downloaded into the istio-1.11.0 folder on your system.

Next Steps:
See https://istio.io/latest/docs/setup/install/ to add Istio to your Kubernetes cluster.

To configure the istioctl client tool <span class="k">for </span>your workstation,
add the /home/yutaka_ich/istio-1.11.0/bin directory to your environment path variable with:
         <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PATH</span><span class="s2">:/home/yutaka_ich/istio-1.11.0/bin"</span>

Begin the Istio pre-installation check by running:
         istioctl x precheck 

Need more information? Visit https://istio.io/latest/docs/setup/install/ 
</code></pre></div></div>

<p>istioctlコマンドを実行できるようにパスを通します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">PWD</span><span class="k">}</span><span class="s2">/istio-</span><span class="k">${</span><span class="nv">ISTIO_VERSION</span><span class="k">}</span><span class="s2">/bin:</span><span class="k">${</span><span class="nv">PATH</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>Istioのバージョンを確認します。バージョンが表示されることで、istioctlコマンドが利用できる状態です。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>istioctl version
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>no running Istio pods <span class="k">in</span> <span class="s2">"istio-system"</span>
1.21.0
</code></pre></div></div>

<p>Istioのコンポーネントをインストールします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>istioctl <span class="nb">install</span> <span class="nt">--set</span> <span class="nv">profile</span><span class="o">=</span>demo <span class="nt">--skip-confirmation</span> <span class="nt">--set</span> components.cni.enabled<span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✔ Istio core installed                                                                                                                           
✔ Istiod installed
✔ CNI installed   
✔ Egress gateways installed                                                                                                                      
✔ Ingress gateways installed                                                                                                                     
✔ Installation <span class="nb">complete                                                                                                                          
</span>Thank you <span class="k">for </span>installing Istio 1.11.  Please take a few minutes to tell us about your <span class="nb">install</span>/upgrade experience!  https://forms.gle/kWULBRjUv7hHci7T6
</code></pre></div></div>

<p>必要なアドオン（Prometheus,Grafana,Kiali,Jaegerなど）をインストールします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> <span class="s2">"istio-</span><span class="k">${</span><span class="nv">ISTIO_VERSION</span><span class="k">}</span><span class="s2">/samples/addons/"</span>
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>serviceaccount/grafana created
configmap/grafana created
service/grafana created
deployment.apps/grafana created
configmap/istio-grafana-dashboards created
configmap/istio-services-grafana-dashboards created
deployment.apps/jaeger created
service/tracing created
service/zipkin created
service/jaeger-collector created
serviceaccount/kiali created
configmap/kiali created
clusterrole.rbac.authorization.k8s.io/kiali-viewer created
clusterrole.rbac.authorization.k8s.io/kiali created
clusterrolebinding.rbac.authorization.k8s.io/kiali created
role.rbac.authorization.k8s.io/kiali-controlplane created
rolebinding.rbac.authorization.k8s.io/kiali-controlplane created
service/kiali created
deployment.apps/kiali created
serviceaccount/prometheus created
configmap/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/prometheus created
deployment.apps/prometheus created
</code></pre></div></div>

<p>Istioで利用するサイドカープロキシを自動でPodに挿入する設定を加えます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl label namespace default istio-injection<span class="o">=</span>enabled
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>namespace/default labeled
</code></pre></div></div>

<p>現時点では、Kubernetesクラスタ外部からアクセスできない状況です。
アドオンとしてインストールしたPrometheus、Grafana、Kiali、JaegerのWebコンソールにブラウザからアクセスできるように、
各コンポーネントのServiceオブジェクトに<code class="language-plaintext highlighter-rouge">NodePort</code>の設定を行います。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch service prometheus <span class="nt">-n</span> istio-system <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service/prometheus patched
</code></pre></div></div>

<hr />

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch service grafana <span class="nt">-n</span> istio-system <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service/grafana patched
</code></pre></div></div>

<hr />

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch service kiali <span class="nt">-n</span> istio-system <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service/kiali patched
</code></pre></div></div>

<hr />

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch service tracing <span class="nt">-n</span> istio-system <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service/tracing patched
</code></pre></div></div>

<hr />

<p>ServiceとDeploymentの状況を確認します。
「service/prometheus」、「service/grafana」、「service/kiali」、「service/tracing」のTYPEが<code class="language-plaintext highlighter-rouge">NodePort</code>になっていることを確認します。「service/istio-ingressgateway」については、しばらくするとEXTERNAL-IPアドレスが自動で付与されます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services,deployments <span class="nt">-n</span> istio-system <span class="nt">-o</span> wide
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                           TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>                                                                      AGE     SELECTOR
service/grafana                NodePort       10.96.142.228   &lt;none&gt;           3000:30536/TCP                                                               96s     app.kubernetes.io/instance<span class="o">=</span>grafana,app.kubernetes.io/name<span class="o">=</span>grafana
service/istio-egressgateway    ClusterIP      10.96.50.236    &lt;none&gt;           80/TCP,443/TCP                                                               2m9s    <span class="nv">app</span><span class="o">=</span>istio-egressgateway,istio<span class="o">=</span>egressgateway
service/istio-ingressgateway   LoadBalancer   10.96.197.12    168.138.xx.xxx   15021:31268/TCP,80:32151/TCP,443:30143/TCP,31400:30084/TCP,15443:32534/TCP   2m9s    <span class="nv">app</span><span class="o">=</span>istio-ingressgateway,istio<span class="o">=</span>ingressgateway
service/istiod                 ClusterIP      10.96.80.173    &lt;none&gt;           15010/TCP,15012/TCP,443/TCP,15014/TCP                                        2m28s   <span class="nv">app</span><span class="o">=</span>istiod,istio<span class="o">=</span>pilot
service/jaeger-collector       ClusterIP      10.96.223.176   &lt;none&gt;           14268/TCP,14250/TCP,9411/TCP                                                 95s     <span class="nv">app</span><span class="o">=</span>jaeger
service/kiali                  NodePort       10.96.65.161    &lt;none&gt;           20001:32446/TCP,9090:31546/TCP                                               95s     app.kubernetes.io/instance<span class="o">=</span>kiali,app.kubernetes.io/name<span class="o">=</span>kiali
service/prometheus             NodePort       10.96.227.118   &lt;none&gt;           9090:32582/TCP                                                               94s     <span class="nv">app</span><span class="o">=</span>prometheus,component<span class="o">=</span>server,release<span class="o">=</span>prometheus
service/tracing                NodePort       10.96.67.34     &lt;none&gt;           80:31870/TCP,16685:32400/TCP                                                 95s     <span class="nv">app</span><span class="o">=</span>jaeger
service/zipkin                 ClusterIP      10.96.222.186   &lt;none&gt;           9411/TCP                                                                     95s     <span class="nv">app</span><span class="o">=</span>jaeger

NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS                                             IMAGES                                                       SELECTOR
deployment.apps/grafana                1/1     1            1           95s     grafana                                                grafana/grafana:7.5.5                                        app.kubernetes.io/instance<span class="o">=</span>grafana,app.kubernetes.io/name<span class="o">=</span>grafana
deployment.apps/istio-egressgateway    1/1     1            1           2m9s    istio-proxy                                            docker.io/istio/proxyv2:1.11.0                               <span class="nv">app</span><span class="o">=</span>istio-egressgateway,istio<span class="o">=</span>egressgateway
deployment.apps/istio-ingressgateway   1/1     1            1           2m9s    istio-proxy                                            docker.io/istio/proxyv2:1.11.0                               <span class="nv">app</span><span class="o">=</span>istio-ingressgateway,istio<span class="o">=</span>ingressgateway
deployment.apps/istiod                 1/1     1            1           2m28s   discovery                                              docker.io/istio/pilot:1.11.0                                 <span class="nv">istio</span><span class="o">=</span>pilot
deployment.apps/jaeger                 1/1     1            1           95s     jaeger                                                 docker.io/jaegertracing/all-in-one:1.23                      <span class="nv">app</span><span class="o">=</span>jaeger
deployment.apps/kiali                  1/1     1            1           95s     kiali                                                  quay.io/kiali/kiali:v1.38                                    app.kubernetes.io/instance<span class="o">=</span>kiali,app.kubernetes.io/name<span class="o">=</span>kiali
deployment.apps/prometheus             1/1     1            1           94s     prometheus-server-configmap-reload,prometheus-server   jimmidyson/configmap-reload:v0.5.0,prom/prometheus:v2.26.0   <span class="nv">app</span><span class="o">=</span>prometheus,component<span class="o">=</span>server,release<span class="o">=</span>prometheus
</code></pre></div></div>

<p>次に、WebブラウザからNodePort経由でアクセスできるように、セキュリティリストを変更します。</p>

<p>OCIコンソールから、[ネットワーキング]-[仮想クラウド・ネットワーク]を選択して対象となる<code class="language-plaintext highlighter-rouge">oke-vcn-quick-cluster1-xxxxxxxxx</code>を選択します。</p>

<p><img src="1-027.png" alt="" /></p>

<p><img src="1-032.png" alt="" /></p>

<p>3つあるサブネットのうち、ワーカノードが属するサブネット<code class="language-plaintext highlighter-rouge">oke-nodesubnet-quick-cluster1-xxxxxxxxx-regional</code>を選択します。</p>

<p><img src="1-028.png" alt="" /></p>

<p>リストに表示される、<code class="language-plaintext highlighter-rouge">oke-nodeseclist-quick-cluster1-xxxxxxxxx</code>を選択します。</p>

<p><img src="1-029.png" alt="" /></p>

<p>「イングレス・ルールの追加」ボタンをクリックします。</p>

<p><img src="1-030.png" alt="" /></p>

<p>以下を設定して、「イングレス・ルールの追加」ボタンをクリックします。</p>

<p><code class="language-plaintext highlighter-rouge">ソースCIDR: 0.0.0.0/0</code><br />
<code class="language-plaintext highlighter-rouge">宛先ポート範囲: 30000-65535</code></p>

<p><img src="1-031.png" alt="" /></p>

<p>以上で、セキュリティリストの変更は完了です。</p>

<p>次に、WebブラウザでアクセスするNodeの<code class="language-plaintext highlighter-rouge">EXTERNAL-IP</code>を確認します。
利用する<code class="language-plaintext highlighter-rouge">EXTERNAL-IP</code>は、どれも利用可能です。Webブラウザで利用する際に、どれか一つ選択をしてください。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes <span class="nt">-o</span> wide
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME          STATUS   ROLES   AGE   VERSION   INTERNAL-IP   EXTERNAL-IP     OS-IMAGE                  KERNEL-VERSION                      CONTAINER-RUNTIME
10.0.10.111   Ready    node    61m   v1.20.8   10.0.10.111   140.83.60.38    Oracle Linux Server 7.9   5.4.17-2102.204.4.4.el7uek.x86_64   cri-o://1.20.2
10.0.10.254   Ready    node    60m   v1.20.8   10.0.10.254   140.83.50.44    Oracle Linux Server 7.9   5.4.17-2102.204.4.4.el7uek.x86_64   cri-o://1.20.2
10.0.10.87    Ready    node    60m   v1.20.8   10.0.10.87    140.83.84.231   Oracle Linux Server 7.9   5.4.17-2102.204.4.4.el7uek.x86_64   cri-o://1.20.2
</code></pre></div></div>

<p>Prometheus,Grafana,Kiali,Jaegerの<code class="language-plaintext highlighter-rouge">NodePort</code>を確認します。
TYPEが<code class="language-plaintext highlighter-rouge">NodePort</code>となっているServiceのPORT(S)「xxxxx:30000」コロン後の30000以上のポート番号が<code class="language-plaintext highlighter-rouge">NodePort</code>番号です。</p>

<p class="notice--warning"><strong>Jaegerのサービス名について</strong><br />
サービス名は、Jaegerだけtracingとなるので、ご注意ください。</p>

<ul>
  <li>Prometheus:prometheus</li>
  <li>Grafana:grafana</li>
  <li>Kiali:kiali</li>
  <li>Jaeger:tracing</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services <span class="nt">-n</span> istio-system
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span class="o">(</span>S<span class="o">)</span>                                                                      AGE
grafana                NodePort       10.96.142.228   &lt;none&gt;           3000:30536/TCP                                                               11m
istio-egressgateway    ClusterIP      10.96.50.236    &lt;none&gt;           80/TCP,443/TCP                                                               11m
istio-ingressgateway   LoadBalancer   10.96.197.12    168.138.xx.xxx   15021:31268/TCP,80:32151/TCP,443:30143/TCP,31400:30084/TCP,15443:32534/TCP   11m
istiod                 ClusterIP      10.96.80.173    &lt;none&gt;           15010/TCP,15012/TCP,443/TCP,15014/TCP                                        12m
jaeger-collector       ClusterIP      10.96.223.176   &lt;none&gt;           14268/TCP,14250/TCP,9411/TCP                                                 11m
kiali                  NodePort       10.96.65.161    &lt;none&gt;           20001:32446/TCP,9090:31546/TCP                                               11m
prometheus             NodePort       10.96.227.118   &lt;none&gt;           9090:32582/TCP                                                               11m
tracing                NodePort       10.96.67.34     &lt;none&gt;           80:31870/TCP,16685:32400/TCP                                                 11m
zipkin                 ClusterIP      10.96.222.186   &lt;none&gt;           9411/TCP                                                                     11m
</code></pre></div></div>

<p>上記コマンド結果を例にすると、以下コロン後の30000以上ポート番号となります。
ご自身のと置き換えて対応してください。</p>

<ul>
  <li>Prometheus 9090:32582</li>
  <li>Grafana 3000:30536</li>
  <li>Kiali 20001:32446</li>
  <li>Jaeger 80:31870</li>
</ul>

<p>先ほど確認した、EXTERNAL-IPと各<code class="language-plaintext highlighter-rouge">NodePort</code>を指定して、Webブラウザからアクセスしてください。</p>

<p><code class="language-plaintext highlighter-rouge">http://EXTERNAL-IP:NodePort/</code></p>

<h3 id="2-2-grafana-loki-インストール">2-2 Grafana Loki インストール</h3>

<p>Helmを利用して、Grafana Lokiをインストールします。</p>

<p class="notice--info"><strong>Helmについて</strong><br />
Helmは、Kubernetesのパッケージマネージャです。パッケージは、Chartと呼ばれ、リポジトリがあります。
Helmは、Linuxのdnfやapt、Chartはrpmやdebのようなものと捉えてください。
Chartは、マニフェストのテンプレート（雛形）であり、そのテンプレートに指定した変数のパラメータをvalues.yamlに定義、
このChartとvalues.yamlの組み合わせで、新たなマニフェストを生成してKubernetesクラスタに登録する仕組みです。
このHelmを利用して、マニフェストをテンプレート化することで、マニフェストが大量とならないように管理の効率化を図ることができます。</p>

<p>Grafana公式のHelmチャートリポジトリを追加します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add grafana https://grafana.github.io/helm-charts
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/yutaka_ich/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/yutaka_ich/.kube/config
<span class="s2">"grafana"</span> has been added to your repositories
</code></pre></div></div>

<p>Helmチャートを最新化します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo update
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/yutaka_ich/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/yutaka_ich/.kube/config
Hang tight <span class="k">while </span>we grab the latest from your chart repositories...
...Successfully got an update from the <span class="s2">"argo"</span> chart repository
...Successfully got an update from the <span class="s2">"grafana"</span> chart repository
Update Complete. ⎈Happy Helming!⎈
</code></pre></div></div>

<p>Grafana Lokiをインストールします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">--install</span> loki <span class="nt">--namespace</span><span class="o">=</span>istio-system grafana/loki-stack
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/yutaka_ich/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/yutaka_ich/.kube/config
Release <span class="s2">"loki"</span> does not exist. Installing it now.
NAME: loki
LAST DEPLOYED: Sun Aug 22 07:22:15 2021
NAMESPACE: istio-system
STATUS: deployed
REVISION: 1
NOTES:
The Loki stack has been deployed to your cluster. Loki can now be added as a datasource <span class="k">in </span>Grafana.

See http://docs.grafana.org/features/datasources/loki/ <span class="k">for </span>more detail.
</code></pre></div></div>

<p>「Loki-0」、「loki-promtail-xxxxx」(3個)がRunningであることを確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-n</span> istio-system
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                                    READY   STATUS    RESTARTS   AGE
grafana-556f8998cd-bkrw8                1/1     Running   0          36m
istio-egressgateway-9dc6cbc49-rv9ll     1/1     Running   0          37m
istio-ingressgateway-7975cdb749-tk4rf   1/1     Running   0          37m
istiod-77b4d7b55d-tq7hh                 1/1     Running   0          37m
jaeger-5f65fdbf9b-28v7w                 1/1     Running   0          36m
kiali-787bc487b7-jkc22                  1/1     Running   0          36m
loki-0                                  1/1     Running   0          2m46s
loki-promtail-lzxg5                     1/1     Running   0          2m46s
loki-promtail-rlrq2                     1/1     Running   0          2m46s
loki-promtail-s7rfz                     1/1     Running   0          2m46s
prometheus-9f4947649-c7swm              2/2     Running   0          36m
</code></pre></div></div>

<h3 id="2-3-grafana-lokiのセットアップ">2-3 Grafana Lokiのセットアップ</h3>

<p>Grafanaにアクセスします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services grafana <span class="nt">-n</span> istio-system
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
grafana   NodePort   10.96.142.228   &lt;none&gt;        3000:30536/TCP   127m
</code></pre></div></div>

<p>GrafanaのアクセスにはNodePortを利用します。<br />
NodePortは<code class="language-plaintext highlighter-rouge">PORT(S)</code>の<code class="language-plaintext highlighter-rouge">:</code>以降のポート番号です。<br />
上記の場合、以下のURLにアクセスします。<br />
http://[WorkerNodeのパブリックIP]:30536</p>

<p>左メニューの[Configuration]-[Data Sources]を選択します。</p>

<p><img src="1-012.png" alt="" /></p>

<p>「Add data source」ボタンをクリックします。</p>

<p><img src="1-013.png" alt="" /></p>

<p>「Logging &amp; document databases」にある「Loki」にカーソルを合わせて「Select」ボタンをクリックします。</p>

<p><img src="1-014.png" alt="" /></p>

<p>Lokiの設定画面の「URL」に<code class="language-plaintext highlighter-rouge">http://loki:3100/</code>と入力、「Maximum lines」に<code class="language-plaintext highlighter-rouge">1000</code>と入力して、「Save &amp; Test」ボタンをクリックします。</p>

<p><img src="1-015.png" alt="" /></p>

<p>左メニューの「Explore」を選択します。</p>

<p><img src="1-016.png" alt="" /></p>

<p>画面遷移後、画面左上のプルダウンメニューで「Loki」を選択します。</p>

<p><img src="1-017.png" alt="" /></p>

<p>「Log browser」に<code class="language-plaintext highlighter-rouge">{app="istiod"}</code>と入力して、「Run Query」ボタンをクリックします。</p>

<p><img src="1-018.png" alt="" /></p>

<p>ログが表示されれば、セットアップは完了です。</p>

<h3 id="2-4-node-exporterのインストール">2-4 node exporterのインストール</h3>

<p>各ノードのメトリクスを取集するためにnode exporterを各ノードに配備します。</p>

<p>既に作成済みのnode exporterのマニフェストを利用して、Kubernetesクラスタに適用します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/oracle-japan/ochacafe-s4-6/main/manifests/node-exporter-handson.yaml
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>serviceaccount/node-exporter-handson created
service/node-exporter-handson created
daemonset.apps/node-exporter-handson created
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">node-exporter-handson</code>というPodの「STATUS」が「Running」であることを確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                          READY   STATUS    RESTARTS   AGE
node-exporter-handson-56m4h   1/1     Running   0          25s
node-exporter-handson-r7br8   1/1     Running   0          25s
node-exporter-handson-rr2rf   1/1     Running   0          25s
</code></pre></div></div>

<h3 id="2-5-prometheus-webuiからpromqlの実行">2-5 Prometheus WebUIからPromQLの実行</h3>

<p>Prometheus WebUIからPromQLを実行して、3ノードの各ノードのメモリ空き容量と3ノードでのメモリ空き容量の合計を確認します。
まずは、ブラウザでPrometheus WebUIにアクセスします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services prometheus <span class="nt">-n</span> istio-system
</code></pre></div></div>
<p><strong><em>コマンド結果</em></strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
prometheus   NodePort   10.96.227.118   &lt;none&gt;        9090:32582/TCP   136m
</code></pre></div></div>

<p>GrafanaのアクセスにはNodePortを利用します。<br />
NodePortは<code class="language-plaintext highlighter-rouge">PORT(S)</code>の<code class="language-plaintext highlighter-rouge">:</code>以降のポート番号です。<br />
上記の場合、以下のURLにアクセスします。<br />
http://[WorkerNodeのパブリックIP]:32582</p>

<p><img src="1-019.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">node_memory_MemAvailable_bytes</code>を入力して、「Execute」ボタンをクリックします。</p>

<p><img src="1-020.png" alt="" /></p>

<p>各ノードのメモリ空き容量が表示されます。「Graph」タブをクリックすると、グラフで見ることができます。</p>

<p><img src="1-021.png" alt="" /></p>

<p><img src="1-022.png" alt="" /></p>

<p>「Table」タブをクリック後、直近3分の状況を確認します。</p>

<p><img src="1-023.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">node_memory_MemAvailable_bytes[3m]</code>と入力して、「Execute」ボタンをクリックします。
各ノードの直近3分間のメモリの空き容量の状況が表示されます。</p>

<p><img src="1-024.png" alt="" /></p>

<p>次に3ノードのメモリの空き容量を確認します。</p>

<p><code class="language-plaintext highlighter-rouge">sum without (instance, kubernetes_node) (node_memory_MemAvailable_bytes)</code>と入力して、「Execute」ボタンをクリックします。</p>

<p>withoutを利用して、instanceとkubernetes_nodeラベルを除外して、3ノードのsum、合計を出力するPromQLです。</p>

<p><img src="1-025.png" alt="" /></p>

<p>「Graph」タブをクリックすることで、グラフでも確認できます。</p>

<p><img src="1-026.png" alt="" /></p>

<p>PromQLは、メトリクス集約に特化したPrometheus独自のクエリ言語です。このハンズオンで利用したクエリは一例です。
使用方法は、多岐にわたります。詳細は、<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">公式レファレンス</a>を参照してください。</p>

<h2 id="3サンプルアプリケーションでobservabilityを体験してみよう">3.サンプルアプリケーションでObservabilityを体験してみよう</h2>

<p>この手順では、手順1および2で構築したObservability環境に対してサンプルアプリケーションをデプロイしていきます。</p>

<h3 id="3-1-サンプルアプリケーションの概要説明">3-1 サンプルアプリケーションの概要説明</h3>

<p>まずはホームディレクトリに移動し、以下のGitレポジトリをcloneします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/oracle-japan/code-at-customer-handson
</code></pre></div></div>

<p>このハンズオン用に作成したサンプルアプリケーションです。<br />
中身を簡単に紹介します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── README.md
├── k8s <span class="o">==&gt;</span> KubernetesのMainifest群
├── olympic_backend <span class="o">==&gt;</span> バックエンドアプリケーション
├── olympic_datasource <span class="o">==&gt;</span> データソースアプリケーション
├── olympic_frontend <span class="o">==&gt;</span> フロントエンドアプリケーション
<span class="nb">.</span>
</code></pre></div></div>

<p>このサンプルアプリケーションは、主に以下の2つから構成されています。</p>

<ul>
  <li><a href="https://oracle-japan-oss-docs.github.io/helidon/docs/v2/#/about/01_overview">Helidon</a>
    <ul>
      <li>Oracleがオープンソースで提供しているJavaのマイクロサービスフレームワーク</li>
    </ul>
  </li>
  <li><a href="https://www.oracle.com/jp/application-development/technologies/jet/oracle-jet.html">Oracle JavaScript Extension Toolkit（Oracle JET）</a>
    <ul>
      <li>Oracleがオープンソースで開発しているJavascript用フレームワーク</li>
      <li>業界標準として普及しているオープンソース・フレームワークに基づき、開発者がより優れたアプリケーションをより迅速に構築できるよう支援する高度な機能とサービスを付加</li>
    </ul>
  </li>
</ul>

<p>簡単にアプリケーションの構成を見ていきます。<br />
この手順が完了すると全体のイメージは以下のようになります。</p>

<p><img src="3-001.png" alt="" /></p>

<p>大きく上部のサンプルアプリケーションと下部のObservability環境から構成されていますが、下部については手順2で構築済みです。<br />
そのため、以降では、主に上部のサンプルアプリケーションについてみていきます。</p>

<p>また、今回はアプリケーションへのアクセスにistio-ingressgatewayおよびNodePortを利用してアクセスします。<br />
実体としては、istio-ingressgatewayはOracle Cloud Infrastructure Load Balancingサービス、NodePortはWorker NodeとなるComputeインスタンスのPublic IPとPortを利用しています。<br />
そのため、Oracle Cloud Infrastructureの構成としては以下のような図になります。</p>

<p><img src="3-031.png" alt="" /></p>

<p>このサンプルアプリケーションは、3つのコンポーネントから以下のように構成されています。</p>

<ul>
  <li>
    <p>フロントエンドアプリケーション(図中の<code class="language-plaintext highlighter-rouge">Olympics</code>)<br />
HelidonとOracle JETから構成されているアプリケーションです。<br />
Helidonの静的コンテンツルート(今回は<code class="language-plaintext highlighter-rouge">resources/web配下</code>)にOracle JETのコンテンツを配置しています。<br />
このアプリケーションは、バックエンドサービス(v1/v2/v3)のいずれかを呼び出します。</p>
  </li>
  <li>
    <p>バックエンドアプリケーション(図中の緑枠部分)<br />
Helidonから構成されているアプリケーションです。
このアプリケーションには3つのバージョンが存在し、それぞれ金メダメリスト(v3)、銀メダリスト(v2)、銅メダリスト(v1)の一覧を返すようになっています。 
バージョン情報は環境変数として保持しています。
このアプリケーションは、データソースアプリケーションに対してバージョンに応じたAPIエンドポイントを呼び出し、データを取得しにいきます。</p>
  </li>
  <li>
    <p>データソースアプリケーション(図中の<code class="language-plaintext highlighter-rouge">Medal Info</code>)<br />
Helidonとインメモリで動作しているデータベースである<a href="https://www.h2database.com/html/main.html">H2 Database</a>から構成されているアプリケーションです。<br />
このアプリケーションでは、メダリストと獲得したメダルの色を保持しており、バックエンドアプリケーションから呼び出されたエンドポイント応じてメダリストとそのメダルの色を返却します。</p>
  </li>
</ul>

<h3 id="3-2-サンプルアプリケーションのビルドとデプロイ">3-2 サンプルアプリケーションのビルドとデプロイ</h3>

<p>ここからは、これらのアプリケーションが含まれたコンテナイメージをビルドしてみます。</p>

<p>まずは、フロントエンドアプリケーションからビルドします。</p>

<p class="notice--info"><strong>Helidonについて</strong><br />
Helidonは<code class="language-plaintext highlighter-rouge">Maven</code>を利用してプロジェクトの雛形を作成することができます。<br />
コマンドについては<a href="https://helidon.io/docs/v2/#/mp/guides/02_quickstart">こちら</a>をご確認ください。<br />
この中にはデフォルトでDockerfileも含まれています。<br />
以降で利用するDockerfileも、基本的に上記雛形ファイルを利用しています。
また、HelidonにはHelidon CLIという便利なCLIツールがあります。<br />
Helidon CLIについては<a href="https://oracle-japan.github.io/ocitutorials/cloud-native/helidon-mp-for-beginners/">こちら</a>をご確認ください。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/olympic_frontend
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build <span class="nt">-t</span> code-at-customer/frontend-app <span class="nb">.</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~~
Status: Downloaded newer image <span class="k">for </span>openjdk:11-jre-slim
 <span class="nt">---</span><span class="o">&gt;</span> e4beed9b17a3
Step 9/13 : WORKDIR /helidon
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>bbbeffe84be8
Removing intermediate container bbbeffe84be8
 <span class="nt">---</span><span class="o">&gt;</span> 518c68977ccc
Step 10/13 : COPY <span class="nt">--from</span><span class="o">=</span>build /helidon/target/olympic_frontend.jar ./
 <span class="nt">---</span><span class="o">&gt;</span> 6eb033c8d5ab
Step 11/13 : COPY <span class="nt">--from</span><span class="o">=</span>build /helidon/target/libs ./libs
 <span class="nt">---</span><span class="o">&gt;</span> d46766254734
Step 12/13 : CMD <span class="o">[</span><span class="s2">"java"</span>, <span class="s2">"-jar"</span>, <span class="s2">"olympic_frontend.jar"</span><span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>b2e205e5b9ed
Removing intermediate container b2e205e5b9ed
 <span class="nt">---</span><span class="o">&gt;</span> a042893b3e8e
Step 13/13 : EXPOSE 8080
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>7e3a2bb12ed4
Removing intermediate container 7e3a2bb12ed4
 <span class="nt">---</span><span class="o">&gt;</span> b96ac0669f0d
Successfully built b96ac0669f0d
Successfully tagged code-at-customer/frontend-app:latest
</code></pre></div></div>

<p>これでビルド完了です。　　</p>

<p>ビルドしたコンテナイメージを確認してみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image <span class="nb">ls</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                           TAG        IMAGE ID       CREATED         SIZE
code-at-customer/frontend-app        latest     5ee35f1e2a49   3 minutes ago   270MB
~~~~
</code></pre></div></div>

<p>本来であれば、ビルドしたイメージをOCIR(Oracle Cloud Infrastructure Registry)へpushすることになりますが、今回はすでにコンテナイメージはpush済みなので、割愛します。</p>

<p class="notice--info"><strong>OCIR(Oracle Cloud Infrastructure Registry)へのpushについて</strong><br />
OCIRへビルドしたコンテナイメージをpushする場合は、Oracle Cloud InfrastructureのネームスペースとOCIRのリージョンを指定したタグ付けを行う必要があります。<br />
詳細は<a href="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-beginners/#2ocir%E3%81%B8%E3%81%AE%E3%83%97%E3%83%83%E3%82%B7%E3%83%A5%E3%81%A8oke%E3%81%B8%E3%81%AE%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4">こちら</a>をご確認ください。</p>

<p>ホームディレクトリに戻っておきます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<p>同じようにバックエンドアプリケーションのコンテナもビルドしてみます。</p>

<p>前述した通り、バックエンドアプリケーションはバージョンが3つ存在します。
今回は、そのバージョン情報を環境変数として持たせたDockerfileを用意していますので、それぞれビルドします。</p>

<p>例えば、v1の銅メダリストを返却するバックエンドアプリケーションは以下のようなDockerfileになっており、ENV命令とARG命令で定義しています。</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># 1st stage, build the app</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">maven:3.6-jdk-11</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">build</span>

<span class="k">WORKDIR</span><span class="s"> /helidon</span>

<span class="c"># Create a first layer to cache the "Maven World" in the local repository.</span>
<span class="c"># Incremental docker builds will always resume after that, unless you update</span>
<span class="c"># the pom</span>
<span class="k">ADD</span><span class="s"> pom.xml .</span>
<span class="k">RUN </span>mvn package <span class="nt">-Dmaven</span>.test.skip <span class="nt">-Declipselink</span>.weave.skip

<span class="c"># Do the Maven build!</span>
<span class="c"># Incremental docker builds will resume here when you change sources</span>
<span class="k">ADD</span><span class="s"> src src</span>
<span class="k">RUN </span>mvn package <span class="nt">-DskipTests</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"done!"</span>

<span class="c"># 2nd stage, build the runtime image</span>
<span class="k">FROM</span><span class="s"> openjdk:11-jre-slim</span>
<span class="k">WORKDIR</span><span class="s"> /helidon</span>

<span class="c"># Copy the binary built in the 1st stage</span>
<span class="k">COPY</span><span class="s"> --from=build /helidon/target/olympic_backend.jar ./</span>
<span class="k">COPY</span><span class="s"> --from=build /helidon/target/libs ./libs</span>

<span class="k">ARG</span><span class="s"> SERVICE_VERSION=V1</span>
<span class="k">ENV</span><span class="s"> SERVICE_VERSION=${SERVICE_VERSION}</span>

<span class="k">CMD</span><span class="s"> ["java", "-jar", "olympic_backend.jar"]</span>

<span class="k">EXPOSE</span><span class="s"> 8080</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ARG SERVICE_VERSION=V1</code>(デフォルト値はV1)で、ビルド時の<code class="language-plaintext highlighter-rouge">--build-arg</code>オプションで指定されたバージョンを取得し、
<code class="language-plaintext highlighter-rouge">ENV SERVICE_VERSION=${SERVICE_VERSION}</code>で環境変数として定義しています。</p>

<p class="notice--info"><strong>ENV命令とARG命令について</strong><br />
Dockerfileでは、コンテナ内で環境変数を扱う際にENV命令が用意されています。<br />
ENV命令は、環境変数と値のセットになっており、値はDockerfileから派生する全てのコマンド環境で利用できます。<br />
また、ARG命令を利用すると<code class="language-plaintext highlighter-rouge">docker image build</code>コマンド実行時に<code class="language-plaintext highlighter-rouge">–build-arg</code>オプションで指定された変数をビルド時に利用することができます。<br />
詳細は<a href="https://docs.docker.jp/engine/reference/builder.html">こちら</a>をご確認ください。</p>

<p>今回はバージョンが3つ存在するので、それぞれビルドしてみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/olympic_backend
</code></pre></div></div>

<p>V1をビルドします。<br />
V1はデフォルト値なので、<code class="language-plaintext highlighter-rouge">--build-arg</code>オプションを付与しなくても良いですが、今回はオプションを付与してビルドしてみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build <span class="nt">-t</span> code-at-customer/backend-app-v1 <span class="nt">--build-arg</span> <span class="nv">SERVICE_VERSION</span><span class="o">=</span>V1 <span class="nb">.</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~~
Successfully tagged code-at-customer/backend-app-v1:latest
</code></pre></div></div>

<p>ビルドしたコンテナイメージを確認してみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image <span class="nb">ls</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong>(順不同になる可能性があります)</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                           TAG        IMAGE ID       CREATED          SIZE
code-at-customer/frontend-app        latest     5ee35f1e2a49   13 minutes ago   270MB
code-at-customer/backend-app-v1      latest     f585e32a1147   27 minutes ago   243MB
~~~~
</code></pre></div></div>

<p>V2、V3も同じようにビルドしていきますが、時間がかかるため、今回は割愛します。<br />
V2、V3をビルドすると以下のようにコンテナイメージが作成されます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                           TAG        IMAGE ID       CREATED          SIZE
code-at-customer/frontend-app        latest     5ee35f1e2a49   15 minutes ago   270MB
code-at-customer/backend-app-v1      latest     9ba2a2183e29   39 minutes ago   243MB
code-at-customer/backend-app-v2      latest     9ba2a2183e29   39 minutes ago   243MB
code-at-customer/backend-app-v3      latest     bb7e737e4940   About a minute ago   243MB
~~~~
</code></pre></div></div>

<p>本来であれば、ビルドしたイメージをOCIR(Oracle Cloud Infrastructure Registry)へpushすることになりますが、今回はすでにコンテナイメージはpush済みなので、割愛します。</p>

<p>ホームディレクトリに戻っておきます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<p>最後にデータソースアプリケーションのコンテナもビルドしてみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/olympic_datasource
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build <span class="nt">-t</span> code-at-customer/datasource-app <span class="nb">.</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~~~~
Successfully tagged code-at-customer/datasource-app:latest
</code></pre></div></div>

<p>ビルドしたコンテナイメージを確認してみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image <span class="nb">ls</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong>(順不同になる可能性があります)</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                           TAG        IMAGE ID       CREATED          SIZE
code-at-customer/frontend-app        latest     5ee35f1e2a49   15 minutes ago   270MB
code-at-customer/backend-app-v1      latest     9ba2a2183e29   39 minutes ago   243MB
code-at-customer/backend-app-v2      latest     9ba2a2183e29   39 minutes ago   243MB
code-at-customer/backend-app-v3      latest     9ba2a2183e29   39 minutes ago   243MB
code-at-customer/datasource-app      latest     3a542bedb13a   43 seconds ago   261MB
~~~~
</code></pre></div></div>

<p>本来であれば、ビルドしたイメージをOCIR(Oracle Cloud Infrastructure Registry)へpushすることになりますが、今回はすでにコンテナイメージはpush済みなので、割愛します。</p>

<p>これで全てのアプリケーションがビルドできました。</p>

<p>ホームディレクトリに戻っておきます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<p>次に、k8sにコンテナアプリケーションをデプロイしていきます。</p>

<p>先ほど、cloneしてきたレポジトリの中にある<code class="language-plaintext highlighter-rouge">k8s</code>ディレクトリに移動します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/k8s
</code></pre></div></div>

<p>先ほどビルドしたコンテナアプリケーションをデプロイするためのManifestが<code class="language-plaintext highlighter-rouge">app</code>ディレクトリにあるので、配下のファイルを全てデプロイします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>app/plain
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> <span class="nb">.</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deployment.apps/backend-app-v1 created
deployment.apps/backend-app-v2 created
deployment.apps/backend-app-v3 created
service/backend-app created
deployment.apps/datasource-app created
service/datasource-app created
deployment.apps/frontend-app created
service/frontend-app created
ingress.networking.k8s.io/gateway created
</code></pre></div></div>

<p>これでOKE上にサンプルアプリケーションがデプロイされました。</p>

<p>デプロイ状況を確認してみます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                              READY   STATUS    RESTARTS   AGE
backend-app-v1-5c674f559f-fg2dq   2/2     Running   0          1m
backend-app-v1-5c674f559f-npjk4   2/2     Running   0          1m
backend-app-v2-84f5859c9f-gr6dd   2/2     Running   0          1m
backend-app-v2-84f5859c9f-pmnfl   2/2     Running   0          1m
backend-app-v3-7596dcf967-7dqnq   2/2     Running   0          1m
backend-app-v3-7596dcf967-tbhhw   2/2     Running   0          1m
datasource-app-7bc89cbdfc-pktdp   2/2     Running   0          1m
datasource-app-7bc89cbdfc-vmpr6   2/2     Running   0          1m
frontend-app-75c8986f76-lnhtg     2/2     Running   0          1m
frontend-app-75c8986f76-q5l44     2/2     Running   0          1m
node-exporter-handson-2mcph       1/1     Running   0          21m
node-exporter-handson-57qqq       1/1     Running   0          21m
node-exporter-handson-mbdzl       1/1     Running   0          21m
</code></pre></div></div>

<p>全て<code class="language-plaintext highlighter-rouge">Running</code>になったら、アプリケーションにアクセスしてみます。</p>

<p>アクセスには手順2で作成した<code class="language-plaintext highlighter-rouge">istio-ingressgateway</code>を経由してアクセスします。<br />
まずは、<code class="language-plaintext highlighter-rouge">istio-ingressgateway</code>のエンドポイントを確認します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services istio-ingressgateway <span class="nt">-n</span> istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP       PORT<span class="o">(</span>S<span class="o">)</span>                                                                      AGE
istio-ingressgateway   LoadBalancer   10.96.176.93   132.226.xxx.xxx   15021:30134/TCP,80:30850/TCP,443:30319/TCP,31400:31833/TCP,15443:30606/TCP   3d3h
</code></pre></div></div>

<p>上記の場合は、istio-ingressgatewayの<code class="language-plaintext highlighter-rouge">EXTERNAL-IP</code>である<code class="language-plaintext highlighter-rouge">132.226.xxx.xxx</code>がエンドポイントになります。</p>

<p>この場合は、以下のURLにアクセスします。<br />
<code class="language-plaintext highlighter-rouge">http://132.226.xxx.xxx</code></p>

<p>以下のような画面が表示されればOKです！</p>

<p><img src="3-002.png" alt="" /></p>

<p>何回かアクセスをしてみると、金メダメリスト(v3)、銀メダリスト(v2)、銅メダリスト(v1)がランダムに表示されることが確認できます。</p>

<p>ホームディレクトリに戻っておきます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<h3 id="3-3-grafana-lokiを利用したログ監視">3-3 Grafana Lokiを利用したログ監視</h3>

<p>ここでは、3-2でデプロイしたアプリケーションのログを監視してみます。</p>

<p>まずは、Grafanaにアクセスします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services grafana <span class="nt">-n</span> istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
grafana   NodePort   10.96.219.44   &lt;none&gt;        3000:31624/TCP   4d3h
</code></pre></div></div>

<p>GrafanaのアクセスにはNodePortを利用します。<br />
NodePortは<code class="language-plaintext highlighter-rouge">PORT(S)</code>の<code class="language-plaintext highlighter-rouge">:</code>以降のポート番号です。<br />
上記の場合、以下のURLにアクセスします。<br />
http://[WorkerNodeのパブリックIP]:31624</p>

<p>アクセスしたら、Exploreをクリックします。</p>

<p><img src="3-003.png" alt="" /></p>

<p>画面上部のプルダウンから<img src="3-004.png" alt="" />を選択します。</p>

<p><img src="3-005.png" alt="" /></p>

<p><img src="3-006.png" alt="" />をクリックします。</p>

<p><img src="3-007.png" alt="" />にログ対象とするラベルが表示されます。<br />
今回は、例として特定のPodのログを確認してみましょう。</p>

<p>対象とするPod名を選択します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                              READY   STATUS    RESTARTS   AGE
backend-app-v1-5c674f559f-fg2dq   2/2     Running   0          1m
backend-app-v1-5c674f559f-npjk4   2/2     Running   0          1m
backend-app-v2-84f5859c9f-gr6dd   2/2     Running   0          1m
backend-app-v2-84f5859c9f-pmnfl   2/2     Running   0          1m
backend-app-v3-7596dcf967-7dqnq   2/2     Running   0          1m
backend-app-v3-7596dcf967-tbhhw   2/2     Running   0          1m
datasource-app-7bc89cbdfc-pktdp   2/2     Running   0          1m
datasource-app-7bc89cbdfc-vmpr6   2/2     Running   0          1m
frontend-app-75c8986f76-lnhtg     2/2     Running   0          1m
frontend-app-75c8986f76-q5l44     2/2     Running   0          1m
node-exporter-handson-2mcph       1/1     Running   0          21m
node-exporter-handson-57qqq       1/1     Running   0          21m
node-exporter-handson-mbdzl       1/1     Running   0          21m
</code></pre></div></div>

<p>例えば、<code class="language-plaintext highlighter-rouge">backend-app-v2-84f5859c9f-gr6dd</code>を対象とします。(各自の環境に合わせてください)</p>

<p><img src="3-008.png" alt="" />から<code class="language-plaintext highlighter-rouge">pod</code>を選択するとPod名が表示されます。<br />
対象とするPod名を選択し、<code class="language-plaintext highlighter-rouge">show logs</code>をクリックします。</p>

<p><img src="3-009.png" alt="" /></p>

<p>対象のPodが出力したログが表示されます。</p>

<p><img src="3-010.png" alt="" /></p>

<p>Loki上でログをフィルタリングしたり、検索したりすることも可能です。</p>

<p>例えば、現在の状態では、Pod内にIstioによってInjectionされているEnvoyのログも出力されているので、アプリだけのログに絞ってみます。</p>

<p><img src="3-006.png" alt="" />欄にあるテキストボックスに<code class="language-plaintext highlighter-rouge">,container="backend-app"</code>という文字列を追加し、左上の<img src="3-013.png" alt="" />をクリックします。<br />
<img src="3-030.png" alt="" />のようなクエリになります。</p>

<p>これで、<code class="language-plaintext highlighter-rouge">backend-app-v2-84f5859c9f-gr6dd</code>というPodの中の<code class="language-plaintext highlighter-rouge">backend-app</code>というcontainerに絞ることができます。</p>

<p><img src="3-012.png" alt="" /></p>

<p>以上で、Grafana Lokiでのログ監視は完了です。</p>

<h3 id="3-4-jaegerを利用したトレーシング">3-4 Jaegerを利用したトレーシング</h3>

<p>続いて、Jaegerを利用してトレーシングを実施してみます。</p>

<p>まずは、アプリケーションにアクセスを行い、トレーシング情報をJaegerに流しましょう。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services istio-ingressgateway <span class="nt">-n</span> istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP       PORT<span class="o">(</span>S<span class="o">)</span>                                                                      AGE
istio-ingressgateway   LoadBalancer   10.96.176.93   132.226.xxx.xxx   15021:30134/TCP,80:30850/TCP,443:30319/TCP,31400:31833/TCP,15443:30606/TCP   3d3h
</code></pre></div></div>

<p>上記の場合は、istio-ingressgatewayの<code class="language-plaintext highlighter-rouge">EXTERNAL-IP</code>である<code class="language-plaintext highlighter-rouge">132.226.xxx.xxx</code>がエンドポイントになります。</p>

<p>この場合は、以下のURLにアクセスします。<br />
<code class="language-plaintext highlighter-rouge">http://132.226.xxx.xxx</code></p>

<p>次にJaegerのUIにアクセスします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services tracing <span class="nt">-n</span> istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                        AGE
tracing   NodePort   10.96.207.90   &lt;none&gt;        80:30483/TCP,16685:31417/TCP   4d4h
</code></pre></div></div>

<p>JaegerのアクセスにはNodePortを利用します。<br />
NodePortは<code class="language-plaintext highlighter-rouge">PORT(S)</code>の<code class="language-plaintext highlighter-rouge">:</code>以降のポート番号です。<br />
上記の場合、以下のURLにアクセスします。<br />
http://[WorkerNodeのパブリックIP]:30483</p>

<p>アクセスしたら、Serviceカテゴリにあるプルダウンをクリックし、<code class="language-plaintext highlighter-rouge">istio-ingress-gateway.istio.system</code>をクリックし、<code class="language-plaintext highlighter-rouge">Find Trace</code>をクリックします。</p>

<p><img src="3-014.png" alt="" /></p>

<p>これで、<code class="language-plaintext highlighter-rouge">istio-ingress-gateway</code>を経由してルーティングされたトラフィックの流れを見ることができます。</p>

<p><img src="3-015.png" alt="" /></p>

<p>このように<code class="language-plaintext highlighter-rouge">istio-ingress-gateway</code>、<code class="language-plaintext highlighter-rouge">frontend-app.default</code>、<code class="language-plaintext highlighter-rouge">backend-app.default</code>、<code class="language-plaintext highlighter-rouge">datasource-app.default</code>の4つのServiceが含まれたトレーシング情報が取得できています。</p>

<p>これをクリックします。</p>

<p><img src="3-016.png" alt="" /></p>

<p>このように一連のトラフィックの流れとそれぞれのレイテンシを確認することができます。</p>

<p>今回は簡単なアプリケーションなので、全体を通して数十~週百msで完了しますが、実際にパフォーマンスでの問題が発生した場合、トレーシング情報を見ることでどの部分がボトルネックになっているのかを確認することができます。</p>

<p>以上で、Jaegerを利用したトレーシングは完了です。</p>

<h3 id="3-5-kialiを利用したservice-meshの可視化">3-5 Kialiを利用したService Meshの可視化</h3>

<p>続いて、Kialiを利用したService Meshの可視化を行ってみます。</p>

<p>まずは、KialiのUIを開きます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services kiali <span class="nt">-n</span> istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME    TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                          AGE
kiali   NodePort   10.96.251.81   &lt;none&gt;        20001:30768/TCP,9090:32228/TCP   4d4h
</code></pre></div></div>

<p>KialiのアクセスにはNodePortを利用します。<br />
NodePortは<code class="language-plaintext highlighter-rouge">PORT(S)</code>の<code class="language-plaintext highlighter-rouge">:</code>以降のポート番号です。<br />
上記の場合、以下のURLにアクセスします。<br />
http://[WorkerNodeのパブリックIP]:30768</p>

<p>Kialiでの可視化を行うためにIstioのトラフィック管理設定リソースの一つである<code class="language-plaintext highlighter-rouge">DestinationRule</code>を作成します。<br />
これは、Serviceリソースを対象としたトラフィックに適用されるポリシーを定義するリソースです。</p>

<p>今回は以下のようなDestinationRuleを作成します。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DestinationRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">backend</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
  <span class="na">trafficPolicy</span><span class="pi">:</span>
    <span class="na">loadBalancer</span><span class="pi">:</span>
      <span class="na">simple</span><span class="pi">:</span> <span class="s">RANDOM</span>
  <span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v3</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DestinationRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">frontend</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">frontend-app</span>
  <span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DestinationRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">datasource</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">datasource-app</span>
  <span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
</code></pre></div></div>

<p>例えば、バックエンドアプリケーションに対するDestination Rule(<code class="language-plaintext highlighter-rouge">backend</code>)をみてみると、</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
  <span class="na">trafficPolicy</span><span class="pi">:</span>
    <span class="na">loadBalancer</span><span class="pi">:</span>
      <span class="na">simple</span><span class="pi">:</span> <span class="s">RANDOM</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">host</code>に対してバックエンドアプリケーションのServiceリソースを定義しています。</p>

<p>今回、<code class="language-plaintext highlighter-rouge">backend-app</code>に紐づくDeploymentは3つ(3バージョン)存在しています。<br />
<code class="language-plaintext highlighter-rouge">trafficPolicy:</code>は複数存在するDeploymentに対する分散ポリシーなどを定義できます。<br />
今回は、<code class="language-plaintext highlighter-rouge">RANDOM</code>なので、ランダムに<code class="language-plaintext highlighter-rouge">backend-app</code>に紐づくDeployment(今回は3つ)にトラフィックを分散します。</p>

<p>まずは、このDestinationRuleを適用してみましょう。</p>

<p>ホームディレクトリに戻ります。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/k8s/base
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> destination_rule.yaml
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>destinationrule.networking.istio.io/backend created
destinationrule.networking.istio.io/frontend created
destinationrule.networking.istio.io/datasource created
</code></pre></div></div>

<p>この状態で、KialiのUIを確認してみます。</p>

<p>まずは<code class="language-plaintext highlighter-rouge">Overview</code>です。</p>

<p><img src="3-017.png" alt="" /></p>

<p>ここでは、<code class="language-plaintext highlighter-rouge">default</code>ネームスペースに4つのアプリケーションが存在することがわかります。<br />
4つのアプリケーションとは、今回デプロイしているフロントエンドアプリケーション、バックエンドアプリケーション、データソースアプリケーションとNode Exporterです。</p>

<p>次に、<code class="language-plaintext highlighter-rouge">istio Config</code>を確認します。</p>

<p><code class="language-plaintext highlighter-rouge">No Namespace Selected</code>と表示されている場合は、右上の<img src="3-020.png" alt="" />から<code class="language-plaintext highlighter-rouge">default</code>にチェックを入れてください。</p>

<p><img src="3-018.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">Name</code>にある<code class="language-plaintext highlighter-rouge">DR</code>ラベルは<code class="language-plaintext highlighter-rouge">DestinationRule</code>を指します。<br />
<code class="language-plaintext highlighter-rouge">backend</code>をクリックしてみると、左側の<code class="language-plaintext highlighter-rouge">Destination Rule Overview</code>で3つのバージョンが存在していることが確認できます。</p>

<p><img src="3-019.png" alt="" /></p>

<p>次に、<code class="language-plaintext highlighter-rouge">Services</code>を確認します。</p>

<p><code class="language-plaintext highlighter-rouge">No Namespace Selected</code>と表示されている場合は、右上の<img src="3-020.png" alt="" />から<code class="language-plaintext highlighter-rouge">default</code>にチェックを入れてください。</p>

<p><img src="3-021.png" alt="" /></p>

<p>KubernetesのServiceリソースが確認できます。<br />
<code class="language-plaintext highlighter-rouge">Deatails</code>には、Serviceリソースに紐づく<code class="language-plaintext highlighter-rouge">DestinationRule</code>が確認できるようになっています。</p>

<p class="notice--info"><strong><code class="language-plaintext highlighter-rouge">node-exporter-handson</code>について</strong><br />
<code class="language-plaintext highlighter-rouge">node-exporter-handson</code>の<code class="language-plaintext highlighter-rouge">Deatails</code>欄に<img src="3-032.png" alt="" />というマークがありますが、今回のハンズオンの動作には影響しませんので、無視してください。</p>

<p>次に<code class="language-plaintext highlighter-rouge">Workload</code>を確認します。</p>

<p><code class="language-plaintext highlighter-rouge">No Namespace Selected</code>と表示されている場合は、右上の<img src="3-020.png" alt="" />から<code class="language-plaintext highlighter-rouge">default</code>にチェックを入れてください。</p>

<p><img src="3-022.png" alt="" /></p>

<p>ここには、デプロイ済みのDeploymentリソースが表示されます。</p>

<p class="notice--info"><strong><code class="language-plaintext highlighter-rouge">node-exporter-handson</code>について</strong><br />
<code class="language-plaintext highlighter-rouge">node-exporter-handson</code>の<code class="language-plaintext highlighter-rouge">Deatails</code>欄に<img src="3-032.png" alt="" /><img src="3-033.png" alt="" />というマークがありますが、今回のハンズオンの動作には影響しませんので、無視してください。</p>

<p>次に<code class="language-plaintext highlighter-rouge">Application</code>を確認します。</p>

<p><code class="language-plaintext highlighter-rouge">No Namespace Selected</code>と表示されている場合は、右上の<img src="3-020.png" alt="" />から<code class="language-plaintext highlighter-rouge">default</code>にチェックを入れてください。</p>

<p>ここには、デプロイ済みのアプリケーションが表示されます。<br />
ここでのアプリケーションとはServiceリソースとほぼ同義です。</p>

<p><img src="3-023.png" alt="" /></p>

<p class="notice--info"><strong><code class="language-plaintext highlighter-rouge">node-exporter-handson</code>について</strong><br />
<code class="language-plaintext highlighter-rouge">node-exporter-handson</code>の<code class="language-plaintext highlighter-rouge">Deatails</code>欄に<img src="3-032.png" alt="" />というマークがありますが、今回のハンズオンの動作には影響しませんので、無視してください。</p>

<p><code class="language-plaintext highlighter-rouge">backend-app</code>をクリックしてみると、以下のような画面が表示されます。</p>

<p><img src="3-024.png" alt="" /></p>

<p>ここで、ブラウザからアプリケーションにアクセスした後に再度確認してみてください。
しばらくすると、以下のようにアクセスしたTrafficが表示されます。</p>

<p><img src="3-025.png" alt="" /></p>

<p>他にも、図の赤枠部分のタブで切り替えると様々な情報が見れるので、確認してみてください。</p>

<p>最後に<code class="language-plaintext highlighter-rouge">Graph</code>を確認を確認します。</p>

<p><img src="3-026.png" alt="" /></p>

<p>ここでは、トラフィックの情報などをグラフで可視化することができます。</p>

<p>例えば、右上の<img src="3-027.png" alt="" />から<code class="language-plaintext highlighter-rouge">Versioned app graph</code>を選択します。</p>

<p><img src="3-028.png" alt="" /></p>

<p>この状態でアプリケーションに複数回アクセスします。<br />
現状は、バックエンドサービスが<code class="language-plaintext highlighter-rouge">DestinationRule</code>でランダムに負荷分散されるようになっているので、金メダリスト、銀メダリスト、銅メダリスト一覧がランダムで表示されることが確認できます。</p>

<p class="notice--info"><strong>バックエンドアプリケーションへの負荷分散について</strong><br />
DestinationRuleを適用する前から、バックエンドアプリケーションはv1/v2/v3にある程度負荷分散されています。<br />
これは、そもそもServiceリソースに負荷分散の機能があるためです。<br />
DestinationRuleを適用することによって、Istioの機能を利用した明示的な負荷分散を行うことができます。<br />
今回は<code class="language-plaintext highlighter-rouge">RANDOM</code>ポリシーを適用していますが、他にも<code class="language-plaintext highlighter-rouge">Weighted</code>(重みづけ)や<code class="language-plaintext highlighter-rouge">Least requests</code>(最小リクエスト)などのポリシーがあります。<br />
詳細は<a href="https://istio.io/latest/docs/concepts/traffic-management/#load-balancing-options">こちら</a>のページをご確認ください。</p>

<p>金メダリスト、銀メダリスト、銅メダリストそれぞれの一覧が表示されたら、再度<code class="language-plaintext highlighter-rouge">Versioned app graph</code>を確認します。</p>

<p><img src="3-029.png" alt="" /></p>

<p>このように、バージョン毎にトラフィックがルーティングされていることが可視化されます。</p>

<p>Kialiでは、上記でご確認いただいたとおり、Service Mesh環境の様々なリソースやトラフィック状況を可視化することができます。</p>

<p>最後に、ホームディレクトリに戻っておきます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
</code></pre></div></div>

<h2 id="4istioを利用したカナリアリリースをやってみよう">4.Istioを利用したカナリアリリースをやってみよう</h2>

<p>最後に、手順3までに構築してきた環境を利用して、カナリアリリースを実施してみます。</p>

<h3 id="4-1-カナリアリリース">4-1 カナリアリリース</h3>

<p>カナリアリリースとは<code class="language-plaintext highlighter-rouge">Blue/Greenデプロイメント</code>や<code class="language-plaintext highlighter-rouge">A/Bテスト</code>などと並ぶ高度なデプロイ戦略の一つで「プロダクトやサービスの新機能を一部ユーザーのみが利用できるようにリリースし、新機能に問題がないことを確認しながら段階的に全体に向けて展開していくデプロイ手法」を指します。<br />
これにより、新しいバージョンのアプリケーションを本番環境バージョンと一緒にデプロイして、ユーザの反応やパフォーマンスを確認することができます。</p>

<p>Istioを利用することで、カナリアリリースを容易に実施することができます。<br />
今回は、以下の想定でカナリアリリースを実施してみます。</p>

<ul>
  <li>対象：バックエンドアプリケーション</li>
  <li>既存バージョン：v1</li>
  <li>新バージョン：v2とv3</li>
  <li>ルーティングポリシー：トラフィックの80%をv1に、15%をv2に、5%をv3にルーティング</li>
</ul>

<p>上記の構成をIstioで実現するために、<code class="language-plaintext highlighter-rouge">VirtualService</code>というリソースを作成します。<br />
これは、<code class="language-plaintext highlighter-rouge">DestinationRule</code>で定義した情報を利用し、さらに細かいルーティングポリシーを設定します。<br />
例えば、HTTP Headerやパス等のマッチングルールに基づいて、リクエストのルーティング先を書き換えたりHTTP Headerの操作をすることが可能です。<br />
今回は、バックエンドアプリケーションのバージョンに重みづけを行い振り分けを行います。</p>

<p><code class="language-plaintext highlighter-rouge">DestinationRule</code>と<code class="language-plaintext highlighter-rouge">VirtualService</code>の関係は以下のようになります。</p>

<p><img src="4-001.png" alt="" /></p>

<p>今回は、以下のような<code class="language-plaintext highlighter-rouge">VirtualService</code>を用意しました。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">canary-release</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">backend-app</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">80</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">15</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v3</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">5</span>
</code></pre></div></div>

<p>以下に注目します。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">backend-app</span>
  <span class="na">http</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">80</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">15</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">backend-app</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v3</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="m">5</span>
</code></pre></div></div>

<p>ここでの<code class="language-plaintext highlighter-rouge">host</code>は対象となるバックエンドアプリケーションのServiceリソースです。<br />
<code class="language-plaintext highlighter-rouge">subset</code>にはそれぞれ<code class="language-plaintext highlighter-rouge">DestinationRule</code>で定義したものを利用しています。<br />
<code class="language-plaintext highlighter-rouge">weight</code>には、それぞれ重み付けを設定しています。</p>

<p>このManifestを適用します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>code-at-customer-handson/k8s/scenario
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> canaly-release.yaml
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virtualservice.networking.istio.io/canary-release created
</code></pre></div></div>

<p>アプリケーションにアクセスしてみましょう。</p>

<p>ほとんど、銅メダリスト(v1)が表示され、偶にv2(銀メダリスト)、ごく稀にv3(金メダリスト)が表示されるかと思います。</p>

<p>何度かアクセスした後に、Kialiでその様子を可視化してみましょう。</p>

<p>KialiのUIにアクセスし、<code class="language-plaintext highlighter-rouge">Application</code>メニューから<code class="language-plaintext highlighter-rouge">backend-app</code>をクリックします。</p>

<p><img src="4-002.png" alt="" /></p>

<p>Graph部分にトラフィックのルーティング割合が表示されます。<br />
概ね、設定した重み付けに従ってルーティングされていることが確認できます。</p>

<p><img src="4-003.png" alt="" /></p>

<p>このように、Istioを利用すると適切なリソースを作成するだけで、カナリアリリースのような高度なデプロイ戦略を実施することができます。</p>

<div class="notice--info">
  <p><strong>その他のシナリオについて</strong><br />
code-at-customer-handson/k8s/scenarioディレクトリにはカナリアリリース以外にも以下のシナリオをご用意しています。<br />
必要に応じてご確認ください。</p>

<ul>
  <li>
    <p>all-v3.yaml
トラフィックの全てをバックエンドアプリケーションv3(金メダリスト)にルーティングするポリシーです。<br />
これを適用すると、アプリケーションでは金メダリストのみが表示されます。</p>
  </li>
  <li>
    <p>v1-v2-half.yaml
トラフィックの50%をバックエンドアプリケーションv1に残りの50%をバックエンドアプリケーションv2にルーティングするポリシーです。<br />
これを適用すると、アプリケーションでは、銀メダリストと銅メダリストが半々に表示されます。</p>
  </li>
</ul>

</div>

<p>以上で、ハンズオンは終わりです。</p>

<h2 id="5oci-monitoringのメトリクスをgrafanaダッシュボードを利用して確認してみようオプション">5.OCI MonitoringのメトリクスをGrafanaダッシュボードを利用して確認してみよう【オプション】</h2>

<p>ここからはオプションの手順になります。<br />
お時間がある方、興味がある方はぜひお試しください。</p>

<p>Grafanaではプラグインを利用して、Oracle Cloud Infrastructure Monitoringが提供するメトリクスをGrafanaダッシュボードで確認することができます。<br />
ここでは、その手順を確認していきます。</p>

<p class="notice--info"><strong>Oracle Cloud Infrastructure Monitoringについて</strong><br />
詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/Monitoring/Concepts/monitoringoverview.htm">こちら</a>のページをご確認ください。</p>

<h3 id="5-1-動的グループとポリシーの設定">5-1 動的グループとポリシーの設定</h3>

<p>ここでは、OKE上にデプロイされているGrafanaからOracle Cloud Infrastructure Monitoringが提供するメトリクスを取得できるようにポリシーの設定を行います。</p>

<p>OCIコンソールのハンバーガーメニューを開き、「アイデンティティとセキュリティ」から「動的グループ」を選択します。</p>

<p class="notice--info"><strong>動的グループについて</strong><br />
動的グループの詳細は<a href="https://docs.oracle.com/ja-jp/iaas/Content/Identity/Tasks/managingdynamicgroups.htm">こちら</a>のページをご確認ください。</p>

<p><img src="5-001.png" alt="" /></p>

<p>「動的グループの作成」をクリックします。</p>

<p><img src="5-002.png" alt="" /></p>

<p>以下のように情報を入力します。</p>

<p class="notice--info"><strong>集合ハンズオンで参加されている皆様へ</strong><br />
動的グループ名は重複が許容されないため、集合ハンズオンなどで同一環境を複数名でご利用されている皆様は動的グループ名に自分のイニシャルや好きな複数桁の番号などを付与し、重複しないように動的グループ名を設定してください。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>grafana_dynamic_group</td>
    </tr>
    <tr>
      <td>説明</td>
      <td>grafana_dynamic_group</td>
    </tr>
    <tr>
      <td>一致ルール - ルール1</td>
      <td><code class="language-plaintext highlighter-rouge">instance.compartment.id = '&lt;ご自身のコンパートメントOCID&gt;'</code></td>
    </tr>
  </tbody>
</table>

<p><img src="5-003.png" alt="" /></p>

<p>画像はイメージですので、コンパートメントOCIDはご自身の環境に合わせて読み替えてください。</p>

<p>「作成」をクリックします。</p>

<p class="notice--info"><strong>コンパートメントOCIDについて</strong><br />
コンパートメントOCIDの確認方法については、<a href="https://oracle-japan.github.io/ocitutorials/cloud-native/functions-for-beginners/#2-1-2-%E3%82%B3%E3%83%B3%E3%83%91%E3%83%BC%E3%83%88%E3%83%A1%E3%83%B3%E3%83%88ocid%E3%81%AE%E7%A2%BA%E8%AA%8D">こちら</a>の<code class="language-plaintext highlighter-rouge">2-1-2</code>の手順をご確認ください。</p>

<p>次に画面左側にあるメニューから「ポリシー」をクリックします。</p>

<p><img src="5-004.png" alt="" /></p>

<p>「ポリシーの作成」をクリックします。</p>

<p><img src="5-005.png" alt="" /></p>

<p>以下の情報を入力します。<br />
また、「手動エディタの表示」にチェックを入れます。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>名前</td>
      <td>grafana_policy</td>
    </tr>
    <tr>
      <td>説明</td>
      <td>grafana_policy</td>
    </tr>
    <tr>
      <td>コンパートメント</td>
      <td>ご自身のコンパートメント名</td>
    </tr>
    <tr>
      <td>ポリシー</td>
      <td><code class="language-plaintext highlighter-rouge">allow dynamic-group grafana_dynamic_group to read metrics in compartment id &lt;ご自身のコンパートメントOCID&gt;</code></td>
    </tr>
  </tbody>
</table>

<div class="notice--warning">
  <p><strong>集合ハンズオンで参加されている皆様へ</strong><br />
集合ハンズオンで参加されている皆様は、ご自身で作成された動的グループ名をご利用ください。<br />
以下のような形になります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>allow dynamic-group &lt;ご自身で作成された動的グループ名&gt; to read metrics in compartment id &lt;ご自身のコンパートメントOCID&gt;
</code></pre></div></div>


</div>

<p><img src="5-006.png" alt="" /></p>

<p>画像はイメージですので、コンパートメントOCIDはご自身の環境に合わせて読み替えてください。</p>

<p>「作成」をクリックします。</p>

<p>これで、動的グループとポリシーの設定は完了です。</p>

<h3 id="5-2-oci-monitoringプラグインのgrafanaへのインストール">5-2 OCI MonitoringプラグインのGrafanaへのインストール</h3>

<p>ここでは、OCI MonitoringプラグインをGrafanaへインストールしていきます。</p>

<p>今回、GrafanaをIstioアドオンとしてインストールしているので、以下にManifestが配置してあります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/istio-1.11.0/samples/addons/
</code></pre></div></div>

<p>GrafanaのManifestファイルをviで開きます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi grafana.yaml
</code></pre></div></div>

<p>160行目くらいにある<code class="language-plaintext highlighter-rouge">env</code>フィールドに以下の環境変数を追加します。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">GF_INSTALL_PLUGINS</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">oci-metrics-datasource"</span>
</code></pre></div></div>

<p>保存して終了したら、Manifestを適用します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> grafana.yaml
</code></pre></div></div>

<p>GrafanaにNodePortからアクセス可能にするために以下のコマンドを再度実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch service grafana <span class="nt">-n</span> istio-system <span class="nt">-p</span> <span class="s1">'{"spec": {"type": "NodePort"}}'</span>
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service/grafana patched
</code></pre></div></div>

<p>また、適用後にGrafanaが再起動するので、起動が完了するまで待機します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod -n istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                                    READY   STATUS    RESTARTS   AGE
grafana-5f75c485c4-5rxdq                1/1     Running   0          37s
istio-egressgateway-9dc6cbc49-pk5q2     1/1     Running   0          55m
istio-ingressgateway-7975cdb749-8kxr9   1/1     Running   0          55m
istiod-77b4d7b55d-cc7b7                 1/1     Running   0          55m
jaeger-5f65fdbf9b-pbjfb                 1/1     Running   0          54m
kiali-787bc487b7-znbl4                  1/1     Running   0          54m
loki-0                                  1/1     Running   0          51m
loki-promtail-8z4x7                     1/1     Running   0          51m
loki-promtail-hpm46                     1/1     Running   0          51m
loki-promtail-kkc9k                     1/1     Running   0          51m
prometheus-9f4947649-znlrr              2/2     Running   0          54m
</code></pre></div></div>

<p>これで、OCI MonitoringプラグインのGrafanaへのインストールは完了です。</p>

<h3 id="5-3-grafanaダッシュボードの確認">5-3 Grafanaダッシュボードの確認</h3>

<p>Grafanaが再起動したら、Grafanaダッシュボードにブラウザからアクセスします。<br />
アクセスするためのポート番号が変わっているので、再度確認を行います。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services grafana <span class="nt">-n</span> istio-system
</code></pre></div></div>

<p><strong><em>コマンド結果</em></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
grafana   NodePort   10.96.219.44   &lt;none&gt;        3000:30453/TCP   4d3h
</code></pre></div></div>

<p>GrafanaのアクセスにはNodePortを利用します。<br />
NodePortは<code class="language-plaintext highlighter-rouge">PORT(S)</code>の<code class="language-plaintext highlighter-rouge">:</code>以降のポート番号です。<br />
上記の場合、以下のURLにアクセスします。<br />
http://[WorkerNodeのパブリックIP]:30453</p>

<p>アクセスしたら、<img src="5-007.png" alt="" />の<img src="5-014.png" alt="" />をクリックします。</p>

<p><img src="5-008.png" alt="" />をクリックし、最下部にある「Oracle Cloud Infrastructure Metrics」を選択し、<img src="5-015.png" alt="" />をクリックします。</p>

<p>以下の情報を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Tenancy OCID</td>
      <td>ご自身のテナンシOCID</td>
    </tr>
    <tr>
      <td>Default Region</td>
      <td>ap-osaka-1</td>
    </tr>
    <tr>
      <td>Environment</td>
      <td>OCI Instance</td>
    </tr>
  </tbody>
</table>

<p><img src="5-009.png" alt="" /></p>

<p class="notice--info"><strong>テナンシOCIDについて</strong><br />
テナンシOCIDの確認方法については、<a href="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-intermediates/#3%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%83%E3%83%97%E3%81%A7%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E6%83%85%E5%A0%B1%E3%81%AE%E5%8F%8E%E9%9B%86">こちら</a>の<code class="language-plaintext highlighter-rouge">3.テナンシOCID</code>をご確認ください。</p>

<p>「Save&amp;Test」をクリックします。</p>

<p><img src="5-010.png" alt="" />をクリックし、上部のタブから「Oracle Cloud Infrastructure Metrics」を選択します。</p>

<p><img src="5-011.png" alt="" /></p>

<p>以下のように必要項目を入力します。</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Region</td>
      <td>ap-osaka-1</td>
    </tr>
    <tr>
      <td>Compartment</td>
      <td>ご自身のコンパートメント名</td>
    </tr>
    <tr>
      <td>Namespace</td>
      <td>oci_computeagent</td>
    </tr>
    <tr>
      <td>Metric</td>
      <td>例えば<code class="language-plaintext highlighter-rouge">CpuUtilization</code>を選択</td>
    </tr>
  </tbody>
</table>

<p class="notice--warning"><strong>ポリシーの反映について</strong><br />
環境や状況によって<a href="#5-1-動的グループとポリシーの設定">先ほどの手順</a>で設定したポリシーの反映に時間がかかる場合があります。<br />
<code class="language-plaintext highlighter-rouge">Namespace</code>以降が選択できない場合は、しばらく時間をおいてから再度お試しください。</p>

<p><img src="5-012.png" alt="" />
画像はイメージですので、各項目はご自身の環境に合わせて読み替えてください。</p>

<p>以下のようなグラフと表が表示されます。</p>

<p><img src="5-013.png" alt="" /></p>

<p>このようにOCI MonitoringのGrafanaプラグインを利用すると、OCIのCompute(今回の場合はOKEのWorker Node)のメトリクスをGrafanaダッシュボードに統合することができます。</p>

<!-- 6.OCI APMを利用してトレーシングしてみよう【オプション】
---------------------------------ß
<!-- 
ここからはオプションの手順になります。  
お時間がある方、興味がある方はぜひお試しください。  

OCI APMでは、Jaegerと同じようにマイクロサービスをはじめとした分散アプリケーションのトレーシングを行うことができます。
この手順では、OCI APMを利用した分散トレーシングの手順を実施していきます。

**OCI APMとOracle Cloud Observability and Management Platform**  
OCIでは、アプリケーションの可視性および機械学習ベースの実用的なインサイトを提供するサービス群として、[Oracle Cloud Observability and Management Platform](https://www.oracle.com/jp/manageability/)があります。  
この中核をなすサービスの一つに、分散トレーシングや合成モニタリングなど実現するサービスであるOCI APMがあります。
詳細は[こちら](https://docs.oracle.com/ja-jp/iaas/application-performance-monitoring/index.html)のページをご確認ください。
{: .notice--info}

### 6-1 ポリシーの作成

まずは、OCI APMを利用するためのポリシーを作成してきます。  

**本手順について**  
この手順6-1は、トライアル環境や管理者権限をお持ちの環境でハンズオンを実施されている皆様には不要な手順ですので、スキップしていただき、手順6-2から実施してください。
{: .notice--info}

OCIコンソールのハンバーガーメニューを開き、「アイデンティティとセキュリティ」から「ポリシー」を選択します。  

![](6-001.png)

「ポリシーの作成」をクリックします。  

![](5-005.png)

以下の情報を入力します。  
また、「手動エディタの表示」にチェックを入れます。  

key|value
-|-
名前| apm_policy
説明| apm_policy
コンパートメント | ご自身のコンパートメント名
ポリシー | `Allow group APM-Admins to manage apm-domains in compartment id <ご自身のコンパートメントOCID>`

![](6-002.png)

画像はイメージですので、コンパートメントOCIDはご自身の環境に合わせて読み替えてください。 

「作成」をクリックします。  

これで、ポリシーの設定は完了です。  

### 6-2 APMドメインの作成

ここでは、APMドメインの作成を行います。  

OCIコンソールのハンバーガーメニューを開き、「監視および管理」から「アプリケーション・パフォーマンス・モニタリング」カテゴリの「管理」を選択します。  

![](6-003.png)

「APMドメインの作成」をクリックします。  

![](6-004.png)

以下の情報を入力します。 

key|value
-|-
名前| oke-handson-apm
説明| oke-handson-apm

**集合ハンズオンで参加されている皆様へ**  
APMドメイン名は重複が許容されないため、集合ハンズオンなどで同一環境を複数名でご利用されている皆様はAPMドメイン名に自分のイニシャルや好きな複数桁の番号などを付与し、重複しないようにAPMドメイン名を設定してください。  
{: .notice--info}

「作成」をクリックします。

![](6-005.png)

ドメインが「作成中」のステータスになるので、「アクティブ」になるまで待機します。

![](6-006.png)

ドメインが「アクティブ」になったら、ドメイン名の箇所をクリックします。

「APMドメイン情報」の「データ・アップロード・エンドポイント」と「データ・キー」の「プライベート」キーの値をコピーし、エディタなどに記録しておきます。  
この値は、アプリケーション側からトレーシング情報をAPMにアップロードする際のエンドポイントとその際に利用するキーになり、後ほど利用します。

![](6-007.png)
![](6-008.png)

これで、APMドメインの作成は完了です。

### 6-3 サンプルアプリケーションのManifest設定の変更

ここでは、Manifestの設定を変更していきます。

Manifestのあるディレクトリに移動します。  

```sh
cd ~
```

```sh
cd code-at-customer-handson/k8s/app/for-oci-apm
```

フロントエンドアプリケーションのManifestをvimで開きます。

```sh
vim olympic_frontend.yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-app
  labels:
    app: frontend-app
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend-app
      version: v1
  template:
    metadata:
      labels:
        app: frontend-app
        version: v1
    spec:
      containers:
      - name: frontend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/frontend-app-apm
        ports:
        - containerPort: 8082
        env:
        - name: tracing.data-upload-endpoint
          value: https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com
        - name: tracing.private-data-key
          value: XXXXXXXXXXXXXXXXXXXXXXXX
~~~
```

25行目から29行目の`env`フィールドの`tracing.data-upload-endpoint`、`tracing.private-data-key`の`value`を[6-2 APMドメインの作成](#6-2-apmドメインの作成)で記録したAPMドメインとプライベート・データキーに差し替えます。  

以下のようになります。

```yaml
~~~
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend-app
      version: v1
  template:
    metadata:
      labels:
        app: frontend-app
        version: v1
    spec:
      containers:
      - name: frontend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/frontend-app-apm
        ports:
        - containerPort: 8082
        env:
        - name: tracing.data-upload-endpoint
          value: <ご自身のAPMドメインのエンドポイント>
        - name: tracing.private-data-key
          value: <ご自身のAPMドメインのプライベート・データキー>
```

この状態で保存します。  

これと同じことをバックエンド、データソースアプリケーションにも実施します。  

```sh
vim olympic_backend.yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-v1
  labels:
    app: backend-app
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
      version: v1
  template:
    metadata:
      labels:
        app: backend-app
        version: v1
    spec:
      containers:
      - name: backend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v1-apm
        ports:
        - containerPort: 8081
        env:
        - name: tracing.data-upload-endpoint
          value: https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com
        - name: tracing.private-data-key
          value: XXXXXXXXXXXXXXXXXXXXXXXX
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-v2
  labels:
    app: backend-app
    version: v2
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
      version: v2
  template:
    metadata:
      labels:
        app: backend-app
        version: v2
    spec:
      containers:
      - name: backend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v2-apm
        ports:
        - containerPort: 8081
        env:
        - name: tracing.data-upload-endpoint
          value: https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com
        - name: tracing.private-data-key
          value: XXXXXXXXXXXXXXXXXXXXXXXX
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-v3
  labels:
    app: backend-app
    version: v3
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
      version: v3
  template:
    metadata:
      labels:
        app: backend-app
        version: v3
    spec:
      containers:
      - name: backend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v3-apm
        ports:
        - containerPort: 8081
        env:
        - name: tracing.data-upload-endpoint
          value: https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com
        - name: tracing.private-data-key
          value: XXXXXXXXXXXXXXXXXXXXXXXX
```  

25行目から29行目、55行目から59行目、85行目から89行目の`env`フィールドの`tracing.data-upload-endpoint`、`tracing.private-data-key`の`value`を[6-2 APMドメインの作成](#6-2-apmドメインの作成)で記録したAPMドメインとプライベート・データキーにそれぞれ差し替えます。  

以下のようになります。

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-v1
  labels:
    app: backend-app
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
      version: v1
  template:
    metadata:
      labels:
        app: backend-app
        version: v1
    spec:
      containers:
      - name: backend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v1-apm
        ports:
        - containerPort: 8081
        env:
        - name: tracing.data-upload-endpoint
          value: <ご自身のAPMドメインのエンドポイント>
        - name: tracing.private-data-key
          value: <ご自身のAPMドメインのプライベート・データキー>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-v2
  labels:
    app: backend-app
    version: v2
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
      version: v2
  template:
    metadata:
      labels:
        app: backend-app
        version: v2
    spec:
      containers:
      - name: backend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v2-apm
        ports:
        - containerPort: 8081
        env:
        - name: tracing.data-upload-endpoint
          value: <ご自身のAPMドメインのエンドポイント>
        - name: tracing.private-data-key
          value: <ご自身のAPMドメインのプライベート・データキー>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-app-v3
  labels:
    app: backend-app
    version: v3
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-app
      version: v3
  template:
    metadata:
      labels:
        app: backend-app
        version: v3
    spec:
      containers:
      - name: backend-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/backend-app-v3-apm
        ports:
        - containerPort: 8081
        env:
        - name: tracing.data-upload-endpoint
          value: <ご自身のAPMドメインのエンドポイント>
        - name: tracing.private-data-key
          value: <ご自身のAPMドメインのプライベート・データキー>
```

最後にデータソースアプリケーションに対しても実施します。

```sh
vim olympic_datasource.yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: datasource-app
  labels:
    app: datasource-app
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: datasource-app
      version: v1
  template:
    metadata:
      labels:
        app: datasource-app
        version: v1
    spec:
      containers:
      - name: datasource-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/datasource-app-apm
        ports:
        - containerPort: 8080
        env:
        - name: tracing.data-upload-endpoint
          value: https://xxxxxxxxxxxxxxxx.apm-agt.us-ashburn-1.oci.oraclecloud.com
        - name: tracing.private-data-key
          value: XXXXXXXXXXXXXXXXXXXXXXXX
``` 

25行目から29行目の`env`フィールドの`tracing.data-upload-endpoint`、`tracing.private-data-key`の`value`を[6-2 APMドメインの作成](#6-2-apmドメインの作成)で記録したAPMドメインとプライベート・データキーに差し替えます。  

以下のようになります。

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: datasource-app
  labels:
    app: datasource-app
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: datasource-app
      version: v1
  template:
    metadata:
      labels:
        app: datasource-app
        version: v1
    spec:
      containers:
      - name: datasource-app
        image: nrt.ocir.io/orasejapan/codeatcustomer/datasource-app-apm
        ports:
        - containerPort: 8080
        env:
        - name: tracing.data-upload-endpoint
          value: <ご自身のAPMドメインのエンドポイント>
        - name: tracing.private-data-key
          value: <ご自身のAPMドメインのプライベート・データキー>
```

これでサンプルアプリケーションのManifest設定の変更は完了です。  

ここで利用するコンテナアプリケーションは、OCI APMを利用するためにアプリケーション側にトレーシングの設定を入れています。  
今回、OCI APMで利用しているアプリケーションは、code-at-customer-handsonディレクトリ配下の`_apm`が付与されているプロジェクトになります。


<div class="notice--info">
  <p><strong>HelidonアプリケーションでのOCI APMの利用</strong><br />
今回はHelidonを利用したアプリケーションですが、<a href="https://docs.oracle.com/ja-jp/iaas/application-performance-monitoring/doc/use-apm-tracer-helidon.html">HelidonにはOCI APM専用のエージェント</a>が用意されています。<br />
基本的には、<code class="language-plaintext highlighter-rouge">pom.xml</code>に以下の依存関係を追加するだけで利用可能です。(アプリケーション側の変更は必要ありません)<br />
また、必要に応じて<code class="language-plaintext highlighter-rouge">src/main/resources/META-INF/microprofile-config.properties</code>に設定値を追加します。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.oracle.apm.agent.java<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>apm-java-agent-helidon<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.oracle.apm.agent.java<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>apm-java-agent-tracer<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>oci<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>OCI Object Store<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://objectstorage.us-ashburn-1.oraclecloud.com/n/idhph4hmky92/b/prod-agent-binaries/o<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>
</code></pre></div></div>

<p>今回、<code class="language-plaintext highlighter-rouge">microprofile-config.properties</code>については以下のように設定しています。(フロントエンドアプリケーションの場合)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># OCI APM関連</span>
  <span class="s">tracing.enabled=true</span>
  <span class="s">tracing.service=oke-helidon-demo-frontend-service</span>
  <span class="s">tracing.name="frontend-helidon-service"</span>
</code></pre></div></div>


</div>

**既存ZipkinプラットフォームでのOCI APMの利用**  
OCI APMはZipkin互換にもなっているので、既存のZipkinベースのAPMプラットフォームをOCI APMで利用して頂くことも可能です。  
詳細については[こちら](https://docs.oracle.com/ja-jp/iaas/application-performance-monitoring/doc/configure-open-source-tracing-systems.html)をご確認ください。
{: .notice--info}

### 6-4 Istioのトレーシング設定の変更

ここでは、現時点で設定されているIstio内のJargerからOCI APMにトレーシングを切り替える設定を行います。  

まずは、今デプロイされているアプリケーションを一旦削除します。  

```sh
cd ~
```

```sh
cd code-at-customer-handson/k8s/app/plain
```

```sh
kubectl delete -f . 
```

***コマンド結果***

```sh
deployment.apps/backend-app-v1 deleted
deployment.apps/backend-app-v2 deleted
deployment.apps/backend-app-v3 deleted
service/backend-app deleted
deployment.apps/datasource-app deleted
service/datasource-app deleted
deployment.apps/frontend-app deleted
service/frontend-app deleted
ingress.networking.k8s.io/gateway deleted
```

ここで、再度Istioをインストールします。
[2-1 Istio（addon: Prometheus, Grafana, Jaeger, Kiali）インストール](#2-1-istioaddon-prometheus-grafana-jaeger-kialiインストール)でインストールしたスタックはそのままで問題ありません。  
 
今回は、MeshConfigを利用してIstioのトレーシングを無効にします。  

**Global Mesh Optionsについて**  
Istioには、Service Mesh全体に影響する設定として、MeshConfigという設定群が存在します。  
詳細は[こちら](https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/)をご確認ください。
{: .notice--info}

```sh
istioctl install --set profile=demo --set meshConfig.enableTracing=false --skip-confirmation
```

***コマンド結果***

```sh
✔ Istio core installed                                                                                                                           
✔ Istiod installed                                                                                                                               
✔ Egress gateways installed                                                                                                                      
✔ Ingress gateways installed                                                                                                                     
✔ Installation complete                                                                                                                          
Thank you for installing Istio 1.11.  Please take a few minutes to tell us about your install/upgrade experience!  https://forms.gle/kWULBRjUv7hHci7T6
```

これで、Istioのトレーシング設定の変更は完了です。

### 6-5 OCI APMでのトレーシング

いよいよ、OCI APMを利用したトレーシングを実施します。  

再度、サンプルアプリケーションをデプロイします。  

```sh
cd ~
```

```sh
cd code-at-customer-handson/k8s/app/for-oci-apm
```

```sh
kubectl apply -f . 
```

***コマンド結果***

```sh
deployment.apps/backend-app-v1 created
deployment.apps/backend-app-v2 created
deployment.apps/backend-app-v3 created
service/backend-app created
deployment.apps/datasource-app created
service/datasource-app created
deployment.apps/frontend-app created
service/frontend-app created
ingress.networking.k8s.io/gateway created
```

アプリケーションにアクセスします。  

```sh
kubectl get services istio-ingressgateway -n istio-system
```

***コマンド結果***

```sh
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP       PORT(S)                                                                      AGE
istio-ingressgateway   LoadBalancer   10.96.176.93   132.226.xxx.xxx   15021:30134/TCP,80:30850/TCP,443:30319/TCP,31400:31833/TCP,15443:30606/TCP   3d3h
```

上記の場合は、istio-ingressgatewayの`EXTERNAL-IP`である`132.226.xxx.xxx`がエンドポイントになります。

この場合は、以下のURLにアクセスします。  
`http://132.226.xxx.xxx`

何度かアクセスしたのちに、トレース情報をOCI APMから確認します。  

OCIコンソールのハンバーガーメニューを開き、「監視および管理」から「アプリケーション・パフォーマンス・モニタリング」カテゴリの「トレース・エクスプローラー」を選択します。  

![](6-009.png)

画面上部にある「APMドメイン」から、[6-2 APMドメインの作成](#6-2-apmドメインの作成)で作成したAPMドメインを選択します。  

![](6-010.png)

右側にある検索条件を「過去15分間」に選択し、「実行」ボタンをクリックします。  

![](6-011.png)

複数のトレース情報が表示されますので、`Spans`が25になっている情報をクリックします。  

![](6-012.png)

以下のようなトレース情報が表示されます。
先ほどJaegerで確認した情報よりも、より詳細な情報が取得できていることが確認できます。  

![](6-013.png)
![](6-014.png)

これで、OCI APMを利用したトレーシングは完了です。  

### 6-6 OCI APMでのアプリケーションサーバのメトリクス監視

ここでは、OCI APMで監視できるアプリケーションサーバのメトリクスについて見ていきたいと思います。  

画面左上のプルダウンから「ダッシュボード」をクリックします。  

![](6-015.png)

ダッシュボードから「アプリケーション・サーバー」をクリックします。  

![](6-016.png)

左上に「アプリケーションサーバを選択します」というプルダウンがあるので、任意のアプリケーションサーバ(実体はHelidonのPod)を選択します。  

![](6-017.png) 

アプリケーションサーバ(今回はHelidon)のメトリクス情報が表示されます。  

![](6-018.png)

ここで取得したメトリクスをもとに、OCI MonitoringやOCI Notificationsと連携すると、一定の閾値を超過した際にアラーム通知を行うこともできます。  

**OCI MonitoringとOCI Notificationsについて**  
OCIにはリソース監視を行うOCI Monitoringがあり、OCI Notificationsと連携するとEmailやSlackなどに対してアラーム通知を行うことができます。  
詳細は[こちら](/ocitutorials/intermediates/monitoring-resources/)のハンズオンをご確認ください。
{: .notice--info}

このように、OCI APMを利用すると詳細なトレーシングの取得と確認およびアプリケーションサーバのメトリクス監視を行うことができます。   -->


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time class="dt-published" datetime="2024-09-20T14:29:49+09:00">September 20, 2024</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Oracle+Container+Engine+for+Kubernetes%28OKE%29%E3%81%A7%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%81%97%E3%81%A6%E3%82%AA%E3%83%96%E3%82%B6%E3%83%90%E3%83%93%E3%83%AA%E3%83%86%E3%82%A3%E3%83%84%E3%83%BC%E3%83%AB%E3%82%92%E5%88%A9%E7%94%A8%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-for-advances%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-for-advances%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-advances/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/cloud-native/oke-for-intermediates/" class="pagination--pager" title="KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう
">前へ</a>
    
    
      <a href="/ocitutorials/cloud-native/oke-observability-for-advances/" class="pagination--pager" title="Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">関連記事</h2>
  <div class="grid__wrapper">
    
  </div>
</div>

  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://oracle-japan.github.io">Oracle Cloud Infrastructure チュートリアル</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  
    <script src="/ocitutorials/assets/js/tabs.js"></script>
  
    <script src="/ocitutorials/assets/js/sidebar.js"></script>
  


  </body>
</html>
