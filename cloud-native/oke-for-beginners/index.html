<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="ja-JP" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="Oracle Container Engine for Kubernetes(OKE)は、Oracle Cloud Infrastructure(OCI)上で提供されるマネージドKubernetsサービスです。こちらのハンズオンでは、Kubernetes自体の特徴や使い方を含めて、OKEを触って頂けるコンテンツになっています。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-beginners/">


  <meta property="og:description" content="Oracle Container Engine for Kubernetes(OKE)は、Oracle Cloud Infrastructure(OCI)上で提供されるマネージドKubernetsサービスです。こちらのハンズオンでは、Kubernetes自体の特徴や使い方を含めて、OKEを触って頂けるコンテンツになっています。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg">





  <meta property="article:published_time" content="2024-07-04T22:38:28+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-beginners/">












<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/ocitutorials/#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E4%B8%80%E8%A6%A7"
                
                
              >チュートリアル一覧</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ocitutorials/about/"
                
                
              >このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: url('/ocitutorials/assets/images/rh01-cloud-home-pine-background.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう

        
      </h1>
      
        <p class="page__lead">Oracle Container Engine for Kubernetes(OKE)は、Oracle Cloud Infrastructure(OCI)上で提供されるマネージドKubernetsサービスです。こちらのハンズオンでは、Kubernetes自体の特徴や使い方を含めて、OKEを触って頂けるコンテンツになっています。
</p>
      
      


      
    </div>
  
  
</div>






  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/cloud-native" itemprop="item"><span itemprop="name">Cloud native</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">Cloud Native編</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-commons/">Oracle Cloud Infrastructure(OCI) DevOps事前準備</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-beginners-compute/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ-Compute編-</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-beginners-oke/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ-OKE編-</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/devops-for-beginners-functions/">Oracle Cloud Infrastructure(OCI) DevOpsことはじめ-Oracle Functions編-</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/ci-for-beginners/">OCI Container Instances をプロビジョニングしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-commons/">Oracle Container Engine for Kubernetes(OKE)をプロビジョニングしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-beginners/" class="active">Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-intermediates/">KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-for-advances/">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてオブザバビリティツールを利用してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/oke-observability-for-advances/">Oracle Container Engine for Kubernetes(OKE)でサンプルマイクロサービスアプリケーションをデプロイしてOCIのオブザバビリティサービスを利用してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/fn-for-beginners/">Fn Project ハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-for-beginners/">Oracle Functions ハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-apigateway-for-beginners/">Oracle Cloud Infrasturcture API Gateway + Oracle Functionsハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-vmshape-for-intermediates/">Oracle Functionsを利用した仮想マシン (VM) のシェイプ変更</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-ords-for-intermediates/">Oracle Functionsを利用したORDSでのデータベースアクセス</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-nosql-for-intermediates/">Oracle Functionsを利用したNoSQLデータベースアクセス</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/functions-apigateway-for-intermediates/">Oracle Functionsを利用したAPI Gatewayの認証</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/apigateway-for-beginners/">OCI API Gatewayハンズオン</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/osm-for-beginners/">OCI Service Meshを使ってサービスメッシュ環境を作ろう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/helidon-mp-for-beginners/">Helidon(MP)を始めてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/helidon-se-for-beginners/">Helidon(SE)を始めてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/wls-for-oci-provisioning/">WebLogic Server for OCIをプロビジョニングしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/wls-for-oci-migration/">WebLogic Server for OCIにアプリケーションを移行してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/wls-for-oke-provisioning/">WebLogic Server for OKEをプロビジョニングしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/cloud-native/microtx-for-beginners/">Oracle Transaction Manager for Microservices(MicroTx)を体験してみよう</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Oracle Container Engine for Kubernetes(OKE)でKubernetesを動かしてみよう">
    <meta itemprop="description" content="Oracle Container Engine for Kubernetes(OKE)は、Oracle Cloud Infrastructure(OCI)上で提供されるマネージドKubernetsサービスです。こちらのハンズオンでは、Kubernetes自体の特徴や使い方を含めて、OKEを触って頂けるコンテンツになっています。">
    <meta itemprop="datePublished" content="2024-07-04T22:38:28+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#前提条件">前提条件</a></li><li><a href="#1コンテナイメージの作成">1.コンテナイメージの作成</a><ul><li><a href="#11-ソースコードをcloneする">1.1. ソースコードをCloneする</a></li><li><a href="#12-コンテナイメージを作る">1.2. コンテナイメージを作る</a></li></ul></li><li><a href="#2ocirへのプッシュとokeへのデプロイ">2.OCIRへのプッシュとOKEへのデプロイ</a><ul><li><a href="#21-ocirを利用するための事前準備">2.1. OCIRを利用するための事前準備</a></li><li><a href="#22-ocirにリポジトリを作成">2.2. OCIRにリポジトリを作成</a></li><li><a href="#23-ocirにコンテナイメージをプッシュする">2.3. OCIRにコンテナイメージをプッシュする</a></li><li><a href="#24-okeへのデプロイ">2.4. OKEへのデプロイ</a></li></ul></li><li><a href="#3kubernetes上のオブジェクトの確認">3.Kubernetes上のオブジェクトの確認</a><ul><li><a href="#31-deploymentオブジェクトの確認">3.1. Deploymentオブジェクトの確認</a></li><li><a href="#32-podの標準出力の表示">3.2. Podの標準出力の表示</a><ul><li><a href="#321-podの環境変数の確認">3.2.1. Podの環境変数の確認</a></li></ul></li></ul></li><li><a href="#4アプリケーションのスケーリング">4.アプリケーションのスケーリング</a><ul><li><a href="#41-スケールアウト">4.1. スケールアウト</a></li><li><a href="#42-serviceによるルーティングの様子の確認">4.2. Serviceによるルーティングの様子の確認</a></li><li><a href="#43-スケールイン">4.3. スケールイン</a></li></ul></li><li><a href="#5podの自動復旧">5.Podの自動復旧</a></li></ul>
            </nav>
          </aside>
        
        <p>Oracle Container Engine for Kubernetes（以下OKE）は、OracleのマネージドKubernetesサービスです。<br />
このハンズオンでは、OKEにサンプルアプリケーションをデプロイするプロセスを通して、Kubernetesそのものの基本的な操作方法や特徴を学ぶことができます。</p>

<p>このカテゴリには以下のサービスが含まれます。</p>

<ul>
  <li>
    <dl>
      <dt>Oracle Container Engine for Kubernetes (OKE):</dt>
      <dd>フルマネージドなKuberentesクラスターを提供するクラウドサービスです。</dd>
    </dl>
  </li>
  <li>
    <dl>
      <dt>Oracle Cloud Infrastructure Registry (OCIR):</dt>
      <dd>フルマネージドなDocker v2標準対応のコンテナレジストリを提供するサービスです。</dd>
    </dl>
  </li>
</ul>

<h2 id="前提条件">前提条件</h2>

<ul>
  <li>クラウド環境
    <ul>
      <li>Oracle Cloudのアカウントを取得済みであること</li>
      <li><a href="/ocitutorials/cloud-native/oke-for-commons/">OKEハンズオン事前準備</a>を実施済みであること</li>
    </ul>
  </li>
</ul>

<h2 id="1コンテナイメージの作成">1.コンテナイメージの作成</h2>
<p>ここでは、サンプルアプリケーションが動作するコンテナイメージを作成します。</p>

<h3 id="11-ソースコードをcloneする">1.1. ソースコードをCloneする</h3>

<p>今回利用するサンプルアプリケーションは、oracle-japanのGitHubアカウント配下のリポジトリとして作成してあります。</p>

<p><a href="https://github.com/oracle-japan/cowweb-for-wercker-demo">サンプルアプリケーションのリポジトリ</a>にアクセスして、<code class="language-plaintext highlighter-rouge">Code</code>ボタンをクリックします。</p>

<p>ソースコードを取得する方法は2つあります。一つはgitのクライアントでCloneする方法、もう一つはZIPファイル形式でダウンロードする方法です。ここでは前者の手順を行いますので、展開した吹き出し型のダイアログで、URLの文字列の右側にあるクリップボード型のアイコンをクリックします。</p>

<p>これにより、クリップボードにURLがコピーされます。</p>

<p><img src="2.3.PNG" alt="" /></p>

<p>Cloud ShellまたはLinuxのコンソールから、以下のコマンドを実行してソースコードをCloneします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone [コピーしたリポジトリのURL]
</code></pre></div></div>

<p>続いて、Cloneしてできたディレクトリをカレントディレクトリにしておきます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd cowweb-for-wercker-demo
</code></pre></div></div>

<h3 id="12-コンテナイメージを作る">1.2. コンテナイメージを作る</h3>
<p>コンテナイメージは、Dockerfileと呼ばれるコンテナの構成を記述したファイルによって、その内容が定義されます。</p>

<p>サンプルアプリケーションのコードには作成済みのDockerfileが含まれていますので、その内容を確認してみます。以下のコマンドを実行してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat Dockerfile
</code></pre></div></div>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1st stage, build the app</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">maven:3.8.4-openjdk-17-slim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">build</span>

<span class="k">WORKDIR</span><span class="s"> /helidon</span>

<span class="c"># Create a first layer to cache the "Maven World" in the local repository.</span>
<span class="c"># Incremental docker builds will always resume after that, unless you update</span>
<span class="c"># the pom</span>
<span class="k">ADD</span><span class="s"> pom.xml .</span>
<span class="k">RUN </span>mvn package <span class="nt">-Dmaven</span>.test.skip <span class="nt">-Declipselink</span>.weave.skip

<span class="c"># Do the Maven build!</span>
<span class="c"># Incremental docker builds will resume here when you change sources</span>
<span class="k">ADD</span><span class="s"> src src</span>
<span class="k">RUN </span>mvn package <span class="nt">-DskipTests</span>

<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"done!"</span>

<span class="c"># 2nd stage, build the runtime image</span>
<span class="k">FROM</span><span class="s"> openjdk:17-jdk-slim</span>
<span class="k">WORKDIR</span><span class="s"> /helidon</span>

<span class="c"># Copy the binary built in the 1st stage</span>
<span class="k">COPY</span><span class="s"> --from=build /helidon/target/cowweb-helidon.jar ./</span>
<span class="k">COPY</span><span class="s"> --from=build /helidon/target/libs ./libs</span>

<span class="k">CMD</span><span class="s"> ["java", "-jar", "cowweb-helidon.jar"]</span>

<span class="k">EXPOSE</span><span class="s"> 8080</span>
</code></pre></div></div>

<p>Dockerfileの内容を見ると、FROMで始まる行が2つあることがわかります。最初のFROMから始まる数行は、jdkがインストールされたコンテナイメージ内にサンプルアプリケーションのコードをコピーし、さらに<code class="language-plaintext highlighter-rouge">mvn package</code>を実行してアプリをビルドしています。</p>

<p>次のFROMから続く一連の処理は、jdkがインストールされたコンテナイメージを基に、アプリの実行ユーザーの作成、ビルドしてできたjarファイルのコピー、コンテナ起動時に実行するコマンドの設定などを行っています。</p>

<p>それではこのDockerfileを使ってコンテナイメージを作成します。以下のコマンドを実行してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build -t [リポジトリ名]/cowweb:v1.0 .
</code></pre></div></div>

<p>このコマンドにおいて<code class="language-plaintext highlighter-rouge">リポジトリ名</code>には任意の文字列を指定できますが、通常はプロジェクト名やユーザー名などを小文字にしたものを指定します。例えば、以下のようなコマンドになります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image build -t oke-handson/cowweb:v1.0 .
</code></pre></div></div>

<p>以下のように、<code class="language-plaintext highlighter-rouge">Successfully tagged</code>のメッセージで処理が終了していれば、イメージのビルドは完了です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sending build context to Docker daemon  128.5kB
Step 1/13 : FROM maven:3.8.4-openjdk-17-slim as build
Trying to pull repository docker.io/library/maven ... 
3.8.4-openjdk-17-slim: Pulling from docker.io/library/maven
f7a1c6dad281: Pull complete 
ea8366d5a4a5: Pull complete 
bff4abe573cd: Pull complete 
3f92e41bef06: Pull complete 
6581ea1ec5a5: Pull complete 
de879b0c951f: Pull complete 
ac1236d673e3: Pull complete 
Digest: sha256:150deb7b386bad685dcf0c781b9b9023a25896087b637c069a50c8019cab86f8
Status: Downloaded newer image for maven:3.8.4-openjdk-17-slim
 ---&gt; 849a2a2d4242
Step 2/13 : WORKDIR /helidon
 ---&gt; Running in 503337c170c7
Removing intermediate container 503337c170c7
 ---&gt; e456a937870a
Step 3/13 : ADD pom.xml .
 ---&gt; fadb77529253
Step 4/13 : RUN mvn package -Dmaven.test.skip -Declipselink.weave.skip
 ---&gt; Running in 190344b19870

...（中略）...

Step 9/13 : WORKDIR /helidon
 ---&gt; Running in ede9941ef284
Removing intermediate container ede9941ef284
 ---&gt; ed9214bcc7e8
Step 10/13 : COPY --from=build /helidon/target/cowweb-helidon.jar ./
 ---&gt; 72e6abc15a88
Step 11/13 : COPY --from=build /helidon/target/libs ./libs
 ---&gt; 039c2d539641
Step 12/13 : CMD ["java", "-jar", "cowweb-helidon.jar"]
 ---&gt; Running in b579e0845ce9
Removing intermediate container b579e0845ce9
 ---&gt; 9344c0c557ac
Step 13/13 : EXPOSE 8080
 ---&gt; Running in d19e9f20932b
Removing intermediate container d19e9f20932b
 ---&gt; 5e997bb463db
Successfully built 5e997bb463db
Successfully tagged oke-handson/cowweb:v1.0
</code></pre></div></div>

<p>実際にビルドされたイメージは、<code class="language-plaintext highlighter-rouge">docker image ls</code>コマンドで確認することができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image ls
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY           TAG                     IMAGE ID            CREATED             SIZE
oke-handson/cowweb   v1.0                    a328bfaffb52        4 minutes ago       428MB
&lt;none&gt;               &lt;none&gt;                  042346419526        5 minutes ago       505MB
openjdk              17-jdk-slim             37cb44321d04        4 months ago        408MB
maven                3.8.4-openjdk-17-slim   849a2a2d4242        5 months ago        425MB
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">oke-handson/cowweb</code>の名前のイメージが作成されていることがわかります。</p>

<p>アプリケーションのコンテナイメージは、ソースコードのビルドにはmavenがインストールされたコンテナを利用し、アプリケーションの実行環境にはopenjdkがインストールされたコンテナを利用しています。このため、mavenやopenjdkといった名前のついたイメージも表示されます。</p>

<p>これらのコンテナは、アプリケーションのコンテナイメージの作成時に、自動的にダウンロードされて利用されています。</p>

<h2 id="2ocirへのプッシュとokeへのデプロイ">2.OCIRへのプッシュとOKEへのデプロイ</h2>

<h3 id="21-ocirを利用するための事前準備">2.1. OCIRを利用するための事前準備</h3>
<p>OCIRはOracleが提供するコンテナレジストリのマネージドサービスです。ここでは、1.3.で作成したコンテナイメージをOCIRにプッシュ（アップロード）します。</p>

<p>OCIRにdockerコマンドからアクセスするため、OCIのユーザーアカウントに必要な設定をしていきます。</p>

<p>OCIコンソール画面右上の人型のアイコンをクリックし、展開したプロファイルからユーザ名(oracleidentitycloudservice/<ユーザ名>)をクリックします。</ユーザ名></p>

<p><img src="3.2-1.png" alt="" /></p>

<p>下にスクロールした左側にある<code class="language-plaintext highlighter-rouge">認証トークン</code>をクリックして、トークンの作成画面に遷移します。</p>

<p><img src="3.3.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">トークンの生成</code>ボタンをクリックします。</p>

<p><img src="3.4.png" alt="" /></p>

<p>[Geterate Token]ダイアログで、トークンの用途を説明する情報（任意の文字列）を入力し、<code class="language-plaintext highlighter-rouge">トークンの生成</code>ボタンをクリックします。</p>

<p><img src="3.5.png" alt="" /></p>

<p>ダイアログに生成したトークンが表示されます。<code class="language-plaintext highlighter-rouge">Copy</code>という文字列をクリックするとクリップボードにこのトークンがコピーされます。そして<code class="language-plaintext highlighter-rouge">閉じる</code>をクリックします。</p>

<p><img src="3.6.png" alt="" /></p>

<p>このトークンはあとの手順で利用するため、テキストエディタ等にペーストするなどして控えておいてください。</p>

<h3 id="22-ocirにリポジトリを作成">2.2. OCIRにリポジトリを作成</h3>

<p>OCIRにビルドしたコンテナイメージを格納するリポジトリを作成します。<br />
ハンバーガーメニューから、「開発者サービス」-「コンテナ・レジストリ」を選択します。</p>

<p><img src="2.2-1.png" alt="" /></p>

<p>左メニューにあるコンパートメントのプルダウンメニューから対象のコンパートメントを選択します。</p>

<p><img src="2.2-2.png" alt="" /></p>

<p>「リポジトリの作成」ボタンをクリックします。</p>

<p><img src="2.2-3.png" alt="" /></p>

<p>以下の設定を行い、「リポジトリの作成」ボタンをクリックします。</p>

<ul>
  <li>コンパートメント：対象のコンパートメント</li>
  <li>リポジトリ名：oke-handson/cowweb</li>
  <li>アクセス：パブリック</li>
</ul>

<p class="notice--warning"><strong>リポジトリ名について</strong><br />
OCIRのリポジトリ名はテナンシで一意になります。<br />
集合ハンズオンなど複数人で同一環境を共有されている皆様は、<code class="language-plaintext highlighter-rouge">oke-handson-01/cowweb</code>や<code class="language-plaintext highlighter-rouge">oke-handson-tn/cowweb</code>などの名前のイニシャルを付与し、名前が重複しないようにしてください。</p>

<p><img src="2.2-4.png" alt="" /></p>

<p>リストに作成したリポジトリがあることを確認します。</p>

<p><img src="2.2-5.png" alt="" /></p>

<h3 id="23-ocirにコンテナイメージをプッシュする">2.3. OCIRにコンテナイメージをプッシュする</h3>
<p>それでは、コンテナイメージをOCIRにプッシュします。</p>

<p>まず、<code class="language-plaintext highlighter-rouge">docker login</code>コマンドでOCIRにログインします。ログイン先のレジストリを指定するにあたり、ホストされているデータセンターリージョンに合わせて適切なリージョンコードを指定する必要があります。</p>

<p>ご自身の環境に合わせて、下表から適切なリージョンコードを見つけてください。</p>

<table>
  <thead>
    <tr>
      <th>リージョン</th>
      <th>リージョンコード</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ap-tokyo-1</td>
      <td>nrt</td>
    </tr>
    <tr>
      <td>ap-osaka-1</td>
      <td>kix</td>
    </tr>
    <tr>
      <td>ap-melbourne-1</td>
      <td>mel</td>
    </tr>
    <tr>
      <td>us-ashburn-1</td>
      <td>iad</td>
    </tr>
    <tr>
      <td>us-phoenix-1</td>
      <td>phx</td>
    </tr>
    <tr>
      <td>ap-mumbai-1</td>
      <td>bom</td>
    </tr>
    <tr>
      <td>ap-seoul-1</td>
      <td>icn</td>
    </tr>
    <tr>
      <td>ap-sydney-1</td>
      <td>syd</td>
    </tr>
    <tr>
      <td>ca-toronto-1</td>
      <td>yyz</td>
    </tr>
    <tr>
      <td>ca-montreal-1</td>
      <td>yul</td>
    </tr>
    <tr>
      <td>eu-frankfurt-1</td>
      <td>fra</td>
    </tr>
    <tr>
      <td>eu-zurich-1</td>
      <td>zrh</td>
    </tr>
    <tr>
      <td>sa-saopaulo-1</td>
      <td>gru</td>
    </tr>
    <tr>
      <td>uk-london-1</td>
      <td>lhr</td>
    </tr>
    <tr>
      <td>sa-santiago-1</td>
      <td>scl</td>
    </tr>
    <tr>
      <td>ap-hyderabad-1</td>
      <td>hyd</td>
    </tr>
    <tr>
      <td>eu-amsterdam-1</td>
      <td>ams</td>
    </tr>
    <tr>
      <td>me-jeddah-1</td>
      <td>jed</td>
    </tr>
    <tr>
      <td>ap-chuncheon-1</td>
      <td>yny</td>
    </tr>
    <tr>
      <td>me-dubai-1</td>
      <td>dxb</td>
    </tr>
    <tr>
      <td>uk-cardiff-1</td>
      <td>cwl</td>
    </tr>
    <tr>
      <td>us-sanjose-1</td>
      <td>sjc</td>
    </tr>
  </tbody>
</table>

<p>次に、OCIRにログインするためにオブジェクト・ストレージ・ネームスペースを確認します。</p>

<p>オブジェクト・ストレージ・ネームスペースは、OCIコンソール画面右上の人型のアイコンをクリックし、展開したプロファイルからテナンシ:<テナンシ名>から確認します。</テナンシ名></p>

<p><img src="3.6-0.png" alt="" /></p>

<p>テナンシ情報のオブジェクト・ストレージ設定からオブジェクト・ストレージ・ネームスペースの値を確認します。OCIRへのアクセスする際に使用するため、値をテキストファイルにコピー＆ペーストするなどして控えておいてください。</p>

<p><img src="3.6-1.png" alt="" /></p>

<p class="notice--info"><strong>オブジェクト・ストレージ・ネームスペースについて</strong><br />
オブジェクト・ストレージ・ネームスペースはテナントに対し1つ割り当てられます。リージョン内のすべてのコンパートメントにまたがり使用されます。任意の文字列が設定され、変更することはできません。</p>

<p>次に、以下のコマンドでOCIRにログインします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login [リージョンコード].ocir.io
</code></pre></div></div>

<p>例えば、東京リージョン(nrt)をご利用の場合は、以下のコマンドでログインします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login nrt.ocir.io
</code></pre></div></div>

<p>ユーザー名、パスワードの入力を求めるメッセージが表示されますので、以下のように入力してください。</p>

<ul>
  <li>ユーザー名: [オブジェクト・ストレージ・ネームスペース]/[ユーザー名] （例: nrzftilbveen/oracleidentitycloudservice/yoi.naka.0106@gmail.com）</li>
  <li>パスワード: [2.1.で作成したトークン文字列]</li>
</ul>

<p class="notice--warning"><strong>パスワードについて</strong><br />
ここで入力するパスワードはOCIコンソールにログインする際のパスワードとは異なるのでご注意ください</p>

<p>以下のように<code class="language-plaintext highlighter-rouge">Login Succeeded</code>というメッセージが表示されれば、ログイン成功です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Username: nrzftilbveen/Handson-001
Password:
Login Succeeded
</code></pre></div></div>

<p>続いて、OCIRの形式に合わせてコンテナイメージのタグを更新します。<code class="language-plaintext highlighter-rouge">docker tag</code>コマンドを実行してくさい。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image tag [リポジトリ名]/cowweb:v1.0 [リージョンコード].ocir.io/オブジェクト・ストレージ・ネームスペース]/[リポジトリ名]/cowweb:v1.0
</code></pre></div></div>

<p>[リージョンコード]と[オブジェクト・ストレージ・ネームスペース]は、これまでの手順で指定したものと同じものを指定します。リポジトリ名には<code class="language-plaintext highlighter-rouge">docker build</code>のときにしてしたものと同じ文字列を指定してください。</p>

<p>例えば、以下のように指定します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image tag oke-handson/cowweb:v1.0 nrt.ocir.io/nrzftilbveen/oke-handson/cowweb:v1.0
</code></pre></div></div>

<p>この操作によって、コンテナイメージにプッシュ先のレジストリを指定する情報を追加しています。これを行わない場合、コンテナイメージはデフォルトのレジストリが指定されたものとみなされ、Docker社が提供するDocker Hubというレジストリが利用されてしまいます。</p>

<p>これで準備が整いましたので、実際にOCIRにイメージをプッシュします。以下のコマンドを実行してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image push [リージョンコード].ocir.io/[オブジェクト・ストレージ・ネームスペース]/[リポジトリ名]/cowweb:v1.0
</code></pre></div></div>

<p>例えば、以下のように指定します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image push nrt.ocir.io/nrzftilbveen/oke-handson/cowweb:v1.0
</code></pre></div></div>

<p>以下のような実行結果となれば、プッシュが成功しています。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The push refers to repository [nrt.ocir.io/nrzftilbveen/oke-handson/cowweb]
d07a2053e8fb: Pushed
93ed7a751af8: Pushed
20dd87a4c2ab: Pushed
78075328e0da: Pushed
9f8566ee5135: Pushed
v1.0: digest: sha256:5769c194f3861f71c9fd43eb763813676aaba0b41acf453fb6a09a1af7525c82 size: 1367
</code></pre></div></div>

<div class="notice--warning">
  <p><strong>docker push時の挙動</strong><br />
集合ハンズオンなどで、コンテナレジストリを複数のユーザーで共有している場合、以下のようなメッセージとなることがあります。</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>60dc38cb0cd5: Layer already exists
ea75a4331573: Layer already exists
20dd87a4c2ab: Layer already exists
…
</code></pre></div></div>
<p>これは既にレジストリに存在するものと同じ内容をアップロードしたときに表示されるものですので、手順をそのまま続行して問題ありません。</p>

</div>

<p>それでは、OCIRにコンテナが保存されていることを確認してみましょう。OCIコンソールの画面で左上のメニューを展開し、<code class="language-plaintext highlighter-rouge">開発者サービス</code>－<code class="language-plaintext highlighter-rouge">コンテナ・レジストリ</code>をクリックします。</p>

<p><img src="3.7.png" alt="" /></p>

<p>リポジトリの一覧が表示されます。この中に、指定した名前のコンテナがあることを確認してください。</p>

<p><img src="3.8-2.png" alt="" /></p>

<p>これでレジストリへのコンテナイメージの格納は完了しました。
以上で、OCIRへのコンテナイメージの格納は完了です。</p>

<h3 id="24-okeへのデプロイ">2.4. OKEへのデプロイ</h3>
<p>それでは、いよいよOKEクラスターにアプリケーションのコンテナをデプロイします。</p>

<p>OKEを始めとして、Kubernetesのクラスターにコンテナをデプロイするには、クラスター上の配置情報をmanifestと呼ばれるファイルに記述しておく必要があります。</p>

<p>サンプルアプリケーションのコードには作成済みのmanifestファイルが含まれていますので、その内容を確認してみます。以下のコマンドを実行してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat ./kubernetes/cowweb.yaml
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: Deployment
apiVersion: apps/v1
metadata:
  name: cowweb
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cowweb
  template:
    metadata:
      labels:
        app: cowweb
        version: v1
    spec:
      containers:
        - name: cowweb
          image: <span class="k">${</span><span class="nv">region</span><span class="p">-code</span><span class="k">}</span>.ocir.io/<span class="k">${</span><span class="nv">tenancy</span><span class="k">}</span>/<span class="k">${</span><span class="nv">repository</span><span class="k">}</span>/cowweb:v1.0
          imagePullPolicy: IfNotPresent
          ports:
            - name: api
              containerPort: 8080
    ...（以下略）...
</code></pre></div></div>

<p>このファイルによって、サンプルアプリケーションのコンテナが、クラスター上にどのように配置されるかが定義されています。例えば、6行目にある<code class="language-plaintext highlighter-rouge">replicas:2</code>という記述は、このコンテナが、2つ立ち上げられて冗長構成を取るということを意味しています。</p>

<p class="notice--info"><strong>サンプルアプリについて</strong><br />
実際にKubernetes上でコンテナが動作する際には、Podと言われる管理単位に内包される形で実行されます。上記のmanifestでは、サンプルアプリのコンテナを内包するPodが、2つデプロイされることになります。</p>

<p>22行目には、実際にクラスター上で動かすコンテナイメージが指定されています。現在の記述内容は、ご自身環境に合わせた記述にはなっていませんので、この部分を正しい値に修正してください。具体的には、2.2.で<code class="language-plaintext highlighter-rouge">docker image push</code>コマンドを実行する際に指定した文字列と同じ内容に修正してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[リージョンコード].ocir.io/[オブジェクト・ストレージ・ネームスペース]/[リポジトリ名]/cowweb:v1.0
</code></pre></div></div>

<p>例えば、以下のような文字列となります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nrt.ocir.io/nrzftilbveen/oke-handson/cowweb:v1.0
</code></pre></div></div>

<p>次に、cowweb-service.yamlというmanifestファイルの内容を確認してみます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat ./kubernetes/cowweb-service.yaml
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kind: Service
apiVersion: v1
metadata:
  name: cowweb
  labels:
    app: cowweb
  annotations:
    oci.oraclecloud.com/load-balancer-type: <span class="s2">"lb"</span>
    service.beta.kubernetes.io/oci-load-balancer-shape: <span class="s2">"flexible"</span>
    service.beta.kubernetes.io/oci-load-balancer-shape-flex-min: <span class="s2">"10"</span>
    service.beta.kubernetes.io/oci-load-balancer-shape-flex-max: <span class="s2">"30"</span>
spec:
  <span class="nb">type</span>: LoadBalancer
  selector:
    app: cowweb
  ports:
    - port: 80
      targetPort: 8080
      name: http
</code></pre></div></div>

<p>このmanifestファイルは、クラスターに対するリクエストのトラフィックを受け付ける際のルールを定義しています。<code class="language-plaintext highlighter-rouge">type: LoadBalancer</code>という記述は、クラスターがホストされているクラウドサービスのロードバランサーを自動プロビジョニングし、そのLBに来たトラフィックをコンテナに届けるという意味です。</p>

<p>それでは、Kubernetes上でサンプルアプリケーションのコンテナを動かしてみます。まずは、クラスターを区画に分けて管理するための領域である、namespaceを作成します。以下のコマンドで、namespace名は任意の文字列を指定できます。<br />
今回は”handson”というnamespace名で作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create namespace handson
</code></pre></div></div>

<p>デフォルトのNamespaceを上記で作成したものに変更しておきます。これを行うと、以降、kubectlの実行の度にNamespaceを指定する必要がなくなります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config set-context $(kubectl config current-context) --namespace=handson
</code></pre></div></div>

<p>次に、manifestファイルをクラスターに適用し、PodやServiceをクラスター内に作成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f ./kubernetes/cowweb.yaml
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f ./kubernetes/cowweb-service.yaml
</code></pre></div></div>

<p>以下のコマンドを実行して、リソースの構成が完了しているかどうかを確認することができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod,service
</code></pre></div></div>

<p>すべてのPodのSTATUSがRunnigであることと、cowwebという名前のServiceがあることが確認できれば、リソースの作成は完了です（ServiceのEXTERNAL-IPは、ロードバランサーが実際に作成されるまで表示されません。その場合は少し時間を置いて上記コマンドを再実行してください）。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                          READY   STATUS    RESTARTS   AGE
pod/cowweb-695c65b665-sgcdk   1/1     Running   0          17s
pod/cowweb-695c65b665-vh825   1/1     Running   0          17s

NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)        AGE
service/cowweb       LoadBalancer   10.96.229.191   130.***.***.***   80:30975/TCP   1m
</code></pre></div></div>

<div class="notice--warning">
  <p><strong>集合ハンズオン時のロードバランサーのシェイプについて</strong><br />
集合ハンズオンなどで、一つのクラウド環境を複数のユーザーで共有している場合、利用可能なロードバランサー数の上限に達して正常にServiceが作成できない場合があります。<br />
そのような場合は、ロードバランサーのシェイプ（対応可能なトラフィック量）を変更して、サービスの作成を行ってみてください。
具体的には以下のコマンドを実行します。</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 作ってしまったServiceを削除</span>
kubectl delete <span class="nt">-f</span> ./kubernetes/cowweb-service.yaml
</code></pre></div></div>
<p>これは既にレジストリに存在するものと同じ内容をアップロードしたときに表示されるものですので、手順をそのまま続行して問題ありません。</p>

</div>

<p class="notice--info"><strong>サンプルアプリについて</strong><br />
実際にKubernetes上でコンテナが動作する際には、Podと言われる管理単位に内包される形で実行されます。上記のmanifestでは、サンプルアプリのコンテナを内包するPodが、2つデプロイされることになります。</p>

<p>上の例では、IPアドレス130.<strong><em>.</em></strong>.***の80番ポートでロードバランサーが公開されておりここにリクエストを送信すると、アプリケーションにアクセスできることを意味しています。このIPアドレスをテキストエディタ等に控えておいてください。</p>

<p>これでクラスターへのデプロイは完了しましたので、実際に動作確認してみます。以下のコマンドを実行してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://[ロードバランサーのIP]/cowsay/say"
</code></pre></div></div>

<p>ローカルで動作確認したときと同様、以下のようなアスキーアートが表示されれば、アプリケーションが正常に動作しています。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ______
&lt; Moo! &gt;
 ------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||--WWW |
                ||     ||
</code></pre></div></div>

<p>おめでとうございます。これで、OKEクラスターで実際にアプリケーションを動かすことができました！</p>

<h2 id="3kubernetes上のオブジェクトの確認">3.Kubernetes上のオブジェクトの確認</h2>
<p>ここからは、先ほどデプロイしたサンプルアプリケーションを利用してKubernetes上のオブジェクトを確認しながら、Kubernetesの基本的な特徴をみていきます。<br />
まずは、Depoymentからです。</p>

<h3 id="31-deploymentオブジェクトの確認">3.1. Deploymentオブジェクトの確認</h3>
<p>Deploymentは、Podのレプリカ数（冗長構成でのPodの数）や、Podが内包するコンテナの指定など、動作させたいコンテナに関連する構成情報を定義するオブジェクトです。<br />
ここまでの手順で、Deploymentオブジェクトをクラスター上に作成済みであり、その事によって、サンプルアプリケーションがクラスタで動作しています。</p>

<p>では、Deploymentオブジェクトの情報を確認してみましょう。クラスターに存在するDeploymentの一覧を取得するには以下のコマンドを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get deployments
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME     READY   UP-TO-DATE   AVAILABLE   AGE
cowweb   2/2     2            2           3m53s
</code></pre></div></div>

<p>先に作成したcowwebという名前のDeploymentがあることがわかります。DESISRED, CURRENTなどの値が2となっているのは、2つのPodを動かすように指定しており、その指定通りにPodが可動していることを表しています。</p>

<p>このDeploymentの情報をもっと詳しく調べるには、以下のコマンドを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe deployments/cowweb
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name:               cowweb
Namespace:          handson-030
CreationTimestamp:  Thu, 31 Jan 2019 17:34:44 +0000
Labels:             &lt;none&gt;
Annotations:        deployment.kubernetes.io/revision: 1
...（中略）...
NewReplicaSet:   cowweb-57885b669c (2/2 replicas created
Events:
  Type    Reason             Age   From                   Messag
  ----    ------             ----  ----                   ------
  Normal  ScalingReplicaSet  23m   deployment-controller  Scaled up replica set cowweb-57885b669c to 2
</code></pre></div></div>

<p>このDeploymentに関する様々な情報が表示されますが、特によく参照するのは、最後のEvents以下に表示される内容です。</p>

<p>これは、このPodにまつわって発生した過去のイベントが記録されているもので、Podが正常に起動しなかったときなど、特にトラブルシュートの場面で手がかりとなる情報を得るのに役立ちます。</p>

<h3 id="32-podの標準出力の表示">3.2. Podの標準出力の表示</h3>
<p>ここからは、Podオブジェクトについてみていきます。<br />
まず、Podの情報を標準出力を表示するなどして確認してみます。<br />
Kubernetes上で動作するアプリケーションの動作状況を確認する上で最もシンプルな方法は、Podの標準出力確認することです。Podの標準出力を表示するには、以下のコマンドを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs [Pod名]
</code></pre></div></div>

<p>ここで指定するPod名は、Podの一覧を表示して表示される2つのPodのうちのどちらかを指定してください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
cowweb-57885b669c-9dzg4   1/1     Running   0          43m
cowweb-57885b669c-r7l4g   1/1     Running   0          43m
</code></pre></div></div>

<p>この場合、例えば以下のようなコマンドとなります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs cowweb-57885b669c-9dzg4
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...（中略）...
2022.08.25 05:09:44 INFO com.oracle.jp.cowweb.CowsayResource Thread[helidon-server-1,5,server]: I'm working...

2022.08.25 05:09:44 INFO com.oracle.jp.cowweb.CowsayResource Thread[helidon-server-2,5,server]: I'm working...

2022.08.25 05:09:49 INFO com.oracle.jp.cowweb.CowsayResource Thread[helidon-server-3,5,server]: I'm working...

2022.08.25 05:09:49 INFO com.oracle.jp.cowweb.CowsayResource Thread[helidon-server-4,5,server]: I'm working...

2022.08.25 05:09:54 INFO com.oracle.jp.cowweb.CowsayResource Thread[helidon-server-1,5,server]: I'm working...
</code></pre></div></div>

<p>これが、Podの標準出力の内容を表示した結果です。Kubernetesはクラスター内で動作するコンテナに対して、定期的に死活確認を行っています。このサンプルアプリケーションでは、死活監視のリクエストが来たときに上記のようなログを出力するように実装してあります。</p>

<div class="notice--info">
  <p><strong>コンテナアプリケーションの死活監視について</strong><br />
コンテナの死活監視の機能はlivenessProbeと呼ばれます。<br />
死活確認の手段としては、以下の3通りの方法がサポートされています。</p>

<p>1) 特定のエンドポイントにHTTP GETリクエストを送信する<br />
2) 所定のコマンドを実行する<br />
3) TCP Socketのコネクションの生成を行う</p>

<p>また、Podの起動時にも、コンテナの起動状態をチェックするために同様の確認が行われます。<br />
サポートされるチェックの手段はlivenessProbeと同じですが、こちらはreadinessProbeと呼ばれます。</p>

</div>

<h4 id="321-podの環境変数の確認">3.2.1. Podの環境変数の確認</h4>
<p>Podに設定されている環境変数を確認するには、Pod内にアクセスして<code class="language-plaintext highlighter-rouge">env</code>コマンドを実行する必要があります。</p>

<p>まず、Pod内から任意のコマンドを実行するには<code class="language-plaintext highlighter-rouge">kubectl exec</code>コマンドを用います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec [Pod名] -- [実行したいコマンド]
</code></pre></div></div>

<p>[実行したいコマンド]に<code class="language-plaintext highlighter-rouge">env</code>を当てはめて実行すると、指定したPod内でそれが呼び出され、環境変数を出力することができます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec [Pod名] -- env
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">kubectl exec</code>を利用すると、Podのシェルに入ることも可能です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it [Pod名] -- /bin/sh
</code></pre></div></div>

<p class="notice--info"><strong><code class="language-plaintext highlighter-rouge">kubectl exec</code>コマンドについて</strong><br />
<code class="language-plaintext highlighter-rouge">kubectl exec</code>を利用すると、任意のコンテナをクラスター内に立ち上げて、そのコンテナのシェルを利用することができます。このテクニックはトラブルシューティングの場面で有用です。
例えば、クラスターで動作するアプリに期待通りにアクセス出来ないような状況において、クラスター内からcurlを実行して疎通確認を行うことで、問題の切り分けに役立てるといったことが可能です。</p>

<h2 id="4アプリケーションのスケーリング">4.アプリケーションのスケーリング</h2>
<p>ここでは、Deploymentに対してレプリカの数を指定することによって、Podのスケールアウト/インを試してみます。</p>

<h3 id="41-スケールアウト">4.1. スケールアウト</h3>
<p>Deploymentに対してレプリカの数を指定することによって、そのDeploymentが管理するPodの数を増減することができます。</p>

<p>レプリカの数を変更するには、<code class="language-plaintext highlighter-rouge">kubectl scale</code>コマンドを使用します。以下のように実行することで、cowwebのPodを管理するDeploymentに対して、レプリカ数を4にするよう指示します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale deployments/cowweb --replicas=4
</code></pre></div></div>

<p>Podの一覧を表示してみます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p>すると、4つのPodが構成されていることがわかります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
cowweb-57885b669c-4h5l4   0/1     Running   0          7s
cowweb-57885b669c-9dzg4   1/1     Running   0          1h
cowweb-57885b669c-hxvpz   0/1     Running   0          7s
cowweb-57885b669c-r7l4g   1/1     Running   0          1h
</code></pre></div></div>

<p>上の例では、一部のPodは起動中の状態です。少し時間が経過すると全てのPodのSTATUSがRunningになります。</p>

<h3 id="42-serviceによるルーティングの様子の確認">4.2. Serviceによるルーティングの様子の確認</h3>
<p>この時点で、クラスターには4つのcowwebのPodがデプロイされている状態です。この状態で、Podに対するアクセスが負荷分散される様子を確認してみましょう。</p>

<p>cowwebには、環境変数の変数名を指定することで、その値を答えてくれる仕掛けがしてあります。これを利用してPodのホスト名を応答させることで、負荷分散の動きを見てみます。</p>

<p>動作確認で実行したcurlコマンドのURLに<code class="language-plaintext highlighter-rouge">?say=HOSTNAME</code>というクエリを追加して、以下のようなコマンドを実行してみてください。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://[ロードバランサーのIP]/cowsay/say?say=HOSTNAME"
</code></pre></div></div>

<p>このコマンドを何度か繰り返すと、その度に異なるホスト名が返ってくることがわかります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> _________________________
&lt; cowweb-57885b669c-r7l4g &gt;
 -------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> _________________________
&lt; cowweb-57885b669c-hxvpz &gt;
 -------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre></div></div>

<h3 id="43-スケールイン">4.3. スケールイン</h3>
<p>Pod数を縮小することも当然ながら可能です。スケールアウトで行ったように、<code class="language-plaintext highlighter-rouge">kubectl scale</code>コマンドでレプリカ数を指定して減らすことが可能です。</p>

<p>他の方法として、Deploymentのmanifestファイルで現在より少ないreplica数を記述しておき、そのmanifestをクラスターに適用することで同様のことが可能になります。</p>

<p>最初にサンプルアプリケーションをデプロイしたときに利用したmanifestファイルには、レプリカ数に2を指定してありますので、これを適用することで4-&gt;2にスケールインしてみます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f ./kubernetes/cowweb.yaml
</code></pre></div></div>

<p>Podの一覧を表示すると、2個に減っていることがわかります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
cowweb-57885b669c-9dzg4   1/1     Running   0          1h
cowweb-57885b669c-r7l4g   1/1     Running   0          1h
</code></pre></div></div>

<p class="notice--info"><strong>スケールイン/アウトについて</strong><br />
現実の場面では、スケールアウト・インのような運用操作は、全てmanifestを編集してそれを適用するオペレーションとすることをおすすめします。manifestをソースコード管理システムで管理することによって、クラスターの構成変更をコードとして追跡可能になるためです。</p>

<h2 id="5podの自動復旧">5.Podの自動復旧</h2>
<p>Kubernetesには、障害が発生してPodがダウンしたときに、自動的に新たなPodを立ち上げ直す機能が備わっています。</p>

<p>Podを削除することによって障害に相当する状況を作り、自動復旧される様子を確認してみましょう。</p>

<p>Podを削除するには、以下のコマンドを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete [Pod名]
</code></pre></div></div>

<p>例えばこのようなコマンドとなります（実際のPod名は、<code class="language-plaintext highlighter-rouge">kubectl get pods</code>コマンドで確認してください）。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pod cowweb-57885b669c-9dzg4
</code></pre></div></div>

<p>この後すぐにPodの一覧を表示すると、削除したPodのPod名はなく、新しい名前のPodが起動していることがわかります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                      READY   STATUS    RESTARTS   AGE
cowweb-57885b669c-5mgrb   0/1     Running   0          7s    &lt;- 新たに起動したPod
cowweb-57885b669c-r7l4g   1/1     Running   0          1h
</code></pre></div></div>

<p>DeploymentオブジェクトによってPod数を2個に指定されています。Podが削除されて1つになると、Kubernnetesは指定された数との差分を検知して自動的にPodを立ち上げてくれます。</p>

<p>以上で本チュートリアルは終了です。</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time class="dt-published" datetime="2024-07-04T22:38:28+09:00">July 4, 2024</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Oracle+Container+Engine+for+Kubernetes%28OKE%29%E3%81%A7Kubernetes%E3%82%92%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-for-beginners%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fcloud-native%2Foke-for-beginners%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://oracle-japan.github.io/ocitutorials/cloud-native/oke-for-beginners/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/cloud-native/oke-for-commons/" class="pagination--pager" title="Oracle Container Engine for Kubernetes(OKE)をプロビジョニングしよう
">前へ</a>
    
    
      <a href="/ocitutorials/cloud-native/oke-for-intermediates/" class="pagination--pager" title="KubernetesでサンプルアプリケーションのデプロイとCI/CDを体験してみよう
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">関連記事</h2>
  <div class="grid__wrapper">
    
  </div>
</div>

  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://oracle-japan.github.io">Oracle Cloud Infrastructure チュートリアル</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  
    <script src="/ocitutorials/assets/js/tabs.js"></script>
  
    <script src="/ocitutorials/assets/js/sidebar.js"></script>
  


  </body>
</html>
