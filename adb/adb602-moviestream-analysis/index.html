<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>602: ADWでMovieStreamデータの分析をしよう | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="Autonomous Data Warehouseでは、ビジネスの成長にかかせないデータ分析を簡単・効率的に行うことができます。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="602: ADWでMovieStreamデータの分析をしよう">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/adb/adb602-moviestream-analysis/">


  <meta property="og:description" content="Autonomous Data Warehouseでは、ビジネスの成長にかかせないデータ分析を簡単・効率的に行うことができます。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/adb/adb602-moviestream-analysis/teaser.png">





  <meta property="article:published_time" content="2024-03-13T16:17:52+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/adb/adb602-moviestream-analysis/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://oracle-japan.github.io/ocitutorials/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ocitutorials/#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E4%B8%80%E8%A6%A7">チュートリアル一覧</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/about/">このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(34, 66, 55, 0.7), rgba(34, 66, 55, 0.7)), url('/ocitutorials/adb/adb602-moviestream-analysis/teaser.png');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          602: ADWでMovieStreamデータの分析をしよう

        
      </h1>
      
        <p class="page__lead">Autonomous Data Warehouseでは、ビジネスの成長にかかせないデータ分析を簡単・効率的に行うことができます。
</p>
      
      


      
      
    </div>
  
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://oracle-japan.github.io/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/adb" itemprop="item"><span itemprop="name">Adb</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">602: ADWでMovieStreamデータの分析をしよう</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">Oracle Database編 - Autonomous Database</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/adb/adb101-provisioning/">101: ADBインスタンスを作成してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb102-dataload/">102: ADBにデータをロードしよう(Database Actions)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb103-livelabs/">103: Oracle LiveLabsのご紹介</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb104-connect-using-wallet/">104: クレデンシャル・ウォレットを利用して接続してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb105-create-apex-app/">105: ADBの付属ツールで簡易アプリを作成しよう(APEX)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb106-json/">106: ADBでコンバージド・データベースを体験しよう（JSONデータの操作）</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb107-machine-learning/">107: ADBの付属ツールで機械学習(予測モデルからデプロイまで)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb108-walletless/">108: 接続文字列を利用して接続してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb109-private-endpoint/">109: プライベート・エンドポイントのADBを作成してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb110-analyze-using-oad/">110: Oracle Analytics Desktopを使ってデータを見える化してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb201-service-names/">201: 接続サービスの理解</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb202-dataload-dbms-cloud/">202: コマンドラインから大量データをロードしてみよう(DBMS_CLOUD)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb203-bulk-query/">203: 分析系クエリの実行(Star Schema Benchmark)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb204-setup-VM/">204: 開発者向け仮想マシンのセットアップ方法</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb205-swingbench/">205: オンライン・トランザクション系のアプリを実行してみよう(Swingbench)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb206-appdev-nodejs/">206: Node.jsによるADB上でのアプリ開発</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb207-appdev-python/">207: PythonによるADB上でのアプリ開発</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb208-oml-notebook/">208: Oracle Machine Learningで機械学習をしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb209-DV/">209 : Database Vaultによる職務分掌に基づいたアクセス制御の実装</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb210-VPD/">210 : 仮想プライベートデータベース(VPD:Virtual Private Database)による柔軟で細やかなアクセス制御の実装</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb211-clone/">211: クローン機能を活用しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb212-audg/">212: Autonomous Data Guardを構成してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb213-tac/">213 : Application Continuityを設定しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb214-spatial-studio/">214 : Spatial Studio で地理情報を扱おう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb215-graph/">215 : Graph Studioで金融取引の分析を行う</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb216-patch-spa/">216 : SQL Performance Analyzer(SPA)によるパッチ適用のテストソリューション</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb217-use-database-actions/">217: Database Actions を使ってみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb218-refreshable-clone/">218 : リフレッシュ可能クローンを活用しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb219-autoindexing/">219: Automatic Indexingを体験してみよう </a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb301-create-source-db/">301 : 移行元となるデータベースを作成しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb302-cpat/">302 : Cloud Premigration Advisor Tool(CPAT)を活用しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb303-datapump/">303 : Data Pumpを利用してデータを移行しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb304-database-migration-prep/">304 : OCI Database Migration Serviceを使用したデータベース移行の前準備</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb305-database-migration-offline/">305 : OCI Database Migration Serviceを使用したデータベースのオフライン移行</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb306-database-migration-online/">306 : OCI Database Migration Serviceを使用したデータベースのオンライン移行</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb401-oci-goldengate/">401 : OCI GoldenGateによるBaseDBからADBへのデータ連携</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb402-database-link/">402 : Database Linkによるデータ連携</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb403-data-transforms/">403 : Data Transformsを使ってみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb501-ocicli/">501: OCICLIを利用したインスタンス操作</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb502-report/">502: 各種設定の確認、レポートの取得</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb503-monitoring/">503 : ADBインスタンスの監視設定をしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb504-audit/">504 : 監査をしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb505-backup/">505 : Autonomous Databaseのバックアップとリストアを体感しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb506-sr/">506: サポートサービスへの問い合わせ(Service Requestの起票)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb601-moviestream-load/">601: ADWでMovieStreamデータのロード・更新をしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb602-moviestream-analysis/" class="active">602: ADWでMovieStreamデータの分析をしよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb603-data-catalog/">603 : データ・カタログを使ってメタデータを収集しよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/adb/adb701-adbd/">ADB-Dの環境を作成してみよう</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="602: ADWでMovieStreamデータの分析をしよう">
    <meta itemprop="description" content="Autonomous Data Warehouseでは、ビジネスの成長にかかせないデータ分析を簡単・効率的に行うことができます。">
    <meta itemprop="datePublished" content="2024-03-13T16:17:52+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#はじめに">はじめに</a></li><li><a href="#1-movie-salesデータの分析">1. Movie Salesデータの分析</a><ul><li><a href="#1-1-結果キャッシュによる実行時間の短縮">1-1. 結果キャッシュによる実行時間の短縮</a></li><li><a href="#1-2-顧客の視聴習慣の分析">1-2. 顧客の視聴習慣の分析</a></li><li><a href="#1-3-それぞれの曜日の割合の算出">1-3. それぞれの曜日の割合の算出</a></li><li><a href="#1-4-売上データのジャンルごとの集計">1-4. 売上データのジャンルごとの集計</a></li><li><a href="#1-5-売上データの四半期ごとの集計">1-5. 売上データの四半期ごとの集計</a></li><li><a href="#1-6-ピボット表の作成">1-6. ピボット表の作成</a></li></ul></li><li><a href="#2-半構造化データの処理">2. 半構造化データの処理</a></li><li><a href="#3-テキスト文字列の処理">3. テキスト文字列の処理</a></li><li><a href="#4-最も重要な顧客の発掘">4. 最も重要な顧客の発掘</a><ul><li><a href="#4-1-顧客の購入金額別分類">4-1. 顧客の購入金額別分類</a></li><li><a href="#4-2-顧客の頻度別分類">4-2. 顧客の頻度別分類</a></li><li><a href="#4-3-rfmクエリの作成">4-3. RFMクエリの作成</a></li></ul></li><li><a href="#5-パターンマッチング機能の利用">5. パターンマッチング機能の利用</a><ul><li><a href="#5-1-ファミリージャンルの映画を見る顧客の特定">5-1. ファミリージャンルの映画を見る顧客の特定</a></li><li><a href="#5-2-パターンに関する情報の取得">5-2. パターンに関する情報の取得</a></li><li><a href="#5-3-ファミリー関連のジャンルの調査">5-3. ファミリー関連のジャンルの調査</a></li><li><a href="#5-4-要件の変更">5-4. 要件の変更</a></li><li><a href="#5-5-結果の共有">5-5. 結果の共有</a></li></ul></li><li><a href="#6-機械学習モデルの適用">6. 機械学習モデルの適用</a><ul><li><a href="#6-1-データセットの用意">6-1. データセットの用意</a></li><li><a href="#6-2-モデルの構築">6-2. モデルの構築</a></li><li><a href="#6-3-出力の確認">6-3. 出力の確認</a></li><li><a href="#6-4-結果の分析">6-4. 結果の分析</a></li></ul></li><li><a href="#おわりに">おわりに</a></li><li><a href="#参考資料">参考資料</a></li></ul>

            </nav>
          </aside>
        
        <p><a id="anchor0"></a></p>

<h1 id="はじめに">はじめに</h1>

<p>データのロード、変換、管理、そして分析まで、全てを1つのデータベースで行うことができるのが、Autonomous Data Warehouseです。このチュートリアルを参考に、ぜひ一度”<strong>完全自律型データベース</strong>“を体験してみてください。</p>

<p>本記事では、MovieStreamデータを使い、データの分析方法を実際のビジネスシナリオに近い形でご紹介します。</p>

<p><br /></p>

<p><strong>想定シナリオ：</strong></p>

<p>Oracle MovieStreamは、架空の映画ストリーミングサービスです。
MovieStreamはビジネスを成長させるため、顧客の視聴傾向や適切な提供価格などのデータ分析を行いたいと考えています。</p>

<p><br /></p>

<p><strong>前提条件：</strong></p>
<ul>
  <li>
    <p>ADBインスタンスが構成済みであること
  <br />※ADBインタンスを作成方法については、<a href="/ocitutorials/adb/adb101-provisioning" target="_blank">101:ADBインスタンスを作成してみよう</a> を参照ください。</p>
  </li>
  <li>
    <p><a href="/ocitutorials/adb/adb601-moviestream-load" target="_blank">601: ADWでMovieStreamデータのロード・更新をしよう</a>のチュートリアルを完了していること</p>
  </li>
</ul>

<p><br /></p>

<p><strong>目次：</strong></p>

<ul>
  <li><a href="#anchor1">1. Movie Salesデータの分析</a></li>
  <li><a href="#anchor2">2. 半構造化データの処理</a></li>
  <li><a href="#anchor3">3. テキスト文字列の処理</a></li>
  <li><a href="#anchor4">4. 最も重要な顧客の発掘</a></li>
  <li><a href="#anchor5">5. パターンマッチング機能の利用</a></li>
  <li><a href="#anchor6">6. 機械学習モデルのご紹介</a></li>
  <li><a href="#おわりに">おわりに</a></li>
</ul>

<p><br /></p>

<p><strong>所要時間 :</strong> 約1.5時間</p>

<p><a id="anchor1"></a>
<br /></p>

<h1 id="1-movie-salesデータの分析">1. Movie Salesデータの分析</h1>
<h2 id="1-1-結果キャッシュによる実行時間の短縮">1-1. 結果キャッシュによる実行時間の短縮</h2>
<ol>
  <li>まずは、年と四半期ごとの映画の総売上高を調べるシンプルなクエリを実行してみましょう。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
 <span class="nb">year</span><span class="p">,</span>
 <span class="n">quarter_name</span><span class="p">,</span>
 <span class="k">SUM</span><span class="p">(</span><span class="n">quantity_sold</span> <span class="o">*</span> <span class="n">actual_price</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="nb">year</span><span class="p">,</span> <span class="n">quarter_name</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>結果は以下のように返されます。
<img src="result_cache.png" alt="result_cacheイメージ" /></p>
  </li>
  <li>
    <p>クエリの実行にかかった時間をメモします。上記の例では、実行に<strong>1.315秒</strong>かかりました。再度同じクエリを実行します。</p>
  </li>
  <li>今回のクエリでは、<strong>0.004秒</strong>しかかかりませんでした。では、何が起こったのでしょうか？
最初にクエリを実行したとき、ADWは、MOVIE_SALES_FACT表に対してクエリを実行し、すべての行をスキャンしました。クエリの結果をワークシートに返し、<strong>結果キャッシュ</strong>と呼ばれるものに結果を保存しました。同じクエリを再度実行すると、ADWは結果キャッシュから結果を取得します。すべての行を再度スキャンする必要はありません。これにより、時間が大幅に短縮され、リソースをほとんど使用しないで済みます。</li>
</ol>

<h2 id="1-2-顧客の視聴習慣の分析">1-2. 顧客の視聴習慣の分析</h2>
<ol>
  <li>MovieStreamの顧客の視聴習慣を調べるために、曜日ごとに何人の顧客が映画を購入しているか、また、何か特定のパターンがあるかどうかを調べてみましょう。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_id</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_name</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">no_viewers</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">)</span> <span class="k">AS</span> <span class="n">revenue</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">to_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">),</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>結果は以下のように返されます。
<img src="eachday_analysis.png" alt="eachday_analysisイメージ" />
これは、金曜日、土曜日、日曜日、月曜日の収益が最も高いことから、これらの曜日に映画を購入する顧客が多いことを示しています。週の真ん中の曜日の収益はこれらと比較すると、明らかに低くなっています。しかし、販売数を見ただけでは、明確なパターンを見出すことはできません。</li>
</ol>

<h2 id="1-3-それぞれの曜日の割合の算出">1-3. それぞれの曜日の割合の算出</h2>
<p>各曜日の売上全体に対する割合を計算することができれば、分析に役立ちます。そのためには、クエリの中で特殊な集計処理を行う必要があります。今回の例では、7日間の合計収益を計算し、各曜日の合計をその合計で割った値を算出します。</p>

<p>まず、各日の合計を定義します。 <strong>SUM(actual_price * quantity_sold)</strong></p>

<p>次に、SUM関数を拡張したウィンドウ関数を使用して、すべての曜日の収益合計を加算します。次のようにキーワード OVER を追加します。</p>

<p><strong>SUM(actual_price * quantity_sold) OVER ()</strong>で、すべての行の総計を計算します。</p>

<blockquote>
  <p>（参考）
ウィンドウ関数についてさらに詳しく知りたい場合は、<a href="https://docs.oracle.com/cd/E82638_01/dwhsg/sql-analysis-reporting-data-warehouses.html#GUID-20EFBF1E-F79D-4E4A-906C-6E496EECA684" target="_blank">こちら</a>をご参照ください。</p>
</blockquote>

<p>では、これらの2つの計算を組み合わせて、各曜日の割合を計算します。</p>

<p><strong>SUM(actual_price * quantity_sold) / SUM(actual_price * quantity_sold) OVER ()</strong></p>

<p>しかし、この計算はまだ少し複雑に思えます。</p>

<p>実は、この計算を行うことができるSQL関数があります。RATIO_TO_REPORTと呼ばれるもので、SQLは次のようになります。</p>

<p><strong>RATIO_TO_REPORT(SUM(actual_price * quantity_sold)) OVER()</strong></p>

<p>この方法は、はるかにシンプルに見えます。
以下のコードでは、結果を100倍してパーセント値を返しています。</p>

<ol>
  <li>それでは元のクエリを拡張した以下のクエリを実行してみます。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_id</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_name</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">no_viewers</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">)</span> <span class="k">AS</span> <span class="n">revenue</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">contribution</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">),</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>結果は以下のようになります。
<img src="eachday_analysis_contribution.png" alt="eachday_analysis_contributionイメージ" />
平日では月曜日が最も大きい割合を占めており、週全体では土曜日・日曜日が大きな割合を占めていることが、数字としてはっきりと分かるようになりました。</li>
</ol>

<h2 id="1-4-売上データのジャンルごとの集計">1-4. 売上データのジャンルごとの集計</h2>
<p>続いて顧客が毎日見ている映画のジャンルを考えてみましょう。SQLのCASE関数を使って、各曜日のジャンルごとの視聴人数の比率を調べます。</p>

<ol>
  <li>先ほどのクエリを応用して、割合計算の中にCASE関数を組み込みます。ここでは、クライム/ドキュメンタリー/ニュース/リアリティ番組で分けてみます。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_id</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_name</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">no_viewers</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">)</span> <span class="k">as</span> <span class="n">revenue</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">contribution</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="n">genre</span> <span class="k">WHEN</span> <span class="s1">'Crime'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">crime</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="n">genre</span> <span class="k">WHEN</span> <span class="s1">'Documentary'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">documentary</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="n">genre</span> <span class="k">WHEN</span> <span class="s1">'News'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">news</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span> <span class="n">genre</span> <span class="k">WHEN</span> <span class="s1">'Reality-TV'</span> <span class="k">THEN</span> <span class="mi">1</span> <span class="k">ELSE</span> <span class="mi">0</span> <span class="k">END</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">realitytv</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">),</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>結果は以下のようになります。
<img src="genre_result.png" alt="genre_resultイメージ" />
これを見ると、リアリティTV関連の映画は、他の曜日に比べて日曜日に人気があることがわかります。ニュースは月曜日に人気があり、土曜日はクライム映画を楽しむ人が多いことがわかります。
このように、顧客の一週間の視聴傾向について、興味深い情報が得られます。</li>
</ol>

<h2 id="1-5-売上データの四半期ごとの集計">1-5. 売上データの四半期ごとの集計</h2>
<p>続いて上記の曜日ごとの分析をさらに掘り下げ、四半期ごとではこの曜日ごとの割合がどのように変化するのか調べてみます。</p>

<ol>
  <li>以下のクエリを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">quarter_name</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_id</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_name</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">no_viewers</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">)</span> <span class="k">AS</span> <span class="n">revenue</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">))</span> <span class="n">OVER</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">contribution</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">,</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">),</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">,</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>結果は以下のようになります。
<img src="quarter_result.png" alt="quarter_resultイメージ" /></p>
  </li>
  <li>contribution列を見てみると、値が非常に小さくなっています。これは、各曜日の売上割合を四半期全体の収益の総計に対して算出しているからです。実際に行う必要があるのは、各四半期内の割合を計算することなので、ウィンドウ関数にPARTITION BY句を追加し算出します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">quarter_name</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_id</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_name</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">no_viewers</span><span class="p">,</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">)</span> <span class="k">as</span> <span class="n">revenue</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">))</span> <span class="n">OVER</span><span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">contribution</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">,</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">),</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">,</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>結果は以下のようになり、各四半期内の割合が正しく算出されていることがわかります。
<img src="quarter_result2.png" alt="quarter_result2イメージ" /></li>
</ol>

<h2 id="1-6-ピボット表の作成">1-6. ピボット表の作成</h2>
<p>四半期ごとの割合を表示することができましたが、行ごとに表示されているためやや見にくく感じます。そこで、PIVOT関数を使って四半期ごとの列を表示させるようにします。</p>

<ol>
  <li>先ほどのクエリにPIVOT関数を追加すると、各四半期の行を列に入れ替えることができます。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span>
<span class="p">(</span><span class="k">SELECT</span>
<span class="n">quarter_name</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_id</span><span class="p">,</span>
<span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span> <span class="k">AS</span> <span class="n">day_name</span><span class="p">,</span>
<span class="n">ROUND</span><span class="p">(</span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">actual_price</span> <span class="o">*</span> <span class="n">quantity_sold</span><span class="p">))</span> <span class="n">OVER</span><span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">contribution</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">YEAR</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">,</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">),</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'Day'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">quarter_name</span><span class="p">,</span> <span class="n">TO_CHAR</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">))</span>
<span class="n">PIVOT</span>
<span class="p">(</span>
<span class="k">SUM</span><span class="p">(</span><span class="n">CONTRIBUTION</span><span class="p">)</span> <span class="n">contribution</span>
<span class="k">FOR</span> <span class="n">QUARTER_NAME</span> <span class="k">IN</span><span class="p">(</span><span class="s1">'Q1-2020'</span> <span class="k">as</span> <span class="nv">"Q1"</span><span class="p">,</span> <span class="s1">'Q2-2020'</span> <span class="k">as</span> <span class="nv">"Q2"</span><span class="p">,</span> <span class="s1">'Q3-2020'</span> <span class="k">as</span> <span class="nv">"Q3"</span><span class="p">,</span> <span class="s1">'Q4-2020'</span> <span class="k">as</span> <span class="nv">"Q4"</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>これにより、2つの時間軸でデータを視覚的に分析することが簡単になりました。
<img src="pivot_result.png" alt="pivot_resultイメージ" /></li>
</ol>

<p>これらの結果から、月曜日の割合が時間の経過とともに減少し、金曜日、土曜日、日曜日の割合が増加していることが容易にわかります。ストリーミングサービスとしては、この3日間はネットワークやサーバーに重要な影響を受ける可能性があるため、この傾向がどのように変化するかを注意深く観察する必要があります。</p>

<p><br />
<a id="anchor2"></a></p>

<h1 id="2-半構造化データの処理">2. 半構造化データの処理</h1>
<p>これまでは、あらかじめ定義されている構造化データを扱ってきました。しかし実際には、半構造化されたデータや、非構造化データを扱わなければいけないことがほとんどです。</p>

<p><a href="https://oracle.github.io/learning-library/data-management-library/autonomous-database/shared/adb-analytics-using-sql/freetier/?lab=working-with-semi-structured-data" target="_blank">こちら</a>では、半構造化データであるJSONデータの処理についてご紹介しています。</p>

<p><br />
<a id="anchor3"></a></p>

<h1 id="3-テキスト文字列の処理">3. テキスト文字列の処理</h1>
<p>ここでは、ADWにテキスト文字列データをカンマ区切りのフォーマットに変換してロードする、という作業を行います。シナリオとしては、顧客の電子メールアドレスを教育レベル別に分類するレポートを作成します。</p>

<p><a href="https://oracle.github.io/learning-library/data-management-library/autonomous-database/shared/adb-analytics-using-sql/freetier/?lab=managing-text-lists" target="_blank">こちら</a>では、このタスクを簡単に行うことのできる集計関数LISTAGGの使用方法についてご紹介しています。</p>

<p><br />
<a id="anchor4"></a></p>

<h1 id="4-最も重要な顧客の発掘">4. 最も重要な顧客の発掘</h1>
<p>ここでは、売上データを分析するためのRFM（Recency Frequency Monetary）クエリを作成します。この一般的に使用されている顧客指標では、以前のクエリで使用したSQL分析関数のいくつかを組み合わせ、WITH句を使用してより複雑なクエリを作成します。</p>

<blockquote>
  <p>（補足）
RFMの詳細については、Wikipediaのこの<a href="https://en.wikipedia.org/wiki/RFM_(market_research)" target="_blank">ページ</a>を参照してください。</p>
</blockquote>

<p>RFM分析を利用して、顧客の行動に関する理解を深めます。RFMは、顧客価値の分析に非常によく使われる手法です。一般的な顧客マーケティング、ダイレクトマーケティング、小売業などでよく使われています。</p>

<p>今回は、以下の情報を得るためのSQLクエリを作成します。</p>
<ul>
  <li>Recency：顧客が最後にサービスにアクセスした時間</li>
  <li>Frequency：その顧客の活動レベル</li>
  <li>Monetary：顧客が使用した金額</li>
</ul>

<p>顧客は、NTILE関数を使用して重要度の高い5つのカテゴリーに分類されます。例えば、RFMの複合スコアが551の場合、その顧客は、最近の訪問回数（R=5）とサイト上での活動回数（F=5）では最高レベルの顧客ですが、消費額（M=1）では最低レベルの顧客であることを示しています。この顧客は、サイトでリサーチをした後、他の手段で映画を購入する可能性が高いということです。</p>

<h2 id="4-1-顧客の購入金額別分類">4-1. 顧客の購入金額別分類</h2>
<ol>
  <li>次のクエリを実行し、顧客を購入金額に基づいて5つに分類します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">customer_name</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">income_band</span><span class="p">,</span>
<span class="n">NTILE</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">sum</span><span class="p">(</span><span class="n">actual_price</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rfm_monetary</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">customer_name</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">income_band</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>3~4秒で実行され、以下のような結果が返されます。
<img src="bin_result1.png" alt="bin_result1イメージ" />
RFM_MONETARY列は、カテゴリーの番号を示しています。この列の値が1であれば、その顧客が低支出の顧客であることを示し、5であれば高支出の顧客であることを示します。SQLドキュメントでNTILE関数の使用に関する詳細を見るには、<a href="https://docs.oracle.com/cd/F19136_01/sqlrf/NTILE.html" target="_blank">こちら</a>をクリックしてください。</li>
</ol>

<h2 id="4-2-顧客の頻度別分類">4-2. 顧客の頻度別分類</h2>
<ol>
  <li>顧客がどのくらいの頻度で映画を視聴しているかを調べます。各顧客が視聴した映画の数を計算し、その計算結果を5つに分けます。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">customer_id</span><span class="p">,</span>
<span class="n">NTILE</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">max</span><span class="p">(</span><span class="k">day</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rfm_recency</span><span class="p">,</span>
<span class="n">NTILE</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rfm_frequency</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>これは1~2秒で実行され、以下のような結果が返されます。
<img src="bin_result2.png" alt="bin_result2イメージ" />
これで、最後に映画を見た時期に基づいて、映画をほとんど見ない顧客（rfm_frequencyが1）と、映画を最も多く見る顧客（rfm_frequencyが5）を識別することができます。</li>
</ol>

<h2 id="4-3-rfmクエリの作成">4-3. RFMクエリの作成</h2>
<ol>
  <li>WITH句を使ってこれら2つのクエリを組み合わせ、RFMクエリを作成します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">customer_sales2</span> <span class="k">AS</span> <span class="p">(</span>
<span class="c1">-- Sales and customer attributes</span>
<span class="k">SELECT</span> <span class="n">m</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">customer_name</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">income_band</span><span class="p">,</span>
<span class="n">NTILE</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">sum</span><span class="p">(</span><span class="n">actual_price</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rfm_monetary</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span> <span class="n">m</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">m</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">customer_name</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">income_band</span><span class="p">),</span>
<span class="n">click_data2</span> <span class="k">AS</span> <span class="p">(</span>
<span class="c1">-- clicks from application log</span>
<span class="k">SELECT</span> <span class="n">customer_id</span><span class="p">,</span>
<span class="n">NTILE</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">max</span><span class="p">(</span><span class="k">day</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rfm_recency</span><span class="p">,</span>
<span class="n">NTILE</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">AS</span> <span class="n">rfm_frequency</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">customer_id</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="p">,</span> <span class="n">cd</span><span class="p">.</span><span class="n">rfm_recency</span><span class="p">,</span> <span class="n">cd</span><span class="p">.</span><span class="n">rfm_frequency</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">rfm_monetary</span><span class="p">,</span>
<span class="n">cd</span><span class="p">.</span><span class="n">rfm_recency</span><span class="o">*</span><span class="mi">100</span> <span class="o">+</span> <span class="n">cd</span><span class="p">.</span><span class="n">rfm_frequency</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="k">c</span><span class="p">.</span><span class="n">rfm_monetary</span> <span class="k">AS</span> <span class="n">rfm_combined</span><span class="p">,</span>
<span class="k">c</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">income_band</span>
<span class="k">FROM</span> <span class="n">customer_sales2</span> <span class="k">c</span><span class="p">,</span> <span class="n">click_data2</span> <span class="n">cd</span>
<span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">cd</span><span class="p">.</span><span class="n">customer_id</span>
<span class="k">AND</span> <span class="k">c</span><span class="p">.</span><span class="n">rfm_monetary</span> <span class="o">&gt;=</span> <span class="mi">4</span>
<span class="k">AND</span> <span class="n">cd</span><span class="p">.</span><span class="n">rfm_recency</span> <span class="o">&lt;=</span> <span class="mi">2</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">rfm_monetary</span> <span class="k">desc</span><span class="p">,</span> <span class="n">cd</span><span class="p">.</span><span class="n">rfm_recency</span> <span class="k">desc</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下の結果は、かなりの金額を使っている（&gt;= 4）が、最近サイトを訪れていない（&lt;= 2）顧客のみを表示します。
<img src="bin_result3.png" alt="bin_result3イメージ" /></li>
</ol>

<p><br />
<a id="anchor5"></a></p>

<h1 id="5-パターンマッチング機能の利用">5. パターンマッチング機能の利用</h1>
<p>パターンとはビジネスのあらゆる場面で発生するものです。データセット内の個々のパターンやグループのパターンを見つけ、分析し、定量化する能力は、今やビジネスにおける重要な要件になっています。これにより、顧客の行動や関連する業務活動をより深く理解することができ、新たな収益源となる機会を模索することができるからです。</p>

<p>ADWは、ネイティブなパターンマッチング機能を備えています。データセット内のパターンを特定するプロセスを、シンプルかつ効率的に行うことができます。ADWは従来のパターンマッチング機能と比較して、パフォーマンス、保守性、スケーラビリティの面で大きなメリットがあります。</p>

<p>今回は以下の項目について、ADWで分析します。</p>
<ul>
  <li>2020年の四半期中にファミリージャンルの映画を1本以上見たことがあるお客様を検索する。</li>
  <li>2020年の四半期中に、少なくともいくつかの家族向けジャンルの映画を追加で見たことがある顧客で、顧客をフィルタリングする。</li>
  <li>マーケティングチームのために、2020年の各四半期に各顧客がそれぞれの種類の映画を何本見たかを示すレポートを作成する。</li>
</ul>

<p>とても複雑に見えますが、SQLのパターンマッチングを使えば、これらの分析はとても簡単に行えます。</p>

<h2 id="5-1-ファミリージャンルの映画を見る顧客の特定">5-1. ファミリージャンルの映画を見る顧客の特定</h2>
<p>SQLのパターン・マッチング関数MATCH_RECOGNIZEを使用して、四半期中にファミリージャンルの映画を1本以上視聴した顧客を見つけることができます。</p>
<ol>
  <li>まず最初に、MOVIE_SALES_FACT表にビューを作成し、2020年の顧客データのみを表示するように結果をフィルタリングします。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">movie_sales_fact_2020</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">movie_sales_fact</span>
<span class="k">WHERE</span> <span class="nb">year</span> <span class="o">=</span> <span class="mi">2020</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下の通り、四半期中に少なくとも2つのファミリージャンルの映画を見た顧客の数をカウントします。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact_2020</span>
<span class="n">MATCH_RECOGNIZE</span>
<span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">day</span><span class="p">,</span> <span class="n">genre</span>
<span class="n">ONE</span> <span class="k">ROW</span> <span class="n">PER</span> <span class="k">MATCH</span>
<span class="n">PATTERN</span> <span class="p">(</span><span class="n">family</span><span class="o">+</span> <span class="n">quarter</span><span class="p">)</span>
<span class="n">DEFINE</span>
<span class="n">family</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Family'</span><span class="p">,</span>
<span class="n">quarter</span> <span class="k">AS</span> <span class="k">first</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span> <span class="o">=</span> <span class="k">last</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>結果は以下のようになります。
<img src="pattern1.png" alt="pattern1イメージ" /></li>
</ol>

<h2 id="5-2-パターンに関する情報の取得">5-2. パターンに関する情報の取得</h2>
<p>パターンマッチング処理では、発見したパターンに関する情報が返されます。必要な情報の定義は、MEASURESの中で行います。今回は各顧客が視聴したファミリー映画の数であるmovie_idを知りたいのですが、パターンマッチングプロセスが機能しているかどうかを確認するために、最初にマッチした行の四半期名とパターンの四半期名を返します。</p>
<ol>
  <li>まずは以下のクエリを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">customer_id</span><span class="p">,</span> <span class="n">genre</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">family_movies</span><span class="p">,</span> <span class="n">match_number</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">first_quarter</span><span class="p">,</span> <span class="n">last_quarter</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact_2020</span>
<span class="n">MATCH_RECOGNIZE</span>
<span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">day</span><span class="p">,</span> <span class="n">genre</span>
<span class="n">MEASURES</span>
<span class="n">match_number</span><span class="p">()</span> <span class="k">as</span> <span class="n">match_number</span><span class="p">,</span>
<span class="n">classifier</span><span class="p">()</span> <span class="k">as</span> <span class="n">classifier</span><span class="p">,</span>
<span class="k">first</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_quarter</span><span class="p">,</span>
<span class="k">last</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">last_quarter</span><span class="p">,</span>
<span class="n">family</span><span class="p">.</span><span class="n">movie_id</span> <span class="k">AS</span> <span class="n">movie</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">family_movies</span>
<span class="k">ALL</span> <span class="k">ROWS</span> <span class="n">PER</span> <span class="k">MATCH</span>
<span class="n">PATTERN</span> <span class="p">(</span><span class="n">family</span><span class="o">+</span> <span class="n">quarter</span><span class="p">)</span>
<span class="n">DEFINE</span>
<span class="n">family</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Family'</span><span class="p">,</span>
<span class="n">quarter</span> <span class="k">AS</span> <span class="k">first</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span> <span class="o">=</span> <span class="k">last</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span>
<span class="p">)</span> <span class="n">mr</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">mr</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">match_number</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下のようにファミリー映画を見ている顧客の出現回数ごとに行が表示され、映画も表示されています。
<img src="pattern2.png" alt="pattern2イメージ" /></li>
</ol>

<h2 id="5-3-ファミリー関連のジャンルの調査">5-3. ファミリー関連のジャンルの調査</h2>
<p>パターンの定義を拡張するだけで、パターンの検索条件をファミリー関連の他のジャンルにも広げることができます。</p>
<ol>
  <li>上記を以下のようにパターンマッチングクエリに追加します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact_2020</span>
<span class="n">MATCH_RECOGNIZE</span>
<span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">day</span><span class="p">,</span> <span class="n">genre</span>
<span class="n">MEASURES</span>
<span class="n">match_number</span><span class="p">()</span> <span class="k">as</span> <span class="n">match_number</span><span class="p">,</span>
<span class="n">classifier</span><span class="p">()</span> <span class="k">as</span> <span class="n">classifier</span><span class="p">,</span>
<span class="k">first</span><span class="p">(</span><span class="n">comedy</span><span class="p">.</span><span class="n">quarter_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_quarter</span><span class="p">,</span>
<span class="k">last</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">last_quarter</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_movies</span>
<span class="k">ALL</span> <span class="k">ROWS</span> <span class="n">PER</span> <span class="k">MATCH</span>
<span class="n">PATTERN</span> <span class="p">(</span><span class="n">comedy</span><span class="o">+</span> <span class="n">crime</span> <span class="n">drama</span> <span class="n">family</span><span class="o">+</span> <span class="n">quarter</span><span class="p">)</span>
<span class="n">DEFINE</span>
<span class="n">comedy</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Comedy'</span><span class="p">,</span>
<span class="n">crime</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Crime'</span><span class="p">,</span>
<span class="n">drama</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Drama'</span><span class="p">,</span>
<span class="n">family</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Family'</span><span class="p">,</span>
<span class="n">quarter</span> <span class="k">AS</span> <span class="k">first</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span> <span class="o">=</span> <span class="k">last</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span>
<span class="p">)</span> <span class="n">mr</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">mr</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">match_number</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下のような結果が返されます。
<img src="pattern6.png" alt="pattern6イメージ" /></li>
</ol>

<h2 id="5-4-要件の変更">5-4. 要件の変更</h2>
<p>先ほどのパターン文を微調整して、次はファミリー映画やSF映画が好きな顧客をピックアップしてみます。</p>
<ol>
  <li>次のクエリを実行して、この新しいパターンに一致する顧客の数を確認します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact_2020</span>
<span class="n">MATCH_RECOGNIZE</span>
<span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">day</span><span class="p">,</span> <span class="n">genre</span>
<span class="n">ONE</span> <span class="k">ROW</span> <span class="n">PER</span> <span class="k">MATCH</span>
<span class="n">PATTERN</span> <span class="p">(</span><span class="n">comedy</span><span class="o">+</span> <span class="n">crime</span> <span class="n">drama</span> <span class="n">family</span><span class="o">+</span> <span class="n">horror</span> <span class="n">scifi</span><span class="o">+</span> <span class="n">quarter</span><span class="p">)</span>
<span class="n">DEFINE</span>
<span class="n">comedy</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Comedy'</span><span class="p">,</span>
<span class="n">crime</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Crime'</span><span class="p">,</span>
<span class="n">drama</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Drama'</span><span class="p">,</span>
<span class="n">family</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Family'</span><span class="p">,</span>
<span class="n">horror</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Horror'</span><span class="p">,</span>
<span class="n">scifi</span> <span class="k">AS</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Sci-Fi'</span><span class="p">,</span>
<span class="n">quarter</span> <span class="k">AS</span> <span class="k">last</span><span class="p">(</span><span class="n">scifi</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span> <span class="o">=</span> <span class="k">FIRST</span><span class="p">(</span><span class="n">comedy</span><span class="p">.</span><span class="n">quarter_num_of_year</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>以下のように278という値が返されます。
<img src="pattern3.png" alt="pattern3イメージ" /></p>
  </li>
  <li>続いてこの結果をより具体的に示すために、列を追加したクエリを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">customer_id</span><span class="p">,</span>
<span class="n">comedy_movies</span><span class="p">,</span>
<span class="n">crime_movies</span><span class="p">,</span>
<span class="n">drama_movies</span><span class="p">,</span>
<span class="n">family_movies</span><span class="p">,</span>
<span class="n">horror_movies</span><span class="p">,</span>
<span class="n">sf_movies</span><span class="p">,</span>
<span class="n">first_quarter</span><span class="p">,</span>
<span class="n">last_quarter</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact_2020</span>
<span class="n">MATCH_RECOGNIZE</span>
<span class="p">(</span><span class="k">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">day</span><span class="p">,</span> <span class="n">genre</span>
<span class="n">MEASURES</span>
<span class="k">first</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">quarter_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">first_quarter</span><span class="p">,</span>
<span class="k">last</span><span class="p">(</span><span class="n">scifi</span><span class="p">.</span><span class="n">quarter_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">last_quarter</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">comedy</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">comedy_movies</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">crime</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">crime_movies</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">drama</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">drama_movies</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">family</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">family_movies</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">horror</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">horror_movies</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">scifi</span><span class="p">.</span><span class="n">movie_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sf_movies</span>
<span class="n">ONE</span> <span class="k">ROW</span> <span class="n">PER</span> <span class="k">MATCH</span>
<span class="n">PATTERN</span> <span class="p">(</span><span class="n">comedy</span><span class="o">+</span> <span class="n">crime</span> <span class="n">drama</span> <span class="n">family</span><span class="o">+</span> <span class="n">horror</span> <span class="n">scifi</span><span class="o">+</span> <span class="n">quarter</span><span class="p">)</span>
<span class="n">DEFINE</span>
<span class="n">comedy</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Comedy'</span><span class="p">,</span>
<span class="n">crime</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Crime'</span><span class="p">,</span>
<span class="n">drama</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Drama'</span><span class="p">,</span>
<span class="n">family</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Family'</span><span class="p">,</span>
<span class="n">horror</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Horror'</span><span class="p">,</span>
<span class="n">scifi</span> <span class="k">as</span> <span class="n">genre</span> <span class="o">=</span> <span class="s1">'Sci-Fi'</span><span class="p">,</span>
<span class="n">quarter</span> <span class="k">as</span> <span class="n">scifi</span><span class="p">.</span><span class="n">quarter_num_of_year</span> <span class="o">=</span> <span class="n">comedy</span><span class="p">.</span><span class="n">quarter_num_of_year</span>
<span class="p">)</span> <span class="n">mr</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">mr</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">first_quarter</span><span class="p">,</span> <span class="n">family_movies</span><span class="p">,</span> <span class="n">sf_movies</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>結果は以下のようになります。
<img src="pattern4.png" alt="pattern4イメージ" /></li>
</ol>

<h2 id="5-5-結果の共有">5-5. 結果の共有</h2>
<ol>
  <li>この結果をマーケティングチームに共有するため、Query Resultパネルのダウンロード機能を使いファイルにすることができます。
<img src="pattern5.png" alt="pattern5イメージ" /></li>
</ol>

<p><br />
<a id="anchor6"></a></p>

<h1 id="6-機械学習モデルの適用">6. 機械学習モデルの適用</h1>
<p>Autonomous Data Warehouseには、機械学習アルゴリズムが組み込まれています。ここでは、ビジネス上の問題を解決するための機械学習モデルの使用について簡単にご紹介します。ADWでの機械学習については、<a href="/ocitutorials/adb/adb107-machine-learning/" target="_blank">こちら</a>もご参照ください。</p>

<p>本記事では、自分のアカウントに対して「残高不足」になる可能性の高い顧客を人口統計学的に特定します。これが特定できれば、顧客がアカウントをよりよく管理できるようになります。</p>

<p>この分析を行うために、DBMS_PREDICTIVE_ANALYTICSというパッケージを使用します。このパッケージには、予測分析として知られる機械学習の自動化された処理が含まれています。すべての機械学習アクティビティは、プロシージャによって内部的に処理されるため、モデル構築やモデルのスコアリングといった典型的な機械学習のステップをユーザーが意識する必要はありません。そのため、ADWでは誰もが簡単に機械学習を用いたデータ分析を行うことができます。</p>

<h2 id="6-1-データセットの用意">6-1. データセットの用意</h2>
<ol>
  <li>まずは顧客の属性をまとめたビューを作成します。ここでは、時間列、トランザクション列、映画列を除きます。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">vw_cust_funds</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="k">DISTINCT</span>
<span class="n">customer_id</span><span class="p">,</span> <span class="n">segment_name</span><span class="p">,</span> <span class="n">credit_balance</span><span class="p">,</span> <span class="n">education</span><span class="p">,</span> <span class="n">full_time</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">household_size</span><span class="p">,</span> <span class="n">insuff_funds_incidents</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">late_mort_rent_pmts</span><span class="p">,</span> <span class="n">marital_status</span><span class="p">,</span> <span class="n">mortgage_amt</span><span class="p">,</span> <span class="n">num_cars</span><span class="p">,</span> <span class="n">num_mortgages</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">rent_own</span><span class="p">,</span> <span class="n">years_current_employer_band</span><span class="p">,</span> <span class="n">years_customer</span><span class="p">,</span> <span class="n">years_residence_band</span><span class="p">,</span> <span class="n">commute_distance</span><span class="p">,</span> <span class="n">commute_distance_band</span>
<span class="k">FROM</span> <span class="n">movie_sales_fact</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>ビューが作成されたら、次のクエリを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">vw_cust_funds</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>以下のように4,845人の顧客がいることがわかります。
<img src="ml1.png" alt="ml1イメージ" /></p>
  </li>
  <li>ビュー全体を見るため以下のクエリを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">vw_cust_funds</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下のような結果が返されます。なおinsufficient_funds_incidents列には、顧客が残高不足の状態であるかどうかを示すフラグが立てられています。
<img src="ml2.png" alt="ml2イメージ" /></li>
</ol>

<h2 id="6-2-モデルの構築">6-2. モデルの構築</h2>
<p>ここでは、顧客のどの属性が残高不足が発生するか予測するのに役立つか調べるため、EXPLAINプロシージャを使用します。EXPLAINプロシージャは、ターゲット列の値を予測する上での各属性の相対的な重要性を識別します。この分析を行うため、今回は以下のパラメータを使用します。</p>
<ul>
  <li><strong>data_table_name:</strong> vm_cust_fundsビュー</li>
  <li><strong>explain_column_name:</strong> insufficient_funds_incidents列</li>
  <li><strong>result_table_name:</strong> customer_explain_result表（これはプロシージャによって自動作成されるため、存在しない表の名前を入力します。）</li>
</ul>

<ol>
  <li>以下でモデルを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">EXEC</span> <span class="n">DBMS_PREDICTIVE_ANALYTICS</span><span class="p">.</span><span class="k">EXPLAIN</span><span class="p">(</span><span class="s1">'vw_cust_funds'</span><span class="p">,</span> <span class="s1">'insuff_funds_incidents'</span><span class="p">,</span> <span class="s1">'customer_explain_result'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>20秒ほどで以下のようにログが出力されます。
<img src="ml3.png" alt="ml3イメージ" /></li>
</ol>

<h2 id="6-3-出力の確認">6-3. 出力の確認</h2>
<ol>
  <li>以下のクエリでモデルの結果を確認します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customer_explain_result</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下のような結果が返されます。
<img src="ml4.png" alt="ml4イメージ" /></li>
</ol>

<ul>
  <li>
    <p>Explanatory Value列：この列には、残高不足が発生する確率を決定するために、その列がどの程度有効であるかを示す値が含まれています。値の範囲は0～1で、大きいほど有効になります。値が0の場合、各列の値とターゲット列（insufficient_funds_incidents列）の値の間に有効な相関がないことを意味します。値が1の場合は、完全な相関があることを意味し、そのような列は予測対象から除外すべきです。</p>
  </li>
  <li>
    <p>Rank列：上記Explanatory Value列の値のランキングを表示しています。値が等しい行は、同じランクになります。</p>
  </li>
</ul>

<h2 id="6-4-結果の分析">6-4. 結果の分析</h2>
<ol>
  <li>先ほどの出力を少し分かりやすくするため、以下のクエリを実行します。
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">attribute_name</span><span class="p">,</span>
<span class="n">round</span><span class="p">(</span><span class="n">explanatory_value</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="n">explanatory_value</span><span class="p">,</span>
<span class="n">round</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">explanatory_value</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="k">order</span> <span class="k">BY</span> <span class="n">rank</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="n">running_total</span><span class="p">,</span>
<span class="n">rank</span>
<span class="k">FROM</span> <span class="n">customer_explain_result</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">RANK</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>以下のようになります。
<img src="ml5.png" alt="ml5イメージ" /></li>
</ol>

<p>この結果から残高不足が発生する顧客を特定するには、住宅ローンの滞納の発生状況、セグメント名、住宅ローンの金額を調べる必要があることがわかります。また、上位4つの属性を使用することで、残高不足の可能性を予測する能力が平均以上（53%）に達することもわかります。</p>

<p>逆に、job_type、marital_status、educationなどの人口統計学的属性は、残高不足になる可能性に影響しない、とうことがわかります。</p>

<p><br /></p>

<h1 id="おわりに">おわりに</h1>
<p>本記事では、<a href="/ocitutorials/adb/adb601-moviestream-load" target="_blank">601: ADWでMovieStreamデータのロード・更新をしよう</a>に続く内容として、MOVIE_SALESデータの分析の手法をいくつかご紹介しました。今回ご紹介した方法以外にも、Autonomous Data Warehouseにはデータ分析に有用な機能が多数備わっています。データのロード、変換、管理、そして分析まで、全てを1つのデータベースで行うことができるのはAutonomous Data Warehouseならでは、と言えます。このチュートリアルを参考に、ぜひ一度”<strong>完全自律型データベース</strong>“を体験してみてください。</p>

<p><br /></p>

<h1 id="参考資料">参考資料</h1>
<ul>
  <li>LiveLabs <a href="https://apexapps.oracle.com/pls/apex/r/dbpm/livelabs/view-workshop?wid=852" target="_blank">Analyze MovieStream data in Oracle Autonomous Database using SQL Workshop</a></li>
  <li>Oracle Big Data Blog <a href="https://blogs.oracle.com/bigdata/post/structured-vs-unstructured-data" target="_blank">Structured vs. Unstructured Data</a></li>
</ul>

<p>以上で、この章は終了です。<br />
次の章にお進みください。</p>

<p><br />
<a href="#anchor0">ページトップへ戻る</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time datetime="2024-03-13T16:17:52+09:00">March 13, 2024</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=602%3A+ADW%E3%81%A7MovieStream%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%88%86%E6%9E%90%E3%82%92%E3%81%97%E3%82%88%E3%81%86%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fadb%2Fadb602-moviestream-analysis%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fadb%2Fadb602-moviestream-analysis%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fadb%2Fadb602-moviestream-analysis%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/adb/adb601-moviestream-load/" class="pagination--pager" title="601: ADWでMovieStreamデータのロード・更新をしよう
">前へ</a>
    
    
      <a href="/ocitutorials/adb/adb603-data-catalog/" class="pagination--pager" title="603 : データ・カタログを使ってメタデータを収集しよう
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">関連記事</h4>
      <div class="grid__wrapper">
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Oracle Cloud Infrastructure チュートリアル. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  
    <script src="/ocitutorials/assets/js/tabs.js"></script>
  
    <script src="/ocitutorials/assets/js/sidebar.js"></script>
  



  </body>
</html>
