---
title: "203: 分析系クエリの実行(Star Schema Benchmark)"
excerpt: "ADBインスタンスにデフォルトで入っているDWH系・分析系のサンプルスキーマ(SHやSSB)に対して、重いSQLを実行し、OCPU数別にその処理時間の違いを体感して頂きます。"
order: "3_203"
layout: single
header:
  teaser: "/adb/adb203-bulk-query/img0.png"
  overlay_image: "/adb/adb203-bulk-query/img0.png"
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://community.oracle.com/tech/welcome/discussion/4474261/
---

<a id="anchor0"></a>

# はじめに

この章ではAutonomous Databaseにおける分析系クエリの性能を確認します。

特に、インスタンスのOCPU数を増やした前後でのパフォーマンスを比較することで、簡単に性能が向上することをみていきます。

また、SQLの実行状況を確認するために、サービス・コンソールを操作いただきます。

**目次**

- [1. SSBスキーマを確認しよう](#anchor1)
    - [データ・モデラーによる構成確認](#anchor1-1)
    - [各表の件数確認](#anchor1-2)
- [2. OCPU数の違いによる処理時間の差を確認しよう](#anchor2)
    - [OCPU=1の場合](#anchor2-1)
    - [OCPU=8の場合](#anchor2-2)
- [3. 性能調査に使えるツールのご紹介](#anchor3)
    - [データベース・ダッシュボード](#anchor3-1)
    - [パフォーマンス・ハブ](#anchor3-2)

<br>

**所要時間:** 約40分

**Star-Schema-Benchmark（SSB）とは？**  

ADBのインスタンスには、DWH系・分析系のサンプルスキーマとして以下が同梱されています。

+ Oracle Sales History（SHスキーマ）
+ Star Schema Benchmark（SSBスキーマ）

<b>上記のサンプルスキーマの特長</b>

+ 約1TB、約60億行のファクト表と、複数のディメンション表から構成
+ マニュアルには動作確認用のサンプルSQLも記載されている
+ ADW、ATPの双方で利用可能（2022/10時点）- 本ガイドでは前の章で作成したAutonomous Transaction Processing(ATP) インスタンスの利用を前提に記載していますが、SSBのような分析系・DWH系のアプリケーションの場合、Autonomous Data Warehouse(ADW) をご選択いただくことを推奨しています。

※サンプルスキーマの詳細については[こちら](https://docs.oracle.com/en/cloud/paas/autonomous-database/serverless/adbsb/autonomous-sample-data.html)を参照ください。

**作業の流れ**

+ SSBスキーマを確認しよう
+ OCPU数の違いによる処理時間の差を確認しよう
+ サービスコンソール/SQL Monitorで処理内容を確認しよう

<br>

<a id="anchor1"></a>

# 1. SSBスキーマを確認しよう

<a id="anchor1-1"></a>

## データ・モデラーによる構成確認

1. [ADBインスタンスを作成しよう](https://oracle-japan.github.io/ocitutorials/adb/adb101-provisioning/)で学習した**Database Actionsを利用したインスタンスへの接続** を参照し、Database Actionsを起動し、Adminユーザーで接続してください。**ツール**タブから、**データベース・アクションを開く**をクリックしてください。

   ![画面ショット1-1](img1.png)

1. Database Actionsのランディングページのデータ・ツールから　**データ・モデラー** を選択し、SSBスキーマの構造を確認していきましょう。

   ![画面ショット1-1](img40.png)

1. データ・モデラーのランディングページです。画面左上のナビゲータに**SSB**と入力し、SSBスキーマの下記の5つの表を確認します。

   - CUSTOMER表
   - DWDATE表
   - LINEORDER表
   - PART表
   - SUPPLIER表

   ![画面ショット1-1](img41.png)

1. SSBスキーマの5つの表を画面中央の**ダイアグラム**に追加します。追加方法は下記の２通りあります。

   - 表を右クリックし、**オブジェクトをダイアグラムに追加**をクリック
   - 表を**ドラッグ&ドロップ**で中央に移動する

   ![画面ショット1-1](img42.png)

1. SSBスキーマの構造がER図で表示されました。画面中央上の**セーブマーク** をクリックし、ダイアグラムを保存します。
<br>※図が重なってしまっている場合は、ドラッグして適宜移動してみてください。

   ![画面ショット1-1](img43.png)

1. ダイアグラム・プロパティの**名前**(例:SSB diagram)を入力し、**OK**をクリックします。

   ![画面ショット1-1](img44.png)

1. ダイアグラムが保存されました。**OK** をクリックします。

   ![画面ショット1-1](img45.png)

1. 保存したダイアグラム(例:SSB diagram)を確認していきます。画面左上 ナビゲータの隣の**ダイアグラム**タブをクリックします。保存したダイアグラム(例:SSB diagram)を選択後、**開く**をクリックします。

   ![画面ショット1-1](img46.png)

1. 画面右上赤枠のボタンをクリックするとスキーマの**DDL文**を確認することができます。

   ![画面ショット1-1](img47.png)

1. **DDL文のプレビュー**になります。

   ![画面ショット1-1](img48.png)

1. 画面右上赤枠のボタンをクリックすると**スキーマ・レポート**を確認することができます。

   ![画面ショット1-1](img49.png)

1. **スキーマ・レポート**になります。

   ![画面ショット1-1](img50.png)

<br>

<a id="anchor1-2"></a>

## 各表の件数確認

1. Database Actionsのランディングページに戻り、データ・ツールから**SQL** を選択します。

   ![画面ショット1-1](img2.png)

	
1. ワークシートの画面左上からスキーマ**SSB** を選択します。

   ![画面ショット1-1](img3.png)

	
1. 以下のスクリプトを実行して、各表の件数を確認します。

   ```
   select count(1) from ssb.dwdate;
   select count(1) from ssb.part;
   select count(1) from ssb.supplier;
   select count(1) from ssb.customer;
   select count(1) from ssb.lineorder;
   ```

   ![画面ショット1-1](img4.png)


   以上でSSBスキーマの構成、および各表に含まれる件数が確認できました。DWHとして理想的なスター・スキーマで構成されており、データサイズとしても比較的規模の大きな構成であることがご確認いただけたかと思います。

   次は、OCPU数を変えて、同じSQL文を実行することで、処理の違いを体験していきましょう。

<br>

<a id="anchor2"></a>

# 2. OCPU数の違いによる処理時間の差を確認しよう

   次にもう少し複雑なクエリを実行してみます。OCPU数を変えることで、高速に処理できることを確認していきましょう。

   次のクエリをコピーして、Database Actionsのワークシートに貼り付けて実行してみましょう。
   <br>すべてのOCPU数で同じクエリを実行します。

   ```sql
   SELECT
      SUM(LO_REVENUE),
      D_YEAR,
      P_BRAND1
   FROM
      SSB.LINEORDER,
      SSB.DWDATE,
      SSB.PART,
      SSB.SUPPLIER
   WHERE
      LO_ORDERDATE = D_DATEKEY
      AND LO_PARTKEY = P_PARTKEY
      AND LO_SUPPKEY = S_SUPPKEY
      AND P_BRAND1 BETWEEN 'MFGR#2221' AND 'MFGR#2228'
      AND S_REGION = 'ASIA'
   GROUP BY
      D_YEAR,
      P_BRAND1
   ORDER BY
      D_YEAR,
      P_BRAND1;
   ```

   本編ではOCPU=1および8の場合を記載しておりますが、ぜひOCPU=2,4,6と細かく変更し、OCPUが大きくなればElaped Timeが短くなることをご確認ください。

   > **注意**
   >
   > ここではOCPU数を段階的に増やし、性能が向上することをご確認いただきますが、クレジット消費も比例して大きくなりますので、ご注意ください。
   >

   > **補足**
   >
   > Autonomous Databaseのマニュアルでは、上に記載しているサンプルSQL以外にも動作確認用のサンプルSQLをご用意しております。
   > [こちら](https://docs.oracle.com/en/cloud/paas/autonomous-database/serverless/adbsb/sample-queries.html)を参照ください。
   >

<br>

<a id="anchor2-1"></a>

## OCPU=1の場合

1. 画面右上の接続サービスを**LOW**から**MEDIUM**に変更し、以下のスクリプトを実行します。

   現在のOCPU数は、**1**です。

   ![画面ショット1-1](img5_new.png)


   処理にかかった時間は、**00:01:30.110**でした。

<br>

<a id="anchor2-2"></a>

## OCPU=8の場合

1. ここでATPの詳細画面に遷移し、**スケール・アップ/ダウン**を選択してください。OCPU数をスケールさせていきます。

   ![画面ショット1-1](img6.jpg)

   > **注意**
   >
   > 自動スケーリングの有無は任意で結構です。
   > <br>自動スケーリングは複数のクエリが同時に走っているときにその効果が発揮されます。今回のように１つのクエリを走らせる分には有効にしてもしなくても性能に影響はありません。


1. OCPU数に**8**を入力し、**更新**をクリックしてください。

   ![画面ショット1-1](img7.jpg)


   ATPの詳細画面で**スケールアップの完了**を確認後、Database Actionsの**SQLワークシート**に戻ります。


1. 画面右上の接続サービスを**MEDIUM**から**HIGH**に変更し、クエリを実行します。現在のOCPU数は、**8**です。

   > **NOTE**
   >
   > 重たいクエリの多いDWH系のシステムでは、単一SQLを複数のコアで処理できるパラレル・クエリーが効果的です。ここからは、割り当てられたOCPUを全て利用できる接続サービスであるHIGHを選択します。
   > <br>**MEDIUM**接続でもパラレル処理が可能ですが、同時実行性も担保するために利用できるOCPU数を**4**までに制限しているため、ここからは8OCPU以上を利用できる**HIGH**接続に切り替えてスケールアップの効果を確認します。


   ![画面ショット1-1](img8_new.png)

   処理にかかった時間は、**00:00:12.698**でした。


ここまでで、OCPU＝1および8のときのElapsed Timeが確認できたと思います。<br>Autonomous Databaseでは利用可能なコア数だけでなく、割り当てメモリのサイズやIO帯域もOCPU数に比例する形で増加します。今回試したDWH系のクエリは一般的に非常に多くのリソースを消費しますが、Autonomous Databaseでは必要に応じてOCPU数を調整することで性能を担保することが可能です。


> **NOTE**
>
>その他、ADBでは、パーティション やHCC圧縮、マテリアライド・ビューといったOracle Database / Exadata のパフォーマンスに寄与する各種オプションも追加費用なくご利用いただけます。


次の表は、OCPU数を細かく増やしていったときのElapsed Timeをまとめたものです。
<br>このようにOCPUが大きくなれば性能が向上していることが分かります。

<table width="70%">
  <tr>
    <th>接続サービス</th>　<th>OCPU数</th> <th>Elapsed Time</th>
  </tr>
  <tr>
    <td rowspan="3">MEDIUM</td> <td>1</td> <td>00:01:30.110</td>
  </tr>
  <tr>
    <td>2</td> <td>00:00:58.209</td>
  </tr>
    <tr>
    <td>4</td> <td>00:00:27.212</td>
  </tr>
  <tr>
    <td rowspan="4">HIGH</td> <td>8</td> <td>00:00:12.698</td>
  </tr>
    <tr>
    <td>16</td> <td>00:00:08.113</td>
  </tr>
  <tr>
    <td>32</td> <td>00:00:05.324</td>
  </tr>
    <tr>
    <td>64</td> <td>00:00:05.102</td>
  </tr>
</table>

※Elapsed Timeにはブレがありますので、あくまでも参考値としてご認識ください。

<br>

<a id="anchor3"></a>

# 3. 性能調査に使えるツールのご紹介

ここからは実際にADBにて性能調査を行う際にどう言ったツールが利用できるのかをみていきたいと思います。

サービスコンソールおよびパフォーマンスハブでは次のような機能をご利用いただけます。


   <div style="text-align: center"><img src="slide.jpg"></div>


<a id="anchor3-1"></a>

## データベース・ダッシュボード

   ADBではインスタンスの稼働状況をDatabase Actionsのデータベース・ダッシュボードを介して確認できます。
   データベース・ダッシュボードからは、リソースの利用状況(CPUやストレージは十分か？どのくらい使われているか？等)を確認する時に活用します。


1. ATPの詳細画面の**Database Actions**をクリックしてください。

   ![画面ショット1-1](img20.jpg)

1. Database Actionsの起動パッドから**データベース・ダッシュボード**をクリックします。

   ![画面ショット1-1](img21.png)

1. **概要**では、ストレージの使用状況やCPU使用率、その他、実行されたSQL数や平均レスポンス時間等をご確認いただけます。

   ![画面ショット1-1](img22.png)

1. **モニター**を選択します。ここではデータベース内の待機イベントの状況、各接続サービス毎のCPU使用率などを、リアルタイムにご確認いただけます。

   ![画面ショット1-1](img23.png)

<a id="anchor3-2"></a>

## パフォーマンス・ハブ

   一方、単一のSQLで時間のかかるものを監視、調査する場合はSQL Monitorが有用です。アプリケーションの性能調査においてポイントとなる、待機イベントの確認やSQL Monitorの確認、AWRの出力はパフォーマンス・ハブを利用することで簡単に確認することができます。

1. ATPの詳細画面の**パフォーマンス・ハブ**をクリックしてください。
   
   ![画面ショット1-1](img30.jpg)

1. **パフォーマンス・ハブ**のランディングページです。このページでは、特定の期間に使用可能なすべてのパフォーマンス・データを表示できます。 期間を選択すると、データベースのパフォーマンスが表示されます。ワークシートで実行したSQLを確認するため、**SQLモニタリング**をクリックします。
   
   ![画面ショット1-1](img31.jpg)

1. **アクティビティ・サマリー**の時間指定範囲に目的のSQL文がないため、SQLが見つかりません。画面左上の**クイック選択**から、任意の期間を選択してください。
   
   ![画面ショット1-1](img32.jpg)

1. 期間変更後、**アクティビティ・サマリー**上に多くのCPUを使用している箇所が見られました。**アクティビティ・サマリー**の**期間ウィンドウ**を合わせてください。SQL文が見つかりました。青文字になっている**SQL ID**をクリックしてください。
   
   ![画面ショット1-1](img33.jpg)

1. **パフォーマンス・ハブ: リアルタイムSQLモニタリングページ**にて、クリックしたSQLの詳細を確認することができます。

   こちらのページの**詳細**セクションでは以下のことを確認できます。

   ・**計画統計**: 選択したSQLの実行計画

   ・**SQL**: 実行したSQL文

   ・**アクティブ・セッション**: 選択したSQLのアクティブセッション履歴

   ・**メトリック**: 選択したSQLにおけるパフォーマンスを、**使用中のCPU**、**メモリー**、**I/Oスループット**、**I/Oリクエスト数**の観点から確認することが可能です。

   また、画面右上の**レポートの保存**をクリックすると、AWRレポートをhtml形式でダウンロードすることができ、簡単にブラウザで確認・共有することができます。
   
   ![画面ショット1-1](img34.jpg)


以上で、この章の作業は終了です。


<br>
[ページトップへ戻る](#anchor0)