---
title: "212: Autonomous Database を災害対策構成にしてみよう"
excerpt: "DRを構成するにはどうしたら良いでしょうか？ADBでは数回クリックするだけでスタンバイ・データベースを簡単にプロビジョニングできます。"
order: "3_212"
layout: single
header:
  teaser: "/adb/adb212-audg/img1.jpg"
  overlay_image: "/adb/adb212-audg/img1.jpg"
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://community.oracle.com/tech/welcome/discussion/4474261/
---

<a id="anchor0"></a>

# はじめに

Autonomous Database ではReal Application Clusters(RAC)やAutomatic Storage Management(ASM)などの高可用性技術が事前構成済みです。そのため、単一のDBサーバー障害やストレージ障害については、RTO/RPOがほぼ0(SLO: サービスレベル目標)で復旧させることが可能です。

それらに加え、有償オプションとして、大きく2種類の災害対策ソリューションが提供されています。

それがAutonomous Data Guardとバックアップベースのディザスタ・リカバリです。Autonomous Data Guard は、本番環境用インスタンス(プライマリ・インスタンス)のスタンバイ・データベースを構成する事ができます。これによって、Autonomous Database インスタンスにデータ保護およびディザスタ・リカバリを実現可能です。Autonomous Data Guard が有効になっている場合、全ノード障害やリージョン障害などの大規模障害の際に、フェイルオーバーやスイッチオーバーが可能なスタンバイ・データベースを提供します。なおAutonomous Data Guard のスタンバイ・データベースへはデータ操作や接続ができません。

バックアップベースのディザスタ・リカバリは、デフォルトで取得されている自動バックアップのコピーを、本番環境用インスタンスのリージョンと異なるリージョンに保管しておくことができます。こちらもAutonomous Data Guard と同様、リージョン障害時に別のリージョンで本番環境と同等の環境をバックアップから構成することで、ディザスタ・リカバリを実現可能です。

<br>

**目次**

- [はじめに](#はじめに)
- [1. Autonomous Data Guard](#1-autonomous-data-guard)
  - [1-1. ローカルAutonomous Data Guard の有効化](#1-1-ローカルautonomous-data-guard-の有効化)
  - [1-2. Autonomous Data Guard のスイッチオーバー](#1-2-autonomous-data-guard-のスイッチオーバー)
  - [1-3. クロスリージョンAutonomous Data Guard](#1-3-クロスリージョンautonomous-data-guard)
  - [1-4. Autonomous Data Guard のその他の機能](#1-4-autonomous-data-guard-のその他の機能)
- [2. バックアップベースのディザスタ・リカバリ](#2-バックアップベースのディザスタリカバリ)
  - [2-1. ローカル・バックアップベースのディザスタ・リカバリ](#2-1-ローカルバックアップベースのディザスタリカバリ)
  - [2-2. クロスリージョン・バックアップベースのディザスタ・リカバリ](#2-2-クロスリージョンバックアップベースのディザスタリカバリ)
- [おわりに](#おわりに)

<br>

**所要時間:** 約30分

<br>

<a id="anchor1"></a>

# 1. Autonomous Data Guard
まずはスタンバイ・データベースを構成するAutonomous Data Guard を有効化してみます。

Autonomous Database は**SLA 99.95%**で提供されますが、Autonomous Data Guard構成時には**SLA 99.995%**で提供されます。

Autonomous Data Guard には2種類あり、プライマリ・インスタンスと同じリージョンにスタンバイ・データベースを構成する**ローカル Autonomous Data Guard**と、異なるリージョンにスタンバイ・データベースを構成する**クロス・リージョン Autonomous Data Guard**があります。

![AuDG1](AuDG1.jpg)

ローカルとクロス・リージョンでは、対応できる障害やRPO/RTO、追加コストが異なります。以下をご参照ください。

![AuDG2](AuDG2.jpg)

なおローカルAutonomous Data Guard では、複数のAvailability Domain(AD)のあるリージョンでは、異なるAD上にプロビジョニングされ、1つのADのみあるリージョンでは、スタンバイ・データベースはプライマリと異なるFault Domain(異なるExadata環境)上にプロビジョニングされます。これにより、全ノード障害やストレージの完全な障害などの物理マシン全体が被害を受けるケースにおいても、スタンバイ・データベースは異なる環境にあるため復旧することが可能です。

コストについて、例えばプライマリ・インスタンスを10ECPU、ストレージ1TBのADBで運用していた場合、それぞれの追加コストは以下のようになります。
+ ローカル Autonomous Data Guard: 10ECPU、ストレージ1TB
+ クロス・リージョン Autonomous Data Guard: 10ECPU、ストレージ2TB

なおスタンバイ・データベースでは、プライマリ・インスタンスの自動スケーリングでスケールした分のCPU課金は発生しません。設定ECPUのみの課金となります。

<br>
<a id="anchor1-1"></a>

## 1-1. ローカルAutonomous Data Guard の有効化
実際にAutonomous Data Guard を有効化してみます。

1. Autonomous Databaseの詳細画面の[ディザスタ・リカバリ]の**Autonomous Data Guardにアップグレード**をクリックします。デフォルトではプライマリ・インスタンスと同じリージョンにバックアップが取得されているため、『ローカル: バックアップベース』と記載されています。

   ![AuDG3](AuDG3.jpg)

2. 今回プライマリ・インスタンスは東京リージョンに作成してあるため、リージョンは東京となっています。ディザスタ・リカバリ・タイプとして、Autonomous Data Guard とバックアップベースのディザスタ・リカバリの2種類表示されています。上記の通りローカルのバックアップベースのディザスタ・リカバリはデフォルトで構成されている自動バックアップと同義のため、こちらを選択しても構成に変更は起きません。Autonomous Data Guard を選択し、送信ボタンをクリックします。

   ![AuDG4](AuDG4.jpg)

   > （補足）
   > データ損失制限(秒)のある自動フェイルオーバーについて
   >
   > ローカル Autonomous Data Guard では障害発生時の自動フェイルオーバーがサポートされています。
   >
   > プライマリ・インスタンスが利用できなくなり、ユーザーが接続できない場合、ローカルのスタンバイ・データベースが利用可能であれば自動的にスタンバイ・データベースにフェイルオーバーします。
   >
   > 自動フェイルオーバーを行うのは、データ損失が上記で0(デフォルト)~3600秒の間で設定した制限内であることを保証できる場合のみです。
   >
   > 例えばデータ損失制限を60秒と設定した場合に、データ損失が60秒以内であれば自動フェイルオーバーを実施しますが、60秒以上であれば自動フェイルオーバーは行いません。この場合はユーザーによる手動フェイルオーバーでの復旧が必要となります。
   
3. 画面左上のステータスがオレンジ色の更新中に変化しました。完了するまで数分待ってみましょう。なおスタンバイ・データベースの構成中であっても、データベース操作に影響はなく、ダウンタイムは発生しません。

   ![AuDG5](AuDG5.jpg)

4. プロビジョニングが完了し、ステータスが緑色の使用可能に戻りました。ADBの詳細画面の[ディザスタ・リカバリ]は**ローカル: Autonomous Data Guard**に変更されています。また左下の[リソース]のディザスタ・リカバリをクリックすると、以下のようにDRタイプがAutonomous Data Guard表示になっています。
   
   ![AuDG6](AuDG6.jpg)

   ![AuDG7](AuDG7.jpg)

5. ここでターミナルからADBにSQL*Plusで接続してみます。現在のプライマリ・インスタンスの情報を下記のSQL文で確認します。

   ```sql
   sqlplus admin/<ADMINユーザのパスワード>@<ADBの接続サービス>
   ```

   ```sql
   SELECT 
   DBID, NAME, DB_UNIQUE_NAME
   FROM 
   V$DATABASE;
   ```

   ![AuDG8](AuDG8.jpg)

   スイッチオーバーの前後でDBID、NAME、DB_UNIQUE_NAMEが変化することを確認したいと思うので、SQLの出力結果をメモ帳などにメモしておいてください。

<br>
<a id="anchor1-2"></a>

## 1-2. Autonomous Data Guard のスイッチオーバー
Autonomous Data Guard を有効化できたので、続いてスタンバイ・データベースにスイッチオーバーして、ロール変更します。
スイッチオーバーは一般的に、実際の障害時のフェイルオーバーのテスト目的で行われます。スイッチオーバー後は、これまでのスタンバイ・データベースがプライマリに、これまでのプライマリ・インスタンスがスタンバイに変更されます。

1. ADB詳細画面に戻り、スイッチオーバーをします。ADBの詳細画面の[ディザスタ・リカバリ]の**スイッチオーバー**をクリックして下さい。

   ![AuDG9](AuDG9.jpg)

2. DB名の入力確認があるので、以下のように入力してスイッチオーバーします。

   ![AuDG10](AuDG10.jpg)

3. 数分でスイッチオーバーが完了しました。ここでターミナルからADBにSQL*Plusでログインしましょう。スイッチオーバー後のプライマリの情報を下記のSQL文でクエリします。

   ```sql
   sqlplus admin/<ADMINユーザのパスワード>@<ADBの接続サービス>
   ```

   ```sql
   SELECT 
   DBID, NAME, DB_UNIQUE_NAME
   FROM 
   V$DATABASE;
   ```

   ![AuDG11](AuDG11.jpg)

   問合せたDBID、NAME、DB_UNIQUE_NAMEは、スイッチオーバー前に接続していたDBとは異なる情報です。適切にスイッチオーバーされたのが確認できます。

<br>
<a id="anchor1-3"></a>

## 1-3. クロスリージョンAutonomous Data Guard
続いてクロスリージョンでのAutonomous Data Guard を構成してみます。プライマリを東京に作成している場合、クロスリージョンでのスタンバイ・データベースの作成先としては、大阪・ソウルリージョンがあります。

1. ADBの詳細画面の左下、リソースの[ディザスタ・リカバリ]をクリックし、**ピア・データベースの追加**をクリックします。
   
   ![AuDG12](AuDG12.jpg)
   
2. リージョンを選択すると、ディザスタ・リカバリ・タイプの選択ができます。**Autonomous Data Guard**を選択します。
   
   ![AuDG13](AuDG13.jpg)

   > （補足）
   > クロスリージョン・バックアップ・レプリケーションの有効化について
   >
   > デフォルトではクロスリージョン・スタンバイ・データベースでは、プライマリと異なり自動バックアップが取得されません。そのためスタンバイ・データベースにスイッチオーバー/フェイルオーバーした直後は、自動バックアップを使用したリストアやクローニングが実行できません。
   >
   > しかしこの機能を有効化すると、最大7日間までの自動バックアップがスタンバイ側リージョンにレプリケートされるため、最大7日間以内であれば、新プライマリ(旧スタンバイ)DBをリストア、クローニングすることができます。
   >
   > なおレプリケートされたバックアップは、7日後もしくは自動バックアップの保持期間が7日未満の場合は、その保持期間の日数が経過すると削除されます。またレプリケートされたバックアップは、バックアップ分の追加コストが発生します。

3. プライマリ・インスタンスのネットワーク・アクセス・タイプが**プライベート・エンドポイント・アクセス**の場合、スタンバイのネットワーク・アクセスを設定する必要があります。ここでは大阪側のVCNとサブネットを選択して、**ピア・データベースの追加**をクリックします。

   ![AuDG14](AuDG14.jpg)

4. 画面左上のステータスがオレンジ色の更新中に変化しました。完了するまで数分待ってみましょう。なおスタンバイ・データベースの構成中であっても、データベース操作に影響はなく、ダウンタイムは発生しません。

   ![AuDG5](AuDG5.jpg)

5. スタンバイ・データベースが構成されると、以下のように大阪リージョンに*DB名_KIX*というインスタンスが作成されます。

   ![AuDG15](AuDG15.jpg)

クロスリージョンAutonomous Data Guard では、自動フェイルオーバーがサポートされていないため、ユーザーによる手動フェイルオーバーを行う必要があります。

実際の障害時には、まずローカルAutonomous Data Guard と同じ要領でスイッチオーバーを試みます。スイッチオーバーが失敗した場合、OCIコンソール上にフェイルオーバーを行うリンクが表示されます。ここではデータ損失が発生し得る時間も同時に表示されます。以下がサンプルです。

![adb_failover_manual](adb_failover_manual.png)

Autonomous Database は、RTO: 15分、RPO: 1分というサービスレベル目標(SLO)を基準にフェイルオーバーを行います。

<br>
<a id="anchor1-4"></a>

## 1-4. Autonomous Data Guard のその他の機能
Autonomous Data Guard には、本記事でご紹介した以外にもいくつか補足機能があります。

1. スナップショット・スタンバイ
   
   Autonomous Data Guard で作成したスタンバイ・データベースは、データ操作はもちろんDB接続はできませんが、このスナップショット・スタンバイ機能を使用すれば、**2日間まで**であれば読み書き可能なインスタンスとしてスタンバイ・データベースを活用できます。スナップショット・スタンバイになっている間は、プライマリからのREDO(更新データ)は転送されるものの、適用はされません。ユーザーが明示的にスナップショット・スタンバイから通常のスタンバイ・データベースに戻すか2日間が経過すれば、プライマリに自動的に再接続されます。そしてスナップショット・スタンバイ中に更新されたデータは破棄され、REDOの適用が再開されます。

   スタンバイ・データベースの詳細画面から、[その他のアクション]の**スナップショット・スタンバイ・データベースへの変換**をクリックします。

   ![AuDG16](AuDG16.jpg)

   ソース・データベース名(プライマリ)を入力して変換を行います。

   ![AuDG17](AuDG17.jpg)

   これでスタンバイ・データベースは最大2日間読み書き可能なインスタンスになりました。通常のスタンバイ・データベースに戻す際は、**ディザスタ・リカバリ・ピア・データベースへの変換**をクリックします。

   ![AuDG18](AuDG18.jpg)

2. クロステナンシのAutonomous Data Guard
   Autonomous Data Guard では、プライマリと異なるテナンシにスタンバイ・データベースを作成することができます。Autonomous Data Guard の本来の目的であるスイッチオーバー、フェイルオーバーを異なるテナンシにできることに加え、Autonomous Database を他のテナンシに移行する際にもこちらの機能を利用することができます。

   具体的な手順については、[こちら](https://docs.oracle.com/cd/E83857_01/paas/autonomous-database/serverless/adbsb/autonomous-data-guard-cross-tenancy.html#GUID-D53D86E6-9A6E-4E6D-8516-3394B3F1CB2C){:target="_blank"}をご参照ください。

3. スタンバイ・データベースに関するイベント通知
   Autonomous Data Guard でスタンバイ・データベースを構成する場合、OCI EventsやOCI Notificationsサービスと組み合わせて、以下のようなイベント通知をすることができます。ユーザーはこれらを受け取って、障害発生時の対応や状況確認をよりスムーズに行うことができます。
   + 自動フェイルオーバーの開始/終了(ローカルAutonomous Data Guard のみ)
   + Autonomous Data Guard の無効化の開始/終了
   + Autonomous Data Guard の有効化の開始/終了
   + 手動フェイルオーバーの開始/終了
   + スイッチオーバーの開始/終了
   
   EventsやNotificationsとの連携方法については、[こちら](https://oracle-japan.github.io/ocitutorials/adb/adb503-monitoring/){:target="_blank"}をご参照ください。

<br>
<a id="anchor2"></a>

# 2. バックアップベースのディザスタ・リカバリ
ここではバックアップベースのディザスタ・リカバリを有効にしてみます。

<br>
<a id="anchor2-1"></a>

## 2-1. ローカル・バックアップベースのディザスタ・リカバリ
ADBではデフォルトで自動バックアップが取得されています。自動バックアップがローカル(ADBインスタンスと同じリージョン)・バックアップコピーとして取得されています。そのため、追加コストとしては発生せず、自動バックアップ分の課金のみになります。

ADBの詳細画面の[リソース]の**ディザスタ・リカバリ**をクリックすると、デフォルトでは以下のようになっています。

![backupbase1](backupbase1.jpg)

※ADBプロビジョニング直後など自動バックアップが取られていない場合、表示されないケースがあります。

このバックアップコピーの右の3点リーダーをクリックすると、以下の項目が表示されます。

![backupbase2](backupbase2.jpg)

+ スイッチオーバー: 現在プロビジョニングされているExadata環境と異なるExadata環境に、バックアップからインスタンス化することでスイッチオーバーします。スイッチオーバーまでの時間はADBストレージ量に比例して長くなります。
   ![backup-based-dr-local](backup-based-dr-local.png)
  
+ ディザスタ・リカバリの更新: バックアップコピーからローカルAutonomous Data Guard にディザスタ・リカバリ・タイプを変更します。
+ ピアの無効化(クリック不可): ローカル・バックアップコピーは自動バックアップ同様無効化できません。


<br>
<a id="anchor2-2"></a>

## 2-2. クロスリージョン・バックアップベースのディザスタ・リカバリ
ローカルとは別に、ADBがプロビジョニングされているリージョンと異なるリージョンに、バックアップコピーを取っておくことができます。クロスリージョンの場合はローカルとは異なり、追加コストとしてコピーするバックアップ(プライマリで課金される自動バックアップに必要なストレージ)の2倍の課金がかかります。

![backup-based-dr-cross-region](backup-based-dr-cross-region.png)

それではクロスリージョンのバックアップベースのディザスタ・リカバリを有効にしてみます。

ADBの詳細画面の[リソース]のディザスタ・リカバリをクリックして、**ピア・データベースの追加**をクリックします。

![backupbase3](backupbase3.jpg)

次にリージョンを選択します。東京リージョンの場合、大阪リージョンとソウルリージョンが選択できます。ここでは大阪リージョンを選択します。

ディザスタ・リカバリ・タイプの選択は、**バックアップベース・ディザスタ・リカバリ**を選択します。

![backupbase4](backupbase4.jpg)

クロスリージョン・バックアップ・レプリケーションの有効化については、[1-3. クロスリージョンAutonomous Data Guard](#1-3-クロスリージョンautonomous-data-guard)に記載があるので、そちらをご参照ください。

プライマリ・インスタンスのネットワーク・アクセス・タイプが**プライベート・エンドポイント・アクセス**の場合、スタンバイのネットワーク・アクセスを設定する必要があります。ここでは大阪側のVCNとサブネットを選択して、**ピア・データベースの追加**をクリックします。

![AuDG14](AuDG14.jpg)

少し待つと、大阪リージョン側に*DB名_KIX*が作成されます。

![backupbase5](backupbase5.jpg)

ロール: バックアップ・コピーとなっているため、このインスタンスに接続することはできません。

Autonomous Data Guard と同様の手順で、スイッチオーバーや、プライマリ障害時にはこのバックアップ・コピーを用いたフェイルオーバーが可能です。

<br>
<a id="おわりに"></a>

# おわりに
このチュートリアルでは、ADBで設定可能な災害対策ソリューションについてご紹介しました。ADBではデフォルトで高可用性構成になっているものの、特にミッションクリティカルなシステムでは、広域障害への対策が必要になってきます。そのような場合に今回ご紹介したソリューションが使用可能です。それぞれのソリューションで、RTO/RPO、コストが変わってくるので、システムの要件に応じてご選択いただければと思います。

以上で、この章の作業は終了です。

<br>

[ページトップへ戻る](#anchor0)