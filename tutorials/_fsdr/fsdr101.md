---
title: "OCI Full Stack Disaster Recovery (FSDR)を使ってみよう"
excerpt: "OCI Full Stack Disaster Recoveryは、世界中のどこからでもOCIリージョン間のコンピュート、データベース、アプリケーションの移行をワンクリックで実行できます。本チュートリアルでは、FSDRを用いてOCIリソースをDR保護グループに登録し、DR計画を発行して実行するまでの流れをご紹介します。"
order: "110"
layout: single
header:
 teaser: "/fsdr/fsdr101/fsdr_component.png"
 overlay_image: "/fsdr/fsdr101/fsdr_component.png"
 overlay_filter: rgba(34, 66, 55, 0.7)
---

# はじめに 
**OCI Full Stack Disaster Recovery (FSDR)** は、Oracle Cloud Infrastructure (OCI)のディザスタ・リカバリ・オーケストレーションおよび管理サービスであり、インフラ、ミドルウェア、データベース、アプリケーションなど、アプリケーション・スタックのすべてのレイヤーに包括的なディザスタ・リカバリ機能を提供します。

FSDRは以下の要素で構成されます。

![FSDRの構成要素](fsdr_component.png)

- **ディザスタ・リカバリ保護グループ(DR保護グループ)** 

  DR保護グループは、フル・スタック・アプリケーションのすべてのコンポーネントをグループ化し、すべてのコンポーネントをまとめてリカバリしてフル・スタック・アプリケーションをリストアできるようにします。
  DR保護グループに追加できるコンポーネントは、FSDRが対応しているコンピュート・インスタンス、ボリューム・グループ、Oracle DatabaseなどのOCIリソースです。
  これらのリソースは、DR保護グループのメンバーと呼ばれます。
  DR保護グループは、プライマリ・リージョン(本番環境)とスタンバイ・リージョン(災害対策環境)にそれぞれ1つずつ作成し、それらは関連付けされます。
- **ディザスタ・リカバリ計画(DR計画)** 

  DR計画は、FSDRによって作成される自動DRワークフローで、プライマリDR保護グループ内のすべてのリソースの障害回復を実行します。
  DR計画は、以下の4種類の計画タイプが存在します。

  - **フェイルオーバー(計画外)**
  
    スタンバイDR保護グループへのサービスの計画外切り替えを実行するDR計画のタイプ。
    フェイルオーバー計画は、プライマリ・リージョンでのサービス停止をせず、スタンバイ・リージョンでアプリケーション・スタックを起動することで即時切り替えを実行します。
    フェイルオーバー計画は通常、プライマリ・リージョンが停止または障害発生した場合に使用されます。

  - **スイッチオーバー(計画済)**

    プライマリDR保護グループからスタンバイDR保護グループへのサービスの計画済切り替えを実行するDR計画のタイプ。
    スイッチオーバー計画は、プライマリ・リージョンのアプリケーション・スタックを停止してから、スタンバイ・リージョンでそれを起動することで、順次切り替えを実行します。
    スイッチオーバー計画は通常、計画済サイト・メンテナンス、ソフトウェアのパッチ適用、DRテストおよび検証の目的で使用されます。

  - **ドリルの開始**

    DRドリルは、災害対策環境が正常に起動できるかどうかをチェックするために実行されます。
    スタンバイDR保護グループに、スイッチオーバーまたはフェイルオーバーの実行時に起動される環境のレプリカが作成されます。
    
  - **ドリルの停止**

    DRドリルを停止するDR計画のタイプです。これにより、ドリルの開始で前に作成した本番スタックのレプリカが削除されます。

本チュートリアルでは、FSDRを用いてOCIリソースをDR保護グループのメンバーに追加し、スイッチオーバー計画を発行して実行するまでの流れをご紹介します。

<br>

**目次**

- [1. 準備作業(バケットの作成)](#anchor1)
- [2. DR保護グループの作成](#anchor2)
- [3. DR保護グループの関連付け](#anchor3)
- [4. OCIリソースをDR保護グループのメンバーに追加](#anchor4)
- [5. DR計画の作成](#anchor5)
- [6. DR計画の実行](#anchor6)

<br>

**前提条件 :**
+ ユーザーに必要なIAMポリシーが割り当てられていること。ポリシーの詳細は[ドキュメント](https://docs.oracle.com/ja-jp/iaas/disaster-recovery/doc/about-iam-policies-for-dr.html)を参照ください。
+ 2つ以上のリージョンをサブスクライブしていること。

**注意 :** 
+ チュートリアル内の画面ショットについてはOracle Cloud Infrastructureの現在のコンソール画面と異なっている場合があります。
+ 本チュートリアルでは、**Japan East(Tokyo)** をプライマリ・リージョン、**Japan Central(Osaka)** をスタンバイ・リージョンとしています。その他のリージョンを使用してチュートリアルを行う場合は、リージョン名を読み替えながら進めてください。

**所要時間 :** 約90分

<br>
<a id="anchor1"></a>
# 1. 準備作業(バケットの作成)
FSDRでは、オブジェクト・ストレージを使用してDR操作ログを格納するため、事前にオブジェクト・ストレージ・バケットを作成します。
バケットはプライマリ・リージョンとスタンバイ・リージョン両方で作成する必要があります。

## 1-1. プライマリ・リージョン
まずはプライマリ・リージョン(Tokyo)側からバケットを作成します。

1. メニューから**ストレージ →　オブジェクト・ストレージ → バケット**を選択し、有効な管理権限を持つコンパートメントを選択します。

   ![ナビゲーション・メニュー](fsdr_oss1.png)

1. 右上で**Tokyo**リージョンを選択し、**バケットの作成**ボタンを押します。

   ![バケット一覧](fsdr_oss_nrt2.png)

1. バケット名を**fsdr-log-tokyo**にして、それ以外はデフォルト設定のまま**作成**ボタンを押します。

   ![バケット作成](fsdr_oss_nrt3.png)

## 1-2. スタンバイ・リージョン
次に、スタンバイ・リージョン側でバケットを作成します。

1. 右上で**Osaka**リージョンを選択し、**バケットの作成**ボタンを押します。

   ![バケット一覧](fsdr_oss_kix2.png)

1. バケット名を**fsdr-log-osaka**にして、それ以外はデフォルト設定のまま**作成**ボタンを押します。

   ![バケット作成](fsdr_oss_kix3.png)

<br>
<a id="anchor2"></a>
# 2. DR保護グループの作成

## 2-1. プライマリ・リージョン
1. メニューから**移行とディザスタ・リカバリ → ディザスタ・リカバリ → DR保護グループ**を選択します。

   ![ナビゲーション・メニュー](fsdr_pg1.png)

1. 右上で**Tokyo**リージョンを選択し、**DR保護グループの作成**ボタンを押します。
   
   ![DR保護グループ一覧](fsdr_pg_nrt2.png)

1. 名前欄に**drpg-tokyo**と記入し、オブジェクト・ストレージ・バケットで**fsdr-log-tokyo**を選択します。それ以外の設定はデフォルトのまま**作成**ボタンを押します。

   ![DR保護グループ作成](fsdr_pg_nrt3.png)

## 2-2. スタンバイ・リージョン

1. 右上で**Osaka**リージョンを選択し、**DR保護グループの作成**ボタンを押します。
   
   ![DR保護グループ一覧](fsdr_pg_kix2.png)

1. 名前欄に**drpg-osaka**と記入し、オブジェクト・ストレージ・バケットで**fsdr-log-osaka**を選択します。それ以外の設定はデフォルトのまま**作成**ボタンを押します。

   ![DR保護グループ作成](fsdr_pg_kix3.png)

<br>
<a id="anchor3"></a>
# 3. DR保護グループの関連付け
作成した2つのDR保護グループの関連付けを行います。

1. DR保護グループの一覧画面で、右上から**Tokyo**リージョンを選択し、**drpg-tokyo**を押します。

   ![DR保護グループ一覧](fsdr_pair1.png)

1. アクションを押して表示されたプルダウンメニューから**関連付け**を選択します。

   ![DR保護グループ詳細](fsdr_pair2.png)

1.  ロールは**プライマリ**、ピア・リージョンは**Japan Central(Osaka)**、ピアDR保護グループは**drpg-osaka**をそれぞれ選択して、**関連付け**を押します。
　　
　　![DR保護グループ関連付け](fsdr_pair3.png)

    関連付けが完了すると、**drpg-tokyo**のロールが**プライマリ**になり、ピアDR保護グループで**drpg-osaka**と表示されます。

    ![DR保護グループ詳細](fsdr_pair4.png)

<br>
<a id="anchor4"></a>
# 4. OCIリソースをDR保護グループのメンバーに追加
DR保護グループの関連付けが完了したら、いよいよアプリケーションのコンポーネントをDR保護グループに登録します。
例として、ボリューム・グループ、コンピュート・インスタンス、Autonomous Databaseを、それぞれDR保護グループに登録する方法をご紹介します。
その他のOCIリソースをメンバーに追加する方法は、マニュアル ([Oracle Cloud Infrastructureドキュメント](https://docs.oracle.com/ja-jp/iaas/disaster-recovery/doc/add-members-protection-group.html)) を参照してください。

## 4-1 ボリューム・グループの追加
DR保護グループのメンバーにブロック・ボリュームやブート・ボリュームを追加するとき、各ボリュームをボリューム・グループにまとめ、クロス・リージョン・レプリケーションを有効にする必要があります。
ここでは、作成済みのブロック・ボリュームをボリューム・グループに登録し、DR保護グループに追加する流れをご紹介します。

**前提条件 :** Tokyoリージョンに作成済のブロック・ボリュームがあること。

1. メニューから**ストレージ →　ブロック・ストレージ → ボリューム・グループ**を選択し、有効な管理権限を持つコンパートメントを選択します。

    ![ナビゲーション・メニュー](fsdr_vg1.png)

1. 右上で**Tokyo**リージョンを選択し、**ボリューム・グループの作成**を押します。

    ![ボリューム・グループ一覧](fsdr_vg2.png)

1. 名前に**fsdr-VolumeGroup**と記入し、可用性ドメインで**TGjA:AP-TOKYO-1-AD-1**を選択します。その後、**次**を押します。

    ![ボリューム・グループ作成](fsdr_vg3.png)

1. ボリュームで、作成済みのブロック・ボリュームを選択します。その後、**次**を押します。

    ![ボリューム・グループ作成](fsdr_vg4.png)

1. 「非同期クロス・リージョン・ボリューム・レプリケーションを有効にします。」のチェックで**オン**を選択し、ターゲット・リージョンで**Japan Central (Osaka)**、可用性ドメインで**TGjA:AP-OSAKA-1-AD-1**を選択します。その後、**確認**のチェックを入れ、**次**を押します。

    ![ボリューム・グループ作成](fsdr_vg5.png)
   
1. 設定は変更せず**次**を押します。

    ![ボリューム・グループ作成](fsdr_vg6.png)

1. 設定内容を確認し、問題なければ**作成**を押します。

    ![ボリューム・グループ作成](fsdr_vg7.png)

1. **drpg-tokyo**の詳細画面で**メンバー**を選択し、**メンバーの追加**を押します。

    ![メンバー一覧](fsdr_member1.png)

1. リソース・タイプで**ボリューム・グループ**を選択します。

    ![メンバー追加](fsdr_vg8.png)

1. 「すべての既存プランをリフレッシュし、検証する必要があることを理解しています」をチェックし、ボリューム・グループで**fsdr-VolumeGroup**を選択します。その後、**追加**を押します。

    ![メンバー追加](fsdr_vg9.png)

## 4-2 コンピュート・インスタンスの追加
コンピュート・インスタンスは、以下2つのどちらかのタイプを選択し、DR保護グループのメンバーに追加します。

- **移動インスタンス**

    移動インスタンスは、スイッチオーバー計画かフェイルオーバー計画が実行されると、プライマリDR保護グループからスタンバイDR保護グループに移動されます。
    インスタンスは、FSDRがプライマリDR保護グループのインスタンスを自動停止(もしくは削除)し、スタンバイDR保護グループで新規にインスタンスを自動作成することで移動されます。
    ユーザーは、事前にプライマリ・リージョンにのみインスタンスをデプロイします。

- **非移動インスタンス**

    非移動インスタンスは、スイッチオーバー計画かフェイルオーバー計画が実行されると、プライマリ・リージョンとスタンバイ・リージョンのインスタンスを起動もしくは停止することで、サービスの切り替えを実現します。
    プライマリDR保護グループからスタンバイDR保護グループに移動されません。
    ユーザーは、事前にプライマリ・リージョンとスタンバイ・リージョンの両方にインスタンスをデプロイする必要があります。

![コンピュート・インスタンス・タイプ](fsdr_compute.png)

ここでは、非移動インスタンスをDR保護グループのメンバーとして登録する流れをご紹介します。

**前提条件 :** TokyoリージョンおよびOsakaリージョンにそれぞれ作成済のコンピュート・インスタンスがあること。

1. **drpg-tokyo**の詳細画面で**メンバー**を選択し、**メンバーの追加**を押します。

    ![メンバー一覧](fsdr_member1.png)

1. リソース・タイプで**コンピュート**を選択します。

    ![メンバー追加](fsdr_compute_tokyo1.png)

1. 「すべての既存プランをリフレッシュし、検証する必要があることを理解しています」をチェックし、インスタンスで作成済みのコンピュート・インスタンスを選択し、コンピュート・インスタンス・タイプで非移動インスタンスを選択します。

    ![メンバー追加](fsdr_compute_tokyo2.png)

1. 拡張オプションを押し、「フェイルオーバー/スイッチオーバーでのインスタンスの起動と停止」をチェックします。その後**追加**を押します。

    ![メンバー追加](fsdr_compute_tokyo3.png)

    
1. **drpg-osaka**の詳細画面で**メンバー**を選択し、**メンバーの追加**を押します。

    ![メンバー一覧](fsdr_member2.png)

1. リソース・タイプで**コンピュート**を選択します。

    ![メンバー追加](fsdr_compute_osaka1.png)

1. 「すべての既存プランをリフレッシュし、検証する必要があることを理解しています」をチェックし、インスタンスで作成済みのコンピュート・インスタンスを選択し、コンピュート・インスタンス・タイプで非移動インスタンスを選択します。

    ![メンバー追加](fsdr_compute_osaka2.png)

1. 拡張オプションを押し、「フェイルオーバー/スイッチオーバーでのインスタンスの起動と停止」をチェックします。その後**追加**を押します。

    ![メンバー追加](fsdr_compute_osaka3.png)

## 4-3 Autonomous Database (ADB)の追加
Autonomous Database (ADB)をDR保護グループのメンバーに追加するためには、事前にAutonomous Data Guard (AuDG)を構成しておく必要があります。
ここでは、作成済のADBでAuDGを構成し、DR保護グループに追加する流れをご紹介します。

**前提条件 :** Tokyoリージョンに作成済のADBがあること。

1. メニューから**Oracle Database →　Autonomous Database**を選択し、有効な管理権限を持つコンパートメントを選択します。

    ![ナビゲーション・メニュー](fsdr_adbs1.png)

1. 右上で**Tokyo**リージョンを選択し、作成済みADBの名前を押します。

    ![Autonomous Database一覧](fsdr_adbs2.png)

1. **ディザスタ・リカバリ**を選択肢、**ピア・データベースの追加**を押します。

    ![ディザスタ・リカバリ](fsdr_adbs3.png)

1. リージョンで**日本中央(大阪)**を選択します。

    ![ピア・データベースの追加](fsdr_adbs4.png)

1. **Autonomous Data Guard**を選択し、**追加**を押します。
これによりAutonomous Data Guardが構成されます。(作業完了まで数分かかります。)
作成が完了すると、ピアAutonomous Database欄に、Autonomous Data Guardによって作成されてスタンバイ・データベースが表示されます。

    ![ピア・データベースの追加](fsdr_adbs5.png)

    ![ディザスタ・リカバリ](fsdr_adbs_result.png)

1. **drpg-tokyo**の詳細画面で**メンバー**を選択し、**メンバーの追加**を押します。

    ![メンバー一覧](fsdr_member1.png)

1. リソース・タイプで**自律型データベース**を選択します。

    ![メンバー追加](fsdr_adbs6.png)

1. 「すべての既存プランをリフレッシュし、検証する必要があることを理解しています」をチェックし、データベースで作成済みのADBを選択します。その後、**追加**を押します。

    ![メンバー追加](fsdr_adbs7.png)

1. **drpg-osaka**の詳細画面で**メンバー**を選択し、**メンバーの追加**を押します。(ADBは、プライマリ・リージョンとスタンバイ・リージョンの両方で、DR保護グループのメンバーとして追加します。)

    ![メンバー一覧](fsdr_member2.png)

1. リソース・タイプで**自律型データベース**を選択します。

    ![メンバー追加](fsdr_adbs8.png)

1. 「すべての既存プランをリフレッシュし、検証する必要があることを理解しています」をチェックし、データベースでスタンバイのADBを選択します。その後、**追加**を押します。

    ![メンバー追加](fsdr_adbs9.png)

<br>
<a id="anchor5"></a>
# 5. DR計画の作成
DR保護グループへのメンバー追加が完了したら、DR計画を作成します。
DR計画の作成は、スタンバイDR保護グループで行います。
ここでは4つのDR計画タイプの中から、例としてスイッチオーバー計画を作成していきます。

1. **drpg-osaka**の詳細画面で**計画**を選択し、**計画の作成**を押します。

    ![計画一覧](fsdr_drplan1.png)

1. 名前に**dr-plan1**と記入し、プラン・タイプで**スイッチオーバー(計画済)**を選択します。その後、**作成**を押します。

    ![計画作成](fsdr_drplan2.png)

<br>
<a id="anchor6"></a>
# 6. DR計画の実行
最後は作成したスイッチオーバー計画を実行し、プライマリ・リージョンとスタンバイ・リージョンの切り替えを行います。

1. DR計画実行前の各DR保護グループの状態は以下の画像のように、それぞれ**drpg-tokyo**(左)がプライマリ、**drpg-osaka**(右)がスタンバイになってることを確認します。

    ![DR計画実行前](fsdr_execute_before.png)

1. **drpg-osaka**の詳細画面で**計画**を選択し、**dr-plan1**の三点リーダーを押します。その後、表示されたプルダウンメニューから**計画の実行**を選択します。

    ![DR計画一覧](fsdr_execute1.png)

1. 計画実行名に**execute_switchover**と入力し、**計画の実行**押します。その後、計画が開始されるので、完了まで待ちます。

    ![計画実行](fsdr_execute2.png)

1. 計画が完了すると、**drpg-tokyo**(左)と**drpg-osaka**(右)のロールが切り替わります。また、メンバーの状態も実行前と逆転します。

    ![計画実行後](fsdr_execute_result.png)

以上でこのチュートリアルは終了です。

# 参考資料

* [製品サイト] [Full Stack Disaster Recovery](https://www.oracle.com/jp/cloud/full-stack-disaster-recovery/){:target="_blank"} 
* [マニュアル] [Oracle Cloud Infrastructureドキュメント(Full Stack Disaster Recovery)](https://docs.oracle.com/en-us/iaas/disaster-recovery/index.html){:target="_blank"} 

<br>