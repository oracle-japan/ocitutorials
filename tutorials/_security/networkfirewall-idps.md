---
title: "OCI Network FirewallのIDS/IPS機能を検証する"
excerpt: "本チュートリアルは「OCI Network Firewallを構築する」の続編として、IDS/IPS機能の動作確認を行います"
order: "120"
layout: single
tags:
 - intermediate
header:
 teaser: "/security/networkfirewall-idps/nfwips7.png"
 overlay_image: "/security/networkfirewall-idps/nfwips7.png"
 overlay_filter: rgba(34, 66, 55, 0.7)

---
<!-- リンク定義 -->
[OCI Network Firewallを構築する]: /ocitutorials/security/networkfirewall-setup/
<!-- --------- -->

パロアルトネットワークスの次世代ファイアウォール技術を基に構築されたOCIクラウドネイティブのマネージド・ファイアウォール「OCI Network Firewall」が2022年7月にリリースされました。「OCI Network Firewall」はURLフィルタリングやTSL/SSL検査などの機能を提供します。
本チュートリアルは「[OCI Network Firewallを構築する]」の続編として、IDS/IPSの設定および動作を確認します。

IDS/IPSの動作検証には、Kali LinuxのツールおよびEicarファイルを使用します。
Kali Linuxでは、Network Firewallインスタンスに保護されたWindowsのコンピュートインスタンスに侵入テストを実施します。
Eicarファイルを使用する際は、Network Firewallインスタンスに保護されたLinuxのコンピュートインスタンスにWebサーバーを構築し、Webサーバーを使用して動作を検証します。


**所要時間 :** 約60分

**前提条件 :**
+ OCIチュートリアル「[OCI Network Firewallを構築する]」を参考に、Network Firewallインスタンスの作成、コンピュートインスタンス（LinuxまたはWindows）の作成が終わっていること
+ Kali Linuxを使用した動作検証を実施する場合、Windowsのコンピュートインスタンスに対して侵入テストを実施します。OCIチュートリアル「[OCI Network Firewallを構築する]」の手順6-2 [Windowsインスタンスの作成](/ocitutorials/security/networkfirewall-setup/#6-2-windowsのインスタンスの作成)に沿って、Windowsのコンピュートインスタンスが作成されていることを確認してください。
+ Kali Linuxを使用した動作検証を実施する場合、[Kali LinuxをOCIにデプロイする](https://qiita.com/western24/items/9830d158247fd2dca60b)を参考に、OCI Network Firewallで保護されたコンピュートインスタンスに対して通信を行える環境に、Kali Linuxの構築が終わっていること。
+ Eicarファイルを使用した動作検証を実施する場合、LinuxのコンピュートインスタンスにWebサーバーをインストールして動作を検証します。OCIチュートリアル「[OCI Network Firewallを構築する]」の手順6-1[Linuxのコンピュート・インスタンスの作成](https://oracle-japan.github.io/ocitutorials/security/networkfirewall-setup/#6-2-windows%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E4%BD%9C%E6%88%90)に沿って、Linuxのコンピュートインスタンスが作成されていることを確認してください。
+ **`重要`**： OCIの環境へツールなどを用いた侵入テストを実行する際は、メールにてOracleに事前に侵入テストの実施を通知する必要があります。本チュートリアルの内容を実施する際は、[クラウド・セキュリティ・テスト通知の送信](https://docs.oracle.com/ja-jp/iaas/Content/Security/Concepts/security_testing-policy_notification.htm)を参考に、事前にOracleへ告知メールを送信してください。


**注意 :**
+ ※チュートリアル内の画面ショットについてはOracle Cloud Infrastructureの現在のコンソール画面と異なっている場合があります。
+ ※本チュートリアルでは、OCI Network Firewallの機能検証を目的にKali LinuxおよびEicarファイルを使用します。ご自身の管理下にないサーバーや、本番環境に対しては使用しないでください。また、ツールを使用したことによりトラブルや損失が発生した場合についても責任を負いかねます。

<br>


# 1. ネットワーク・ファイアウォール・ポリシーの編集

今回のチュートリアルでは、「[OCI Network Firewallを構築する]」で作成したネットワーク・ファイアウォール・ポリシーを編集し、既存のネットワーク・ファイアウォール・ポリシーで許可しているアクセス以外は全て侵入検知するセキュリティ・ルールを追加します。


## 1-1. ネットワーク・ファイアウォール・ポリシーのクローニング

OCIチュートリアル「[OCI Network Firewallを構築する]」で作成したネットワーク・ファイアウォール・ポリシーの詳細画面の「ポリシーのクローニング」をクリックします。
 ![画面ショット1](nfwips1.png)


「ネットワーク・ファイアウォール・ポリシー・クローンの作成」画面にて、新しいネットワーク・ファイアウォール・ポリシー名を入力し、「ネットワーク・ファイアウォール・ポリシーの作成」ボタンをクリックします。
+ **`名前`** - 任意 例）NFWPolicy2
 ![画面ショット2](nfwips2.png)

以上の手順で、既存のネットワーク・ファイアウォール・ポリシーのクローンは完了です。
クローンしたネットワーク・ファイアウォール・ポリシーは既存の設定内容を修正し、新しくネットワーク・ファイアウォール・インスタンスにアタッチすることができます。

<br>

## 1-2. サービス・リストの追加
手順1-2でクローンしたネットワーク・ファイアウォール・ポリシーの詳細画面を開きます。
 
 ![画面ショット43](nfwips43.png)

ポリシー詳細画面左下のポリシー・リソースから「サービス・リスト」を選択し、「サービス・リストの作成」ボタンをクリックします。
 
 ![画面ショット44](nfwips44.png)

「サービス・リストの作成」画面にて、任意のサービス・リスト名を入力します。  
例）「others」  
サービス・リスト名を入力したら、「サービスの作成」ボタンをクリックします。
 
 ![画面ショット45](nfwips45.png)

「サービスの作成」画面にて、以下情報を入力し、「サービスの作成と選択」ボタンをクリックします。

+ **`名前`** - 任意 例）others
+ **`プロトコル`** - TCP
+ **`ポート範囲`** - 1-65535
 
 ![画面ショット46](nfwips46.png)

作成したサービスが「Selectedサービス」に追加されていることを確認したら、「サービス・リストの作成」ボタンをクリックします。
 
 ![画面ショット47](nfwips47.png)

<br>

## 1-3.セキュリティ・ルールの作成

セキュリティ・ルールでは、手順1-2で指定したポート番号による通信のパケットを監視し、不正通信を防止するルールを作成します。  
ポリシー詳細画面左下のポリシー・リソースから「セキュリティ・ルール」を選択し、「セキュリティ・ルールの作成」ボタンをクリックします。
 
 ![画面ショット48](nfwips48.png)

「セキュリティ・ルールの作成」画面にて、セキュリティ・ルール名を入力します。  
例）others-ips

 ![画面ショット49](nfwips49.png)

一致条件の項目にて、「ソースIPアドレス」、「宛先IPアドレス」、「アプリケーション」は全て「任意」を選択します。  
「サービス」にて、「サービス・リストの選択」をクリックし、「サービス・リストの選択
」ボタンをもう一度クリックします。

 ![画面ショット50](nfwips50.png)

「サービス・リストの選択」画面にて、手順1-2で作成したサービス・リストにチェックをいれ、「選択済へ追加」ボタンをクリックします。
 
 ![画面ショット51](nfwips51.png)

選択されたサービス・リストの欄に、手順1-2で作成したサービス・リストが表示されていることを確認したら、画面下の「選択したサービス・リストの追加」ボタンをクリックします。
 
 ![画面ショット52](nfwips52.png)

URLは「任意のURL」を選択します。  
続いて、ルール・アクションにて「侵入防止」を選択します。  
ルールの順序で「リストの最後のルール」を選択し、「セキュリティ・ルールの作成」ボタンをクリックします。
 
 ![画面ショット53](nfwips53.png)

以上の手順で、ポート番号1番から9999番における不正通信の侵入防止の設定は完了です。  
セキュリティ・ルールは設定された順序に沿って通信が検査され、今回追加した侵入防止のルールは一番最後に検査されます。


<!---
## 1-2. アプリケーション・リストの追加
クローンしたネットワーク・ファイアウォール・ポリシーの詳細画面を開きます。
 
 ![画面ショット]
「リスト」の画面にて、「アプリケーション・リストの追加」ボタンをクリックします。
 
 ![画面ショット3](nfwips3.png)

「アプリケーション・リストの追加」画面にて、以下情報を入力し、「アプリケーション・リストの追加」ボタンをクリックします。
+ **`名前`** - 任意 例）others
+ **`アプリケーション・プロトコル`** - UDP/TCP
+ **`プロトコル`** - TCP
+ **`ポート範囲`** - 0-9999

 ![画面ショット4](nfwips4.png)

アプリケーション・リストを追加したら「次」ボタンをクリックします。
「マップされたシークレット/復号化プロファイル」は何も設定せず「次」ボタンをクリックします。



<br>


## 1-3. セキュリティ・ルールの作成
「ルール」の画面にて、「セキュリティ・ルールの追加」ボタンをクリックします。
 ![画面ショット5](nfwips5.png)

「セキュリティ・ルールの追加」画面にて、以下情報を入力したら「変更の保存」ボタンをクリックします。

+ **`名前`** - 任意 例）others-ips
+ **`ソースIPアドレス`** - 任意のIPアドレス
+ **`宛先IPアドレス`** - 任意のIPアドレス
+ **`アプリケーション`** - UDP/TCPを選択し、手順1-2で作成したアプリケーション・リスト「others」を選択します。
+ **`URL`** - 任意のURL
+ **`ルール・アクション`** - 「侵入防止」を選択します。
 ![画面ショット6](nfwips6.png)


セキュリティ・ルールを追加したら「次」ボタンをクリックし、「ネットワーク・ファイアウォール・ポリシーの作成」ボタンをクリックします。
 ![画面ショット7](nfwips7.png)

新しいネットワーク・ファイアウォール・ポリシーが作成されます。

<br>

--->

# 2. Network Firewallインスタンスに割り当てられているNetwork Firewallポリシーの変更

OCIチュートリアル「[OCI Network Firewallを構築する]」で作成したNetwork Firewallインスタンスの詳細画面の「編集」ボタンをクリックします。
 
 ![画面ショット8](nfwips8.png)

「ファイアウォールの編集」画面にて、手順1で作成したネットワーク・ファイアウォール・ポリシー「例）NFWPolicy2」を選択し、「変更の保存」ボタンをクリックします。
 
 ![画面ショット9](nfwips9.png)


約10分程でNetwork Firewallが「更新中」から「アクティブ」になります。

 ![画面ショット10](nfwips10.png)


Network Firewallが再び「アクティブ」になるのを待つ間に、次のステップでNetwork Firewallで保護されたコンピュートインスタンスにWebサーバーをインストールします。

<br>


# 3. Network Firewallで保護されたコンピュートインスタンスにWebサーバーをインストール（Eicarファイルを使用する場合）


本手順では、Eicarファイルを使用した動作検証を実施する場合、必要になるWebサーバーをインストールします。
OCIチュートリアル「[OCI Network Firewallを構築する]」で作成したコンピュートインスタンス（Linux）にSSHでアクセスします。
ターミナルで以下コマンドを実行し、Apache HTTPサーバをインストールします。

1. Apache HTTPサーバーをインストールします

    ```sh
    sudo yum -y install httpd
    ```

2. TCPの80番(http)および443番(https)ポートをオープンします

    ```sh
    sudo firewall-cmd --permanent --add-port=80/tcp
    sudo firewall-cmd --permanent --add-port=443/tcp
    ```

3. ファイアウォールを再ロードします

    ```sh
    sudo firewall-cmd --reload
    ```

4. Webサーバーを起動します

    ```sh
    sudo systemctl start httpd
    ```

クライアントPCのブラウザを開き、「http://<コンピュートインスタンスのIPアドレス>」にアクセスし、以下のようなページが表示されることを確認します。
 
 ![画面ショット11](nfwips11.png)

<br>


# 4. Network Firewallインスタンスのログの有効化

本手順では、Network Firewallインスタンスのログを有効化します。
Network Firewallでは、以下2種類のログを出力します。
+ Traffic Log : Network Firewallインスタンスを通過したトラフィックを記録したログ。
+ Threat Log : Network Firewallによって脅威が検知されたトラフィックの詳細情報（脅威の内容など）を記録したログ。

本チュートリアルでは、実際に攻撃した内容がNetwork Firewallによって脅威として検知されているかを確認するため、「Threat Log」を有効化します。

Network Firewallインスタンスの更新が終了し、再びアクティブになったら、Network Firewallインスタンス詳細画面左下にあるリソースから「ログ」を選択します。
 ![画面ショット12](nfwips12.png)

表示された「ログの有効化」画面にて、以下情報を入力し、「ログの有効化」ボタンをクリックします。
+ **`ログ・グループ`** - 新規ログ・グループの作成を選択します。
+ **`名前`** - 任意 例）NFW_LOG
+ **`説明`** - 任意
+ **`ログ名`** - デフォルト「NFW1_threatlog」のままにします。変更したい場合は任意のログ名を入力してください。
+ **`ログの保持`** - デフォルトの1ヵ月にします。最大で6ヵ月まで保持することが可能です。
 ![画面ショット13](nfwips13.png)

<br>



# 5. Eicarファイルを用いたNetwork Firewallの動作検証

Eicarファイルは、ウイルス対策ソフトの応答をテストするために[EICAR](https://www.eicar.org/)が開発したテストファイルです。

## 5-1. Eicarファイルの配置
[Eicarのホームページ](https://www.eicar.org/download-anti-malware-testfile/)から、eicar.comファイルをクリックします。
 ![画面ショット23](nfwips23.png)

以下の文字列がブラウザ上に表示されるので、表示された文字列をクリップボードにコピーします。
 
 ![画面ショット22](nfwips22.png)

手順3でWebサーバーをインストールしたインスタンスにアクセスし、/var/www/htmlディレクトリ配下にコピーしたeicarファイルの中身をペーストします。
ここではページ名を「eicar.html」とします。
```sh
$ sudo cd /var/www/html
$ sudo vi eicar.html 
```
 ![画面ショット24](nfwips24.png)

<br>

## 5-2. Eicarファイルへアクセス

クライアントPCのブラウザを開き、以下URIにアクセスします。
```
http://<手順3でWebサーバをインストールしたインスタンスのIPアドレス>/eicar.html
```
OCI Network Firewallの侵入防止の機能によって、接続がリセットされます。

 ![画面ショット25](nfwips25.png)

<br>

## 5-3. Network Firewallのログの確認

実際にNetwork Firewallのログに、脅威情報として上記のアクセスが記録されていることを確認します。

Network Firewallインスタンスの詳細画面左下のリソース→ログ→手順4で有効化したThreat Logの「ログ名」から、ログを確認します。
 ![画面ショット26](nfwips26.png)

出力されたログから、手順1-3で作成したルール「others-ips」によって「Eicarファイルが検知」され、クライアントPCのグローバルIPアドレスからの接続がリセットされていることが分かります。
 ![画面ショット27](nfwips27.png)


