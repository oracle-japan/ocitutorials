---
title: "オブジェクト・ストレージを使用するバックアップツールの選択方法"
excerpt: "HPC/GPUクラスタを運用する際必須となるファイル共有ストレージは、コストパフォーマンスを考慮するとベア・メタル・インスタンスとブロック・ボリューム等のストレージサービスで構築することになりますが、このストレージをバックアップする場合そのバックアップ環境を独自に構築することになり、このバックアップを格納するストレージの有力な選択肢は、その安価な容量単価からオブジェクト・ストレージが挙げられます。この際のバックアップツールは、POSIXファイルシステムとオブジェクト・ストレージ間の差分バックアップ機能を有していることが求められ、候補となるツールがいくつか存在します。本テクニカルTipsは、ファイル共有ストレージのバックアップをオブジェクト・ストレージに取得することを想定し、自身のバックアップ要件に沿ったツールを選択する方法を解説します。"
order: "325"
layout: single
header:
  teaser: "/hpc/spinup-backup-server/architecture_diagram.png"
  overlay_image: "/hpc/spinup-backup-server/architecture_diagram.png"
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://community.oracle.com/tech/welcome/discussion/4474261/
---

***
# 0. 概要

**ベア・メタル・インスタンス** と **ブロック・ボリューム** 等のストレージサービスで構築するNFSでサービスするファイル共有ストレージは、NFSのマネージドサービスである **ファイル・ストレージ** の場合は備え付けのバックアップ機能を利用できるのに対し、自身でバックアップ環境を構築する必要があります。  
この際バックアップを格納するストレージは、通常バックアップ対象のファイルを格納するストレージより容量単価の安価なものを選択する必要があるため、 **オブジェクト・ストレージ** がその有力な候補になります。

この際バックアップを行うツールは、POSIXファイルシステムと **オブジェクト・ストレージ** 間の差分バックアップ機能が必要になり、この機能を有する代表的なものとして以下のツールが挙げられます。

- **[Command Line Interface（以降"OCI CLI"と呼称）](https://docs.oracle.com/en-us/iaas/Content/API/Concepts/cliconcepts.htm)** の **[oci os object sync](https://docs.oracle.com/en-us/iaas/tools/oci-cli/3.49.3/oci_cli_docs/cmdref/os/object/sync.html)** コマンド  
**OCI** の操作をコマンドラインインターフェースで行うための **OCI CLI** は、POSIXファイルシステムと **オブジェクト・ストレージ** を同期させるサブコマンド **oci os object sync** を提供しており、これを利用して差分バックアップを実現します。
- **[OCIFS](https://docs.oracle.com/en-us/iaas/oracle-linux/ocifs/index.htm)** + rsync  
**OCI** が無償で提供するユーティリティの **OCIFS** は、 **オブジェクト・ストレージ** をPOSIXファイルシステムのディレクトリ階層にマウントし、POSIXのIOシステムコールを使用するアプリケーションが **オブジェクト・ストレージ** にアクセスすることを可能にします。  
**OCIFS** でマウントされた **オブジェクト・ストレージ** とファイル共有ストレージをrsyncで同期させることで、ファイル共有ストレージの **オブジェクト・ストレージ** への差分バックアップを実現します。
- **[Rclone](https://rclone.org/)**  
**Rclone** は、様々なクラウトストレージで利用可能なデータ転送ツールとして幅広く利用されている高機能のオープンソースソフトウェアで、 **オブジェクト・ストレージ** をバックエンドのストレージとして公式にサポートしており、ストレージ間を同期させるサブコマンド **rclone sync** を利用し、ファイル共有ストレージの **オブジェクト・ストレージ** への差分バックアップを実現します。

本テクニカルTipsは、ファイル共有ストレージのバックアップを **オブジェクト・ストレージ** に取得することを念頭に、まず初めにこれらのツールを検証する際の前提条件を提示し、次に以下の観点でこれらのツールを比較・検証することで、自身のバックアップ要件に沿ったツールをどのように選択すればよいかを解説します。

- バックアップ・リストア時の制約事項
- バックアップ・リストア性能

***
# 1. バックアップツール検証時前提条件

## 1-0. 概要

本章は、本テクニカルTipsで比較するバックアップツールを検証する際の前提条件を、以下の観点で解説します。

- 検証環境
- ソフトウェアバージョン
- バックアップ・リストア時指定のオプション

## 1-1. 検証環境

バックアップツールを検証する際に使用する環境は、ストレージに **ブロック・ボリューム** を使用しこれを **ベア・メタル・インスタンス** にアタッチする方法（以降"ブロック・ボリュームNFSサーバ”と呼称）でNFSでサービスするファイル共有ストレージをバックアップする前提で、何れも **[OCI HPCチュートリアル集](/ocitutorials/hpc/#1-oci-hpcチュートリアル集)** の **[ブロック・ボリュームでファイル共有ストレージを構築する](/ocitutorials/hpc/spinup-nfs-server/)** の手順に従い構築されたファイル共有ストレージと **[ベア・メタル・インスタンスNFSサーバ向けバックアップサーバを構築する](/ocitutorials/hpc/spinup-backup-server/)** の手順に従い構築されたバックアップ環境を使用し、ここで構築したバックアップサーバでバックアップツールを実行して検証します。

![システム構成図](/ocitutorials/hpc/spinup-backup-server/architecture_diagram.png)

なお、このチュートリアルで構築するバックアップ環境は、 **Rclone** のみを使用しているため、 **OCI CLI** と **OCIFS** を追加でバックアップサーバにインストールします。

**OCI CLI** のインストールは、以下の **OCI** 公式マニュアルに従い行います。  
なお、 **OCI CLI** の実行時認証は、チュートリアルに従って構築されたバックアップサーバが **[インスタンス・プリンシパル](/ocitutorials/hpc/#5-15-インスタンスプリンシパル)** 認証の設定を完了しているため、これを使用します。

**[https://docs.oracle.com/ja-jp/iaas/Content/API/SDKDocs/cliinstall.htm](https://docs.oracle.com/ja-jp/iaas/Content/API/SDKDocs/cliinstall.htm)**

また **OCIFS** のインストールは、以下コマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sudo dnf install -y ocifs
```

次に、以下コマンドをバックアップサーバのopcユーザで実行し、バックアップに使用する **オブジェクト・ストレージ・バケット** を **/mnt/os** にマウントします。  
なお、 **OCIFS** の実行時認証は、チュートリアルに従って構築されたバックアップサーバが **[インスタンス・プリンシパル](/ocitutorials/hpc/#5-15-インスタンスプリンシパル)** 認証の設定を完了しているため、これを使用します。

```sh
$ sudo mkdir /mnt/os
$ sudo ocifs --auth=instance_principal --cache=/var/tmp/ocifs-cache bucket_name /mnt/os
```

なおコマンド中の **bucket_name** は、自身の環境に置き換えて指定します。

## 1-2. ソフトウェアバージョン

本テクニカルTipsで検証する各バックアップツールのバージョンを以下に示します。

- **OCI CLI** ： 3.48.2
- **OCIFS** ： 1.1.0-2
- **Rclone** ： v1.68.1

## 1-3. バックアップ・リストア時指定のオプション

### 1-3-1. OCI CLI

**OCI CLI** を使用するバックアップは、以下コマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sudo oci os object sync --auth instance_principal --delete --parallel-operations-count 100 --bucket-name bucket_name --src-dir /mnt/nfs/source_dir
```

なおコマンド中の **bucket_name** と **source_dir** は、自身の環境に置き換えて指定します。

また、 **OCI CLI** を使用するリストアは、以下コマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sudo oci os object sync --auth instance_principal --delete --parallel-operations-count 100 --bucket-name bucket_name --dest-dir /mnt/nfs/dest_dir
```

なおコマンド中の **bucket_name** と **dest_dir** は、自身の環境に置き換えて指定します。

### 1-3-2. OCIFS

**OCIFS** を使用するバックアップは、以下コマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sudo rsync -au /mnt/nfs/source_dir /mnt/os/
```

なおコマンド中の **source_dir** は、自身の環境に置き換えて指定します。

また、 **OCIFS** を使用するリストアは、以下コマンドをバックアップサーバのopcユーザで実行します。  
最初の2個のコマンドは、バックアップ時のキャッシュを無効化するためのもので、これによりリストア時に **オブジェクト・ストレージ** からデータを読み出す際の性能を計測しています。

```sh
$ sudo umount /mnt/os
$ sudo ocifs --auth=instance_principal --cache=/var/tmp/ocifs-cache bucket_name /mnt/os
$ sudo rsync -au /mnt/os/source_dir restore_dir 
```

なおコマンド中の **source_dir** と **restore_dir** は、自身の環境に置き換えて指定します。

### 1-3-3. Rclone

**Rclone** を使用するバックアップは、以下コマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sudo rclone --oos-upload-cutoff 16Mi --transfers 100 --oos-chunk-size 16Mi --oos-upload-concurrency 128 --oos-attempt-resume-upload --oos-leave-parts-on-error --copy-links --metadata --checksum sync /mnt/nfs/source_dir rclone_conn:bucket_name/dest_dir
```

なお、コマンド中の **source_dir** 、 **rclone_conn** 、 **bucket_name** 、及び **dest_dir** は、自身の環境に置き換えて指定します。

また、 **Rclone** を使用するリストアは、以下コマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sudo rclone --oos-upload-cutoff 16Mi --transfers 100 --oos-chunk-size 16Mi --oos-upload-concurrency 128 --oos-attempt-resume-upload --oos-leave-parts-on-error --copy-links --metadata --checksum sync rclone_conn:bucket_name/dest_dir /mnt/nfs/restore/source_dir
```

なおコマンド中の **rclone_conn** 、 **bucket_name** 、 **dest_dir** 、及び **source_dir** は、自身の環境に置き換えて指定します。

***
# 2. バックアップ・リストア時の制約事項

本章は、本テクニカルTipsで比較・検証するバックアップツールを **[1. バックアップツール検証時前提条件](#1-バックアップツール検証時前提条件)** で示した条件で利用する際、通常バックアップに求められる機能が満たせないような制約事項について、その評価項目と各バックアップツールの対応を以下の表にまとめます。  
この制約事項の多くは、POSIXファイルシステムのメタデータをバックエンドストレージの **オブジェクト・ストレージ** がサポートしていないことに起因します。

| No. | 評価項目                   | OCI CLI | OCIFS | Rclone |
| :-: | :--------------------: | :---------: | :-------: | :--------: |
| 1   | オーナーユーザーの保存            | ✖（※1）       | △（※2）     | ✖（※1）      |
| 2   | オーナーグループの保存            | ✖（※1）       | △（※2）     | ✖（※1）      |
| 3   | パーミッションの保存             | ✖（※3）       | △（※4）     | ✖（※3）      |
| 4   | ファイル作成・更新日時の保存         | ✖（※5）       | △（※6）     | 〇          |
| 5   | ファイル属性変更日時の保存          | ✖（※5）       | ✖（※5）     | ✖（※5）      |
| 6   | ディレクトリ作成・更新日時の保存       | ✖（※5）       | △（※6）     | ✖（※5）      |
| 7   | ハードリンクの保存              | ✖（※7）       | ✖（※7）     | ✖（※7）      |
| 8   | シンボリックリンクの保存           | ✖（※8）       | ✖         | ✖（※9）      |
| 9   | 空のディレクトリの保存            | 〇           | 〇         | ✖          |
| 10  | キャシュをローカルファイルシステムに持たない | 〇           | ✖（※10）    | 〇          |
|11|チェックサムによる<br>ファイル転送結果確認機能を持つ|✖|✖|〇|

※1）リストア実行ユーザとそのプライマリグループになります。  
※2）再マウントでマウント実行ユーザとそのプライマリグループになります。  
※3）全てのファイルとディレクトリはそれぞれ **644** と **755** でリストアされます。  
※4）再マントで全てのファイルとディレクトリはそれぞれ **644** と **755** になります。  
※5）リストア時の日時になります。  
※6）再マウントでリストア時の日時になります。  
※7）リンク数分のファイルの実体としてリストアされます。  
※8）参照元ファイルの実体としてリストアされます。  
※9）参照元ファイルの実体としてリストアされます。（ **--copy-links** オプション指定による挙動です。）  
※10）**オブジェクト・ストレージ** にアクセス（書込み・読込みの何れも含みます。）するファイルサイズの総容量に等しいキャッシュ用途の空き容量がローカルファイルシステムに必要です。このためフルバックアップは、バックアップ対象のファイル共有ストレージの総使用量以上の空き容量をローカルファイルシステムに用意する必要があります。 **OCIFS** のキャッシュに関する詳細は、 **OCI** 公式ドキュメントの **[ここ](https://docs.oracle.com/ja-jp/iaas/oracle-linux/ocifs/index.htm#ocifs-cache-options)** を参照してください。

この結果から各バックアップツールを比較すると、以下のように考察することが出来ます。

1. 評価項目 **10** から、 **OCIFS** は容量単価の安価な **オブジェクト・ストレージ** をバックエンドストレージに利用するメリットを享受できない。
2. 評価項目 **1** 、 **2** 、 **3** 、 **4** 、及び **6** から、POSIXファイルシステムのメタデータ保持に関する **OCIFS** の優位性は、バックアップサーバの再起動等で発生する再マウントによりキャシュ領域に保持しているメタデータ情報が消失するため、現実的な運用ではこれを享受することが出来ない。  
3. 評価項目 **4** から、 **Rclone** はファイル作成・更新日時を保持できる点で優位性がある。  
4. 評価項目 **11** から、 **Rclone** はバックアップの信頼性で優位性がある。

以上より、考察 **1** で<u><strong>OCI CLI</strong>か<strong>Rclone</strong>が現実的な選択肢</u>となり、考察 **3** と **4** で<u><strong>Rclone</strong>に優位性がある</u>ことになります。

***
# 3. バックアップ・リストア性能

本章は、 **[1. バックアップツール検証時前提条件](#1-バックアップツール検証時前提条件)** で示した条件に於ける各バックアップツールのバックアップ時とリストア時の性能を、以下の観点で検証します。

- スループット  
サイズの大きなファイルをバックアップ・リストアする際の性能指標として、以下の条件でスループット（単位時間当たりの転送データ量 **MiB/s** ）を計測します。  
この際、ファイルシステムキャッシュを無効化した後に計測します。（※11）
  - テストファイルサイズ： 10 GiB
  - テストファイル作成方法： /dev/urandomを元にddで作成（※12）
  - テストファイル数： 1
- メタデータ性能  
サイズの小さなファイルをバックアップ・リストアする際の性能指標として、以下の条件でメタデータ性能（単位時間当たりの作成ファイル数 **files/s** ）を計測します。
  - テストファイルサイズ： 0 B
  - ディレクトリ数： 1,000
  - ディレクトリ当たりファイル数： 1,000
  - 総ファイル数： 1,000,000（※13）

※11）以下のコマンドをバックアップサーバのopcユーザで実行します。

```sh
$ sync && echo 3 | sudo tee /proc/sys/vm/drop_caches
```

※12）以下のコマンドでテストファイルを作成します。

```sh
$ dd if=/dev/urandom of=./10G.bin bs=1048576 count=$((1024*10))
```

※13）以下のコマンドでテストファイルを作成します。

```sh
$ count=1000; for i in `seq -w 1 $count`; do echo $i; mkdir $i; cd $i;for j in `seq -w 1 $count`; do fname=$j".out"; touch $fname; done; cd ..; done
```

以下の表は、以上の条件で計測したバックアップ・リストア性能です。（各データは3回計測した平均値です。）  
なおこの性能値は、状況により変化するため、参考値としてご利用ください。

| No. | 評価項目              | OCI CLI        | OCIFS          | Rclone         |
| :-: | :---------------: | -----------------: | -----------------: | -----------------: |
| 1   | バックアップ<br>スループット  | 665 MiB/s<br>（※14） | 46 MiB/s           | 301 MiB/s<br>（※14） |
| 2   | バックアップ<br>メタデータ性能 | 238 files/s        | 3 files/s<br>（※15） | 2,857 files/s      |
| 3   | リストア<br>スループット    | 417 MiB/s<br>（※14） | 4 MiB/s            | 217 MiB/s<br>（※14） |
| 4   | リストア<br>メタデータ性能   | 128 files/s        | 259 files/s        | 1,927 files/s      |

※14）**OCI CLI** と **Rclone** のスループットの差は、ファイル転送前後のチェックサムによる結果確認の有無が影響していると考えられ、 **Rclone** はチェックサム確認を実施するのに対し、 **OCI CLI** はチェックサム確認の機能を有していません。  
※15）性能が悪く途中で検証を打ち切ったため、途中経過から算出した概略値です。

この結果から各バックアップツールを比較すると、以下のように考察することが出来ます。

1. 評価項目 **2** から、 **OCIFS** をバックアップツールとして利用することは現実的ではない。  
2. 評価項目 **1** と **3** から、 **OCI CLI** は **Rclone** に対して約2倍のスループットを示し、サイズの大きなファイルが存在するファイル共有ストレージのバックアップに於いて有利である。（この理由は、※14）を参照してください。）  
3. 評価項目 **2** と **4** から、 **Rclone** は **OCI CLI** に対してメタデータ性能が桁違いに高く、ファイル数が多いファイル共有ストレージのバックアップで圧倒的に有利である。

以上より、考察 **1** で <u><strong>OCI CLI</strong>か<strong>Rclone</strong>が現実的な選択肢</u>となり、考察 **2** と **3** で<u><strong>OCI CLI</strong>と<strong>Rclone</strong>のどちらを選択するかはバックアップ対象のファイルサイズ分布で判断する</u>のが良いと考えることが出来ます。
