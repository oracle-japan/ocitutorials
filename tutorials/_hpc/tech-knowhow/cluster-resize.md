---
title: "計算ノードの追加・削除・入れ替え方法"
excerpt: "HPCクラスタやGPUクラスタは、実行するワークロードの増減に伴い計算/GPUノードのノード数を増減する必要が生じることがあります。またハードウェア障害が発生すると、利用可能なノード数を維持するために該当ノードを別のノードに置き換える必要が生じます。本テクニカルTipsは、クラスタ・ネットワークを使用するHPC/GPUクラスタで計算/GPUノードのノード数を増減する方法や置き換える方法を解説します。"
order: "334"
layout: single
header:
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://community.oracle.com/tech/welcome/discussion/4474261/
---

HPCクラスタやGPUクラスタは、実行するワークロードの増減に伴い計算/GPUノードのノード数を増減する必要が生じることがあります。またハードウェア障害が発生すると、利用可能なノード数を維持するために該当ノードを別のノードに置き換える必要が生じます。  
本テクニカルTipsは、 **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** を使用するHPC/GPUクラスタで計算/GPUノードのノード数を増減する方法や置き換える方法を解説します。

***
# 0. 概要

HPC/GPUクラスタのノード数を増減させたり既存の計算/GPUノードを置き換える際、これらのノードが通常同一の **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** に接続されている必要があることから、クラスタ・ネットワークを使用しないインスタンスとは異なる手順が必要になります。  
そこで本テクニカルTipsでは、これらの手順を以下の3ケースに分けて解説します。

- ノード数を減らす
- ノード数を増やす
- ノードを置き換える

***
# 1. ノード数を減らす

## 1-0. 概要

ノード数を減らす場合、終了するノードを指定する方法と終了するノードをOCIに任せる方法があります。

終了するノードをOCIに任せる方法は、 **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** に接続するどのノードを終了しても構わないが複数のノードを一度に減らす際に有効で、最も作成日の古いものから終了の対象として選択されます。  
これに対して終了するノードを指定する方法は、一度に終了するノードは1ノードだが終了するノードを特定する必要がある際に有効です。

## 1-1. 終了するノードを指定する方法

本章は、計算/GPUノードを減らす際、終了するノードを指定する方法を解説します。

1. OCIコンソールメニューから **コンピュート** → **クラスタ・ネットワーク** を選択し、表示される以下画面で、ノード数を減らす **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** をクリックします。

   ![画面ショット](console_page01.png)

2. 表示される以下画面の **インスタンス・プール** フィールドで、クラスタ・ネットワークの作成に伴い作成されたインスタンスプールをクリックします。

   ![画面ショット](console_page02.png)

3. 表示される以下画面左下の **アタッチされたインスタンス** メニューをクリックします。

   ![画面ショット](console_page03.png)

4. 表示される画面の以下 **アタッチされたインスタンス** フィールドで、終了するインスタンスのメニューから **インスタンスのデタッチ** メニューをクリックします。

   ![画面ショット](console_page04.png)

5. 表示される以下画面で、 **このインスタンスおよびアタッチされたブート・ボリュームを完全に終了（削除）** チェックボックスをチェックし、 **デタッチと終了** ボタンをクリックします。

   ![画面ショット](console_page05.png)

6. OCIコンソールメニューから **コンピュート** → **インスタンス** とメニューを辿り、デタッチしたインスタンスが終了されれば、手順完了です。

## 1-2. 終了するノードをOCIに任せる方法

本章は、計算/GPUノードを減らす際、終了するノードをOCIに任せる方法を解説します。

1. OCIコンソールメニューから **コンピュート** → **クラスタ・ネットワーク** を選択し、表示される以下画面で、ノード数を減らす **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** をクリックします。

   ![画面ショット](console_page01.png)

2. 表示される以下画面で、 **編集** ボタンをクリックします。

   ![画面ショット](console_page06.png)

3. 表示される以下 **クラスタ・ネットワークの編集** サイドバーで、 **インスタンス数** フィールドに減らした後の新しいノード数を入力し **変更の保存** ボタンをクリックします。

   ![画面ショット](console_page07.png)

4. 表示される以下 **クラスタ・ネットワーク・インスタンス・プール** ウィンドウで、左上のステータスが **スケーリング中** → **完了** と遷移したら、手順完了です。

   ![画面ショット](console_page08.png)

5. 同じウィンドウ下方の以下 **インスタンス・プール** フィールドで、 **インスタンス数** が新しいノード数に変わっていることを確認します。

   ![画面ショット](console_page09.png)

***
# 2. ノード数を増やす

## 2-0. 概要

ノード数を増やす場合、通常追加するノードは既存のノードと同じ **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** に接続する必要があります。  
この際、同一のクラスタ・ネットワークに追加できるその時点で利用可能なインスタンスが有限であることから、既存のクラスタ・ネットワークに接続するノード数の増加は、必ずしも成功するわけではない点に留意する必要があります。

もしノード数を増やした際にこの制限で失敗する場合は、その対策として以下の選択肢が考えられます。

- ノード数増加手順のリトライ  
インスタンスの空きが発生するタイミングを狙い、時間をおいてノード数増加手順をリトライします。  
ただこの方法は、他のユーザがインスタンスを終了する等のタイミングに出くわさない限り、同様に失敗します。
- 新たなクラスタ・ネットワークの作成  
追加するノードが既存のノードとクラスタ・ネットワークを介して通信する必要が無い場合、既存のクラスタ・ネットワークはそのままに、追加するノード数の計算/GPUノードを新たにクラスタ・ネットワークとともにデプロイします。
- クラスタ・ネットワーク再作成  
既存のクラスタ・ネットワークを計算/GPUノードと共に一旦終了し、新たに追加後のノード数の計算/GPUノードをクラスタ・ネットワークからデプロイします。

以上の背景から、運用中にHPC/GPUクラスタのノード数を増やす可能性がある場合や、ハードウェア障害による利用可能なノード数の減少に備えて、予めその分のノード数を含めた計算/GPUノードのクラスタ・ネットワークを作成しておくことで、既存のクラスタ・ネットワークに接続するノード数増加時の問題を回避することが出来ます。  
例えば、運用に必要なノード数が128ノードの場合、129ノードでクラスタ・ネットワークを構築してそのうちの128ノードを運用に供し、運用中の128ノードのうち1ノードでハードウェア障害等の問題が発生したら、このノードを運用から外して予備ノードを運用に組み込む、という運用方針が考えられます。

なお、既存クラスタ・ネットワークのノード数を増やすことがその時点で利用可能なインスタンスの不足により失敗する場合は、当該クラスタ・ネットワークの以下 **作業リクエスト** メニューを選択し、

![画面ショット](console_page11.png)

表示される以下画面の **作業リクエスト** フィールドでノード数増加により生成されたエントリの該当する **操作** を選択し、

![画面ショット](console_page12.png)

表示される以下画面の **エラー・メッセージ** メニューをクリックし、

![画面ショット](console_page13.png)

以下のように **Insufficient capacity for cluster network based on the cluster network placement constraints.** メッセージが表示されることを以って、これを確認することが出来ます。

![画面ショット](console_page14.png)

## 2-1. ノード数を増やす方法

本章は、計算/GPUノードを増やす方法を解説します。

1. OCIコンソールメニューから **コンピュート** → **クラスタ・ネットワーク** を選択し、表示される以下画面で、ノード数を増やす **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** をクリックします。

   ![画面ショット](console_page01.png)

2. 表示される以下画面で、 **編集** ボタンをクリックします。

   ![画面ショット](console_page06.png)

3. 表示される以下 **クラスタ・ネットワークの編集** サイドバーで、 **インスタンス数** フィールドに増やした後の新しいノード数を入力し **変更の保存** ボタンをクリックします。

   ![画面ショット](console_page07.png)

4. 表示される以下 **クラスタ・ネットワーク・インスタンス・プール** ウィンドウで、左上のステータスが **スケーリング中** → **完了** と遷移したら、手順完了です。

   ![画面ショット](console_page08.png)

5. 同じウィンドウ下方の以下 **インスタンス・プール** フィールドで、 **インスタンス数** が新しいノード数に変わっていることを確認します。

   ![画面ショット](console_page09.png)

***
# 3. ノードを置き換える

## 3-0. 概要

ノードを置き換える場合、置き換える新しいノードが受けるノード数を増やす場合と同様の **[2-0. 概要](#2-0-概要)** に記載の制約から、必ずしも成功するわけではない点に留意します。

## 3-1. ノードを置き換える方法

本章は、計算/GPUノードを置き換える方法を解説します。

1. OCIコンソールメニューから **コンピュート** → **クラスタ・ネットワーク** を選択し、表示される以下画面で、置き換えられるノードが接続する **[クラスタ・ネットワーク](/ocitutorials/hpc/#5-1-クラスタネットワーク)** をクリックします。

   ![画面ショット](console_page01.png)

2. 表示される以下画面の **インスタンス・プール** フィールドで、クラスタ・ネットワークの作成に伴い作成されたインスタンスプールをクリックします。

   ![画面ショット](console_page02.png)

3. 表示される以下画面左下の **アタッチされたインスタンス** メニューをクリックします。

   ![画面ショット](console_page03.png)

4. 表示される画面の以下 **アタッチされたインスタンス** フィールドで、置き換えられるインスタンスのメニューから **インスタンスのデタッチ** メニューをクリックします。

   ![画面ショット](console_page04.png)

5. 表示される以下画面で、 **このインスタンスおよびアタッチされたブート・ボリュームを完全に終了（削除）** と **プールのインスタンス構成をインスタンスのテンプレートとして使用し、インスタンスを新しいインスタンスで置き換える** チェックボックスをチェックし、 **デタッチと終了** ボタンをクリックします。

   ![画面ショット](console_page10.png)

6. OCIコンソールメニューから **コンピュート** → **インスタンス** とメニューを辿り、デタッチしたインスタンスが終了し、新たなインスタンスが起動されれば、手順完了です。