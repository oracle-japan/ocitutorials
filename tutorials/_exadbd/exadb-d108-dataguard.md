---
title: "108 : Data Guardを構成しよう"
excerpt: "ExaDB-DでData Guardを構成する方法について紹介します。"
order: "2_108"
layout: single
header:
  teaser: "/exadbd/exadb-d108-dataguard/teaser.png"
  overlay_image: "/exadbd/exadb-d108-dataguard/teaser.png"
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://apexapps.oracle.com/pls/apex/dbpm/r/livelabs/view-workshop?wid=797
---

<a id="anchor0"></a>

# はじめに
**Oracle Data Guard**とは、変更履歴(REDO)を利用して自動でリアルタイム・データベース複製を持つことが出来る機能です。この機能を利用することによって、データベース障害やリージョン障害などのRTO/RPOを短くすることができ、広範囲な計画停止(メンテナンス)においてもスタンバイをプライマリに切り替えることによって停止時間を極小化することが可能です。バックアップを取得していても、有事の際の復旧において、大量データのリストアが必要になる場合ではRTOを満たせないケースもあります。こういったケースに備えて、バックアップだけでなく、すぐに切り替えられるスタンバイを持つことは重要です。災害対策(DR)としてのデータ保護はもちろんのこと、移行やアップグレードの停止時間短縮といった利用用途もあります。また、参照専用として利用可能なActive Data Guardにしたり、一時的に読み書き可能なスナップショット・スタンバイとして利用したりと、普段から利用できるスタンバイ・データベースを持つことができます。参照処理をオフロードしたり、この仕組みを応用してデータ破損が検知された場合にクライアントにエラーを返すことなく自動修復をしてくれる自動メディア・ブロックリカバリ機能も使えるため、Data Guardであればスタンバイのリソースも有効活用してROIを高めつつ、きちんと切り替えられるスタンバイを持つということが可能です。

ここでは、OCIコンソールからExaDB-Dで別リージョン間(東京、大阪)でのData Guardを構成する手順について紹介します。東京をプライマリ、大阪をスタンバイとして構成します。使用するリージョンは任意です。

**目次 :**
+ [1. Data Guardの構成](#1-data-guardの構成)
+ [2. Data Guardの切り替え](#2-data-guardの切り替え)
    - [スイッチオーバー](#anchor2-1)
    - [フェイルオーバー](#anchor2-2)
    - [回復](#anchor2-3)
+ [3. Data Guard構成に含まれるDBの削除方法](#3-data-guard構成に含まれるdbの削除方法)


**前提条件 :**
+ [101 : ExaDB-Dを使おう](/ocitutorials/exadbd/exadb-d101-create-exadb-d){:target="_blank"}を通じて、プライマリ・データベースのリージョン（本ガイドでは東京リージョン）でExaDB-Dの作成が完了していること。
+ [その2 - クラウドに仮想ネットワーク(VCN)を作る](/ocitutorials/beginners/creating-vcn/){:target="_blank"}を通じて、スタンバイ・データベースのリージョン（本ガイドでは大阪リージョン）でVCNの作成が完了していること。
+ プライマリ・データベースのリージョン（本ガイドでは東京リージョン）とスタンバイ・データベースのリージョン（本ガイドでは大阪リージョン）間でリモートVCNピアリングの設定が完了していること。設定方法については、[Oracle Cloud Infrasturctureドキュメント - DRGを介した異なるリージョン内のVCNのピアリング](https://docs.oracle.com/ja-jp/iaas/Content/Network/Tasks/scenario_e.htm#scenario_e){:target="_blank"}をご参照ください。
+ プライマリ・データベースのリージョン（本ガイドでは東京リージョン）とスタンバイ・データベースのリージョン（本ガイドでは大阪リージョン）のそれぞれのVCNのセキュリティ・リストの設定でポート1521を開く。設定方法については、[Oracle Cloud Infrastructureドキュメント - セキュリティ・リスト](https://docs.oracle.com/ja-jp/iaas/Content/Network/Concepts/securitylists.htm){:target="_blank"}をご参照ください。

**所要時間 :** 約2時間　※環境によって異なるため、参考値です。

<BR>

# 1. Data Guardの構成

1. OCIコンソール・メニューから **Oracle Database** → **Oracle Public Cloud上のExadata** に移動します。

    ![](2022-11-04-17-13-56.png)

1. 利用したいコンパートメントを**リスト範囲**の**コンパートメント**から選択します。

    ![](2022-11-15-16-30-05.png)

1. 利用したいリージョンを右上のリージョンの折りたたみメニューをクリックして、**リージョン**の一覧から選択します。

    ![](2022-11-15-16-32-47.png)

1.  操作したい**Exadata VMクラスタ**の表示名をクリックします。

    ![](2022-12-27-16-19-24.png)

1. **データベース**の一覧から対象のデータベースの名前をクリックします。

    ![](2022-12-27-16-22-18.png)

1. **リソース**の一覧から**Data Guardアソシエーション**をクリックし、**Data Guardの有効化**をクリックします。

    ![](2022-12-27-16-24-22.png)

1. **Data Guardの有効化** の各項目は以下のように設定します。その他の設定はデフォルトのままにします。
    + **ピアDBシステムの選択**
        + **リージョン** - スタンバイ・データベースを作成したいリージョン（本ガイドでは大阪リージョン）
        + **可用性ドメイン** - 任意
        + **シェイプ** - スタンバイ・データベースを作成したいVMクラスタのシェイプ
        + **Data Guardピア・リソース・タイプ** - VMクラスタ
        + **[コンパートメント名]のVMクラスタの選択** - スタンバイ・データベースを作成したいVMクラスタを選択

    ![](2022-12-27-16-38-37.png)
    
    + **Data Guardアソシエーション詳細**
        + **Data Guardタイプ** - **アクティブなData Guard**か**Data Guard**を選択します。（本ガイドでは、**Data Guard**を選択します。）

    ![](2022-12-27-16-41-04.png)

    + **データベース・ホームの選択**
        + **データベース・ホームの構成** - **既存のデータベース・ホームの選択**か**新規データベース・ホームの作成**を選択します。（本ガイドでは、**新規データベース・ホームの作成**を選択します。）
        + **データベース・イメージの変更** - カスタム・イメージを使用したい場合は**データベース・イメージの変更**ボタンをクリックし、作成済みのカスタム・イメージを選択します。（本ガイドでは、変更はせずに進みます。）
    + **スタンバイ・データベースの構成**
        + **データベース・パスワード** - データベースの管理パスワードを入力します。スタンバイ・データベース管理パスワードは、プライマリ・データベースの管理パスワードと同じである必要があります。  

    設定後、**Enable data guard** をクリックします。作成まで1時間ほどかかります。（作成時間は環境によって異なります。）

    ![](2022-12-27-16-51-43.png)

    ![](2022-12-27-16-52-22.png)

    完了すると、プライマリ・データベースとスタンバイ・データベースが使用可能な状態に切り替わります。

    ![](2022-12-27-16-55-42.png)

    ![](2022-12-27-16-57-39.png)

1. プライマリ・データベースのリージョン（本ガイドでは東京リージョン）の**データベース詳細**の**リソース**の一覧から**Data Guardアソシエーション**をクリックし、スタンバイ・データベースの情報が追加されていることを確認します。

    ![](2022-12-27-17-04-31.png)

1. スタンバイ・データベースのリージョン（本ガイドでは大阪リージョン）の**データベース詳細**の**リソース**の一覧から**Data Guardアソシエーション**をクリックし、プライマリ・データベースの情報が追加されていることを確認します。

    ![](2022-12-27-17-05-36.png)

<BR>

# 2. Data Guardの切り替え 

コンソールやCLIから、簡単にData Guardの切り替え(スイッチオーバー、フェイルオーバー)や、旧プライマリの回復(フェイルオーバー実施後に旧プライマリ・データベースを簡単にスタンバイとして復旧)が可能です。

<a id="anchor2-1"></a>

## スイッチオーバー

スイッチオーバーは主に計画停止用途のもので、スタンバイにREDOを転送・適用をしきった状態で、プライマリとスタンバイを切り替えます。そのため、切り替え後には旧プライマリは新スタンバイとしてData Guard構成を保った状態となります。

1. プライマリ・データベースのリージョン（本ガイドでは、東京リージョン）の**データベース詳細**の**リソース**の一覧から**Data Guardアソシエーション**をクリックし、**アクション・ボタン**をクリックし、**スイッチオーバー**をクリックします。

    ![](2022-12-28-09-52-40.png)

1. **データベース管理パスワード**を入力し、**OK**ボタンをクリックします。プライマリ・データベースの管理パスワードとスタンバイ・データベース管理パスワードは同じパスワードが設定されています。

    ![](2022-12-28-09-53-20.png)

1. データベースの状態が**更新中**になります。

    ![](2022-12-28-09-57-32.png)

1. データベースの状態が**使用可能**になるとプライマリ・データベース（本ガイドでは、東京リージョン）とスタンバイ・データベース（本ガイドでは、大阪リージョン）のそれぞれの**データベース・ロール**が切り替わります。

    旧プライマリ・データベース（本ガイドでは、東京リージョン）の**データベース・ロール**が**Standby**に切り替わっている

    ![](2023-04-01-00-10-22.png)

    旧スタンバイ・データベース（本ガイドでは、大阪リージョン）の**データベース・ロール**が**Primary**に切り替わっている

    ![](2023-04-01-00-10-34.png)

<a id="anchor2-2"></a>

## フェイルオーバー

フェイルオーバーは主に計画外停止用途のもので、プライマリ側が利用できない状態の際にスタンバイ側に切り替える際に用いられます。旧プライマリは壊れている状態で切り替えられ、非同期転送をしている場合には未転送分データがない可能性もあり、基本的には切り替え後にスタンバイがない構成となります。そのため、フェイルオーバー後にもData Guardでの可用性構成を組むために、スタンバイを作成して再度Data Guardを構成することが必要となります。

1. スタンバイ・データベースのリージョン（本ガイドでは東京リージョン）の**データベース詳細**の**リソース**の一覧から**Data Guardアソシエーション**をクリックし、**アクション・ボタン**をクリックし、**フェイルオーバー**をクリックします。

    ![](2022-12-28-10-19-28.png)

1. **データベース管理パスワード**を入力し、**OK**ボタンをクリックします。プライマリ・データベースの管理パスワードとスタンバイ・データベース管理パスワードは同じパスワードが設定されています。

    ![](2022-12-28-10-20-45.png)

1. データベースの状態が**更新中**になります。

    ![](2022-12-28-10-21-23.png)

1. データベースの状態が**使用可能**になるとスタンバイ・データベース（本ガイドでは、東京リージョン）とプライマリ・データベース（本ガイドでは、大阪リージョン）のそれぞれの**データベース・ロール**が変更されます。

    旧スタンバイ・データベース（本ガイドでは、東京リージョン）の**データベース・ロール**が**Primary**に切り替わっている

    ![](2023-04-01-00-11-57.png)

    旧プライマリ・データベース（本ガイドでは、大阪リージョン）の**データベース・ロール**が**Disabled Standby**に切り替わっている

    ![](2023-04-01-00-12-13.png)

<a id="anchor2-3"></a>

## 回復

フェイルオーバー後に活用されるのがFlashback Database機能です。旧プライマリを障害発生直前(スタンバイが切り替わる前の時点)までデータを戻し(フラッシュバック)、スタンバイにロールを変換してData Guard構成に組み込まれ、フラッシュバックしたことで生じる差分も自動で同期されるため、一からスタンバイを構築する必要はありません。そのため、ExaDB-DのData Guard機能では、コンソール上の『回復』というボタンをクリックするだけで簡単にData Guardが再構成されます。

1. プライマリ・データベースのリージョン（本ガイドでは東京リージョン）の**データベース詳細**の**リソース**の一覧から**Data Guardアソシエーション**をクリックし、**アクション・ボタン**をクリックし、**回復**をクリックします。

    ![](2022-12-28-10-30-42.png)

1. **データベース管理パスワード**を入力し、**OK**ボタンをクリックします。プライマリ・データベースの管理パスワードとスタンバイ・データベース管理パスワードは同じパスワードが設定されています。

    ![](2022-12-28-10-32-26.png)

1. データベースの状態が**更新中**になります。

    ![](2022-12-28-10-32-34.png)

1. データベースの状態が**使用可能**になると、**Disabled Standby**であったデータベース（本ガイドでは、大阪リージョン）の**データベース・ロール**が**Standby**に回復されます。

    ![](2023-04-01-00-14-56.png)

# 3. Data Guard構成に含まれるDBの削除方法

Data Guardアソシエーションに含まれるデータベースもしくはDBシステムを削除する場合、最初にスタンバイ・データベース(DBシステム)を削除しましょう。スタンバイ・データベースが紐づけられている状態の時に、プライマリ・データベースを削除しようとするとエラーが表示され、削除できません。もし、プライマリ・データベースの環境のみを削除したい場合には、一度ロールを切り替えて削除対象の環境をスタンバイ・ロールにしてから削除という形をとって頂ければと思います。

プライマリ・データベースから削除しようとした場合の例

![](2022-12-28-10-39-31.png)

![](2022-12-28-10-40-13.png)


<BR>

以上で この章の作業は完了です。

<BR>

<a id="anchor11"></a>

# 参考資料
+ [Oracle Cloud Infrastructure Documentation - Oracle Exadata Database Service on Dedicated Infrastructure](https://docs.oracle.com/en-us/iaas/exadatacloud/index.html){:target="_blank"}
+ [Oracle Cloud Infrastructure Exadata Database Service on Dedicated Infrastructure (ExaDB-D) サービス詳細](https://speakerdeck.com/oracle4engineer/exadata-database-cloud-technical-detail){:target="_blank"}

<BR>

[ページトップへ戻る](#anchor0)
