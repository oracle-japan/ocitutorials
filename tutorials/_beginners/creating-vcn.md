---
title: "その2 - クラウドに仮想ネットワーク(VCN)を作る"
excerpt: "クラウドの最初の一歩は、クラウド上に皆さん専用のネットワーク(VCN)を作るところから始まります。難しい作業は必要ありません。まずはやってみましょう!!"
order: "020"
header:
  teaser: "/beginners/creating-vcn/1_overviewVCN.png"
  overlay_image: "/beginners/creating-vcn/1_overviewVCN.png"
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://community.oracle.com/tech/welcome/discussion/4474255/
---
**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)

このチュートリアルでは、コンソール画面から**仮想クラウド・ネットワーク(Virtual Cloud Network : VCN)** を1つ作成し、その構成について確認してくことで、OCIのネットワークに対する理解を深めます。<br>
**注意 :** チュートリアル内の画面ショットについては Oracle Cloud Infrastructure の現在のコンソール画面と異なっている場合があります

**所要時間 :** 約15分

**前提条件 :**
1. Oracle Cloud Infrastructure の環境(無料トライアルでも可) と、管理権限を持つユーザーアカウントがあること
2. [その1 - OCIコンソールにアクセスして基本を理解する](../getting-started)を完了していること



**目次：**
---
- [1. 仮想クラウドネットワーク(VCN)とは?](#1-仮想クラウドネットワークvcnとは)
- [2. 複数のコンポーネント含めたVCNをウィザードで一括作成する](#2-複数のコンポーネント含めたvcnをウィザードで一括作成する)
- [3 作成されたリソースを確認する](#3-作成されたリソースを確認する)
- [4. インターネットからインスタンスへSSH接続するときのパケットの動き](#4-インターネットからインスタンスへssh接続するときのパケットの動き)

   **参考動画：**本チュートリアルの内容をベースとした定期ハンズオンWebinarの録画コンテンツです。操作の流れや解説を動画で確認したい方はご参照ください。

   - [Oracle Cloud Infrastructure ハンズオン - 2.仮想クラウドネットワーク](https://videohub.oracle.com/media/Oracle+Cloud+Infrastructure+%E3%83%8F%E3%83%B3%E3%82%BA%E3%82%AA%E3%83%B3+-+2.%E4%BB%AE%E6%83%B3%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF/1_wkkm6sru)


<a id="anchor1"></a>


## 1. 仮想クラウドネットワーク(VCN)とは? 
**仮想クラウド・ネットワーク(Virtual Cloud Network : VCN)**とは、Oracle Cloud Infrastructure内に作成するソフトウェア定義のプライベートなネットワークです。<br>
VCNというネットワーク空間を作ることで、インスタンスやストレージなどのコンポーネントをネットワーク上に配置し、それらが通信できるようになります。

**VCNのコンポーネント**
---


仮想クラウドネットワーク(VCN)は以下のようなコンポーネントから構成されています。<br>
① **VCN (Virtual Cloud Network)** <br>
② **サブネット** <br>
③ **ゲートウェイ** <br>
④ **ルート表** <br>
⑤ **セキュリティリスト** <br>
<br>
*その他のリソース :* VNIC、IPアドレス、ネットワークセキュリティグループ、プライベートDNSなど<br>

   ![image.png](1_overviewVCN.png)

**ポイント** <br>
・上記①〜⑤が主要コンポーネント <br>
・このコンポーネントの役割を理解する<br>
・さらにこれらリソースがどのリソースと紐づいているかを意識する
{: .notice--info}

<a id="anchor2"></a>

## 2. 複数のコンポーネント含めたVCNをウィザードで一括作成する 
- **左上のナビゲーションメニュー → ネットワーキング → 「仮想クラウド・ネットワーク」を選択** 

   ![image.png](2_SelectNetwork.png)

- **白い「アクション」タブ→「VCNウィザードの起動」をクリック** （「VCNの作成」ボタンはVCNしか作成されません）
- **「インターネット接続性を持つVCNの作成」**が選択されていることを確認して、VCNウィザードの起動をクリック
    ![image.png](2_selectWizardAndInternet.png)

- 「VCN名」に任意の名前を入力して 下の**次**をクリック （この名前は他の自動で作成されるコンポーネントにも使われます。）
- コンパートメントには現在のコンパートメントが表示されています。別のコンパートメントに作成する場合は変更できます。

    ![image.png](2_InputVCNName.png)

- 作成されるリソース一覧を確認して **作成** 

    ![image.png](2_ConfirmVCN.png)

- *結果:* インターネットからアクセス可能な環境が自動生成されました。

    ![image.png](2_VCNdetails.png)


<a id="anchor3"></a>

## 3. 作成されたリソースを確認する
ここからはインターネットへの接続設定が構成されているVCNとその中にあるコンポーネントを確認していきます。<br>


## ① VCN 
- CIDR 範囲: `10.0.0.0/16` (ウィザードでデフォルトで入っていた値) 
- このVCNで使われるDNSドメイン名は <名前>.oraclevcn.com であることを確認します

    ![image.png](3_VCN.png)

## ② サブネット
サブネットはVCNを分割して作成されるネットワークです。 
VCN詳細画面の上の「サブネット」の欄を見ます。<br>10.0.0.0/16というネットワークから10.0.0.0/24と10.0.1.0/24の小さなネットワークを切り出しています。


   ![image.png](3_subnet.png)

サブネットには2つの種類があります。

| 種類 | サブネット名 | CIDR | 備考　|
|------|------|------|------|
| パブリックサブネット | パブリック・サブネット-<入力名> | 例:`10.0.0.0/24` |パブリックIPが使えます|
| プライベートサブネット | プライベート・サブネット-<入力名> | 例:`10.0.1.0/24` |プライベートIPのみが使えます|

この二種類の違いについてはパブリックIPアドレスを付与できるかできないかの違いで覚えておきましょう。<br>パブリックIPアドレスとは全世界で被らないIPアドレスなので、インターネットから到達することができます。


## ③ ゲートウェイ
ゲートウェイはVCNのネットワークの境界に位置し、ネットワークの出入り口となるコンポーネントです。 
ウィザードによって3つのゲートウェイが作成されています。


   ![image.png](3_gateway.png)


| 種類 | ゲートウェイ名 | 用途 |
|------|------|------|
| インターネットゲートウェイ | インターネット・ゲートウェイ-<入力名> | パブリックサブネットからインターネットへ行くため |
|NATゲートウェイ |NATゲートウェイ-<入力名> |プライベートサブネットからインターネットへ行くため|
|サービスゲートウェイ|サービスゲートウェイ-<入力名> |Oracle Services Networkというリージョン内サービスへ行くため| 

 ウィザードでは作成されませんが、他のゲートウェイとして動的ルーティングゲートウェイ (DRG) やローカル・ピアリング・ゲートウェイがあります。


## ④ ルート表 
ルート表はサブネット内から出ていく通信が次にどこへ行くかを示すコンポーネントです。<br>

ウィザードによって2つのルート表が作成されており、この2つのルート表はそれぞれパブリックサブネットとプライベートサブネットに紐づいています。

   ![image.png](3_routetable.png)


| ルート表の名前 | 紐づくサブネット | 適用される通信 |
|------|------|------|
| default route table for <入力名> | パブリックサブネット | パブリックサブネットから出ていく通信 |
| route table for private プライベート・サブネット-<入力名> | プライベートサブネット | プライベートサブネットから出ていく通信 |

次にパブリックサブネットに紐づくdefault route tableの中身を見てみましょう。
- 宛先：`0.0.0.0/0`
- ターゲット：インターネットゲートウェイ


つまり、パブリックサブネット内のインスタンスからサブネットの外に出るとき、全ての通信（0.0.0.0/0）がインターネットゲートウェイへ行くことになります。<br>
同様にプライベートサブネットに紐づくルート表はNATゲートウェイとサービスゲートウェイへのルートルールがあります。

   ![image.png](3_routetableAndDetail.png)



ちなみに、ルート表がどのサブネットに紐づいているかを確認するには、サブネットの詳細画面から確認します。
default route table for <入力名>はパブリックサブネットに紐づいています。プライベートサブネット用のルート表も同様にプライベートサブネットの詳細画面から確認できます。

<img  width="700" alt="img1.png" src="3_routetableSubnet.png">

## ⑤ セキュリティリスト 
セキュリティリストはファイアウォールのようなコンポーネントで許可する通信を記述します。<br>
セキュリティリストはサブネットに紐づいてます。
ウィザードによって2つのセキュリティリストが作成されています。

   ![image.png](3_securitylist.png)


| 名前 | 紐づくサブネット | 備考 |
|------|---------|------|
| Default Security List for test <入力名> | パブリックサブネット | パブリックサブネット内のVNICに適用されるルール |
| プライベート・サブネット-<入力名>のセキュリティ・リスト | プライベートサブネット | プライベートサブネット内のVNICに適用されるルール |

セキュリティリストがどのサブネットに紐づいているかは、サブネットの詳細画面から確認できます。

   ![image.png](3_securitylistSubnet.png)

**セキュリティリストのルール記述要素**
---
セキュリティリストのルールには以下の要素がセットとなって記述されています。
- イングレス方向 / エグレス方向 
- 送信元CIDR/宛先CIDR、プロトコル、ポート番号 
- ステートフル / ステートレス 

Default Security List for test <入力名> と書かれたパブリックサブネットに紐づくセキュリティリストを見ていきましょう。<br>



   ![image.png](3_securitylistDetail.png)


**例: デフォルトのセキュリティリスト (パブリック) のイングレスルール**

| ステートレス  | 送信元 | プロトコル | ポート|
|------|------|------|------|
|いいえ|`0.0.0.0/0` |TCP|22 (SSH通信)|


- ステートレスがいいえ→ステートフル<br>
ステートフルというのは状態を保持するという意味があるので、例えば行きの通信でイングレスルールに合致したものは、その帰りの通信も自動的に許可されます。
ステートレスルールでは片方向で許可されたとしても、帰りの方向でも許可されていないと通信ができません。<br>
例えばイングレスルールでSSH通信がステートレスで許可された時、帰っていく通信はエグレスルールでも記述する必要があります。
- 送信元0.0.0.0/0<br>
すべてのIPアドレスを指します。つまり、送信元がどこでもという意味です。
- TCP22番ポ―ト<br>
これはsshというリモートログインするプロトコルです。

他にもICMPの一部タイプとコードがデフォルトで設定されています。

**例: デフォルトのセキュリティリスト (パブリック) のエグレスルール**

| ステートレス  | 送信元 | プロトコル |
|------|------|------|
|いいえ|`0.0.0.0/0` |全てのポートすべてのプロトコル|

- 宛先が0.0.0.0/0、つまり全ての宛先への通信が許可されています。
- ステートフルとなっているため、出ていった通信が帰ってくる時にも自動的に許可されます。

つまり、通信の起点がVNICから出ていく方向の通信は全て許可されていて、帰りの通信もステートフルルールによって許可されます。

**重要:** <br>セキュリティリストは許可する通信のみを記述していくホワイトリスト方式です。<br>何も書いていない場合、セキュリティリストに適用されたVNICでパケットがブロックされるため通信はできません。 
{: .notice--info}

**（参考） ネットワークセキュリティグループ (NSG)**
<br>これは⑤のセキュリティリストと役割は同じになります。<br>
異なる点は紐づくリソースとセキュリティルールが適用される範囲です。

| 比較項目 | 紐づくリソース | 適用範囲 |
|----------|------------------|-----|
|セキュリティリスト | サブネット | サブネット内の全VNIC |
|ネットワークセキュリティグループ| VNIC |紐づけたVNICのみ|


> **Tips**  
> セキュリティリストとネットワークセキュリティグループの両方を使った場合 **OR** 条件で許可される。<br>通常は片方のみを使って運用。
{: .notice--info}

<a id="anchor4"></a>

## 4. インターネットからインスタンスへSSH接続するときのパケットの動き 
ネットワークはパケットと呼ばれる小さな小包でやり取りされています。
パケットの気持ちになって順番にどのリソースを経由していくのか見ていきましょう。お使いのPCからインターネットを経由してクラウド内のインスタンスにsshを行う場合を考えてましょう。<br>
次の章のコンピュートインスタンスを作成してSSH接続するものと同じです。

   ![image.png](4_packetrouting.png)

1. ノートPC → インスタンスのパブリックIPが目的地として**インターネットゲートウェイ** へ 
2. インターネットゲートウェイ →インスタンスのIPアドレスにルーティングされます
3. **VNIC** に到達すると**セキュリティリスト** で許可確認 (TCP 22) 
4. インスタンス (OpenSSH) に接続 
5. VNICから出ていく戻りパケットは3のステートフルルールで自動的に許可される 
6. ルート表 `0.0.0.0/0 → インターネットゲートウェイ`というルートルールからインターネットゲートウェイへ向かう 
7. インターネット経由でノートPCへ戻る


---

これで、この章の作業は終了です。

**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)








# 1. 仮想クラウドネットワーク(VCN)とは?

仮想クラウド・ネットワークの作成は、基本的にはオンプレミスでよく利用されるネットワークの各コンポーネントの仮想バージョンをクラウド上で構築していくようなものをイメージしていただくとわかりやすいと思います。

仮想クラウド・ネットワークは以下のようなコンポーネントから構成されます。



- **サブネット** - 仮想ネットワークを構成するIPv4のサブネット
- **仮想NIC** - インスタンスにアタッチされ、サブネットに接続する仮想的なネットワーク・インターフェース・カード
- **プライベートIPアドレス** - 仮想NICにアサインされるIPアドレス
- **インターネット・ゲートウェイ** - VCNとインターネットとを接続するゲートウェイ
- **動的ルーティング・ゲートウェイ(DRG)** - VPNやFastConnect(閉域網/専用線接続サービス)によってオンプレミス・ネットワークなどと接続するゲートウェイ
- **ローカル・ピアリング・ゲートウェイ(LPG)** - 他のVCNと接続するゲートウェイ
- **NATゲートウェイ** - インターネットに到達する必要があるが、インターネットからは到達できないようにしたい場合
- **サービス・ゲートウェイ** - VCN外のOracle Cloudサービス(パブリックIPアドレスでアクセスするサービス)にプライベートに接続可能
- **ルート表** - VCN/サブネットのルーティングを行う仮想ルーターに設定するルーティング・テーブル
- **セキュリティ・リスト** - VCN/サブネットの仮想ファイアウォールに設定するルール
- **ネットワーク・セキュリティ・グループ** - 仮想ファイアウォールの役割を持つ新たな機能で、セキュリティ・リストよりもより細やかな設定が可能
- **DHCPオプション** - インスタンスがDHCPサーバーから取得する情報の設定



<a id="anchor2"></a>

# 2. 仮想クラウド・ネットワークの作成

仮想クラウド・ネットワークを作成します。今回は、予め設定されているテンプレート構成をもとに、付随するネットワーク・コンポーネントも一度に作成する **VCNウィザード** を利用して作成していきます。（すべてカスタムで作成することも可能です。）



1. コンソールメニューから **`ネットワーキング`** → **`仮想クラウド・ネットワーク`** を選択し、**`VCNウィザード`** ボタンを押します。

   <img  width="900" alt="img1.png" src="img1.png">

   <img width="700" alt="img2.png" src="img2.png">

   ※この際、左下の **”リスト範囲”** でリソースを **作成したいコンパートメントを選択していること** を確認してください。ここでは handson コンパートメントを作成して使用しています。

   - 画面左下のリスト範囲

     <img width="280" alt="img3.png" src="img3.png">



2. 立ち上がった VCNウィザード ウィンドウで、デフォルトの **”インターネット接続性を持つVCN”** を選択した状態で **`VCNウィザードの起動`** をクリックします。このタイプを選択すると、以下のコンポーネントが作成されます。

   - VCN、パブリック・サブネット、プライベート・サブネット、インターネット・ゲートウェイ(IG)、NATゲートウェイ(NAT)、サービス・ゲートウェイ(SG)

     <img width="600" alt="img4.png" src="img4.png">

3. **インターネット接続性を持つVCNの作成** ウィンドウに以下の項目を入力し、**`次`** ボタンを押します

   - **基本情報**

     - **VCN名** - 任意 (画面では TutorialVCN と入力しています)

     - **コンパートメント** - デフォルトで現在のコンパートメントが選択されています。もし別のコンパートメントに作成したい場合は選択します。

       <img width="650" alt="img5.png" src="img5.png">

   - **VCNとサブネットの構成**

     - **VCN CIDRブロック** - デフォルトの **10.0.0.0/16** のまま。

     - **パブリック・サブネットCIDRブロック** - デフォルトの **10.0.0.0/24** のまま。

     - **プライベート・サブネットCIDRブロック** - デフォルトの **10.0.1.0/24** のまま。

       <img width="650" alt="img6.png" src="img6.png">

4. 次の **確認および作成** 画面で、これから作成されるリソースを確認し、**`作成`** ボタンをクリックします。

5. 仮想クラウド・ネットワークが作成されます。

   <img width="600" alt="img7.png" src="img7.png">

   

6. 左下の、**`仮想クラウドネットワークの表示`** ボタンをクリックし、作成されたVCNのページを表示します。
   
   <img width="700" alt="img8.png" src="img8.png">



<a id="anchor3"></a>

# 3. 作成した仮想クラウド・ネットワークの確認

作成した仮想クラウド・ネットワーク(VCN)の詳細を確認し、どのようなコンポーネントが作成されているかを理解します。



1. コンソールで、先ほど作成した **TutorialVCN** のリンクをクリックし、詳細画面を表示します

2. 上部に表示されている 仮想クラウド・ネットワークの概要情報を確認します

   アドレス空間が **10.0.0.0/16** で、ネットワークのDNSドメイン名が **tutorialvcn.oraclevcn.com** であることを確認します

   <img width="550" alt="img9.png" src="img9.png">

   > **Note**
   >
   > これらの設定は、VCNウィザードでテンプレートに従って自動的に作成されたものです

   

3. 下部には、作成されたリソースが表示されています。
   パブリック・サブネットとプライベート・サブネットの2つが作成されていることを確認します。どちらも**リージョナル・サブネット**です。
   まず、**”パブリック・サブネット-\<VCN名\>”** のリンクをクリックし、サブネットの詳細画面を開きます。

   <img width="700" alt="img10.png" src="img10.png">

   
   
4. **”パブリック・サブネット-\<VCN名\>”** の画面で、このサブネットに設定されているセキュリティ・リスト、ルート表、DHCPオプションを確認できます。これらのコンポーネントは、VCN内に複数作成でき、各サブネット単位で割り当てます。
   セキュリティ・リストは **Default Security List for \<VCN名\>**、ルート表は **Default Route Table for \<VCN名\>**、DHCPオプションは **Default DHCP Options for \<VCN名\>** が設定されていることがわかったので、これらの中身を確認していきます。

   <img width="700" alt="img11.png" src="img11.png">

   > **Note**
>
   > 作成されているサブネットはテンプレートに従って自動的に作成されたものです。もし異なる内容のサブネットを作成したい場合には、この画面から作成されたサブネットを終了(Terminate)し、新しいサブネットを作成することができます。

   

5. 左側のサブメニューで **”インターネット・ゲートウェイ”** を選択し、作成済のインターネット・ゲートウェイを確認します
   インターネット・ゲートウェイが1つ作成されています。

   <img width="700" alt="img12.png" src="img12.png">

   

6. 左側のサブメニューで **”ルート表”** を選択し、作成済のルート表を確認します。Default Route Tableと、プライベート・サブネット用のルート表の2つが作成されていることを確認します。

   <img width="700" alt="img13.png" src="img13.png">

   

7. ルート表のうち、**Default Route Table for \<VCN名\>** リンクをクリックし、作成されているルート表の詳細を確認します。

   0.0.0.0/0 に対するルート(デフォルトルート)として、**インターネット・ゲートウェイ-\<VCN名\>** がターゲットに定義されていることを確認します。

   <img width="700" alt="img14.png" src="img14.png">

   

8. 左側のサブメニューで **”インターネット・ゲートウェイ”** を選択し、作成済のインターネット・ゲートウェイを確認します。インターネット・ゲートウェイが1つ作成されています。

   <img width="700" alt="img15.png" src="img15.png">

   

9. 次に、ページ上部の **”VCN名”** のリンクを押して画面をもどり、次に左側サブメニューから **”セキュリティ・リスト”** を選択します
   下部に作成済セキュリティ・リストが表示されるので、**Default Security List for \<VCN名\>** リンクをクリックし、詳細を表示します

   <img width="700" alt="img16.png" src="img16.png">

   

10. **Default Security List for \<VCN名\>** の画面で、作成済みのセキュリティ・リストに設定されているルールの内容を確認します

    <img width="700" alt="img17.png" src="img17.png">

    **イングレス・ルール** (インバウンドのルール) として、以下のステートフル・ルールが定義され、またステートレス・ルールは定義されていないことがわかります

    - パブリック・インターネット(0.0.0.0/0) からの ssh(TCP/22) に対する接続の許可

    - パブリック・インターネット(0.0.0.0/0) からのICMP通信に対してはタイプ3(Destination Unreachable)のコード4(Fragmentation Needed and Don't Fragment was Set)を返答

    - **TestVCN** 内(10.0.0.0/16) からのICMP通信に対してはタイプ3(Destination Unreachable)を返答

      > **Note**
      >
      > ICMPのコードおよびタイプの詳細については IANAのサイト をご覧ください

11. ページ左側のサブメニューから **”エグレス・ルール”** を選択し、定義済の Egress Rule (アウトバウンドのルール) の内容を確認します

    <img width="700" alt="img18.png" src="img18.png">

    **エグレス・ルール** としては、パブリック・インターネット(0.0.0.0/0) に対する全てのステートフル通信が許可されていることがわかります

    

12. ページ上部の **”VCN名”** のリンクを押して画面をもどり、次にページ左側のサブメニューから **”DHCPオプション”** を選択します
    下部に作成済のDHCPオプションが表示されるので、 **Default DHCP Options for \<VCN名\>** リンクをクリックし、詳細を表示します
    DHCPのオプションとして、リゾルバーの設定がインターネットおよびVNC内の名前解決に、検索ドメインがVCNのDNSドメイン名(tutorialvcn.oraclevcn.com)に設定されていることを確認します

    <img width="700" alt="img19.png" src="img19.png">

    

13. 次に、手順4以降と同様に、プライベート・サブネットに設定されているルート表、セキュリティ・リストもどのような設定になっているかを確認しましょう。プライベート・サブネットの場合は、インターネット・ゲートウェイ経由で外部アクセスをすることはできないので、NATゲートウェイおよびサービス・ゲートウェイが設定されていることがわかります。



