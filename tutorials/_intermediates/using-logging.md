---
title: "ロギング・サービスを使って3つのログを収集する"
excerpt: "OCIのロギング・サービスを使用することによりログを一元的に収集できて、トラブルが発生しても、ログをすぐに確認し素早く対策できます。また安価で使用できてOCIリソースだけでなくオンプレミスや他社クラウド環境のログを確認することができます。この文書ではコンソールからOCIで提供されている３つのログを使用します。"
order: "185"
tags:
  - intermediate
  - logging
header:
  teaser: "/intermediates/using-logging/img1.png"
  overlay_image: "/intermediates/using-logging/img1.png"
  overlay_filter: rgba(34, 66, 55, 0.7)
---
**チュートリアル一覧に戻る :**  [<u>Oracle Cloud Infrastructure チュートリアル</u>](../..)
<br>
ロギング・サービスを使用することによりさまざまなログを一元的に収集して1つのビューにまとめます。なので万が一トラブルが発生しても、ログをすぐに確認し素早く対策できます。

ロギング・サービスは監査ログ、サービス・ログ、カスタム・ログの3つのログを使用できます。ログはOCIのリソースだけでなく、他社クラウドやオンプレミスの環境のログも取得できます。また他のOracleサービスと統合することができて、ログをEmailなどを通じて通知させたり、OCIモニタリングにメトリックを発行してアラームと統合したりすることが可能です。さらにLogging Analyticsを併用することで、よりログを細かく分析できます。

今回のチュートリアルではこの3つのログをコンソールからアクセスします。

**所要時間：** 15分 

**前提条件：**
1. [<u>その2 - クラウドに仮想ネットワーク(VCN)を作る を通じて仮想クラウド・ネットワーク(VCN)の作成</u>](https://oracle-japan.github.io/ocitutorials/beginners/creating-vcn/)が完了していること
2. [<u>その3 - インスタンスを作成する</u>](https://oracle-japan.github.io/ocitutorials/beginners/creating-compute-instance/)が完了していること
3. [<u>その7 - オブジェクト・ストレージを使う</u>](https://oracle-japan.github.io/ocitutorials/beginners/object-storage/)の **`コンソール画面の確認とバケットの作成`** が完了していること（サービス・ログを使用する際にオブジェクトストレージのログを収集します）

**注意**: チュートリアル内の画面ショットについてはOracle Cloud Infrastructureの現在のコンソール画面と異なっている場合があります 


**目次 :**
   1. [監査ログ](#anchor1)
   2. [サービス・ログ](#anchor2)
   3. [カスタム・ログ](#anchor3) 

<a id="anchor1"></a>

# 1. 監査ログ
監査ログはOCI上のAPIコールをデフォルトで収集します。

メニューから **`監視および管理 → ロギング`** を選択すると監査ログのデータが一覧で表示されます。監査ログの詳しい説明に関しては、以下のチュートリアルを参照してください。

[<u>監査(Audit)ログを使用したテナント監視</u>](https://oracle-japan.github.io/ocitutorials/intermediates/serviceconnecterhub/)

  ![img1.png](img1.png)

<a id="anchor2"></a>

# 2. サービス・ログ

サービス・ログでOCIネイティブ・サービス（APIゲートウェイ、イベント、ファンクション、ロード・バランシング、オブジェクト・ストレージ、VCNフロー・ログなど）のログを取得できます。今回はオブジェクトストレージの読み取りのログデータを収集します。

## 2-1　ログ・グループの作成
1. まず初めにログ・グループを作成します。メニューから **`監視および管理 → ログ・グループ`** を選んでください。


2. するとログ・グループの一覧が表示されます。**`_Audit`** のログ・グループがデフォルトで作成されているのが確認できます。**`ログ・グループの作成`**　ボタンを押します。

    ![img2.png](img2.png)

3. **`ログ・グループの作成`**　を以下の通り行います。

     - **`コンパートメント`** - 対象となるオブジェクトストレージが配置されているコンパートメント
     - **`名前`** - Tutorial_Log_Group
     - **`説明`** - チュートリアル用
     - **`タグ・ネームスペース`**　- なし（フリーフォーム・タグの追加）

      ![img3.png](img3.png)

## 2-2　サービス・ログの作成
1. ログ・グループの詳細画面が表示されるので、左上のログ・グループのボタンを押して、ログ・グループの一覧画面に戻ります。そして左側の　**`ログ`**　をクリックします。すると右側に **`サービス・ログの有効化`** のボタンがあるので、それを押します。

    - **`リソースの選択`**
      - **`リソース・コンパートメント`** - 対象となるオブジェクトストレージが配置されているコンパートメント
      - **`サービス`** - Object Storage
      - **`リソース`** -　TutorialBucket1（ご自身で作成したバケットを選択してください）
   - **`ログの構成`**
      - **`ログ・カテゴリ`**　- Read Access Events
      -  **` ログ名`**  - service_log

    ![img4.png](img4.png)
    >**Note**  
    拡張オプションを使用すると最長6カ月ログを保存するように設定できます。デフォルトは1カ月です。

2. 作成後サービス・ログの詳細画面が表示されます。

## 2-3　オブジェクトのアップロードとダウンロード

ログを取得するために、オブジェクトストレージにオブジェクトをアップロードしてダウンロードをします。
1. メニューから **`ストレージ → バケット`** を選択します。そして作成済みのバケットのリンクを押します。

2. バケットの詳細画面が表示されるのでスクロールして、**`アップロード`**　のボタンをクリックします。
   - **`オブジェクト名の接頭辞`** - 空白
   - **`ストレージ層`** - 標準
   - **`コンピュータからファイルを選択`**　- ローカルPCのファイルを選択してください

    ![img5.png](img5.png)

3. アップロード完了後、**`閉じる`** のボタンをクリックしてください。
  
4. 作成したオブジェクトの一番右側にあるメニューから **`ダウンロード`**　をクリックします。
  ![img6.png](img6.png)

## 2-4　サービス・ログの確認  
1. メニューから **`監視および管理 → ログ`** を選択します。そして先ほど作成したサービス・ログのリンクをクリックします。

2. すると詳細画面が表示されます。スクロールするとログの探索からオブジェクトストレージの読み取りのログデータを確認できます。
例えばオブジェクトをダウンロードした際のログは赤線で囲まれている箇所に該当します。

    ![img7.png](img7.png)
    
    >**`Note`**　操作をしてからログが表示されるまでに多少タイムラグが生じます。時間を置いてもデータが表示されない場合は **`時間によるフィルタ`** の値を変えてください。

<a id="anchor3"></a>

# 3. カスタム・ログ

カスタム・ログを使用することによりOCIリソースのログだけではなく、他のクラウド・プロバイダやオンプレミスの環境のログを取得できます。ログを収集する際の方法は2種類あります。OCIのインスタンス上のログを確認する際はエージェントを構成して、ログを収集します。またオンプレ環境や他のクラウド・プロバイダ等の場合はAPIを通じて収集する必要があります。

今回のチュートリアルではLinuxのコンピュート・インスタンスのOSの **`/var/log`** 以下のすべてのログをエージェントを構成して収集します。

## 3-1　カスタム・ログ使用前の確認事項

1. カスタム・ログを使用するにはエージェントが対応しているOSを使用しなければなりません。必ず対応しているか[<u>エージェント管理</u>](https://docs.oracle.com/ja-jp/iaas/Content/Logging/Concepts/agent_management.htm)を確認してください。2021年11月現在では以下のOSが対象になっています。

   - Oracle Linux 7、Oracle Linux 8　　
   - CentOS 7、CentOS 8
   - Windows Server 2012 R2、Windows Server 2016、Windows Server 2019
   - Ubuntu 16.04、Ubuntu 18.04、Ubuntu 20.04

2. Oracle Cloudエージェントが有効になっているか確認します。インスタンスにアクセスして、以下のコマンドで必要なリソースがactiveになっているかを確認してください。もしactiveになっていない等問題が発生した場合は[<u>エージェントのトラブルシューティング</u>](https://docs.oracle.com/ja-jp/iaas/Content/Logging/Reference/agent_troubleshooting.htm)を参照してください。

   ```
    sudo systemctl status unified-monitoring-agent
    sudo systemctl status unified-monitoring-agent_config_downloader.timer
    sudo systemctl status unified-monitoring-agent_config_downloader.service
    sudo systemctl status unified-monitoring-agent_restarter.path

   ```

## 3-2　動的グループの作成 
1. 動的グループを作成する際にログを収集する対象のコンピュート・インスタンスのコンパートメントのOCIDを確認する必要があります。メニューから **`アイデンティティとセキュリティ → コンパートメント`**　を選択します。

2. コンパートメントの一覧が表示されるので、ログを収集する対象のインスタンスのコンパートメントのリンクをクリックします。するとコンパートメントの詳細画面が表示されます。 **`コンパートメント情報`** の **`OCID`** をコピーしてテキストエディタに貼り付けます。

   ![img8.png](img8.png)

3. 動的グループを作成します。左上の **`アイデンティティ`** のボタンを押すとユーザーの一覧画面が表示されます。左の **`動的グループ`** を選択します。そして **`動的グループの作成`** ボタンを押して以下の設定をします。

     - **`名前`** -  Tutorial_Dynamic_Group
     - **`説明`** - カスタム・ログ用
     - **`一致ルール`** -　下で定義したいずれかのルールに一致
     - **`ルール1`** - instance.compartment.id = '＜コンパートメントOCID＞'

    ![img9.png](img9.png)

## 3-3　ポリシーの設定
1. 次にメニューから　**`アイデンティティとセキュリティ → ポリシー`**　を選択します。

2. そして **`ポリシーの作成`**　を押してください。

     - **`名前`** - log_policy
     - **`説明`** - カスタム・ログ用
     - **`コンパートメント`** - 対象となるインスタンスが配置されているコンパートメントを選択してください
     - **`ポリシー・ビルダー`** - 手動エディタの表示
     - **`ルール１`** - Allow dynamic-group Tutorial_Dynamic_Group to use log-content in compartment ＜コンパート名＞
    
    ![img10.png](img10.png)

## 3-4　カスタム・ログの作成

1. メニューから **`監視および管理 → ログ`** を選択して、左側の **`カスタム・ログの作成`** ボタンを押して以下の設定をします。

   - **`カスタム・ログ`** - Tutorial_custom_log
   - **`コンパートメント`** -  対象となるインスタンスが配置されているコンパートメントを選択してください
   - **`ログ・グループ`** - Tutorial_Log_Group

    ![img11.png](img11.png)

     >**Note**  
    追加オプションを使用すると最長6カ月ログを保存するように設定できます。デフォルトは1カ月です。

2. エージェント構成の作成を行います。

   - **`エージェント構成の作成`** -　新規構成の作成
   - **`構成名`** - Tutorial_Log_Group
   - **`説明`** - for tutorial
   - **`コンパートメント`** - 対象となるインスタンスのコンパートメントを選択してください

    ![img12.png](img12.png)

   - **`ホスト・グループ`** 
     - **`グループ・タイプ`** - 動的グループ
     - **`グループ`** - Tutorial_Log_Group
   - **`ログ入力の構成`** 
     - **`入力タイプ`** - ログ・パス
     - **`名前の入力`** - log
     - **`ファイル・パス`** - /var/log/*
   - **`ログの保存先の選択`**
     - **`コンパートメント`** - 対象となるインスタンスのコンパートメントを選択してください
     - **`ログ・グループ`** - Tutorial_Log_Group
     - **`ログ名`** - Tutorial_Custom_Log
     
    ![img13.png](img13.png)
  　
3. 作成後、カスタム・ログの詳細画面が表示され、スクロールするとログの探索でログ・データを確認できます。
      ![img14.png](img14.png)

  >**`Note`**　操作をしてログが表示されるまで多少タイムラグがあります。時間を置いてもデータが表示されない場合は **`時間によるフィルタ`** の値を変えてください。
<br><br>

今回のチュートリアルでは、ロギングサービスを使用しましたが、よりログを細かく分析したい場合はOCIのLogging Analyticsを使うことが推奨されます。Logging Analyticsを使用したい場合は
[<u>OCIのLogging AnalyticsでOCIの監査ログを可視化・分析する</u>](https://oracle-japan.github.io/ocitutorials/intermediates/audit-log-analytics/)
を参照してください。

**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)

