---
title: "ロードバランサーでWebサーバーを負荷分散する"
excerpt: "OCIのロードバランサーを使うと、冗長化したWebサーバーに対して負荷分散を簡単に構成できるようになります。しかもマネージドサービスなので管理は簡単。"
order: "020"
tags:
  - intermediate
  - network
header:
  teaser: "/intermediates/using-load-balancer/img1.png"
  overlay_image: "/intermediates/using-load-balancer/img1.png"
  overlay_filter: rgba(34, 66, 55, 0.7)
#link: https://community.oracle.com/tech/welcome/discussion/4474257/%E3%83%AD%E3%83%BC%E3%83%89%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B5%E3%83%BC%E3%81%A7web%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%92%E8%B2%A0%E8%8D%B7%E5%88%86%E6%95%A3%E3%81%99%E3%82%8B-oracle-cloud-infrastructure%E3%82%A2%E3%83%89%E3%83%90%E3%83%B3%E3%82%B9%E3%83%89
---

**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)
<br>

Oracle Cloud Infrastructure ロードバランサー・サービスを利用することにより、仮想クラウド・ネットワーク(VCN)内の複数のサーバーに対して一つのエントリーポイントからのネットワーク・トラフィックを分散させることができます。ロードバランサー・サービスは、パブリックIPアドレスの分散を行うパブリック・ロードバランサーと、プライベートIPアドレスの分散を行うプライベート・ロードバランサーの2種類が提供されます。双方のタイプのロードバランサーとも、一定の帯域(100MB/s~8000MB/s)の保証と、高可用性がデフォルトで提供されます。またパブリック・ロードバランサーについてはVCN内の2つの異なるサブネットに跨って構成されるため、アベイラビリティ・ドメイン全体の障害に対する耐障害性が提供されます。

この章では、シンプルなパブリック・ロードバランサーを構成し、VNC内の2台のWebサーバーに対する負荷分散を構成する手順について学習します。

**所要時間 :** 約50分

**前提条件 :**
1. [その2 - クラウドに仮想ネットワーク(VCN)を作る](/ocitutorials/beginners/creating-vcn) を通じて仮想クラウド・ネットワーク(VCN)の作成が完了していること
2. 2048bit 以上のRSA鍵ペアを作成していること

**注意 :** チュートリアル内の画面ショットについては Oracle Cloud Infrastructure の現在のコンソール画面と異なっている場合があります

**目次 :**
   1. [仮想クラウド・ネットワークと2つのサブネットの作成](#anchor1)
   2. [2つのインスタンスの作成とWebサーバーの起動](#anchor2)
   3. [ロードバランサー用のサブネットの作成](#anchor3)
   4. [ロードバランサーの構成](#anchor4)
   5. [ロードバランサーへのhttp通信許可の設定](#anchor5)
   6. [ロードバランサーの動作の確認](#anchor6)
   7. [Webサーバーの保護](#anchor7)

<br><br>

<a id="anchor1"></a>

# 1. 仮想クラウド・ネットワークと2つのサブネットの作成

[その2 - クラウドに仮想ネットワーク(VCN)を作る](/ocitutorials/beginners/creating-vcn) を参考に、仮想クラウド・ネットワーク(VCN)および付随するネットワーク・コンポーネントを作成してください。

作成時に **`仮想クラウド・ネットワークおよび関連リソースの作成`** オプションで作成することで、簡単に今回のチュートリアルに必要なVCNおよび付随コンポーネントを作成することができます。

この章では、Tokyoリージョン (可用性ドメインが1つの構成) を例として、最終的に下記のような構成を作成します。

   ![img1.png](img1.png)


<br>
<a id="anchor2"></a>

# 2.  2つのインスタンスの作成とWebサーバーの起動

[その3 - インスタンスを作成する](/ocitutorials/beginners/creating-compute-instance) を参考に、パブリック・サブネットに2つの仮想マシン・インスタンスを作成してください。その際、かならず **`パブリックIPアドレスの割当て`** を選択し、パブリックIPアドレスを割当ててください。
インスタンスが2つ起動したら、以下の手順に従ってそれぞれにWebサーバーを起動します。

1. sshで2つのインスタンスにアクセスします
インスタンスへのsshでのアクセス方法が不明な場合は、 [その3 - インスタンスを作成する](/ocitutorials/beginners/creating-compute-instance) を参考にしてください。

> 以下の手順は、2つのインスタンスに対してそれぞれsshセッションを起動することで、同時に作業を実行して時間を短縮することができます

2. Apache HTTPサーバーをインストールします

    ```sh
    sudo yum -y install httpd
    ```

3. TCPの80番(http)および443番(https)ポートをオープンします

    ```sh
    sudo firewall-cmd --permanent --add-port=80/tcp
    sudo firewall-cmd --permanent --add-port=443/tcp
    ```

4. ファイアウォールを再ロードします

    ```sh
    sudo firewall-cmd --reload
    ```

5. Webサーバーを起動します

    ```sh
    sudo systemctl start httpd
    ```

6. index.html ファイルを作成し、それぞれにどちらのWebサーバーかを示す文字列を記述します。

    1台目のWebサーバーで以下を実行します。

    ```sh 
    sudo sh -c 'echo "Web Server 1 (host:`hostname`)" > /var/www/html/index.html'
    ```

    次に2台めのWebサーバーで以下を実行します。

    ```sh
    sudo sh -c 'echo "Web Server 2 (host:`hostname`)" > /var/www/html/index.html'
    ```

ここまでで、下記のような構成になっています。

   ![img2.png](img2.png)

<br>
<a id="anchor3"></a>

# 3. ロードバランサー用のサブネットの作成

ロードバランサーは、先ほど作成したWebサーバーと同じサブネットに配置することも可能ですが、別のサブネットに配置することでWebサーバーをプライベート・サブネット上に配置して外部から直接アクセスされることを防ぐことができるようになります。

今回は、Webサーバーが配置されているサブネットとは別のパブリック・サブネットをリージョナル・サブネットとして作成し、そこにロードバランサーを配置していきます。

## 3-1. ロードバランサー用のセキュリティ・リストの追加

1. コンソールメニューから **`ネットワーキング → 仮想・クラウドネットワーク`** を選択し、リストから今回Webサーバーが存在する仮想クラウド・ネットワークの名称のリンクを押します

2. 画面左下部の **`リソース`** メニューにある **`セキュリティ・リスト`** を選択し、**`セキュリティ・リストの作成`** ボタンを押します

3. 立ち上がった **`セキュリティ・リストの作成`** ウィンドウに以下の項目を入力し、 **`セキュリティ・リストの作成`**  ボタンを押します

    - **`名前`** - 任意 (画面は LB_Security_List として入力しています)
    - **`コンパートメントに作成`** - デフォルトで現在のコンパートメントが選択されています。もし別のコンパートメントに作成したい場合は選択します
    - **`Ingress Rule`** と **`Egress Rule`** のエントリーをすべて削除
     >Note
     >
     >この時点ではセキュリティリストにはルールを付与しないでください。後の作業ステップにおいてロードバランサーを作成した際に、適切なルールが自動的に付与されます

   ![img3-1-3.png](img3-1-3.png)

<br>

## 3-2. ロードバランサー用のルート表の追加

1. 画面左下部の **`リソース`** メニューにある **`ルート表`** を選択し、**`ルート表の作成`** ボタンを押します

2. 立ち上がった **`ルート表の作成`** ウィンドウに以下の項目を入力し、**`ルート表の作成`** ボタンを押します

    - **`名前`** - 任意 (画面は LB_Route_Table として入力しています)
    - **`コンパートメントに作成`** - デフォルトで現在のコンパートメントが選択されています。もし別のコンパートメントに作成したい場合は選択します
    - **`宛先CIDRブロック`** - 0.0.0.0/0
    - **`ターゲット・タイプ`** - Internet Gateway を選択
    - **`コンパートメント`** - デフォルトで現在のコンパートメントが選択されています。もし別のコンパートメントに作成したい場合は選択します
    - **`ターゲット・インターネット・ゲートウェイ`** - VCNのインターネットゲートウェイを選択
    
    ![img3-2-2.png](img3-2-2.png)

<br>

## 3-3. ロードバランサー用のサブネットの追加

1. 画面左下部の **`リソース`** メニューにある **`サブネット`** を選択し、**`サブネットの作成`** ボタンを押します

2. 立ち上がった **`サブネットの作成`** ウィンドウに以下の項目を入力し、**`サブネットの作成`** ボタンを押します

    - **`名前`** - 任意 (画面では LB_Subnet と入力しています)
    - **`サブネット・タイプ`** - リージョナル（推奨）を選択
    - **`CIDR ブロック`** - 10.0.3.0/24
    - **`ルート表`** - ステップ3-2で作成したルート・テーブルを選択 (画面では LB_Route_Table を選択しています)
    - **`サブネット・アクセス`** - パブリック・サブネット を選択
    - **`DNS 解決`** - チェックを外す
    - **`DHCPオプション`** - 入力なしのまま
    - **`セキュリティ・リスト`** - ステップ3-1で作成したセキュリティ・リストを選択 (画面では LB_Security_List を選択しています)

    ![img3-3-2-1.png](img3-3-2-1.png)

ここまでの操作で、下記のような構成になりました。
<br>

   ![img3-3-2-2.png](img3-3-2-2.png)

<br>
<a id="anchor4"></a>

# 4. ロードバランサーの構成

ロードバランサーを作成します。作成の際にロードバランサーに必要なシェイプ(帯域)とともに、配置先として先ほど作成したリージョナル・サブネットを選択します。

1. コンソールメニューから **`ネットワーキング → ロード・バランサ`** を選択し、**`ロード・バランサの作成`** ボタンを押します

2. **`ロード・バランサ・タイプの選択`** 画面では **`Load Balancer as a Service`** を選択し、**`ロード・バランサの作成`** ボタンを押します

2. 立ち上がった **`ロード・バランサの作成`** 画面で以下の項目を入力していきます。ロード・バランサの作成は、全部で3画面に分かれています。

    - **`詳細の追加`** 画面で下記項目を入力し、**`次の手順`** ボタンをクリック
        - **`名前`** - 任意 (画面では Tutorial_LB と入力しています)
        - **`可視性タイプの選択`** - パブリックを選択
        - **`パブリックIPアドレスの割当て`** - エフェメラルIPアドレスを選択
        - **`シェイプ`** - 最小帯域幅：10 Mbps、最大帯域幅：50 Mbps と入力
        - **`仮想クラウド・ネットワーク`** - サブネットを作成したVCNを選択 (画面では TutorialVCN を選択しています)
        - **`サブネット`** - ステップ3-3 で作成したリージョナル・サブネットを選択
        (画面では LB_Subnet を選択しています)

        ![img4-2-1.png](img4-2-1.png)

        <br>


    - **`バックエンドの選択`** 画面で以下の項目を入力し、次の手順 をクリック
        - **`ロード・バランシング・ポリシーの指定`** - **`重み付けラウンド・ロビン`** を選択
        - **`バックエンド・サーバーの選択`** - **`バックエンドの追加`** ボタンを押して、インスタンスの指定画面を表示。あらかじめ作成した2つのインスタンスを選択し、**`選択したバックエンドの追加`** ボタンを押す

        ![img4-2-2.png](img4-2-2.png)

        <br>

    - ヘルス・チェック・ポリシーの指定 - すべてデフォルトのまま
        - プロトコル - HTTP (デフォルト)
        - ポート - 80 (デフォルト)
        - 間隔(ミリ秒) - 100000 (デフォルト)
        - タイムアウト(ミリ秒) - 3000  (デフォルト)
        - 再試回数 - 3  (デフォルト)
        - ステータス・コード - 200  (デフォルト)
        - URLパス - /  (デフォルト)
        - レスポンス本文の正規表現 - 空欄 (デフォルト)

        ![img4-2-3.png](img4-2-3.png)

        <br>

    - **`リスナーの構成`** 画面で以下の項目を入力し、すべての項目が入力できたら、画面下部の ロード・バランサの作成 ボタンを押す。
        - **`リスナー名`** - 任意 (ここでは LB_Listener としています)
        - **`リスナーで処理するトラフィックのタイプを指定します`** - HTTP を選択
        - **`リスナーでイングレス・トラフィックをモニターするポートを指定します`** - 80 (デフォルト)

        ![img4-2-4.png](img4-2-4.png)

        <br>

3. ロードバランサーの作成が開始されます。作成はバックエンドで行われ、完了するとステータスが **`AVAILABLE`** になります
   ![img4-3.png](img4-3.png)

<br>

4. この時点で、ロードバランサーにグローバルIPアドレスが1つ付与されています。
ロードバランサーの概要で **`IP アドレス: xxx.xxx.xxx.xxx (Public)`** と表示されているものを確認し、手元に値をメモしておいてください。このIPアドレスは後のステップで使用します。

5. 作成が完了すると、ロードバランサからバックエンドのWebサーバー・インスタンスへのセキュリティ・ルールが自動的に追加されています。作成されたルールを確認するには、 **`ネットワーキング → 仮想クラウド・ネットワーク → ＜VCN名＞ → セキュリティ・リスト → ＜セキュリティ・リスト名＞`** で確認することができます。

    - ロードバランサーのサブネットに設定されたセキュリティ・ルール(Egress)

    ![img4-5-1.png](img4-5-1.png)
     <br>

    - Webサーバーのサブネットに設定されたセキュリティ・ルール(Ingress)

    ![img4-5-2.png](img4-5-2.png)
    <br>
        ※赤枠の部分が追加されたルールです


<br>
<a id="anchor5"></a>

# 5. ロードバランサーへのhttp通信許可の設定

ここまでで、ロードバランサーの設定は完了しています。最後にロードバランサーに対してインターネットからのhttp通信を許可する設定を行い、トラフィックの転送を完成させます。

1. コンソールメニューから **`ネットワーキング → 仮想クラウド・ネットワーク`** を選択し、チュートリアルで使用している仮想クラウド・ネットワークの名前のリンクをクリックします

2. 左下メニューから セキュリティ・リスト を選択し、ステップ3-1で追加したロードバランサー用のセキュリティリスト名のリンクをクリックします

3. **`イングレス・ルールの追加`** ボタンを押します

4. 入力フィールドが開くので、以下の情報を入力し、下部の **`イングレス・ルールの追加`** をクリックします

    - **`ステートレス`** - いいえ (デフォルト)
    - **`ソースCIDR`** - 0.0.0.0/0
    - **`IPプロトコル`** - TCP を選択
    - **`ソース・ポート範囲`** - ALL
    - **`宛先ポート範囲`** - 80 

    ![img5-4.png](img5-4.png)
    <br>



<br>
<a id="anchor6"></a>

# 6. ロードバランサーの動作の確認

ブラウザからアクセスし、ロードバランサーが正しく動作していることを確認します。

1. ステップ 4-1 で作成した、ロードバランサーのグローバルIPアドレスを確認します。(手元にメモしているはずです)

2. ブラウザの新しいタブを開き、IPアドレスを入力して **`ENTER`** キーを押します
**`Web Server 1`** または **`Web Server 2`** と表示されることを確認します

   ![img6-2.png](img6-2.png)
<br>

3. ブラウザのウィンドウにフォーカスした状態で、F5キーを何度か押します
すると、ウィンドウがリロードされ、**`Web Server 1`** という表示と **`Web Server 2`** という表示が切り替わることを確認します。
うまく切り替わるようであれば、無事にロードバランサーの構成が成功しています

   ![img6-3.png](img6-3.png)


<br>
<a id="anchor7"></a>

# 7. Webサーバーの保護

最後に、Webサーバーのサブネットに設定されたルート・テーブルとセキュリティ・リストを更新し、Webサーバーを保護します。


1. コンソールメニューから **`ネットワーキング → 仮想クラウド・ネットワーク`** を選択し、チュートリアルで使用している仮想クラウド・ネットワークの名前のリンクをクリックします

2. 左下メニューから ルート表 を選択し、使用しているVCNのデフォルト・ルート・テーブルを選択します ( **`Default Route Table for TutrialVCN`** のような名前になっているはずです)

3. 下部の **`ルート・ルール`** に表示されている **`CIDR Block: 0.0.0.0/0`** というルールの右端にカーソルをあて、 **`削除`** を押して削除します

    ![img7-3.png](img7-3.png)
<br>

4. 下部の **`ルート・ルール`** に表示されている **`CIDR Block: 0.0.0.0/0`** というルールの右端にカーソルをあて、 **`削除`** を押して削除します

5. **`イングレス・ルール`** を編集し、イングレス・ルールのうち、以下のものを削除します
<br>

    |  SOURCE CIDR  |  IP Protocol  |  Destination Port Range |
    | ---- | ---- | ---- |
    |  0.0.0.0/0  |  TCP  |  22  |
    |  0.0.0.0/0  |  ICMP  |  3, 4  |
    |  10.0.0.0/16  |  ICMP  |  3  |

    <br>
    これで、Webサーバーのネットワークは保護され、インターネットとの間で直接通信はできなくなりました。引き続きロードバランサー経由でのhttpアクセスは許可されており、Webページは閲覧することができます。
    管理用途に外部からの通信が必要な場合は、必要に応じてルート・テーブルおよびセキュリティ・リストの設定を変更してください。

<br>

以上で、この章の作業は終了です。

<br>

**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)


