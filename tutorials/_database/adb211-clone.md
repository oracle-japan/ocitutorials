---
title: "211: クローン機能を活用しよう"
excerpt: "ADBを簡単に複製することができる、クローニング機能についてご紹介します。"
order: "3_211"
layout: single
#header:
#  teaser: "/database/adb211-clone/image_top.png"
#  overlay_image: "/database/adb211-clone/img_top.png"
#  overlay_filter: rgba(34, 66, 55, 0.7)
---

<a id="anchor0"></a>

Autonomous Databaseのクローン機能を利用することにより、テスト/検証/分析用途の環境複製を、すぐに簡単に作成することができます。
本章では、このクローン機能についてフォーカスしていきます。

**所要時間 :** 約20分

**前提条件 :**

* ADBインスタンスが構成済みであること
   <br>※ADBインタンスを作成方法については、本ハンズオンガイドの [101:ADBインスタンスを作成してみよう](/ocitutorials/database/adb101-provisioning){:target="_blank"} を参照ください。
* 構成済みのADBインスタンスへ接続できることが確認できていること



**目次：**

- [1. ADBにおけるクローニングの概要](#anchor1)
- [2. 事前準備](#anchor2)
- [3. クローン環境を作成してみよう](#anchor3)
- [4. クローン環境を確認してみよう](#anchor4)

<br>

<a id="anchor1"></a>

# 1. ADBにおけるクローニングの概要

ADBのクローニング機能は、コンソールまたはAPIを使用して利用することができます。
<br>クローニング機能を使用することで、テスト・開発・分析などの目的でADBの**ポイントインタイム・コピー**を作成できます。


ADBのクローンを作成する際には、**クローンタイプ**、**クローン元のソースの選択**、**クローンのスペックや配置場所の決定**などを行う必要があります。
<br>各項目で設定する内容を順にご紹介します。

* **クローンタイプ**について

    * **フルクローン**：データベース全体の複製
    <br>ソース・データベースの**メタデータとデータ**を含むデータベースが作成されます。

    * **メタデータ・クローン**：データベースのメタデータのみの複製
    <br>このオプションでは、ソース・データベースのメタデータのみを含むデータベースが作成されます。
    <br>メタデータ・クローンでは、格納されるデータはコピーしませんが、表定義や索引定義といったスキーマ定義、オブジェクト構成を引き継ぐクローンを作成します。
    メタデータのみをコピーし、データはサンプルデータなどに置き換えることでOCPU数やストレージの使用を抑え、コストを削減することができます。

    * **リフレッシュ可能クローン**：更新可能なクローンの作成
    <br>ソース・データベースの変更を使用して、簡単に更新できるクローンが作成されます。
    <br>クローンを作成後にソース・データベースの任意の時間の状態に更新することができるクローンです。
    <br>任意の時間の状態に更新するには、バックアップから新しいクローンを作成するという方法もありますが、バックアップからデータをリストアする時間が必要であったり、新しいデータベースをプロビジョニングしなくてはならないなど手間や時間がかかってしまいます。リフレッシュ可能クローンを使用することにより、手軽に任意の時間の状態のクローンを取得することが可能です。

    > **補足**
    > 
    > その他、リフレッシュ可能クローンは次のような特長があります：
    > <ul><li>実⾏中インスタンスの更新を引き継ぐクローンを作成可能</li>
    > <li>1つのインスタンスに対して複数の更新可能クローンの作成が可能</li>
    > <li>他の部⾨、コンパートメント跨ぎでの共有が可能であり、コストの分散が可能（クエリ・オフロード）</li>
    > <li>1週間以内の更新が必要（1週間(168時間)を経過すると更新不可）</li>
    > <li>そのまま読み取り専⽤のDBとして利⽤するか、ソースから切断して通常のR/W可能なインスタンスとしての利⽤が可能</li>
    > </ul>
    > <br>※詳細については [マニュアル](https://docs.oracle.com/ja-jp/iaas/adbrefreshableclone/autonomous-refreshable-clone.html) を参照ください。

    <br>

* **クローンするソース**について

  **フルクローン**または**メタデータクローン**を取得する場合、クローンソースを選択するオプションがあります。
    * **アクティブなデータベースインスタンスからクローンを作成**
    <br>
    実行中のデータベースのクローンが作成されます。この場合、バックアップからのクローン作成と比較して、比較的短い時間でのクローンの作成が可能です。
    ソースデータベースはオンラインのまま停止する必要はありませんが、もしデータの断面を取得したい場合は、アプリケーションを停止するか、ソースデータベースを停止してからクローンしてください。

      > **補足**
      >
      > <br>ターゲット・インスタンスにはソース・インスタンスの断面と変更ログを転送しクローンが作成されます。また変更ログは可能な限り最新の断面となるよう直近まで転送、適用することで、ソース・インスタンスを再現します。
      > <br>反対をいうと、アクティブなデータベースを元に作成されたクローンは、ピンポイントに特定の状態のクローンを取得したいときには向きません。そのようなクローンを作成したいときには、一旦ソースデータベースを停止させた状態でクローンを取得する、または次の項目でご紹介するバックアップからのクローンの取得が適切でしょう。
      >

    * **バックアップからクローンを作成**
  <br>バックアップリストからバックアップを指定してクローン、もしくは、過去の特定時点を指定してクローンします。
  <br>前述の通りバックアップからクローンを作成する際は、オブジェクトストレージからデータをリストアする必要があるため、アクティブなインスタンスから作成する場合に比べ、時間がかかります。
  <br>また、バックアップから作成できるクローンタイプはフル・クローンおよびメタデータ・クローンのみです。バックアップから更新可能クローンを作成することができませんのでご注意ください。


* **クローン先の構成**について

  クローンは、サブスクライブしている任意のリージョンの任意のコンパートメント内に取得することが可能です。また、ネットワークに関しては、ソースデータベースと異なるVCN・サブネットに配置できます。
  <br>クローン環境を配置するコンパートメントや、クローン環境のバージョン・コア数・ストレージ容量などを含むスペックなどを決定します。

その他、ADBのクローンに関する詳細な情報は[マニュアル](https://docs.oracle.com/ja-jp/iaas/Content/Database/Tasks/adbcloning.htm)を参照ください。

<br>

<a id="anchor2"></a>

# 2. 事前準備

実際にクローン環境を作成する前に、ソースデータベースとなるADBにサンプルスクリプトを流し、データを挿入します。
<br>ここではある会社の部門の情報を含む、DEPARTMENT表という簡単な表を作成していきます。


1. 次の手順に従って、DBインスタンスのSQL*Plusに接続します。
  <br>接続方法はOCI CLIを使用する方法や、別の仮想マシンからssh接続する方法がありますが、こちらでは後者の方法で進めていきます。

    1-1. 作成した仮想マシンにssh接続します。
      <br>仮想マシンの作成およびセットアップ方法は[こちら](https://oracle-japan.github.io/ocitutorials/database/adb204-setup-VM/)

    1-2. 下記のコマンドを参考に、oracleユーザに切り替えます。
    
    ```sh
    sudo -s
    ```
    ```sh
    su - oracle
    ```
    （一旦rootユーザにスイッチしてから、oracleユーザにスイッチしています）

    1-3. 下記のコマンドを参考に、SQL*Plusに接続します。

    ```sh
    sqlplus [username]/[password]@[接続サービス名]
    ```

    本ハンズオンガイドを参考にADBインスタンスをお作りいただいた方は、次のようなコマンドになります。

    ```sh
    sqlplus admin/Welcome12345#@atp01_low
    ```

    SQL*Plusへの接続方法の詳細については、[104: クレデンシャル・ウォレットを利用して接続してみよう](https://oracle-japan.github.io/ocitutorials/database/adb104-connect-using-wallet/) をご確認ください。

2. 次のサンプルスクリプトを流し、テーブルを作成します。
  <br>こちらのスクリプトをコピーし、SQL*Plusのターミナルにペーストします。

    ```sql
    DROP TABLE DEPARTMENT CASCADE CONSTRAINTS PURGE;
    DROP SEQUENCE DEPT_ID_SEQ;
    DROP TRIGGER DEPT_ID_TRIGGER;
    
    CREATE SEQUENCE DEPT_ID_SEQ
    START WITH     1
    INCREMENT BY   1
    NOCACHE
    NOCYCLE;


    CREATE TABLE DEPARTMENT (
      DEPT_ID NUMBER(10) PRIMARY KEY,
      DEPT_NAME VARCHAR2(60) NOT NULL,
      MGR_ID NUMBER(10) NOT NULL
    );

    CREATE OR REPLACE TRIGGER DEPT_ID_TRIGGER
      BEFORE INSERT
      ON DEPARTMENT
      FOR EACH ROW
      WHEN (NEW.DEPT_ID IS NULL)
    BEGIN
      SELECT DEPT_ID_SEQ.NEXTVAL INTO :NEW.DEPT_ID FROM DUAL;
    END DEPT_ID_TRIGGER;
    /

    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('ADMINISTRATION', 1000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('HUMAN RESOURCE', 2000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('LEGAL', 3000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('ACCOUNTING', 4000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('MARKETING', 5000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('SALES', 6000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('DEVELOPMENT', 7000);
    INSERT INTO DEPARTMENT (DEPT_NAME, MGR_ID) VALUES ('ENGINEERING', 8000);
    COMMIT;
      ```

    +  [上記のサンプルデータをダウンロード](/ocitutorials/database/adb-data/department.sql)


  3. 次のSELECT文を実行し、表が正しく作成されているかを確認します。

      ```sql
      select * from department;
      ```
      
      次のような表が作成されていればOKです。

      ![img1_3.png](img1_3.png)

<br>

<a id="anchor3"></a>

# 3. クローン環境を作成してみよう

ADB（atp01）のフルクローンを作成していきます。

1. ソースのインスタンスの詳細画面から「クローンを作成」をクリックします。
  ![img2_1.png](img2_1.png)

2. クローンの作成画面が表示されます。クローン環境を設定していきます。
<br>下記を参考に設定してみましょう。

  * クローン・タイプ：**フルクローン**
  <br>ソース・データベースのメタデータとデータが複製されます。

  * ソースのクローニング：**データベース・インスタンスからのクローニング**
  <br>現在の状態のまま、実行中のデータベースのクローンを作成します。

    ![img2_2_1.png](img2_2_1.png)

  * Autonomous Databaseクローンの基本情報の指定
    * コンパートメント：**任意のコンパートメントを指定**
    * ソース・データベース名：**atp01（変更できません）**
    * 表示名：**Clone of atp01（デフォルト）**
    <br>任意の名前で結構です。
    * データベース名：**atp01Clone**
    <br>任意の名前で結構です。

    ![img2_2_2.png](img2_2_2.png)
  
  * データベースの構成
    * データベース・バージョン：**19c（デフォルト）**
    <br>任意のバージョンで結構です。
    * OCPU数：**2**
    <br>任意の値で結構です。
    * ストレージ(TB)：**1（デフォルト）**
    <br>任意の値で結構です。

    ![img2_2_3.png](img2_2_3.png)

  * 管理者資格証明の作成
    * ユーザ名：**ADMIN（変更できません）**
    * パスワード：**Welcome12345#**
    <br>次の要件を満たす任意のパスワードを設定ください
      * 12文字から30文字
      * 大文字、小文字および数字をそれぞれ1つ以上含む
      * 二重引用符(")文字またはユーザー名"admin"を含めることはできない
    
     ![img2_2_4.png](img2_2_4.png)

  * ネットワーク・アクセスの選択：**すべての場所からのセキュア・アクセス**
  * ライセンス・タイプの選択：**ライセンス込み**

     ![img2_2_5.png](img2_2_5.png)

  最後に「**クローンを作成**」をクリックすると、プロビジョニングが始まります。
  <br>指定したコンパートメント内にクローン環境が作成されていることをご確認ください。

  <br>

<a id="anchor4"></a>

# 4. クローン環境を確認してみよう

作成したクローン環境に接続してみましょう。
<br>また、正しくクローンされているかを確認するために、2で作成したデータと同様のデータが入っているかを確認します。

1. 次の手順に従って、クローンADBに接続してみましょう。
  <br>詳細は、[104: クレデンシャル・ウォレットを利用して接続してみよう](https://oracle-japan.github.io/ocitutorials/database/adb104-connect-using-wallet/) の [1. クレデンシャル・ウォレットのダウンロード](https://oracle-japan.github.io/ocitutorials/database/adb104-connect-using-wallet/#anchor1) を参照ください。

    1-1. クローンADBのウォレットをダウンロードします。
      <br>OCIコンソールからクローンADBの詳細画面に移動します。
      <br>手順は次の通りです：
      <br>**「DB接続」→インスタンスタイプのウォレットをダウンロード→ADMINに設定したパスワードを入力**

    1-2. クローンADBへの接続に使用するクライアントの設定ファイルを編集します。
    <br>設定ファイルを編集する方法は、OCI CLIを使用した編集方法、接続用の仮想マシンで編集する方法があります。
    <br>それぞれの編集方法は次のリンク先をご確認ください：
      + OCI CLIを使用して編集する方法
        [104: クレデンシャル・ウォレットを利用して接続してみよう - 2. 設定ファイルの編集](https://oracle-japan.github.io/ocitutorials/database/adb104-connect-using-wallet/#anchor2)
      + 接続用の仮想マシン上で編集する方法
        [204: マーケットプレイスからの仮想マシンのセットアップ方法](https://oracle-japan.github.io/ocitutorials/database/adb204-setup-VM/#4-adb%E3%81%AB%E6%8E%A5%E7%B6%9A%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%B7%A8%E9%9B%86)
        
    > **補足**
    >
    > １つの接続用の仮想マシンから様々なDBに接続するようなことがある場合、それぞれのウォレットごとにディレクトリを作成し、どのDBに接続したいかによってTNS_ADMINが参照するウォレットの場所を切り替えるとスムーズに接続することができます。
    >
    > または、**リージョナル・ウォレット**というクレデンシャルウォレットを活用するとより簡単に接続することが可能になります。
    > リージョナル・ウォレットには、同一コンパートメント内のすべてのADBに関する資格情報が含まれているため、DBを切り替えるたびにウォレットの場所などを意識することなくご利用いただけます。
    >ADBの資格証明に関する詳細な情報は[こちら](https://docs.oracle.com/ja-jp/iaas/Content/Database/Tasks/adbconnecting.htm#credentials)を参照ください。
    >

2. 先ほど同様に、SQL*Plusに接続します。

    ```sh
    sqlplus [username]/[password]@[接続サービス名]
    ```

    ```sh
    sqlplus admin/Welcome12345#@atp01Clone_low
    ```

    ※接続サービス名にご注意ください。ソース・データベースと名称が異なります。

3. SELECT文を使用し、先ほど作成したDEPARTMENT表が表示されていることを確認します。

    ```sh
    select * from department;
    ```
    ![img1_3.png](img1_3.png)

    このように、フルクローンではメタデータのみならずデータも取得されていることが分かります。

> **補足**
> 
> ソースデータベースのメタデータのみをコピーするメタデータ・クローンを使用してatp01を複製した場合の出力結果は次のようになります。
> 
> ![img4_3.png](img4_3.png)
> 
> DEPARTMENT表の行を表示するselect文の出力結果では、行が表示されません。表の中身が空であることが分かります。
> しかし、データベースオブジェクトの定義を表示するdesc文を実行すると、このように列名・データ型などの情報が取得されていることが分かります。


<br>
以上で、この章は終了です。  
次の章にお進みください。

<br>
[ページトップへ戻る](#anchor0)
