<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HPCクラスタを構築する(基礎インフラ手動構築編) | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="HPCクラスタの基礎インフラを作成してみましょう。このチュートリアルを終了すると、OCIが提供するHPC向けインターコネクトネットワークであるクラスタ・ネットワークをデプロイし、ベアメタル計算ノードをこのクラスタ・ネットワークに接続してRDMA対応RoCEv2を使用した高速・低レイテンシにノード間通信を行う環境を、OCIコンソールから構築することが出来るようになります。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="HPCクラスタを構築する(基礎インフラ手動構築編)">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/hpc/spinup-cluster-network/">


  <meta property="og:description" content="HPCクラスタの基礎インフラを作成してみましょう。このチュートリアルを終了すると、OCIが提供するHPC向けインターコネクトネットワークであるクラスタ・ネットワークをデプロイし、ベアメタル計算ノードをこのクラスタ・ネットワークに接続してRDMA対応RoCEv2を使用した高速・低レイテンシにノード間通信を行う環境を、OCIコンソールから構築することが出来るようになります。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/intermediates/spinup-cluster-network/architecture_diagram.png">





  <meta property="article:published_time" content="2023-03-09T09:06:46+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/hpc/spinup-cluster-network/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://oracle-japan.github.io/ocitutorials/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ocitutorials/#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E4%B8%80%E8%A6%A7">チュートリアル一覧</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/about/">このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(34, 66, 55, 0.7), rgba(34, 66, 55, 0.7)), url('/ocitutorials/intermediates/spinup-cluster-network/architecture_diagram.png');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          HPCクラスタを構築する(基礎インフラ手動構築編)

        
      </h1>
      
        <p class="page__lead">HPCクラスタの基礎インフラを作成してみましょう。このチュートリアルを終了すると、OCIが提供するHPC向けインターコネクトネットワークであるクラスタ・ネットワークをデプロイし、ベアメタル計算ノードをこのクラスタ・ネットワークに接続してRDMA対応RoCEv2を使用した高速・低レイテンシにノード間通信を行う環境を、OCIコンソールから構築することが出来るようになります。
</p>
      
      


      
      
    </div>
  
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://oracle-japan.github.io/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/hpc" itemprop="item"><span itemprop="name">Hpc</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">HPCクラスタを構築する(基礎インフラ手動構築編)</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">HPC編</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/hpc/spinup-hpc-cluster/">HPCクラスタを構築する(スタティッククラスタ自動構築編)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/hpc/spinup-ml-instance/">GPUインスタンスで機械学習にトライ</a></li></p>
        
          <p></p><li><a href="/ocitutorials/hpc/spinup-cluster-network/" class="active">HPCクラスタを構築する(基礎インフラ手動構築編)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/hpc/spinup-gpu-cluster-withstack/">GPUクラスタを構築する(スタティッククラスタ自動構築編)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/hpc/spinup-gpu-cluster/">GPUクラスタを構築する(基礎インフラ手動構築編)</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="HPCクラスタを構築する(基礎インフラ手動構築編)">
    <meta itemprop="description" content="HPCクラスタの基礎インフラを作成してみましょう。このチュートリアルを終了すると、OCIが提供するHPC向けインターコネクトネットワークであるクラスタ・ネットワークをデプロイし、ベアメタル計算ノードをこのクラスタ・ネットワークに接続してRDMA対応RoCEv2を使用した高速・低レイテンシにノード間通信を行う環境を、OCIコンソールから構築することが出来るようになります。">
    <meta itemprop="datePublished" content="2023-03-09T09:06:46+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#0-クラスタネットワーク作成事前作業">0. クラスタ・ネットワーク作成事前作業</a><ul><li><a href="#0-0-クラスタネットワーク作成事前作業概要">0-0. クラスタ・ネットワーク作成事前作業概要</a></li><li><a href="#0-1-vcn作成">0-1. VCN作成</a></li><li><a href="#0-2-bastionノード作成">0-2. bastionノード作成</a></li></ul></li><li><a href="#1-クラスタネットワーク作成">1. クラスタ・ネットワーク作成</a><ul><li><a href="#1-0-クラスタネットワーク作成概要">1-0. クラスタ・ネットワーク作成概要</a></li><li><a href="#1-1-cloud-init設定ファイル作成">1-1. cloud-init設定ファイル作成</a></li><li><a href="#1-2-インスタンス構成作成">1-2. インスタンス構成作成</a></li><li><a href="#1-3-クラスタネットワーク作成">1-3. クラスタ・ネットワーク作成</a></li></ul></li><li><a href="#2-計算ノード確認">2. 計算ノード確認</a><ul><li><a href="#21-計算ノードログイン">2.1. 計算ノードログイン</a></li><li><a href="#22-cloud-init完了確認">2.2. cloud-init完了確認</a></li><li><a href="#23-計算ノードファイルシステム確認">2.3. 計算ノードファイルシステム確認</a></li></ul></li><li><a href="#3-mpiプログラム実行2ノード編">3. MPIプログラム実行（2ノード編）</a><ul><li><a href="#3-0-mpiプログラム実行2ノード編概要">3-0. MPIプログラム実行（2ノード編）概要</a></li><li><a href="#3-1-計算ノード間ssh接続環境構築">3-1. 計算ノード間SSH接続環境構築</a></li><li><a href="#3-2-プライベートサブネットセキュリティリスト修正">3-2. プライベートサブネットセキュリティリスト修正</a></li><li><a href="#3-3-intel-mpi-benchmark-ping-pong実行">3-3. Intel MPI Benchmark Ping-Pong実行</a></li></ul></li><li><a href="#4-計算ノード追加">4. 計算ノード追加</a></li><li><a href="#5-mpiプログラム実行4ノード編">5. MPIプログラム実行（4ノード編）</a><ul><li><a href="#5-0-mpiプログラム実行4ノード編概要">5-0. MPIプログラム実行（4ノード編）概要</a></li><li><a href="#5-1-計算ノード間ssh接続環境構築">5-1. 計算ノード間SSH接続環境構築</a></li><li><a href="#5-2-intel-mpi-benchmark-alltoall実行">5-2. Intel MPI Benchmark Alltoall実行</a></li></ul></li><li><a href="#6-計算ノード入れ替え">6. 計算ノード入れ替え</a></li><li><a href="#7-クラスタネットワークの終了">7. クラスタ・ネットワークの終了</a></li></ul>

            </nav>
          </aside>
        
        <p>Oracle Cloud Infrastructure（以降OCIと記載）のクラスタ・ネットワークは、以下の特徴からHPCワークロードを実行するHPCクラスタを構築する際の計算ノード間を接続するインターコネクトに最適なサービスです。</p>
<ul>
  <li>RoCEv2を使用する高帯域・低レイテンシRDMAインターコネクト（MPI通信で最大12GB/sの帯域幅と最小1.5μsのレイテンシ）</li>
  <li>オーバーサブスクリプションの無いフラットなネットワークトポロジーから来る再現性の高いネットワーク特性</li>
</ul>

<p>このチュートリアルは、HPC向けIntel Ice Lakeプロセッサを搭載する計算ノード（BM.Optimized3.36（※））をクラスタ・ネットワークを使用してノード間接続し、HPCワークロードを実行するためのHPCクラスタを構築する際のベースとなるインフラストラクチャを構築、そのインターコネクト性能を検証します。</p>

<p>※：シェイプ詳細は以下URLを参照<br />
  <a href="https://docs.oracle.com/ja-jp/iaas/Content/Compute/References/computeshapes.htm#bm-hpc-optimized">https://docs.oracle.com/ja-jp/iaas/Content/Compute/References/computeshapes.htm#bm-hpc-optimized</a></p>

<p>このチュートリアルで作成する環境は、ユーザ管理、ホスト名管理、共有ファイルシステム、プログラム開発環境、ジョブスケジューラ等、必要なソフトウェア環境をこの上に整備し、ご自身の要件に沿ったHPCクラスタを構築する際の基礎インフラストラクチャとして利用することが可能です。
なおOCIでは、これらのクラスタ管理に必要なソフトウェアの導入までを自動化する、OCIのリソース・マネージャを使用したHPCクラスタ構築自動化ソリューションも利用可能です。この詳細は、本チュートリアルの姉妹編である以下ページ <strong>HPCクラスタを構築する</strong> を参照ください。</p>

<p><a href="https://oracle-japan.github.io/ocitutorials/intermediates/spinup-hpc-cluster">https://oracle-japan.github.io/ocitutorials/intermediates/spinup-hpc-cluster</a></p>

<p><img src="architecture_diagram.png" alt="システム構成図" /></p>

<p>またこのチュートリアルでは、環境構築後により大規模な計算を実施する必要が生じたり、メンテナンスによりノードを入れ替える必要が生じることを想定し、既存のクラスタ・ネットワークに計算ノードを追加する方法と、特定の計算ノードを入れ替える方法も学習します。</p>

<p><strong>所要時間 :</strong> 約1時間</p>

<p><strong>前提条件 :</strong> クラスタ・ネットワークを収容するコンパートメント(ルート・コンパートメントでもOKです)の作成と、このコンパートメントに対する必要なリソース管理権限がユーザーに付与されていること。</p>

<p><strong>注意 :</strong> チュートリアル内の画面ショットについては、OCIの現在のコンソール画面と異なっている場合があります。</p>

<hr />
<h1 id="0-クラスタネットワーク作成事前作業">0. クラスタ・ネットワーク作成事前作業</h1>

<h2 id="0-0-クラスタネットワーク作成事前作業概要">0-0. クラスタ・ネットワーク作成事前作業概要</h2>

<p>クラスタ・ネットワークは、これに接続する計算ノードと共に作成します。</p>

<p>このため、この計算ノードをTCP接続するVCNと、インターネットから直接アクセス出来ないプライベートサブネットに通常接続される計算ノードにログインする際の踏み台となるbastionノードを、クラスタ・ネットワーク作成前に予め作成しておく必要があります。</p>

<p>本章は、これらクラスタ・ネットワーク作成の前提となるリソースを作成します。</p>

<h2 id="0-1-vcn作成">0-1. VCN作成</h2>

<p>本章は、計算ノードをTCP接続するVCNを作成します。
VCNの作成は、以下チュートリアルページ <strong>クラウドに仮想ネットワーク(VCN)を作る</strong> の手順通りに実行し、</p>

<p><a href="https://oracle-japan.github.io/ocitutorials/beginners/creating-vcn">https://oracle-japan.github.io/ocitutorials/beginners/creating-vcn</a></p>

<p>以下のリソースを作成します。</p>

<ul>
  <li>VCN（10.0.0.0/16）</li>
  <li>パブリックサブネット（10.0.0.0/24）</li>
  <li>プライベートサブネット（10.0.1.0/24）</li>
  <li>インターネット・ゲートウェイ（パブリックサブネットにアタッチ）</li>
  <li>NATゲートウェイ（プライベートサブネットにアタッチ）</li>
  <li>サービス・ゲートウェイ（プライベートサブネットにアタッチ）</li>
  <li>ルート表 x 2（パブリックサブネットとプライベートサブネットにアタッチ）</li>
  <li>セキュリティリスト x 2（パブリックサブネットとプライベートサブネットにアタッチ）</li>
</ul>

<p>このVCNは、セキュリティリストで以下のアクセス制限が掛けられています。</p>

<ul>
  <li>インターネットからのアクセス：パブリックサブネットに接続されるインスタンスの22番ポート（SSH）に限定</li>
  <li>インターネットへのアクセス：インターネット上の任意のIPアドレス・ポートに制限なくアクセス可能</li>
</ul>

<h2 id="0-2-bastionノード作成">0-2. bastionノード作成</h2>
<p>本章は、計算ノードにログインする際の踏み台となるbastinノードを作成します。
bastionノードの作成は、以下チュートリアルページ <strong>インスタンスを作成する</strong> の手順を参考に、</p>

<p><a href="https://oracle-japan.github.io/ocitutorials/beginners/creating-compute-instance">https://oracle-japan.github.io/ocitutorials/beginners/creating-compute-instance</a></p>

<p>ご自身の要件に沿ったインスタンスを、先の手順でVCNを作成したコンパートメントとパブリックサブネットを指定して作成します。本チュートリアルは、以下属性のインスタンスをbastionノードとして作成します。</p>

<ul>
  <li><strong>イメージ　:</strong> Oracle Linux 8</li>
  <li><strong>シェイプ　:</strong> VM.Optimized3.Flex（1 OCPU）</li>
  <li><strong>SSHキーの追加　:</strong> bastionノードへのログインで使用するSSH秘密鍵に対応する公開鍵</li>
</ul>

<p>次に、このbastionノード上でSSHの鍵ペアを作成します。このSSH鍵は、bastionノードからクラスタ・ネットワークに接続する計算ノードにログインする際に使用します。
先のチュートリアル <strong>インスタンスを作成する</strong> に記載のインスタンスへの接続方法に従い、bastionノードにopcユーザでSSHログインして以下コマンドでSSH鍵ペアを作成、作成された公開鍵を後のクラスタ・ネットワーク作成手順で指定します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> ssh-keygen
Generating public/private rsa key pair.
Enter file <span class="k">in </span>which to save the key <span class="o">(</span>/home/opc/.ssh/id_rsa<span class="o">)</span>: 
Enter passphrase <span class="o">(</span>empty <span class="k">for </span>no passphrase<span class="o">)</span>: 
Enter same passphrase again: 
Your identification has been saved <span class="k">in</span> /home/opc/.ssh/id_rsa.
Your public key has been saved <span class="k">in</span> /home/opc/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:2EvR7FXtEYAsDknJG1oREie1kv2r1PN3OYrYCP/Xlyg opc@bast
The keys randomart image is:
+---[RSA 2048]----+
|     +<span class="o">=</span><span class="k">*</span><span class="o">=</span> <span class="nb">.</span> ..oo.|
|      <span class="k">*</span>B.+ o <span class="nb">.</span> ..|
|     ooo<span class="k">*</span> + <span class="nb">.</span>  ..|
|     ..+.+ <span class="nb">.</span>    .|
|      <span class="nb">.</span> S..      |
|       ....      |
|       o.+    o o|
|      <span class="nb">.</span> + <span class="k">*</span>E.+ <span class="k">*</span>.|
|       <span class="nb">.</span> +.<span class="o">=</span>+.o o|
+----[SHA256]-----+
<span class="o">&gt;</span> <span class="nb">cat</span> .ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQD0TDo4QJPbXNRq/c5wrc+rGU/dLZdUziHPIQ7t/Wn+00rztZa/3eujw1DQvMsoUrJ+MHjE89fzZCkBS2t4KucqDfDqcrPuaKF3+LPBkgW0NdvytBcBP2J9zk15/O9tIVvsX8WBi8jgPGxnQMo4mQuwfvMh1zUF5dmvX3gXU3p+lH5akZa8sy/y16lupge7soN01cQLyZfsnH3BA7TKFyHxTe4MOSHnbv0r+6Cvyy7Url0RxCHpQhApA68KBIbfvhRHFg2WNtgggtVGWk+PGmTK7DTtYNaiwSfZkuqFdEQM1T6ofkELDruB5D1HgDi3z+mnWYlHMNHZU5GREH66acGJ opc@bast
</code></pre></div></div>

<p>次に、以降作成する計算ノードのDNS名前解決をイニシャルホスト名で行えるようにするため、/etc/resolv.confファイルのsearch行に、先に作成したプライベートサブネットのDNSドメイン名を以下のように追加します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> diff /etc/resolv.conf_org /etc/resolv.conf
7c7
&lt; search vcn.oraclevcn.com sub11010929110.vcn.oraclevcn.com
<span class="nt">---</span>
<span class="o">&gt;</span> search vcn.oraclevcn.com sub11010929110.vcn.oraclevcn.com sub10030907571.vcn.oraclevcn.com
</code></pre></div></div>

<p>なおプライベートサブネットのDNSドメイン名は、OCIコンソール上で当該プライベートサブネットの <strong>サブネット詳細</strong> メニューから、以下のように確認することが出来ます。</p>

<p><img src="console_page30.png" alt="画面ショット" /></p>

<p>この修正は、このままではOS再起動により元に戻ってしまうため、以下コマンドをbastionのopcユーザで実行し、この修正が上書きされないようにします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">sudo </span>chattr <span class="nt">-R</span> +i /etc/resolv.conf
</code></pre></div></div>

<hr />
<h1 id="1-クラスタネットワーク作成">1. クラスタ・ネットワーク作成</h1>

<h2 id="1-0-クラスタネットワーク作成概要">1-0. クラスタ・ネットワーク作成概要</h2>

<p>クラスタ・ネットワークは、その下層にOCIのインスタンス・プールを使用し、インスタンス・プールが持つ同一イメージのインスタンスを複製する機能により、クラスタ・ネットワークに接続する計算ノードを指定ノード数デプロイします。</p>

<p>またインスタンス・プールは、その下層にOCIのインスタンス構成を使用し、インスタンス構成に指定した属性を持つインスタンスを複製します。</p>

<p>OCIのクラスタ・ネットワークに接続する計算ノードは、OS（Oracle Linux 8）起動時点でクラスタ・ネットワークに接続するRDMAインタフェースが作成されていないため、デプロイ後の最初のOS起動時のみ実行されるOCIのcloud-initを利用して、この作成を行います。また本チュートリアルでは、計算ノードに使用するBM.Optimized3.36に装備されるNVMeローカルディスクのファイルシステム作成も、このcloud-initから行います。</p>

<p>以上より、クラスタ・ネットワークの作成は、以下の手順を経て行います。</p>

<ul>
  <li>cloud-init設定ファイル作成</li>
  <li>インスタンス構成作成</li>
  <li>クラスタ・ネットワーク作成</li>
</ul>

<p>なおインスタンス・プールは、クラスタ・ネットワークを作成することで自動的に作成されるため、改めて作成する必要はありません。</p>

<h2 id="1-1-cloud-init設定ファイル作成">1-1. cloud-init設定ファイル作成</h2>

<p>本章は、cloud-init設定ファイルを作成します。</p>

<p>cloud-initは、主要なクラウドサービスプロバイダーで利用可能なインスタンス初期化のための仕組みで、cloud-initが用意する文法に沿った設定ファイルを作成しこれを指定することで、インスタンスデプロイ後に必要な様々なOSレベルのカスタマイズを適用することが可能になります。</p>

<p>本チュートリアルは、このcloud-initを以下の目的で使用します。</p>

<ul>
  <li>NVMeローカルディスクファイルシステム作成</li>
  <li>firewalld停止</li>
  <li>クラスタ・ネットワーク接続設定</li>
</ul>

<p>以下は、本チュートリアルで使用するBM.Optimized3.36用のcloud-init設定ファイルで、OCIコンソールを実行している端末上にテキストファイルで保存します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#cloud-config</span>
runcmd:
<span class="c">#</span>
<span class="c"># Mount NVMe local storage</span>
  - parted <span class="nt">-s</span> /dev/nvme0n1 mklabel gpt
  - parted <span class="nt">-s</span> /dev/nvme0n1 <span class="nt">--</span> mkpart primary xfs 1 <span class="nt">-1</span>
  - mkfs.xfs <span class="nt">-L</span> localscratch /dev/nvme0n1p1
  - <span class="nb">mkdir</span> <span class="nt">-p</span> /mnt/localdisk
  - <span class="nb">echo</span> <span class="s2">"LABEL=localscratch /mnt/localdisk/ xfs defaults,noatime 0 0"</span> <span class="o">&gt;&gt;</span> /etc/fstab
  - mount /mnt/localdisk
<span class="c">#</span>
<span class="c"># Stop firewalld</span>
  - systemctl stop firewalld
  - systemctl disable firewalld
<span class="c">#</span>
<span class="c"># Set up RDMA interface</span>
  - ifdown ens800f0
  - <span class="nb">echo</span> <span class="s2">"TYPE=</span><span class="se">\"</span><span class="s2">Ethernet</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"BOOTPROTO=</span><span class="se">\"</span><span class="s2">none</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"IPADDR=192.168.0.</span><span class="sb">`</span>ifconfig ens300f0 | <span class="nb">head</span> <span class="nt">-2</span> | <span class="nb">tail</span> <span class="nt">-1</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | <span class="nb">awk</span> <span class="nt">-F</span><span class="nb">.</span> <span class="s1">'{print $4}'</span><span class="sb">`</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"NETMASK=255.255.255.0"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"DEFROUTE=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"PEERDNS=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"PEERROUTES=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"IPV4_FAILURE_FATAL=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"IPV6INIT=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"IPV6_FAILURE_FATAL=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"NAME=</span><span class="se">\"</span><span class="s2">System ens800f0</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"DEVICE=</span><span class="se">\"</span><span class="s2">ens800f0</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"ONBOOT=</span><span class="se">\"</span><span class="s2">yes</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - <span class="nb">echo</span> <span class="s2">"NM_CONTROLLED=</span><span class="se">\"</span><span class="s2">no</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens800f0
  - ifup ens800f0
<span class="c">#</span>
<span class="c"># Start CN authentication renew service for OL8 HPC image to avoid 15min. hiatus of CN connection on deployment</span>
  - systemctl start oci-cn-auth-renew.service
</code></pre></div></div>

<p>このcloud-init設定ファイルのRDMAインタフェース設定は、プライベートサブネットに接続するTCP接続（インターフェース名：ens300f0）用IPアドレスの4フィールド目の値を取得し、この値を4フィールド目に持つ192.168.0.xをクラスタ・ネットワークに接続するRDMAインタフェースのIPアドレスに設定します。</p>

<p>またこのcloud-init設定ファイルは、RDMAインタフェースを設定する際に指定するインタフェース名がBM.Optimized3.36用（ens800f0）になっているため、他のクラスタ・ネットワーク対応のシェイプ（BM.HPC2.36やBM.GPU4.8等）を使用する場合は、使用するシェイプに合わせてRDMAインタフェース名を変更します。</p>

<p>なお、BM.GPU4.8をクラスタ・ネットワークに接続するためのRDMAインタフェースを設定する際のcloud-init設定ファイルは、以下のチュートリアル”GPUクラスタを構築する（手動構築編）”にその記載があります。</p>

<p><a href="https://oracle-japan.github.io/ocitutorials/intermediates/spinup-gpu-cluster/#1-1-cloud-init%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BD%9C%E6%88%90">https://oracle-japan.github.io/ocitutorials/intermediates/spinup-gpu-cluster/#1-1-cloud-init%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BD%9C%E6%88%90</a></p>

<h2 id="1-2-インスタンス構成作成">1-2. インスタンス構成作成</h2>

<p>本章は、インスタンス構成を作成します。</p>

<p>インスタンス構成は、インスタンスをデプロイする際のひな型設定で、一度インスタンス構成を作成すると、これを利用して簡単に同じ属性のインスタンスをデプロイすることが出来るようになります。</p>

<ol>
  <li>
    <p>OCIコンソールにログインし、クラスタ・ネットワークをデプロイするリージョンを選択後、 <strong>コンピュート</strong> → <strong>インスタンス構成</strong> とメニューを辿ります。</p>
  </li>
  <li>
    <p>表示される以下画面で、<strong>インスタンス構成の作成</strong> ボタンをクリックします。</p>

    <p><img src="console_page02.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される <strong>インスタンス構成の作成</strong> 画面で、以下の情報を入力し <strong>作成</strong> ボタンをクリックします。なお、ここに記載のないフィールドは、デフォルトのままとします。</p>

    <p>3.1 <strong>インスタンス構成情報</strong> フィールド</p>

    <ul>
      <li><strong>名前</strong> ：インスタンス構成に付与する名前</li>
      <li><strong>コンパートメントに作成</strong> ：インスタンス構成を作成するコンパートメント</li>
    </ul>

    <p><img src="console_page03.png" alt="画面ショット" /></p>

    <p>3.2 <strong>インスタンスの作成先のコンパートメント</strong> フィールド：クラスタ・ネットワークをデプロイするコンパートメント</p>

    <p><img src="console_page04.png" alt="画面ショット" /></p>

    <p>3.3 <strong>配置</strong> フィールド</p>
    <ul>
      <li><strong>可用性ドメイン</strong> ：クラスタ・ネットワークをデプロイする可用性ドメイン</li>
    </ul>

    <p><img src="console_page05.png" alt="画面ショット" /></p>

    <p>3.4 <strong>イメージとシェイプ</strong> フィールド</p>

    <p><img src="console_page06.png" alt="画面ショット" /></p>

    <ul>
      <li><strong>イメージ</strong> ：Oracle Linux - HPC Cluster Networking Image (<strong>イメージの変更</strong> ボタンをクリックして表示される以下 <strong>すべてのイメージの参照</strong> サイドバーで <strong>イメージ・ソース</strong> フィールドに <strong>Oracleイメージ</strong> を選択し検索フィールドに <strong>hpc</strong> と入力して表示される <strong>Oracle Linux - HPC Cluster Networking Image</strong> を選択し右側のボタンをクリックして表示される <strong>イメージ・ビルド</strong> フィールドで <strong>OracleLinux-8-RHCK-OFED-5.4-3.5.8.0-2022.11.15-0</strong> を選択し <strong>イメージの選択</strong> ボタンをクリック）</li>
    </ul>

    <p><img src="console_page08.png" alt="画面ショット" /></p>

    <p>ここで指定しているイメージは、OCIのマーケットプレースから提供するOracke Linux 8をベースに作成されたクラスタ・ネットワークに接続するために必要なソフトウェアが含まれるイメージ（以降 <strong>HPCイメージ</strong> と呼称）です。</p>

    <ul>
      <li><strong>Shape</strong> ：BM.Optimized3.36 (<strong>Change Shape</strong> ボタンをクリックして表示される以下 <strong>すべてのシェイプの参照</strong> サイドバーで <strong>ベア・メタル・マシン</strong> をクリックして表示される <strong>BM.Optimized3.36</strong> を選択し <strong>シェイプの選択</strong> ボタンをクリック）</li>
    </ul>

    <p><img src="console_page07.png" alt="画面ショット" /></p>

    <p>3.5 <strong>ネットワーキング</strong> フィールド</p>
    <ul>
      <li><strong>プライマリ・ネットワーク</strong> ： 先に作成したVCNを選択</li>
      <li><strong>サブネット</strong> ：先に作成したプライベートサブネットを選択</li>
    </ul>

    <p><img src="console_page09.png" alt="画面ショット" /></p>

    <p>3.6 <strong>SSHキーの追加</strong> フィールド</p>
    <ul>
      <li><strong>SSHキー</strong> ：先にbastionで作成したSSH鍵の公開鍵（ <strong>公開キーの貼付け</strong> を選択することで入力フィールドを表示）</li>
    </ul>

    <p><img src="console_page10.png" alt="画面ショット" /></p>

    <p>3.7 <strong>管理</strong> フィールド（以下 <strong>拡張オプションの表示</strong> ボタンを選択して表示）</p>

    <p><img src="console_page11.png" alt="画面ショット" /></p>

    <ul>
      <li><strong>cloud-initスクリプト</strong> ：先に作成したcloud-init設定ファイルを選択（ <strong>参照</strong> ボタンでファイルを選択）</li>
    </ul>

    <p><img src="console_page12.png" alt="画面ショット" /></p>
  </li>
</ol>

<h2 id="1-3-クラスタネットワーク作成">1-3. クラスタ・ネットワーク作成</h2>

<p>本章は、既に作成したcloud-init設定ファイルとインスタンス構成を使用して、クラスタ・ネットワークを作成します。</p>

<ol>
  <li>
    <p>OCIコンソールにログインし、クラスタ・ネットワークをデプロイするリージョンを選択後、 <strong>コンピュート</strong> → <strong>クラスタ・ネットワーク</strong> とメニューを辿ります。</p>
  </li>
  <li>
    <p>表示される以下画面で、<strong>クラスタ・ネットワークの作成</strong> ボタンをクリックします。</p>

    <p><img src="console_page13.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される <strong>クラスタ・ネットワークの作成</strong> 画面で、以下の情報を入力し <strong>クラスタ・ネットワークの作成</strong> ボタンをクリックします。なお、ここに記載のないフィールドは、デフォルトのままとします。</p>

    <p>3.1 <strong>名前</strong> フィールド：クラスタ・ネットワークに付与する名前</p>

    <p><img src="console_page14.png" alt="画面ショット" /></p>

    <p>3.2 <strong>コンパートメントに作成</strong> フィールド：クラスタ・ネットワークを作成するコンパートメント</p>

    <p><img src="console_page15.png" alt="画面ショット" /></p>

    <p>3.2 <strong>可用性ドメイン</strong> フィールド：クラスタ・ネットワークをデプロイする可用性ドメイン</p>

    <p><img src="console_page16.png" alt="画面ショット" /></p>

    <p>3.3 <strong>ネットワーキングの構成</strong> フィールド</p>

    <ul>
      <li><strong>仮想クラウド・ネットワーク</strong> ：先に作成したVCNを選択</li>
      <li><strong>サブネット</strong> ：先に作成したプライベートサブネットを選択</li>
    </ul>

    <p><img src="console_page17.png" alt="画面ショット" /></p>

    <p>3.4 <strong>インスタンス・プールの構成</strong> フィールド</p>

    <ul>
      <li><strong>インスタンス・プール名</strong> ：作成されるインスタンス・プールに付与する名前</li>
      <li><strong>インスタンス数</strong> ：デプロイする計算ノードのノード数</li>
      <li><strong>インスタンス構成</strong> ：先に作成したインスタンス構成</li>
    </ul>

    <p><img src="console_page18.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>クラスタ・ネットワーク作業リクエスト</strong> 画面で、左上のステータスが <strong>プロビジョニング中</strong> と表示されれば、クラスタ・ネットワークと計算ノードの作成が実施されています。</p>

    <p><img src="console_page19.png" alt="画面ショット" /></p>

    <p>ステータスが <strong>実行中</strong> となれば、クラスタ・ネットワークと計算ノードの作成が完了しています。</p>
  </li>
</ol>

<hr />
<h1 id="2-計算ノード確認">2. 計算ノード確認</h1>

<p>本章は、デプロイされた計算ノードにログインし、環境を確認します。</p>

<h2 id="21-計算ノードログイン">2.1. 計算ノードログイン</h2>

<p>計算ノードは、プライベートサブネットに接続されており、インターネットからログインすることが出来ないため、bastionノードを経由してSSHログインします。bastionノードから計算ノードへのログインは、計算ノードのイニシャルホスト名を使用します。</p>

<p>計算ノードのイニシャルホスト名は、OCIコンソールで計算ノードをデプロイしたリージョンを選択後、 <strong>コンピュート</strong> → <strong>インスタンス</strong> とメニューを辿り、以下のインスタンス一覧からそのイニシャルホスト名を確認します。</p>

<p>またこの画面は、計算ノードのIPアドレスも表示されており、これを使用してbastionからSSHログインすることも可能です。</p>

<p><img src="console_page20.png" alt="画面ショット" /></p>

<p>計算ノードへのログインは、以下のようにbastionからopcユーザでSSHログインします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> ssh inst-wyr6m-comp
The authenticity of host <span class="s1">'inst-wyr6m-comp (10.0.1.61)'</span> cant be established.
ECDSA key fingerprint is SHA256:z1Hqcm+vNKQLCvqL6t1fqCgqpqo+onshYP7tI1AcwYU.
ECDSA key fingerprint is MD5:0a:86:6f:d3:86:36:d0:7d:74:3e:8c:3f:cd:4c:3a:68.
Are you sure you want to <span class="k">continue </span>connecting <span class="o">(</span><span class="nb">yes</span>/no<span class="o">)</span>? <span class="nb">yes
</span>Warning: Permanently added <span class="s1">'inst-wyr6m-comp,10.0.1.61'</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
</code></pre></div></div>

<h2 id="22-cloud-init完了確認">2.2. cloud-init完了確認</h2>

<p>cloud-initは、計算ノードが起動してSSHログインできる状態であっても、その処理が継続している可能性があるため、以下コマンドでそのステータスを表示し、 <strong>done</strong> となっていることでcloud-initの処理完了を確認します。</p>

<p>ステータスが <strong>running</strong> の場合は、cloud-initの処理が継続中のため、処理が完了するまで待ちます。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">sudo </span>cloud-init status
status: <span class="k">done</span>
</code></pre></div></div>

<h2 id="23-計算ノードファイルシステム確認">2.3. 計算ノードファイルシステム確認</h2>

<p>計算ノードは、以下のようにNVMe領域が/mnt/localdiskにマウントされています。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">df</span> <span class="nt">-k</span> /mnt/localdisk
Filesystem                  1K-blocks     Used  Available Use% Mounted on
/dev/nvme0n1p1             3748905484    32976 3748872508   1% /mnt/localdisk
</code></pre></div></div>

<hr />
<h1 id="3-mpiプログラム実行2ノード編">3. MPIプログラム実行（2ノード編）</h1>

<h2 id="3-0-mpiプログラム実行2ノード編概要">3-0. MPIプログラム実行（2ノード編）概要</h2>

<p>本章は、計算ノードのHPCイメージに含まれるOpenMPIとIntel MPI Benchmarkを使用し、クラスタ・ネットワークのノード間インターコネクト性能を確認します。</p>

<p>OpenMPIを計算ノード間で実行するためには、mpirunを実行する計算ノード（いわゆるヘッドノード）からOpenMPI実行に参加する他の全ての計算ノードに対して、パスフレーズ無しでSSH接続できる必要があります。</p>

<p>またOpenMPIの実行は、これを実行する計算ノード間で必要なポートにアクセス出来る必要があるため、先に作成したプライベートサブネットのセキュリティリストを修正する必要があります。</p>

<p>以上より、本章で実施するIntel MPI BenchmarkによるMPIプログラム実行は、以下の手順を経て行います。</p>

<ul>
  <li>計算ノード間SSH接続環境構築</li>
  <li>プライベートサブネットセキュリティリスト修正</li>
  <li>Intel MPI Benchmark Ping-Pong実行</li>
</ul>

<p>ここでは、2ノードのPing-Pong性能を計測しており、以下性能が出ています。</p>

<ul>
  <li>帯域：約11 GB/s（インタフェース物理帯域100 Gbpsに対し88 Gbpsを計測）</li>
  <li>レイテンシ：約1.7 μs</li>
</ul>

<h2 id="3-1-計算ノード間ssh接続環境構築">3-1. 計算ノード間SSH接続環境構築</h2>

<p>本章は、先にbastionノードで作成したSSH秘密鍵を全ての計算ノードにコピーすることで、全ての計算ノード間でパスフレーズ無しのSSH接続環境を実現します。</p>

<p>まず初めに、先に確認したOCIコンソールのインスタンス一覧を使用し、以下のように全ての計算ノードのイニシャルホスト名を含むファイルをbastion上に作成します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat </span>hostlist.txt 
inst-wyr6m-comp
inst-9wead-comp
</code></pre></div></div>

<p>次にこのファイルを使用し、以下コマンドで全計算ノードにbastionノードのSSH秘密鍵をコピーします。この際、計算ノード1ノード毎に接続確認を求められるため、全てに <strong>yes</strong> を入力します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">for </span>hname <span class="k">in</span> <span class="sb">`</span><span class="nb">cat </span>hostlist.txt<span class="sb">`</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$hname</span><span class="p">;</span> scp <span class="nt">-p</span> ~/.ssh/id_rsa <span class="nv">$hname</span>:~/.ssh/<span class="p">;</span> <span class="k">done
</span>inst-wyr6m-comp
The authenticity of host <span class="s1">'inst-wyr6m-comp (10.0.1.61)'</span> cannot be established.
ECDSA key fingerprint is SHA256:z1Hqcm+vNKQLCvqL6t1fqCgqpqo+onshYP7tI1AcwYU.
ECDSA key fingerprint is MD5:0a:86:6f:d3:86:36:d0:7d:74:3e:8c:3f:cd:4c:3a:68.
Are you sure you want to <span class="k">continue </span>connecting <span class="o">(</span><span class="nb">yes</span>/no<span class="o">)</span>? <span class="nb">yes
</span>Warning: Permanently added <span class="s1">'inst-wyr6m-comp,10.0.1.61'</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
id_rsa                                                                 100% 1675     1.9MB/s   00:00    
inst-9wead-comp
The authenticity of host <span class="s1">'inst-9wead-comp (10.0.1.62)'</span> cannot be established.
ECDSA key fingerprint is SHA256:alxTYf1T2VGbwLYSuvBs5X29YorXB40rAwWWuVDKxPA.
ECDSA key fingerprint is MD5:14:73:f4:87:3c:43:72:b5:cc:b2:e8:37:15:2f:20:3e.
Are you sure you want to <span class="k">continue </span>connecting <span class="o">(</span><span class="nb">yes</span>/no<span class="o">)</span>? <span class="nb">yes
</span>Warning: Permanently added <span class="s1">'inst-9wead-comp,10.0.1.62'</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
id_rsa                                                                 100% 1675     1.8MB/s   00:00
</code></pre></div></div>

<p>次に、先のSSH秘密鍵のコピーでbastionノードに作成された全計算ノードのエントリを含むknown_hostsファイルを、以下コマンドで全計算ノードにコピーします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">for </span>hname <span class="k">in</span> <span class="sb">`</span><span class="nb">cat </span>hostlist.txt<span class="sb">`</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$hname</span><span class="p">;</span> scp <span class="nt">-p</span> ~/.ssh/known_hosts <span class="nv">$hname</span>:~/.ssh/<span class="p">;</span> <span class="k">done
</span>inst-wyr6m-comp
known_hosts                                                            100%  440   631.9KB/s   00:00    
inst-9wead-comp
known_hosts                                                            100%  440   470.6KB/s   00:00
</code></pre></div></div>

<p>次に、後のIntel MPI Benchmark Ping-Ponを実行する際に使用する、先に作成した計算ノードのイニシャルホスト名を格納したファイルを、以下コマンドで全計算ノードにコピーします。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">for </span>hname <span class="k">in</span> <span class="sb">`</span><span class="nb">cat </span>hostlist.txt<span class="sb">`</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$hname</span><span class="p">;</span> scp <span class="nt">-p</span> ./hostlist.txt <span class="nv">$hname</span>:~/<span class="p">;</span> <span class="k">done
</span>inst-wyr6m-comp
hostlist.txt                                                           100%   32   113.3KB/s   00:00    
inst-9wead-comp
hostlist.txt                                                           100%   32   146.3KB/s   00:00
</code></pre></div></div>

<h2 id="3-2-プライベートサブネットセキュリティリスト修正">3-2. プライベートサブネットセキュリティリスト修正</h2>

<p>本章は、プライベートサブネットのセキュリティリストを以下の手順で修正します。</p>

<ol>
  <li>
    <p>OCIコンソールにログインし、計算ノードをデプロイしたリージョンを選択後、 <strong>ネットワーキング</strong> → <strong>仮想クラウド・ネットワーク</strong> とメニューを辿ります。</p>
  </li>
  <li>
    <p>表示される画面で、先に作成した仮想クラウド・ネットワークをクリックします。</p>
  </li>
  <li>
    <p>表示される以下 <strong>サブネット</strong> フィールドで、先に作成したプライベートサブネットをクリックします。</p>

    <p><img src="console_page20-2.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>セキュリティ・リスト</strong> フィールドで、プライベートサブネットに適用されているセキュリティリストをクリックします。</p>

    <p><img src="console_page21.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>イングレス・ルール</strong> フィールドで、SSHアクセスを許可しているルールの <strong>編集</strong> メニューをクリックします。</p>

    <p><img src="console_page22.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>イングレス・ルールの編集</strong> サイドバーで、 <strong>IPプロトコル</strong> フィールドを <strong>すべてのプロトコル</strong> に変更し、 <strong>変更の保存</strong> ボタンをクリックします。</p>

    <p><img src="console_page23.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>イングレス・ルール</strong> フィールドで、変更したルールの <strong>IPプロトコル</strong> が <strong>すべてのプロトコル</strong> に変更されたことを確認します。</p>

    <p><img src="console_page24.png" alt="画面ショット" /></p>
  </li>
</ol>

<h2 id="3-3-intel-mpi-benchmark-ping-pong実行">3-3. Intel MPI Benchmark Ping-Pong実行</h2>

<p>本章は、Intel MPI Benchmark Ping-Pongを実行します。</p>

<p>計算ノードのうちの1ノードにopcユーザでSSHログインし、以下コマンドを実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">source</span> /usr/mpi/gcc/openmpi-4.1.2a1/bin/mpivars.sh
<span class="o">&gt;</span> mpirun <span class="nt">-n</span> 2 <span class="nt">-N</span> 1 <span class="nt">-hostfile</span> ./hostlist.txt <span class="nt">-x</span> <span class="nv">UCX_NET_DEVICES</span><span class="o">=</span>mlx5_2:1 /usr/mpi/gcc/openmpi-4.1.2a1/tests/imb/IMB-MPI1 <span class="nt">-msglog</span> 3:28 PingPong
<span class="c">#------------------------------------------------------------</span>
<span class="c">#    Intel (R) MPI Benchmarks 2018, MPI-1 part    </span>
<span class="c">#------------------------------------------------------------</span>
<span class="c"># Date                  : Fri Jan 27 17:14:26 2023</span>
<span class="c"># Machine               : x86_64</span>
<span class="c"># System                : Linux</span>
<span class="c"># Release               : 4.18.0-372.26.1.0.1.el8_6.x86_64</span>
<span class="c"># Version               : #1 SMP Tue Sep 13 21:44:27 PDT 2022</span>
<span class="c"># MPI Version           : 3.1</span>
<span class="c"># MPI Thread Environment: </span>


<span class="c"># Calling sequence was: </span>

<span class="c"># /usr/mpi/gcc/openmpi-4.1.2a1/tests/imb/IMB-MPI1 -msglog 3:28 PingPong</span>

<span class="c"># Minimum message length in bytes:   0</span>
<span class="c"># Maximum message length in bytes:   268435456</span>
<span class="c">#</span>
<span class="c"># MPI_Datatype                   :   MPI_BYTE </span>
<span class="c"># MPI_Datatype for reductions    :   MPI_FLOAT</span>
<span class="c"># MPI_Op                         :   MPI_SUM  </span>
<span class="c">#</span>
<span class="c">#</span>

<span class="c"># List of Benchmarks to run:</span>

<span class="c"># PingPong</span>

<span class="c">#---------------------------------------------------</span>
<span class="c"># Benchmarking PingPong </span>
<span class="c"># #processes = 2 </span>
<span class="c">#---------------------------------------------------</span>
       <span class="c">#bytes #repetitions      t[usec]   Mbytes/sec</span>
            0         1000         1.66         0.00
            8         1000         1.66         4.81
           16         1000         1.67         9.59
           32         1000         1.70        18.77
           64         1000         1.84        34.86
          128         1000         1.88        68.01
          256         1000         2.14       119.52
          512         1000         2.86       178.76
         1024         1000         2.34       438.04
         2048         1000         2.97       689.33
         4096         1000         3.46      1184.22
         8192         1000         4.47      1831.97
        16384         1000         6.28      2610.75
        32768         1000         8.16      4018.05
        65536          640        10.27      6383.12
       131072          320        15.51      8449.89
       262144          160        29.02      9031.92
       524288           80        51.64     10153.66
      1048576           40        97.01     10808.74
      2097152           20       187.74     11170.72
      4194304           10       369.25     11358.83
      8388608            5       732.18     11457.09
     16777216            2      1461.24     11481.46
     33554432            1      2933.51     11438.32
     67108864            1      5876.47     11419.94
    134217728            1     11797.17     11377.11
    268435456            1     23900.00     11231.61


<span class="c"># All processes entering MPI_Finalize</span>
</code></pre></div></div>

<hr />
<h1 id="4-計算ノード追加">4. 計算ノード追加</h1>

<p>本章は、作成したクラスタ・ネットワークに接続する計算ノードを2ノード追加して4ノードに拡張します。</p>

<ol>
  <li>
    <p>OCIコンソールメニューから <strong>コンピュート</strong> → <strong>クラスタ・ネットワーク</strong> を選択し、表示される画面で作成したクラスタ・ネットワークをクリックします。</p>
  </li>
  <li>
    <p>表示される以下画面で、 <strong>編集</strong> ボタンをクリックします。</p>

    <p><img src="console_page25.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>クラスタ・ネットワークの編集</strong> サイドバーで、 <strong>インスタンス数</strong> フィールドを4に変更し <strong>変更の保存</strong> ボタンをクリックします。</p>

    <p><img src="console_page26.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>クラスタ・ネットワーク・インスタンス・プール</strong> ウィンドウで、左上のステータスが <strong>スケーリング中</strong> → <strong>完了</strong> と遷移したら、計算ノードの追加が完了しています。</p>

    <p><img src="console_page27.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>同じウィンドウ下方の以下 <strong>インスタンス・プール</strong> フィールドで、 <strong>インスタンス数</strong> が4に増加していることを確認します。</p>

    <p><img src="console_page28.png" alt="画面ショット" /></p>
  </li>
</ol>

<hr />
<h1 id="5-mpiプログラム実行4ノード編">5. MPIプログラム実行（4ノード編）</h1>

<h2 id="5-0-mpiプログラム実行4ノード編概要">5-0. MPIプログラム実行（4ノード編）概要</h2>

<p>本章は、追加した2ノードを含めた計4ノードの計算ノードのインターコネクト性能をIntel MPI Benchmarkで確認します。</p>

<p>ここでは、4ノードのAlltoall性能を計測しています。</p>

<h2 id="5-1-計算ノード間ssh接続環境構築">5-1. 計算ノード間SSH接続環境構築</h2>

<p>本章は、追加した2ノードを含めた4ノードの計算ノード間で、パスフレーズ無しのSSH接続ができる環境を構築します。</p>

<p>具体的な手順は、 <strong><a href="#3-1-計算ノード間ssh接続環境構築">3-1. 計算ノード間SSH接続環境構築</a></strong> を参照ください。</p>

<h2 id="5-2-intel-mpi-benchmark-alltoall実行">5-2. Intel MPI Benchmark Alltoall実行</h2>

<p>計算ノードのうつの1ノードにopcユーザでSSHログインし、以下コマンドを実行します。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">source</span> /usr/mpi/gcc/openmpi-4.1.2a1/bin/mpivars.sh
<span class="o">&gt;</span> mpirun <span class="nt">-n</span> 4 <span class="nt">-N</span> 1 <span class="nt">-hostfile</span> ./hostlist.txt <span class="nt">-x</span> <span class="nv">UCX_NET_DEVICES</span><span class="o">=</span>mlx5_2:1 /usr/mpi/gcc/openmpi-4.1.2a1/tests/imb/IMB-MPI1 <span class="nt">-mem</span> 4 Alltoall 
<span class="c">#------------------------------------------------------------</span>
<span class="c">#    Intel (R) MPI Benchmarks 2018, MPI-1 part    </span>
<span class="c">#------------------------------------------------------------</span>
<span class="c"># Date                  : Tue Jan 31 06:22:34 2023</span>
<span class="c"># Machine               : x86_64</span>
<span class="c"># System                : Linux</span>
<span class="c"># Release               : 4.18.0-372.26.1.0.1.el8_6.x86_64</span>
<span class="c"># Version               : #1 SMP Tue Sep 13 21:44:27 PDT 2022</span>
<span class="c"># MPI Version           : 3.1</span>
<span class="c"># MPI Thread Environment: </span>


<span class="c"># Calling sequence was: </span>

<span class="c"># /usr/mpi/gcc/openmpi-4.1.2a1/tests/imb/IMB-MPI1 -mem 4 Alltoall</span>

<span class="c"># Minimum message length in bytes:   0</span>
<span class="c"># Maximum message length in bytes:   4194304</span>
<span class="c">#</span>
<span class="c"># MPI_Datatype                   :   MPI_BYTE </span>
<span class="c"># MPI_Datatype for reductions    :   MPI_FLOAT</span>
<span class="c"># MPI_Op                         :   MPI_SUM  </span>
<span class="c">#</span>
<span class="c">#</span>

<span class="c"># List of Benchmarks to run:</span>

<span class="c"># Alltoall</span>

<span class="c">#----------------------------------------------------------------</span>
<span class="c"># Benchmarking Alltoall </span>
<span class="c"># #processes = 2 </span>
<span class="c"># ( 2 additional processes waiting in MPI_Barrier)</span>
<span class="c">#----------------------------------------------------------------</span>
       <span class="c">#bytes #repetitions  t_min[usec]  t_max[usec]  t_avg[usec]</span>
            0         1000         0.03         0.03         0.03
            1         1000         3.13         3.77         3.45
            2         1000         3.32         3.59         3.46
            4         1000         3.26         3.65         3.45
            8         1000         3.32         3.61         3.47
           16         1000         3.24         3.67         3.46
           32         1000         3.25         3.77         3.51
           64         1000         1.31         6.46         3.88
          128         1000         3.87         4.42         4.15
          256         1000         1.38         6.91         4.15
          512         1000         3.83         4.19         4.01
         1024         1000         1.61         7.17         4.39
         2048         1000         4.93         5.54         5.24
         4096         1000         7.27         7.70         7.49
         8192         1000         7.97         8.13         8.05
        16384         1000         9.46         9.54         9.50
        32768         1000        11.43        11.48        11.45
        65536          640        21.34        21.45        21.39
       131072          320        30.19        30.25        30.22
       262144          160        46.84        46.93        46.88
       524288           80        78.71        78.74        78.72
      1048576           40       188.45       192.14       190.29
      2097152           20       336.62       340.21       338.42
      4194304           10       713.29       718.38       715.84

<span class="c">#----------------------------------------------------------------</span>
<span class="c"># Benchmarking Alltoall </span>
<span class="c"># #processes = 4 </span>
<span class="c">#----------------------------------------------------------------</span>
       <span class="c">#bytes #repetitions  t_min[usec]  t_max[usec]  t_avg[usec]</span>
            0         1000         0.03         0.03         0.03
            1         1000         4.02         4.32         4.16
            2         1000         4.05         4.37         4.20
            4         1000         4.03         4.35         4.18
            8         1000         4.07         4.40         4.23
           16         1000         4.12         4.43         4.26
           32         1000         4.07         4.41         4.23
           64         1000         4.26         4.57         4.40
          128         1000         4.38         4.69         4.53
          256         1000         4.90         5.41         5.15
          512         1000         5.02         5.53         5.27
         1024         1000         5.29         5.84         5.56
         2048         1000         5.61         6.06         5.83
         4096         1000         8.45         8.71         8.57
         8192         1000         9.96        10.43        10.20
        16384         1000        12.52        13.87        13.20
        32768         1000        22.50        23.07        22.81
        65536          640        33.11        33.87        33.50
       131072          320        52.12        52.76        52.40
       262144          160        90.90        92.47        91.37
       524288           80       173.89       176.26       174.68
      1048576           40       371.47       380.94       375.46
      2097152           20       732.57       747.82       738.86
      4194304           10      1405.77      1422.57      1412.98


<span class="c"># All processes entering MPI_Finalize</span>
</code></pre></div></div>

<hr />
<h1 id="6-計算ノード入れ替え">6. 計算ノード入れ替え</h1>

<p>本章は、構築した4ノードクラスタのうち1ノードにハードウェア障害等が発生した場合を想定し、この計算ノードを新たな計算ノードに入れ替えます。</p>

<ol>
  <li>
    <p>OCIコンソールメニューから <strong>コンピュート</strong> → <strong>クラスタ・ネットワーク</strong> を選択し、表示される以下画面で、作成されたクラスタ・ネットワークをクリックします。</p>

    <p><img src="console_page31.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面の <strong>インスタンス・プール</strong> フィールドで、クラスタ・ネットワークの作成に伴い作成されたインスタンスプールをクリックします。</p>

    <p><img src="console_page32.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面左下の <strong>アタッチされたインスタンス</strong> メニューをクリックします。</p>

    <p><img src="console_page33.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される画面の以下 <strong>アタッチされたインスタンス</strong> フィールドで、削除するインスタンスのメニューから <strong>インスタンスのデタッチ</strong> メニューをクリックします。</p>

    <p><img src="console_page34.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面で、 <strong>このインスタンスおよびアタッチされたブート・ボリュームを完全に終了（削除）</strong> と <strong>プールのインスタンス構成をインスタンスのテンプレートとして使用し、インスタンスを新しいインスタンスで置き換える</strong> チェックボックスをチェックし、 <strong>デタッチと終了</strong> ボタンをクリックします。</p>

    <p><img src="console_page35.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>OCIコンソールメニューから <strong>コンピュート</strong> → <strong>インスタンス</strong> とメニューを辿り、デタッチしたインスタンスが終了され、新たなインスタンスが実行中となれば、計算ノードの入れ替えは終了です。</p>
  </li>
</ol>

<p>再度 <strong><a href="#5-mpiプログラム実行4ノード編">5. MPIプログラム実行（4ノード編）</a></strong> に従いIntel MPIベンチマークを実行、インターコネクト性能が十分出ていることを確認します。</p>

<hr />
<h1 id="7-クラスタネットワークの終了">7. クラスタ・ネットワークの終了</h1>

<p>本章は、クラスタ・ネットワークを終了することで、作成したクラスタ・ネットワークと計算ノードを削除します。</p>

<ol>
  <li>
    <p>OCIコンソールメニューから <strong>コンピュート</strong> → <strong>クラスタ・ネットワーク</strong> を選択し、表示される以下画面で作成したクラスタ・ネットワークの <strong>終了</strong> メニューをクリックします。</p>

    <p><img src="console_page29.png" alt="画面ショット" /></p>
  </li>
</ol>

<p>クラスタ・ネットワークの <strong>状態</strong> が <strong>終了済</strong> となれば、削除が完了しています。</p>

<p>これで、このチュートリアルは終了です。</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time datetime="2023-03-09T09:06:46+09:00">March 9, 2023</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=HPC%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B%28%E5%9F%BA%E7%A4%8E%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E6%89%8B%E5%8B%95%E6%A7%8B%E7%AF%89%E7%B7%A8%29%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fhpc%2Fspinup-cluster-network%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fhpc%2Fspinup-cluster-network%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fhpc%2Fspinup-cluster-network%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/hpc/spinup-ml-instance/" class="pagination--pager" title="GPUインスタンスで機械学習にトライ
">前へ</a>
    
    
      <a href="/ocitutorials/hpc/spinup-gpu-cluster-withstack/" class="pagination--pager" title="GPUクラスタを構築する(スタティッククラスタ自動構築編)
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">関連記事</h4>
      <div class="grid__wrapper">
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Oracle Cloud Infrastructure チュートリアル. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  
    <script src="/ocitutorials/assets/js/tabs.js"></script>
  
    <script src="/ocitutorials/assets/js/sidebar.js"></script>
  



  </body>
</html>
