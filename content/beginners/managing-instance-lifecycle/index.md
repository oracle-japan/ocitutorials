---
title: "その5 - インスタンスのライフサイクルを管理する"
description: "作ったインスタンスを必要なときに止めたり、削除したり、また再作成したりと、いつでも簡単にできてしまうところがクラウドのいいところです。実際にどのような動きになるのか試してみましょう。"
weight: 050
images:
- beginners/managing-instance-lifecycle/img_header.png
tags:
- コンピュート
#link: https://community.oracle.com/tech/welcome/discussion/4474283/
---

**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)

<br>

リソースを必要なときに必要なだけ使える、というのがクラウドのいいところですね。そのために作成したインスタンスはいつでも停止、再起動、終了、再作成といった処理が行えるようになっています。このチュートリアルでは、そのようなインスタンスのライフサイクル管理をどう行うかと、それぞれのステータスで実際にインスタンスがどのような状態になっているのかについて確認していきます。

**所要時間 :** 約20分

**前提条件 :**
- [その3 - インスタンスを作成する](../creating-compute-instance) を通じてコンピュート・インスタンスの作成が完了していること
- [その4 - ブロック・ボリュームをインスタンスにアタッチする](../attaching-block-volume) を通じてブロック・ボリュームのアタッチが完了していること

**注意 :** チュートリアル内の画面ショットについては Oracle Cloud Infrastructure の現在のコンソール画面と異なっている場合があります

**目次 :**
   1. [インスタンスの停止、再起動](#anchor1)
   2. [インスタンスの終了(Terminate)](#anchor2)
   3. [ブート・ボリュームからのインスタンスの再作成](#anchor3)

<br>

**参考動画：** 本チュートリアルの内容をベースとした定期ハンズオンWebinarの録画コンテンツです。操作の流れや解説を動画で確認したい方はご参照ください。

- [Oracle Cloud Infrastructure ハンズオン - 5.インスタンスのライフサイクル](https://videohub.oracle.com/media/Oracle+Cloud+Infrastructure+%E3%83%8F%E3%83%B3%E3%82%BA%E3%82%AA%E3%83%B3+-+5.%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB/1_h2rb5d4x)

<a id="anchor1"></a>

# 1. インスタンスの停止、再起動

まずは、インスタンスの停止、再起動処理と、その際に実行される動作について確認していきましょう。

<br>

## 1-1. ブートボリュームへのファイルの作成

OCIのインスタンスは、すべてブート・ボリュームと呼ばれる永続化されたiSCSIデバイスからネットワーク経由でブート(iPXEブート)されます。

このブート・ボリュームの変更(OSのパラメーター変更など)が、インスタンスのライフサイクル操作によってどのような影響を受けるかを確認するために、予めファイルを1つ作成します。

1. SSHターミナルを開き、 で作成したインスタンスにsshでアクセスします

2. アクセスしたユーザーホームディレクトリに、任意のファイルを作成します。
   下記の例では、opcユーザーのホームディレクトリ(/home/opc)に、testfileというファイルを作成しています

    ```sh
    [opc@testvm1 ~]$ pwd
    /home/opc
    [opc@testvm1 ~]$ touch testfile
    [opc@testvm1 ~]$ ls -l
    total 0
    -rw-rw-r--. 1 opc opc 0 Feb 16 16:47 testfile
    [opc@testvm1 ~]$
    ```

<br>

## 1-2. インスタンスの停止

インスタンスを停止し、その際にどのようなことが起こるかをOCIコンソールから確認します。

1. コンソールメニューから コンピュート → **`インスタンス`** を選択し、で作成したインスタンス名 (TestVM1など) のリンクをクリックします

2. インスタンスの詳細画面の右上部にある **`アクション`** メニューから **`停止`** をクリックします

    ![img1-2-2.png](img1-2-2.png)

3. 確認を求めるメッセージ・ダイアログが立ち上がるので、**`インスタンスの停止`** ボタンを押します

    ![img1-2-3.png](img1-2-3.png)

4. インスタンスのステータスが **`停止中`** となり、その後 **`停止済`** に変わります

    ![img1-2-4.png](img1-2-4.png)

    sshでアクセスしていたターミナル・ウィンドウも接続が切断されています。(Tera Termの場合はウィンドウが閉じているはずです)

5. **`停止済`** になったインスタンスの状態を、OCIコンソールから確認します。
   主な確認ポイントは以下のとおりです。

    - インスタンス情報の画面の **`ネットワーキング`** のタブを開き、 **`プライマリVNIC情報`** フィールドを確認すると、**`プライベートIPアドレス`** と **`パブリックIPアドレス`** に、インスタンス起動時と同じIPアドレスが引き続き確保されていること 

    -　**`ストレージ`** のタブを開き、 **`アタッチされたブロック・ボリューム`** フィールドを確認すると、アタッチした追加ボリュームが引き続き表示され、アタッチ済 のステータスになっていること

    - **`ブート・ボリューム`**フィールドに、ブートボリュームが表示され、**`アタッチ済`** のステータスになっていること

        > **Note**
        >
        >インスタンスが 停止済 ステータスになると、一部の例外のインスタンスを除き、インスタンスへの課金が停止します。一方ブロック・ボリューム等の確保済のストレージ・リソースは存続しているため、課金は継続します。
        >インスタンスのシェイプ名称のうち、DenseIO / HighIO / HPC / GPU という名称がつくインスタンスに関しては、例外的に 停止済 ステータスになってもインスタンスへの課金が継続します。インスタンス停止時の課金に関する詳細についてはマニュアルの [こちら](https://docs.oracle.com/ja-jp/iaas/Content/Compute/Tasks/resource-billing-stopped-instances.htm) で確認できます。

<br>

## 1-3. インスタンスの起動

停止したインスタンスを再度起動し、挙動を確認します。

1. 停止中のインスタンスの詳細画面右上部の 起動 ボタンを押します

    ![img1-3-1.png](img1-3-1.png)


2. インスタンスのステータスが **`実行中`** になるのを確認します
   ステータスが変わったらインスタンスの詳細情報を確認し、**`停止済`** のステータスの際と、表示されている情報を比較してください。

3. sshターミナルを起動し、opcユーザーでsshログインします
   > **Note**
    >
    >インスタンスがRUNNING ステートになった後、sshdが起動してsshアクセスできるようになるまで、さらに約3分程度かかります
   
4. sshログインしたら、ステップ1-1で作成したブート・ボリュームのファイルを確認します
    ```sh
    [opc@testvm1 ~]$ ls -l
    total 0
    -rw-rw-r--. 1 opc opc 0 Feb 16 16:47 testfile
    [opc@testvm1 ~]$ pwd
    /home/opc
    [opc@testvm1 ~]$
    ```

    おそらくファイルが正しく表示されるはずです。
    これは、ブート・ボリューム(OS領域)に対する変更が、インスタンスの停止、再起動処理を経ても永続化されていることを示します。

5. また、以下のコマンドを発行し、アタッチされているボリュームの情報を確認します  

    ```sh
    $ lsblk
    ```

    このインスタンスにアタッチされている、ブートボリュームを含むボリュームの一覧が表示されています。

    ```sh
    [opc@testvm1 ~]$ lsblk
    NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    sdb      8:16   0   50G  0 disk
    sda      8:0    0 46.6G  0 disk
    tqsda2   8:2    0    8G  0 part [SWAP]
    tqsda3   8:3    0 38.4G  0 part /
    mqsda1   8:1    0  200M  0 part /boot/efi
    [opc@testvm1 ~]$
    ```

    /dev/sdb というボリュームが表示されていることがわかります。これは、 において追加でアタッチし、OSからiSCSIでログインしたボリュームです。
    つまり、インスタンスの停止、再起動を経ても、ブロックボリュームへのiSCSIのログインが継続しており、再起動後に再びログイン処理を行う必要がないことがわかります。

<br><br>

<a id="anchor2"></a>

# 2. インスタンスの終了(Terminate)

ここでは、インスタンスの終了(Terminate)処理を行って、その際の挙動について確認します。

1. コンソールメニューから **`コンピュート`** → **`インスタンス`** を選択し、先程起動処理を行ったインスタンス名 (TestVM1など) のリンクをクリックします

2. インスタンスの詳細画面の右上部にある **`アクション`** メニューから **`終了`** を選択します

    ![img2-2.png](img2-2.png)

3. インスタンスのブート・ボリュームをどうするかを選択するダイアログ・ボックスが起動します
   **`アタッチされたブート・ボリュームを完全に削除`** というチェックボックスにチェックをつけると、インスタンスのブート・ボリュームが削除されます。
   今回は、ブート・ボリュームを後ほど利用するので、チェックを外したまま **`インスタンスの終了`** ボタンを押します。

    ![img2-3.png](img2-3.png)

4. インスタンスの終了処理がはじまります。終了処理中は **`終了中`** というステータスになります。
   この処理の間に、インスタンス作成時に確保された各種のリソースが順にデタッチ、または削除されていきます。
    OCIコンソール上では、リアルタイムで情報が変化し、削除されたリソースから表示が変化していきますので、リアルタイムで状況がどう変わるかを確認してみてください。
   
5. インスタンスの終了(Terminate)処理が完了すると、ステータスが 終了済 に変わります。
   画面上のステータスアイコンで、ステータスが 終了済 になったことを確認します。

    ![img2-5.png](img2-5.png)

    - **`終了済`** ステータスのインスタンスは、暫くの間OCIコンソールに表示され続けますが、このインスタンスを復活させることはできません。しばらくすると終了済インスタンスはOCIコンソールから表示が消えます。

6. **`ネットワーキング`** のタブを開いて、 **`プライマリVNIC情報`** 欄で、**`プライベートIPアドレス`** および **`パブリックIPアドレス`** が **`「 - 」`** になっていることを確認します。
   これは、インスタンスの終了とともに、アタッチされていたインスタンスのプライベートIPアドレス、パブリックIPアドレスがデタッチされ、IPのプールに返還された状態であることを示しています。これらのIPアドレスは、他のインスタンスで再利用することができます。

    ![img2-6.png](img2-6.png)

7. アタッチされたVNIC 欄には、何も表示されていません。インスタンスの終了とともに、アタッチされていた仮想NICはすべて削除されています。

    ![img2-7.png](img2-7.png)

    > **Note**
    >
    >現在の Oracle Cloud Infrastructure では、インスタンスの削除時に仮想NICを残しておいて、他のインスタンスにアタッチするような機能(いわいるElastic Network Interface)の機能はありません。
    >予約IP機能をつかったグローバルIPアドレスの移動(いわいるElastic Global IP)は可能です。

8. **`ストレージ`** のタブを開いて、Boot Volume 欄を確認すると、**`デタッチ済`** というステータスのボリュームがひとつ表示されています。
   削除時のダイアログで、ブートボリュームを削除しないという選択をしたため、ボリュームは保全されています。

    ![img2-8.png](img2-8.png)

    - **`終了済`** ステータスのインスタンスは、インスタンスのシェイプを問わず、すべて課金が停止しています。ただし、ブート・ボリュームを残す選択をした場合は、そのボリュームはインスタンス終了後も存続し、課金が継続します。

    > **Note**
    >
    >DenseIO、HighIO、HPCなどの、インスタンス内部にストレージが付属するインスタンスの場合、インスタンスを終了(terminate)すると内部ストレージのデータが消去され、損失します。もし内部ストレージのデータの保全が必要な場合は、予めブロック・ボリューム等の他の永続ストレージにデータを保管してからインスタンスを終了するようにしてください。

9. **`アタッチされたブロック・ボリューム`** 欄には、**`このインスタンスにはアタッチされたブロック・ボリュームはありません。`** と表示されています。
   インスタンスの終了とともに、アタッチされていた追加ボリュームはデタッチされていることがわかります。

    ![img2-9.png](img2-9.png)

<br>

<a id="anchor3"></a>

# 3. ブート・ボリュームからのインスタンスの再作成

終了したインスタンスを再度起動させることはできませんが、ブート・ボリュームが保管されている場合はそこから新しく別のインスタンスを作成することができます。ここではその手順について確認します。

1. コンソールメニューから コンピュート → **`ブート・ボリューム`** を選択します

2. 先程削除したインスタンスのブート・ボリュームが表示されています。TestVM1 (Boot Volume) のような名称のリンクをクリックします

3. ブート・ボリュームの詳細画面の上部にある **`インスタンスの作成`** というボタンを押します

    ![img3-3.png](img3-3.png)

4. コンピュート・インスタンスの作成 ウィザードが起動してきます。下記の内容を入力して下部の **`作成`** ボタンを押します。
   その他の設定項目は任意で入力してください。

    - **`基本情報`**
        - **`コンパートメント`** - 先程削除したインスタンスと同じコンパートメントを選択
        - **`可用性ドメイン`** - 先程削除したインスタンスが存在していた可用性ドメインと同じものを選択
        - **`イメージ`** - さきほど表示したブート・ボリューム（TestVM1 (Boot Volume)）が選択されていることを確認

         > **Note**
         >
         >Oracle Cloud Infrastructure では、同一のイメージから仮想マシン、ベアメタルサーバーの両方のインスタンスを作成することができます。このため、仮想マシンのブート・ボリュームからベアメタルサーバーを立ち上げる、といったことや、その逆の操作も可能です。この手順の シェイプ・タイプ および シェイプ で、もとのインスタンスとは違うものを選択することで実現できます。

5. インスタンスの作成が開始されます。2-3分ほどでインスタンス作成が完了し、ステータスが **`実行中`** に変わります。
インスタンスに新しく割り振られたパブリックIPアドレスを確認します。

6. 確認したパブリックIPアドレスに対してsshでアクセスし、ステップ1-1で作成したファイル(/home/opc/testfile) が存在することを確認します。
これにより、インスタンス削除時のOS領域の情報がインスタンスの再作成後も保全されていることがわかります。

<br>

以上がブート・ボリュームを利用したインスタンスの再作成の方法です。
今回は、終了(Termitate)したインスタンスのブートボリュームからインスタンスを作成しましたが、必ずしもインスタンスを終了(Terminate)する必要があるわけではなく、インスタンスの停止→ブートボリュームのデタッチを行ったブートボリュームであれば、元のインスタンスを残したまま新しいインスタンスを作成することも可能です。この方法を使うと、一時的にインスタンスのタイプやシェイプを変更し、作業が終わったらまた元のインスタンスにアタッチして利用するようなことも可能になります。

<br>

**チュートリアル一覧に戻る :** [Oracle Cloud Infrastructure チュートリアル](../..)