<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HPCクラスタを構築する | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="HPCクラスタを構築してみましょう。このチュートリアルを終了すると、HPC向けIntel Ice Lakeプロセッサを搭載したベアメタル計算ノードをRoCEv2インターコネクトで接続した典型的な構成のHPCクラスタを、OCIコンソールから簡単に構築することが出来るようになります。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="HPCクラスタを構築する">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/intermediates/spinup-hpc-cluster/">


  <meta property="og:description" content="HPCクラスタを構築してみましょう。このチュートリアルを終了すると、HPC向けIntel Ice Lakeプロセッサを搭載したベアメタル計算ノードをRoCEv2インターコネクトで接続した典型的な構成のHPCクラスタを、OCIコンソールから簡単に構築することが出来るようになります。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/intermediates/spinup-hpc-cluster/architecture_diagram.png">





  <meta property="article:published_time" content="2023-01-27T12:56:14+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/intermediates/spinup-hpc-cluster/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://oracle-japan.github.io/ocitutorials/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ocitutorials/#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E4%B8%80%E8%A6%A7">チュートリアル一覧</a>
            </li><li class="masthead__menu-item">
              <a href="/ocitutorials/about/">このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(34, 66, 55, 0.7), rgba(34, 66, 55, 0.7)), url('/ocitutorials/intermediates/spinup-hpc-cluster/architecture_diagram.png');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          HPCクラスタを構築する

        
      </h1>
      
        <p class="page__lead">HPCクラスタを構築してみましょう。このチュートリアルを終了すると、HPC向けIntel Ice Lakeプロセッサを搭載したベアメタル計算ノードをRoCEv2インターコネクトで接続した典型的な構成のHPCクラスタを、OCIコンソールから簡単に構築することが出来るようになります。
</p>
      
      


      
      
    </div>
  
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://oracle-japan.github.io/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/intermediates" itemprop="item"><span itemprop="name">Intermediates</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">HPCクラスタを構築する</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">応用編</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/intermediates/monitoring-resources/">モニタリング機能でOCIのリソースを監視する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/using-load-balancer/">ロードバランサーでWebサーバーを負荷分散する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/autoscaling/">インスタンスのオートスケーリングを設定する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/taking-block-volume-backups/">ブロック・ボリュームをバックアップする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/object-storage-advanced/">オブジェクト・ストレージの高度な設定</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/using-dns/">DNSサービスを使ってWebサーバーの名前解決をする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/private-dns/">プライベートDNSを使って名前解決をする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/certificate/">プライベート認証局と証明書の発行</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/sending-emails-1/">Email Deliveryを利用した外部へのメール送信(基礎編)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/sending-emails-2/">Email Deliveryを利用した外部へのメール送信(応用編)</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/accessing-serial-console/">シリアル・コンソールでsshできないインスタンスのトラブルシュートをする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/attaching-secondary-ips/">インスタンスにセカンダリIPを付与する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/spinup-hpc-cluster/" class="active">HPCクラスタを構築する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/spinup-ml-instance/">GPUインスタンスで機械学習にトライ</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/spinup-cluster-network/">クラスタ・ネットワークを作成する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/spinup-gpu-cluster/">GPUクラスタを構築する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/using-cli/">コマンドライン(CLI)でOCIを操作する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/audit-log-analytics/">OCIのLogging AnalyticsでOCIの監査ログを可視化・分析する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/networkfirewall/">OCI Network Firewallを構築する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/terraforming/">TerraformでOCIの構築を自動化する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/byok-with-vault/">OCI Valut (OCI Key Management) でBYOKをする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/dbcs-database-management/">OCI Database Cloud ServiceでDatabase Managementを有効化する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/protecting-web-servers-with-waf/">Web Application Firewall(WAF)を使ってWebサーバを保護する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/dbcs_operations_insights/">OCIのDBCSでOperations Insightsを有効化する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/identitydomains-add-domains-license/">OCI IAM Identity Domainsのドメインの追加とライセンスタイプを変更する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/identitydomains-admin-users/">OCI IAM Identity Domains - テナント管理者・一般ユーザーを作成する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/logginganalytics_adb_log/">Logging AnalyticsでAutonomous Databaseのログを収集する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/logginganalytics_customparser/">カスタム・パーサーを作成してOCI Logging Analyticsで未対応のログを分析する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/management-cloud-tutorials/">Oracle Management Cloud チュートリアルまとめ</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/monitoring_prometheus/">Prometheus Node Exporterを利用した管理エージェントによるインスタンスのメトリック収集</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/cloud-guard/">Cloud Guardを使ってみる</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/data-safe-tutorials/">Oracle Data Safe チュートリアルまとめ</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/database-management/">OCI Database ManagementでOracleDBのパフォーマンス監視をする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/storage-gateway/">ストレージ・ゲートウェイを作成する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/resource-manager/">リソース・マネージャを使ってサンプルアプリケーションをデプロイする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/using-logging/">ロギング・サービスを使って3つのログを収集する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/vtap/">VTAPでパケットをミラーリングし、パケットキャプチャをする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/serviceconnecterhub/">監査(Audit)ログを使用したテナント監視</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/mobile_app/">OCIモバイル・アプリケーションを使ってみる</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/oce-tutorial/">Oracle Content and Experience チュートリアル</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/blockchain-tutorial/">Oracle Blockchain Platform チュートリアル</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/bastion/">BastionサービスでパブリックIPを持たないリソースにアクセスする</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/oracle-linux-storage-appliance/">Oracle Linux Storage Applianceでファイルストレージの構築</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/os_management/">コンピュート・インスタンスのOSを管理する</a></li></p>
        
          <p></p><li><a href="/ocitutorials/intermediates/ocidi-tutorials/">OCI Data Integrationチュートリアル</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="HPCクラスタを構築する">
    <meta itemprop="description" content="HPCクラスタを構築してみましょう。このチュートリアルを終了すると、HPC向けIntel Ice Lakeプロセッサを搭載したベアメタル計算ノードをRoCEv2インターコネクトで接続した典型的な構成のHPCクラスタを、OCIコンソールから簡単に構築することが出来るようになります。">
    <meta itemprop="datePublished" content="2023-01-27T12:56:14+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#0-hpcクラスタ構築用スタックの概要">0. HPCクラスタ構築用スタックの概要</a></li><li><a href="#1-スタックの作成">1. スタックの作成</a></li><li><a href="#2-スタックの計画">2. スタックの計画</a></li><li><a href="#3-スタックの適用">3. スタックの適用</a></li><li><a href="#4-hpcクラスタの確認">4. HPCクラスタの確認</a></li><li><a href="#5-ldapユーザ作成">5. LDAPユーザ作成</a></li><li><a href="#6-mpiプログラム実行2ノード編">6. MPIプログラム実行（2ノード編）</a></li><li><a href="#7-計算ノード追加">7. 計算ノード追加</a></li><li><a href="#8-mpiプログラム実行4ノード編">8. MPIプログラム実行（4ノード編）</a></li><li><a href="#9-計算ノード入れ替え">9. 計算ノード入れ替え</a></li><li><a href="#10-スタックの破棄">10. スタックの破棄</a></li></ul>

            </nav>
          </aside>
        
        <p>Oracle Cloud Infrastructure（以降OCIと記載）は、以下の特徴からHPCワークロードを実行するHPCクラスタを構築するには最適なクラウトサービスです。</p>
<ul>
  <li>仮想化オーバーヘッドの無いHPC用途に特化したベアメタルシェイプ</li>
  <li>RoCEv2を使用する高帯域・低レイテンシRDMAインターコネクトネットワーク</li>
</ul>

<p>このチュートリアルは、OCIのマーケットプレイスから利用可能なHPCクラスタ構築のためのリソース・マネージャ用スタックを利用し、以下構成の典型的なHPCクラスタを構築、そのインターコネクト性能を検証します。</p>
<ul>
  <li>HPC向けIntel Ice Lakeプロセッサ搭載計算ノード（ <strong><a href="https://docs.oracle.com/ja-jp/iaas/Content/Compute/References/computeshapes.htm#bm-hpc-optimized">BM.Optimized3.36</a></strong> ）</li>
  <li>100 Gbps RoCEv2 RDMAインターコネクト（※1）</li>
  <li>インターネットからSSH接続可能なBastionノード</li>
  <li>OS: Oracle Linux 7.9</li>
  <li>ジョブスケジューラ: Slurm</li>
  <li>OCIファイルストレージサービスによるHPCクラスタ内ホームディレクトリ共有</li>
  <li>LDAPによるクラスタ内ユーザ統合管理</li>
</ul>

<p>※1：OCIでは、このインターコネクトネットワークを <strong><a href="https://docs.oracle.com/ja-jp/iaas/Content/Compute/Tasks/managingclusternetworks.htm">クラスタ・ネットワーク</a></strong> と呼称します。</p>

<p><img src="architecture_diagram.png" alt="システム構成図" /></p>

<p>このHPCクラスタ構築用スタックを利用すると、通常であれば数日かかるようなHPCクラスタ構築作業を、OCIコンソールのGUIから10項目程度のメニューを選択するだけで実施することが可能になります。</p>

<p>またこのチュートリアルでは、クラスタ構築後により大規模な計算を実施する必要が生じたり、メンテナンスによりノードを入れ替える必要が生じることを想定し、既存のクラスタに計算ノードを追加する方法と、特定の計算ノードを入れ替える方法も学習します。</p>

<p>リソース・マネージャについては、以下のチュートリアルも参考にしてください。</p>

<p><a href="https://oracle-japan.github.io/ocitutorials/intermediates/resource-manager/">https://oracle-japan.github.io/ocitutorials/intermediates/resource-manager/</a></p>

<p><strong>所要時間 :</strong> 約1時間</p>

<p><strong>前提条件 :</strong> HPCクラスタを収容するコンパートメント(ルート・コンパートメントでもOKです)の作成と、このコンパートメントに対する必要なリソース管理権限がユーザーに付与されていること。具体的には、以下ページの <strong>Policies to deploy the stack:</strong> に記載のポリシーが付与されていること。</p>

<p><a href="https://cloud.oracle.com/marketplace/application/67628143/usageInformation">https://cloud.oracle.com/marketplace/application/67628143/usageInformation</a></p>

<p><strong>注意 :</strong> チュートリアル内の画面ショットについては、OCIの現在のコンソール画面と異なっている場合があります。また使用するHPCクラスタ構築用スタックのバージョンが異なる場合も、チュートリアル内の画面ショットが異なる場合があります。</p>

<h1 id="0-hpcクラスタ構築用スタックの概要">0. HPCクラスタ構築用スタックの概要</h1>

<p>本チュートリアルで使用するHPCクラスタ構築用スタックは、クラスタ構築を大きく2つのステップに分けて実行しており、前半はTerraformを使用したOCIレベルのリソース構築フェーズで、後半はTerraformから起動されるAnsibleによるOSレベルのカスタマイズフェーズです。</p>

<p>具体的には、以下のような処理が行われます。</p>

<p>［TerraformによるOCIリソース構築フェーズ］</p>

<ul>
  <li>VCNと関連するネットワークリソース構築</li>
  <li>クラスタネットワークと関連リソース構築</li>
  <li>Bastionノードインスタンス構築</li>
  <li>計算ノードインスタンス構築</li>
  <li>ファイルストレージ構築</li>
  <li>Ansible関連ソフトウェアインストール</li>
</ul>

<p>[AnsibleによるOSレベルカスタマイズフェーズ]</p>

<ul>
  <li>firewalld停止</li>
  <li>NVMeディスク領域ファイルシステム構築</li>
  <li>/etc/hostsファイル生成</li>
  <li>NFSファイル共有環境構築</li>
  <li>LDAPユーザ統合環境構築</li>
  <li>RDMAインタフェース構築</li>
  <li>Slurm環境構築</li>
</ul>

<h1 id="1-スタックの作成">1. スタックの作成</h1>

<p>リソース・マネージャでリソースをデプロイする場合、まずそのためのスタックを作成する必要があります。</p>

<p>本章は、マーケットプレースから提供するHPCクラスタ構築用スタックを元に、前述のHPCクラスタ環境を構築するためのスタックを作成します。このチュートリアルで使用するHPCクラスタ構築用スタックは、バージョン2.9.2です。</p>

<ol>
  <li>
    <p>以下マーケット・プレースのHPCクラスタ構築用スタックページにアクセスします。</p>

    <p><a href="https://cloud.oracle.com/marketplace/application/67628143/">https://cloud.oracle.com/marketplace/application/67628143/</a></p>
  </li>
  <li>
    <p>OCIコンソールへのログイン画面が表示された場合（まだログインしていない場合）、ログインを完了します。</p>
  </li>
  <li>
    <p>表示される以下画面の右上で、スタックをデプロイするリージョンを選択し、HPCクラスタ構築用スタックの <strong>バージョン</strong> を確認後、 <strong>コンパートメント</strong> をHPCクラスタスタックをデプロイするコンパートメントに指定、<strong>使用許諾</strong> チェックボックスをチェックし、 <strong>スタックの起動</strong> ボタンをクリックします。</p>

    <p><img src="market_place.png" alt="画面ショット" /></p>
  </li>
  <li>表示される以下 <strong>スタック情報</strong> 画面で、以下の情報を入力し、下部の <strong>次</strong> ボタンをクリックします。
    <ul>
      <li><strong>名前 :</strong> スタックに付与する名前（任意）</li>
      <li><strong>説明 :</strong> スタックに付与する説明（任意）</li>
    </ul>

    <p><img src="stack_page01.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される <strong>変数の構成</strong> 画面で、各画面フィールドに以下の情報を入力し、下部の <strong>次</strong> ボタンをクリックします。なお、ここに記載のないフィールドは、デフォルトのままとします。</p>

    <p>5.1 <strong>Cluster configuration</strong> フィールド</p>
    <ul>
      <li><strong>Public SSH key :</strong> Bastionにログインする際使用するSSH秘密鍵に対応する公開鍵
        <ul>
          <li>公開鍵ファイルのアップロード（ <strong>SSHキー・ファイルの選択</strong> ）と公開鍵のフィールドへの貼り付け（ <strong>SSHキーの貼付け</strong> ）が選択可能</li>
        </ul>
      </li>
    </ul>

    <p><img src="stack_page02.png" alt="画面ショット" /></p>

    <p>5.2 <strong>Headnode options</strong> フィールド</p>
    <ul>
      <li><strong>Availability Domain :</strong> BastionノードをデプロイするAD</li>
    </ul>

    <p><img src="stack_page03.png" alt="画面ショット" /></p>

    <p>5.3 <strong>Compute node options</strong> フィールド</p>
    <ul>
      <li><strong>Availability Domain :</strong> 計算ノードをデプロイするAD</li>
      <li><strong>Shape of the Compute Nodes :</strong> BM.Optimized3.36</li>
      <li><strong>Initial cluster size :</strong> 計算ノードのノード数（デフォルト：2）</li>
    </ul>

    <p><img src="stack_page04.png" alt="画面ショット" /></p>

    <p>5.4 <strong>Additional file system</strong> フィールド</p>
    <ul>
      <li><strong>Add another NFS filesystem :</strong> チェック</li>
      <li><strong>Create FSS :</strong> チェック</li>
      <li><strong>NFS Path :</strong> /mnt/home（※2）</li>
      <li><strong>NFS server Path :</strong> /mnt/home（※2）</li>
    </ul>

    <p>※2：ここで指定するパスは、ファイルストレージ領域に作成するLDAPユーザのホームディレクトリを格納するディレクトリを指定しています。よって、ユーザ名user1のLDAPユーザのホームディレクトリは、/mnt/home/user1となります。</p>

    <p><img src="stack_page04-1.png" alt="画面ショット" /></p>

    <p>5.5 <strong>Advanced storage options</strong> フィールド</p>
    <ul>
      <li><strong>Show advanced storage options :</strong> チェック</li>
      <li>
        <p><strong>Shared NFS scratch space from NVME or Block volume :</strong> チェックオフ</p>

        <ul>
          <li>計算ノードのNVMeディスク領域をNFS共有するかの指定（本チュートリアルでは共有しない）</li>
        </ul>
      </li>
    </ul>

    <p><img src="stack_page05.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される <strong>確認</strong> 画面で、これまでの設定項目が意図したものになっているかを確認し、以下 <strong>作成されたスタックで適用を実行しますか。</strong> フィールドの <strong>適用の実行</strong> をチェックオフし、下部の <strong>作成</strong> ボタンをクリックします。</p>

    <p><img src="stack_page06.png" alt="画面ショット" /></p>

    <p>ここで <strong>適用の実行</strong> をチェックした場合、 <strong>作成</strong> ボタンのクリックと同時にスタックの適用が開始され、HPCクラスタのデプロイが始まりますが、このチュートリアルではスタックの計画を実行してから適用を行います。</p>
  </li>
</ol>

<p>これで、以下画面のとおりHPCクラスタ構築用スタックが作成されました。</p>

<p><img src="stack_page07.png" alt="画面ショット" /></p>

<h1 id="2-スタックの計画">2. スタックの計画</h1>

<p>本章は、完成したリソース・マネージャのスタックを計画し、どのようなリソースがデプロイされるか確認します。</p>

<ol>
  <li>
    <p>作成したスタックの以下 <strong>スタックの詳細</strong> 画面で、 <strong>計画</strong> ボタンをクリックします。</p>

    <p><img src="stack_page08.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>計画</strong> サイドバーで、 <strong>計画</strong> ボタンをクリックします。</p>

    <p><img src="stack_page09.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>ジョブ詳細</strong> ウィンドウで、左上のステータスが <strong>受入れ済</strong> → <strong>進行中</strong> → <strong>成功</strong> と遷移すれば、スタックの計画が終了しています。</p>

    <p><img src="stack_page10.png" alt="画面ショット" /></p>

    <p>表示される以下 <strong>ログ</strong> フィールドで、適用時にデプロイされるリソースを確認します。</p>

    <p><img src="stack_page11.png" alt="画面ショット" /></p>
  </li>
</ol>

<h1 id="3-スタックの適用">3. スタックの適用</h1>

<p>本章は、計画で作成されるリソースに問題が無いことを確認したスタックに対し、適用を行いHPCクラスタをデプロイします。</p>

<ol>
  <li>
    <p>以下 <strong>スタックの詳細</strong> 画面で、 <strong>適用</strong> ボタンをクリックします。</p>

    <p><img src="stack_page12.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>適用</strong> サイドバーで、 <strong>適用</strong> ボタンをクリックします。</p>

    <p><img src="stack_page13.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>ジョブ詳細</strong> ウィンドウで、左上のステータスが <strong>受入れ済</strong> → <strong>進行中</strong> と遷移すれば、スタックの適用が実施されています。</p>

    <p><img src="stack_page14.png" alt="画面ショット" /></p>

    <p>表示される以下 <strong>ログ</strong> フィールドで、リソースのデプロイ状況を確認します。</p>

    <p><img src="stack_page11.png" alt="画面ショット" /></p>

    <p>この適用が完了するまでの所要時間は、計算ノードのノード数が2ノードの場合で15分程度です。</p>

    <p>ステータスが <strong>成功</strong> となれば、HPCクラスタのデプロイが完了しています。</p>
  </li>
</ol>

<h1 id="4-hpcクラスタの確認">4. HPCクラスタの確認</h1>

<p>本章は、デプロイされたHPCクラスタにログインし、環境を確認します。</p>

<ol>
  <li>
    <p>Bastionノードログイン</p>

    <p>Bastionへのログインは、スタック適用時の以下 <strong>ログ</strong> フィールドの最後に表示されているBastionのIPアドレスを使用し、インターネットを介してopcユーザでSSHログインします。</p>

    <p><img src="stack_page15.png" alt="画面ショット" /></p>

    <p>このSSH接続では、スタックに指定したSSH公開鍵に対応する秘密鍵を使用します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> ssh <span class="nt">-i</span> path_to_ssh_secret_key opc@123.456.789.123
</code></pre></div>    </div>
  </li>
  <li>
    <p>Bastionノードファイルシステム確認</p>

    <p>Bastionノードは、以下のようにファイルストレージの/mnt/homeがマウントされています。この/mnt/homeは、HPCクラスタ内で共有するLDAPユーザのホームディレクトリに使用します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">df</span> <span class="nt">-h</span> /mnt/home
Filesystem        Size  Used Avail Use% Mounted on
FSS_ip:/mnt/home  8.0E     0  8.0E   0% /mnt/home
</code></pre></div>    </div>
  </li>
  <li>
    <p>計算ノードログイン</p>

    <p>計算ノードは、プライベートサブネットに接続されており、インターネット経由ログインすることが出来ないため、Bastionノードを経由してログインします。</p>

    <p>計算ノードのホスト名は、Bastionノードの/etc/opt/oci-hpcディレクトリ以下のファイルに格納されており、hostfile.tcpとhostfile.rdmaがそれぞれプライベートサブネット接続とクラスタ・ネットワークサブネット接続に使用するIPアドレスに対応するホスト名です。このため、Bastionノードから計算ノードへのログインは、hostfile.tcpファイルに格納されているホスト名を使用し、opcユーザでSSHログインします。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat</span> /etc/opt/oci-hpc/hostfile.tcp 
inst-ecrs7-massive-coyote
inst-mnykj-massive-coyote
<span class="o">&gt;</span> ssh inst-ecrs7-massive-coyote
</code></pre></div>    </div>
  </li>
  <li>
    <p>計算ノードファイルシステム確認</p>

    <p>計算ノードは、以下のようにNVMe領域が/mnt/localdiskにマウントされています。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">df</span> <span class="nt">-h</span> /mnt/localdisk
Filesystem      Size  Used Avail Use% Mounted on
/dev/nvme0n1p1  3.5T   33M  3.5T   1% /mnt/localdisk
</code></pre></div>    </div>

    <p>また、以下のようにBasionノードの/homeと/export/clusterが全ての計算ノードでマウントされています。これらの領域は、Bastionノードの/homeをopcユーザのホームディレクトリ領域に、/export/clusterをHPCクラスタ内で共有する任意のデータを格納する領域に、それぞれ使用します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">df</span> <span class="nt">-h</span> /home /nfs/cluster
Filesystem                   Size  Used Avail Use% Mounted on
Bastion_ip:/home             42G   13G   29G  32% /home
Bastion_ip:/export/cluster   42G   13G   29G  32% /nfs/cluster
</code></pre></div>    </div>

    <p>また、以下のようにファイルストレージの/mnt/homeが全ての計算ノードでマウントされています。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">df</span> <span class="nt">-h</span> /mnt/home
Filesystem        Size  Used Avail Use% Mounted on
FSS_ip:/mnt/home  8.0E     0  8.0E   0% /mnt/home
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="5-ldapユーザ作成">5. LDAPユーザ作成</h1>

<p>本章は、HPCクラスタ構築用スタックが作成したHPCクラスタ内のLDAP統合ユーザ管理環境に於いて、LDAPユーザを作成しこのユーザでHPCクラスタにログイン出来ることを確認します。</p>

<p>このLDAP統合ユーザ管理環境は、BastionがLDAPサーバで計算ノードがLDAPクライアントです。</p>

<ol>
  <li>
    <p>LDAPユーザ作成</p>

    <p>LDAPサーバであるBastionは、ユーザ管理のためのclusterコマンドが用意されています。</p>

    <p>このコマンドは、作成するユーザのホームディレクトリを/home以下に作成するため、本環境のLDAPユーザ用ホームディレクトリであるファイルストレージの/mnt/home以下に作成するよう修正する必要があります。このため、以下コマンドをBastionのopcユーザで実行します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'s/\/home\//\/mnt\/home\//g'</span> /usr/bin/cluster
</code></pre></div>    </div>

    <p>次に、以下コマンドをBastionのopcユーザで実行し、LDAPユーザを作成します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> cluster user add user_name <span class="nt">--ssh</span>
Password:  &lt;- Password <span class="k">for </span>user_name
Repeat <span class="k">for </span>confirmation: &lt;- Password <span class="k">for </span>user_name
Full Name: full_name &lt;- Full name <span class="k">for </span>user_name
Creating group
</code></pre></div>    </div>

    <p>ここで指定するパスワードは、インターネットを介してBastionにSSHログインする際のパスワード認証で使用します。</p>
  </li>
  <li>
    <p>LDAPユーザログイン</p>

    <p>先に作成したLDAPユーザを使用したインターネットを介したBastionへのログインは、以下コマンドでパスワード認証でSSHログインします。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> ssh user_name@123.456.789.123
user_name@123.456.789.123 s password: &lt;- Password <span class="k">for </span>user_name
Last login: Fri Dec  2 06:48:00 2022 from 123.456.789.123
</code></pre></div>    </div>

    <p>またこのユーザは、以下のようにHPCクラスタ内の全ての計算ノードにパスフレーズ無し鍵認証によるSSHログインが可能になっています。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat</span> /etc/opt/oci-hpc/hostfile.tcp 
inst-ecrs7-massive-coyote
inst-mnykj-massive-coyote
<span class="o">&gt;</span> ssh inst-ecrs7-massive-coyote
Last login: Fri Dec  2 06:48:39 2022 from causal-dinosaur-bastion.public.cluster.oraclevcn.com
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="6-mpiプログラム実行2ノード編">6. MPIプログラム実行（2ノード編）</h1>

<p>本章は、先に作成したLDAPユーザを使ってMPIプログラムをSlurmを介してバッチジョブとして投入し、構築したHPCクラスタのインターコネクト性能をIntel MPIベンチマークで確認します。</p>

<p>ここでは、2ノードのPing-Pong性能を計測しており、以下性能が出ています。</p>

<ul>
  <li>帯域：約12 GB/s（インタフェース物理帯域100 Gbpsに対し96 Gbpsを計測）</li>
  <li>レイテンシ：約1.7 μs</li>
</ul>

<p>以降の手順は、先に作成したLDAPユーザで実施します。</p>

<ol>
  <li>
    <p>バッチジョブスクリプト作成</p>

    <p>以下のバッチジョブ投入用スクリプトをBastionノードのホームディレクトリ下に作成します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat </span>submit.sh
<span class="c">#!/bin/bash</span>
<span class="c">#SBATCH -p compute</span>
<span class="c">#SBATCH -n 2</span>
<span class="c">#SBATCH -N 2</span>
<span class="c">#SBATCH -J ping_ping</span>
<span class="c">#SBATCH -o stdout.%J</span>
<span class="c">#SBATCH -e stderr.%J</span>
   
<span class="c"># Only for BM.Optimized3.36</span>
<span class="nb">export </span><span class="nv">UCX_NET_DEVICES</span><span class="o">=</span>mlx5_2:1
   
module load intel/mpi/latest
   
mpirun IMB-MPI1 <span class="nt">-msglog</span> 3:28 PingPong
</code></pre></div>    </div>
  </li>
  <li>
    <p>バッチジョブ投入</p>

    <p>作成したスクリプトをバッチジョブとして投入します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> sbatch submit.sh 
Submitted batch job 2
</code></pre></div>    </div>
  </li>
  <li>
    <p>バッチジョブ結果確認</p>

    <p>投入したバッチジョブの結果を確認します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat </span>stderr.2 
Loading mpi version 2021.3.0
<span class="o">&gt;</span> <span class="nb">cat </span>stdout.2 
<span class="c">#----------------------------------------------------------------</span>
<span class="c">#    Intel(R) MPI Benchmarks 2021.2, MPI-1 part</span>
<span class="c">#----------------------------------------------------------------</span>
<span class="c"># Date                  : Tue Feb 15 08:02:48 2022</span>
<span class="c"># Machine               : x86_64</span>
<span class="c"># System                : Linux</span>
<span class="c"># Release               : 3.10.0-1160.25.1.el7.x86_64</span>
<span class="c"># Version               : #1 SMP Tue Apr 27 15:52:10 PDT 2021</span>
<span class="c"># MPI Version           : 3.1</span>
<span class="c"># MPI Thread Environment: </span>
   
   
<span class="c"># Calling sequence was: </span>
   
<span class="c"># IMB-MPI1 -msglog 3:28 PingPong </span>
   
<span class="c"># Minimum message length in bytes:   0</span>
<span class="c"># Maximum message length in bytes:   268435456</span>
<span class="c">#</span>
<span class="c"># MPI_Datatype                   :   MPI_BYTE </span>
<span class="c"># MPI_Datatype for reductions    :   MPI_FLOAT </span>
<span class="c"># MPI_Op                         :   MPI_SUM  </span>
<span class="c"># </span>
<span class="c"># </span>
   
<span class="c"># List of Benchmarks to run:</span>
   
<span class="c"># PingPong</span>
   
<span class="c">#---------------------------------------------------</span>
<span class="c"># Benchmarking PingPong </span>
<span class="c"># #processes = 2 </span>
<span class="c">#---------------------------------------------------</span>
       <span class="c">#bytes #repetitions      t[usec]   Mbytes/sec</span>
            0         1000         1.72         0.00
            8         1000         1.73         4.62
           16         1000         1.75         9.17
           32         1000         1.77        18.11
           64         1000         1.86        34.36
          128         1000         1.92        66.50
          256         1000         2.19       117.04
          512         1000         2.24       228.74
         1024         1000         2.38       431.07
         2048         1000         2.98       687.54
         4096         1000         3.54      1158.67
         8192         1000         4.10      1998.63
        16384         1000         5.52      2968.87
        32768         1000         7.45      4396.34
        65536          640        12.60      5200.24
       131072          320        17.94      7307.18
       262144          160        28.54      9184.01
       524288           80        49.91     10504.31
      1048576           40        92.51     11334.97
      2097152           20       177.93     11786.26
      4194304           10       348.68     12029.08
      8388608            5       690.13     12155.19
     16777216            2      1373.20     12217.63
     33554432            1      2742.04     12237.02
     67108864            1      5474.34     12258.80
    134217728            1     10944.01     12264.04
    268435456            1     21872.05     12272.99
   
   
<span class="c"># All processes entering MPI_Finalize</span>
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="7-計算ノード追加">7. 計算ノード追加</h1>

<p>本章は、構築した2ノードクラスタに計算ノードを2ノード追加して4ノードクラスタに拡張します。</p>

<p>この計算ノード追加は、OCIコンソールから実施する追加2ノード分のOCIリソース構築フェーズと、Bastionノードのコマンドラインから実施するAnsibleのOSレベルカスタマイズフェーズを、個別に実行することで行います。</p>

<ol>
  <li>
    <p>OCIコンソールメニューから <strong>コンピュート</strong> → <strong>クラスタ・ネットワーク</strong> を選択し、表示される以下画面で、スタックの適用により作成されたクラスタ・ネットワークをクリックします。</p>

    <p><img src="console_page01.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面で、 <strong>編集</strong> ボタンをクリックします。</p>

    <p><img src="console_page02.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>クラスタ・ネットワークの編集</strong> サイドバーで、 <strong>インスタンス数</strong> を4に変更し <strong>変更の保存</strong> ボタンをクリックします。</p>

    <p><img src="console_page03.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>クラスタ・ネットワーク・インスタンス・プール</strong> ウィンドウで、左上のステータスが <strong>スケーリング中</strong> → <strong>完了</strong> と遷移したら、計算ノードの追加が完了しています。</p>

    <p><img src="console_page04.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>同じウィンドウ下方の以下 <strong>インスタンス・プール</strong> フィールドで、 <strong>インスタンス数</strong> が4に増加していることを確認します。</p>

    <p><img src="console_page05.png" alt="画面ショット" /></p>
  </li>
</ol>

<p>以上で、OCIリソース構築フェーズは完了です。この段階は、追加した計算ノード用インスタンスのデプロイが完了し既存クラスタ・ネットワークに物理的に接続されOSが起動した状態で、未だクラスタ・ネットワークを利用可能な状態になっていません。</p>

<p>次に、AnsibleによるOSレベルカスタマイズを行います。</p>

<ol>
  <li>
    <p>Bastionノードにログインし、Ansibleのインベントリファイル/etc/ansible/hostsの <strong>compute</strong> セクションの最後に、追加された計算ノードのホスト名とIPアドレスの記述を、以下のように追加します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>compute]
inst-gxosv-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.6.51 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
inst-mdu0w-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.6.187 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
<span class="c">#</span>
<span class="c"># Two nodes added from here</span>
inst-yzgqv-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.5.203 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
inst-jow40-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.5.11 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
<span class="c">#</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>本ステップで実行するコマンドは、Bastionから計算ノードへのSSH接続を使用するため、全ての計算ノードがSSH接続可能な状態まで起動されていることを確認します。</p>

    <p>以下コマンドを実行し、追加された計算ノードに対するAnsibleのOSレベルカスタマイズを起動、最後の <strong>PLAY RECAP</strong> フィールドの出力で <strong>failed</strong> や <strong>unreachable</strong> の項目が無いことで、正常に終了していることを確認します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False ansible-playbook /opt/oci-hpc/playbooks/site.yml
   :
   :
   :
PLAY RECAP <span class="k">**********************************************************************************************</span>
inst-gxosv-relevant-owl    : <span class="nv">ok</span><span class="o">=</span>86   <span class="nv">changed</span><span class="o">=</span>16   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>59   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
inst-jow40-relevant-owl    : <span class="nv">ok</span><span class="o">=</span>85   <span class="nv">changed</span><span class="o">=</span>51   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>56   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
inst-mdu0w-relevant-owl    : <span class="nv">ok</span><span class="o">=</span>83   <span class="nv">changed</span><span class="o">=</span>13   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>57   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
inst-yzgqv-relevant-owl    : <span class="nv">ok</span><span class="o">=</span>85   <span class="nv">changed</span><span class="o">=</span>51   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>56   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
relevant-owl-bastion       : <span class="nv">ok</span><span class="o">=</span>112  <span class="nv">changed</span><span class="o">=</span>21   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>115  <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0
<span class="o">&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>以上で、AnsibleのOSレベルカスタマイズフェーズは完了し、4ノードのHPCクラスタが利用可能になります。</p>

<h1 id="8-mpiプログラム実行4ノード編">8. MPIプログラム実行（4ノード編）</h1>

<p>本章は、先に作成したLDAPユーザを使ってMPIプログラムをSlurmを介してバッチジョブとして投入し、追加後の4ノードHPCクラスタのインターコネクト性能をIntel MPIベンチマークで確認します。</p>

<p>ここでは、4ノードのAlltoall性能を計測しています。</p>

<p>以降の手順は、先に作成したLDAPユーザで実施します。</p>

<ol>
  <li>
    <p>バッチジョブスクリプト作成</p>

    <p>以下のバッチジョブ投入用スクリプトをBastionノードのホームディレクトリ以下に作成します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat </span>submit_4nodes.sh
<span class="c">#!/bin/bash</span>
<span class="c">#SBATCH -p compute</span>
<span class="c">#SBATCH -n 4</span>
<span class="c">#SBATCH -N 4</span>
<span class="c">#SBATCH -J all_to_all</span>
<span class="c">#SBATCH -o stdout.%J</span>
<span class="c">#SBATCH -e stderr.%J</span>
   
<span class="c"># Only for BM.Optimized3.36</span>
<span class="nb">export </span><span class="nv">UCX_NET_DEVICES</span><span class="o">=</span>mlx5_2:1
   
module load intel/mpi/latest
   
mpirun IMB-MPI1 <span class="nt">-mem</span> 4 Alltoall
</code></pre></div>    </div>
  </li>
  <li>
    <p>バッチジョブ投入</p>

    <p>作成したスクリプトをバッチジョブとして投入します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> sbatch submit_4nodes.sh 
Submitted batch job 3
</code></pre></div>    </div>
  </li>
  <li>
    <p>バッチジョブ結果確認</p>

    <p>投入したバッチジョブの結果を確認します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cat </span>stderr.3
Loading mpi version 2021.3.0
<span class="o">&gt;</span> <span class="nb">cat </span>stdout.3
<span class="c">#----------------------------------------------------------------</span>
<span class="c">#    Intel(R) MPI Benchmarks 2021.2, MPI-1 part</span>
<span class="c">#----------------------------------------------------------------</span>
<span class="c"># Date                  : Thu Mar 24 04:29:15 2022</span>
<span class="c"># Machine               : x86_64</span>
<span class="c"># System                : Linux</span>
<span class="c"># Release               : 3.10.0-1160.25.1.el7.x86_64</span>
<span class="c"># Version               : #1 SMP Tue Apr 27 15:52:10 PDT 2021</span>
<span class="c"># MPI Version           : 3.1</span>
<span class="c"># MPI Thread Environment: </span>


<span class="c"># Calling sequence was: </span>

<span class="c"># IMB-MPI1 -mem 4 Alltoall </span>

<span class="c"># Minimum message length in bytes:   0</span>
<span class="c"># Maximum message length in bytes:   4194304</span>
<span class="c">#</span>
<span class="c"># MPI_Datatype                   :   MPI_BYTE </span>
<span class="c"># MPI_Datatype for reductions    :   MPI_FLOAT </span>
<span class="c"># MPI_Op                         :   MPI_SUM  </span>
<span class="c"># </span>
<span class="c"># </span>

<span class="c"># List of Benchmarks to run:</span>

<span class="c"># Alltoall</span>

<span class="c">#----------------------------------------------------------------</span>
<span class="c"># Benchmarking Alltoall </span>
<span class="c"># #processes = 2 </span>
<span class="c"># ( 2 additional processes waiting in MPI_Barrier)</span>
<span class="c">#----------------------------------------------------------------</span>
       <span class="c">#bytes #repetitions  t_min[usec]  t_max[usec]  t_avg[usec]</span>
            0         1000         0.07         0.07         0.07
            1         1000         0.65         6.07         3.36
            2         1000         0.82         6.21         3.51
            4         1000         0.63         6.11         3.37
            8         1000         0.68         6.05         3.37
           16         1000         0.66         6.15         3.41
           32         1000         0.67         6.15         3.41
           64         1000         0.75         6.29         3.52
          128         1000         0.79         6.37         3.58
          256         1000         0.97         6.69         3.83
          512         1000         1.03         6.79         3.91
         1024         1000         1.81         6.31         4.06
         2048         1000         7.22         7.25         7.24
         4096         1000         7.90         7.92         7.91
         8192         1000         8.50         8.55         8.53
        16384         1000         9.82         9.87         9.85
        32768         1000        13.08        13.09        13.09
        65536          640        23.10        23.10        23.10
       131072          320        30.03        30.50        30.27
       262144          160        43.79        43.85        43.82
       524288           80        71.72        71.86        71.79
      1048576           40       272.44       277.41       274.93
      2097152           20       520.28       526.08       523.18
      4194304           10      1002.88      1007.84      1005.36

<span class="c">#----------------------------------------------------------------</span>
<span class="c"># Benchmarking Alltoall </span>
<span class="c"># #processes = 4 </span>
<span class="c">#----------------------------------------------------------------</span>
       <span class="c">#bytes #repetitions  t_min[usec]  t_max[usec]  t_avg[usec]</span>
            0         1000         0.08         0.08         0.08
            1         1000         3.77         4.16         3.97
            2         1000         3.62         4.32         3.97
            4         1000         3.54         4.40         3.98
            8         1000         3.55         4.40         3.98
           16         1000         3.60         4.35         3.98
           32         1000         3.35         4.77         4.06
           64         1000         3.68         4.61         4.16
          128         1000         4.17         4.23         4.20
          256         1000         4.66         5.13         4.87
          512         1000         4.45         5.63         5.02
         1024         1000         4.93         5.58         5.23
         2048         1000         7.70         7.76         7.74
         4096         1000         8.98         9.09         9.06
         8192         1000        11.02        11.40        11.23
        16384         1000        12.88        13.61        13.31
        32768         1000        20.15        21.55        20.79
        65536          640        32.60        34.18        33.04
       131072          320        53.61        58.48        55.11
       262144          160        99.36       106.92       102.02
       524288           80       185.47       206.04       194.67
      1048576           40       406.18       445.43       425.45
      2097152           20       807.91       919.29       863.22
      4194304           10      1588.80      1787.67      1688.05


<span class="c"># All processes entering MPI_Finalize</span>
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="9-計算ノード入れ替え">9. 計算ノード入れ替え</h1>

<p>本章は、構築した4ノードクラスタのうち1ノードにハードウェア障害等が発生した場合を想定し、この計算ノードを新たな計算ノードに入れ替えます。</p>

<p>この計算ノード入れ替えは、OCIコンソールから実施するOCIリソースレベルの計算ノード入れ替えフェーズと、Bastionノードのコマンドラインから実施するAnsibleによるOSレベルの新計算ノードカスタマイズフェーズを、個別に実行することで行います。</p>

<ol>
  <li>
    <p>OCIコンソールメニューから <strong>コンピュート</strong> → <strong>クラスタ・ネットワーク</strong> を選択し、表示される以下画面で、スタックの適用により作成されたクラスタ・ネットワークをクリックします。</p>

    <p><img src="console_page01.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面の <strong>インスタンス・プール</strong> フィールドで、クラスタ・ネットワークの作成に伴い作成されたインスタンスプールをクリックします。</p>

    <p><img src="console_page07.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面左下の <strong>アタッチされたインスタンス</strong> メニューをクリックします。</p>

    <p><img src="console_page06.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される画面の以下 <strong>アタッチされたインスタンス</strong> フィールドで、削除するインスタンスのメニューから <strong>インスタンスのデタッチ</strong> メニューをクリックします。</p>

    <p><img src="console_page08.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下画面で、 <strong>このインスタンスおよびアタッチされたブート・ボリュームを完全に終了（削除）</strong> と <strong>プールのインスタンス構成をインスタンスのテンプレートとして使用し、インスタンスを新しいインスタンスで置き換える</strong> チェックボックスをチェックし、 <strong>デタッチと終了</strong> ボタンをクリックします。</p>

    <p><img src="console_page09.png" alt="画面ショット" /></p>
  </li>
</ol>

<p>以上で、OCIリソースレベルの計算ノード入れ替えフェーズは完了です。この段階は、置き換えた計算ノード用インスタンスの削除とデプロイが完了し、新たな計算ノードが既存クラスタ・ネットワークに物理的に接続されOSが起動した状態で、未だクラスタ・ネットワークを利用可能な状態になっていません。</p>

<p>次に、AnsibleによるOSレベルカスタマイズを行います。</p>

<ol>
  <li>
    <p>Bastionノードにログインし、Ansibleのインベントリファイル/etc/ansible/hostsの <strong>compute</strong> セクションで、置き換えられた計算ノードのホスト名とIPアドレスの記述を、置き換えた計算ノードのものに書き換えます。なお、置き換えられた計算ノードが <strong>nfs</strong> セクションにも記載がある場合、これを以下のようにコメントアウトします。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>compute]
inst-gxosv-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.6.51 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
inst-mdu0w-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.6.187 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
<span class="c">#</span>
<span class="c"># Two nodes added from here</span>
inst-yzgqv-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.5.203 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
<span class="c">#</span>
<span class="c"># The following two compute nodes were replaced each other due to haradware failure</span>
<span class="c">#inst-jow40-relevant-owl ansible_host=172.16.5.11 ansible_user=opc role=compute</span>
inst-sz0pd-relevant-owl <span class="nv">ansible_host</span><span class="o">=</span>172.16.5.15 <span class="nv">ansible_user</span><span class="o">=</span>opc <span class="nv">role</span><span class="o">=</span>compute
<span class="c">#</span>
<span class="c">#</span>

<span class="o">[</span>nfs]
<span class="c">#inst-jow40-relevant-owl ansible_host=172.16.5.11 ansible_user=opc role=compute</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>本ステップで実行するコマンドは、Bastionから計算ノードへのSSH接続を使用するため、置き換えた計算ノードがSSH接続可能な状態まで起動されていることを確認します。</p>

    <p>以下コマンドを実行し、置き換えた計算ノードに対するAnsibleのOSレベルカスタマイズを起動、最後の <strong>PLAY RECAP</strong> フィールドの出力で <strong>failed</strong> や <strong>unreachable</strong> の項目が無いことで、正常に終了していることを確認します。</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False ansible-playbook /opt/oci-hpc/playbooks/site.yml
   :
   :
   :
PLAY RECAP <span class="k">**********************************************************************************************</span>
inst-gxosv-relevant-owl : <span class="nv">ok</span><span class="o">=</span>98   <span class="nv">changed</span><span class="o">=</span>14   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>94   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
inst-yzgqv-relevant-owl : <span class="nv">ok</span><span class="o">=</span>108  <span class="nv">changed</span><span class="o">=</span>20   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>96   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
inst-mdu0w-relevant-owl : <span class="nv">ok</span><span class="o">=</span>98   <span class="nv">changed</span><span class="o">=</span>13   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>94   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
inst-sz0pd-relevant-owl : <span class="nv">ok</span><span class="o">=</span>102  <span class="nv">changed</span><span class="o">=</span>68   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>93   <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0   
relevant-owl-bastion     : <span class="nv">ok</span><span class="o">=</span>112  <span class="nv">changed</span><span class="o">=</span>22   <span class="nv">unreachable</span><span class="o">=</span>0    <span class="nv">failed</span><span class="o">=</span>0    <span class="nv">skipped</span><span class="o">=</span>115  <span class="nv">rescued</span><span class="o">=</span>0    <span class="nv">ignored</span><span class="o">=</span>0 
<span class="o">&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>以上で、AnsibleのOSレベルカスタマイズフェーズは完了し、計算ノードの置き換えは完了です。</p>

<p>再度 <strong>8. MPIプログラム実行（4ノード編）</strong> に従いIntel MPIベンチマークを実行し、インターコネクト性能が十分出ていることを確認します。</p>

<h1 id="10-スタックの破棄">10. スタックの破棄</h1>

<p>本章は、スタックを破棄することで、構築したHPCクラスタを削除します。</p>

<p>以下の手順は、 <strong>計算ノード追加</strong> の手順で追加を実施したかどうかにかかわらず、本チュートリアルで作成したOCI上のリソースをすべて削除します。</p>

<ol>
  <li>
    <p>以下 <strong>スタックの詳細</strong> 画面で、 <strong>破棄</strong> ボタンをクリックします。</p>

    <p><img src="stack_page16.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>破棄</strong> サイドバーで、 <strong>破棄</strong> ボタンをクリックします。</p>

    <p><img src="stack_page17.png" alt="画面ショット" /></p>
  </li>
  <li>
    <p>表示される以下 <strong>ジョブ詳細</strong> ウィンドウで、左上のステータスが <strong>受入れ済</strong> → <strong>進行中</strong> と遷移すれば、スタックの破棄が実施されています。</p>

    <p><img src="stack_page18.png" alt="画面ショット" /></p>

    <p>表示される以下 <strong>ログ</strong> フィールドで、リソースの削除状況を確認します。</p>

    <p><img src="stack_page11.png" alt="画面ショット" /></p>

    <p>この破棄が完了するまでの所要時間は、計算ノードのノード数が2ノードの場合で5分程度です。</p>

    <p>ステータスが <strong>成功</strong> となれば、HPCクラスタの削除が完了しています。</p>
  </li>
</ol>

<p>これで、このチュートリアルは終了です。</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time datetime="2023-01-27T12:56:14+09:00">January 27, 2023</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=HPC%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF%E3%82%92%E6%A7%8B%E7%AF%89%E3%81%99%E3%82%8B%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fintermediates%2Fspinup-hpc-cluster%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fintermediates%2Fspinup-hpc-cluster%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fintermediates%2Fspinup-hpc-cluster%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/intermediates/attaching-secondary-ips/" class="pagination--pager" title="インスタンスにセカンダリIPを付与する
">前へ</a>
    
    
      <a href="/ocitutorials/intermediates/spinup-ml-instance/" class="pagination--pager" title="GPUインスタンスで機械学習にトライ
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">関連記事</h4>
      <div class="grid__wrapper">
        
      </div>
    </div>
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Oracle Cloud Infrastructure チュートリアル. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  
    <script src="/ocitutorials/assets/js/tabs.js"></script>
  
    <script src="/ocitutorials/assets/js/sidebar.js"></script>
  



  </body>
</html>
