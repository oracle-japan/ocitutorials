<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="ja-JP" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>107 : 会話履歴保持の仕組みを取り入れたRAGの実装をしてみよう | Oracle Cloud Infrastructure チュートリアル</title>
<meta name="description" content="シンプルな検索拡張生成(RAG)の実装に、チャット会話履歴を保持する仕組みを取り入れた構成をご紹介します。">


  <meta name="author" content="Oracle Japan Solution Engineers">
  
  <meta property="article:author" content="Oracle Japan Solution Engineers">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ja_JP">
<meta property="og:site_name" content="Oracle Cloud Infrastructure チュートリアル">
<meta property="og:title" content="107 : 会話履歴保持の仕組みを取り入れたRAGの実装をしてみよう">
<meta property="og:url" content="https://oracle-japan.github.io/ocitutorials/ai-vector-search/ai-vector107-rag-chat-history/">


  <meta property="og:description" content="シンプルな検索拡張生成(RAG)の実装に、チャット会話履歴を保持する仕組みを取り入れた構成をご紹介します。">



  <meta property="og:image" content="https://oracle-japan.github.io/ocitutorials/ai-vector-search/ai-vector107-rag-chat-history/1.png">





  <meta property="article:published_time" content="2025-04-15T14:18:46+09:00">






<link rel="canonical" href="https://oracle-japan.github.io/ocitutorials/ai-vector-search/ai-vector107-rag-chat-history/">












<!-- end _includes/seo.html -->



  <link href="/ocitutorials/feed.xml" type="application/atom+xml" rel="alternate" title="Oracle Cloud Infrastructure チュートリアル Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ocitutorials/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-32.png" sizes="32x32">
<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-128.png" sizes="128x128">
<link rel="icon" href="https://www.oracle.com/asset/web/favicons/favicon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://www.oracle.com/asset/web/favicons/favicon-120.png" sizes="120x120">
<link rel="apple-touch-icon" href="https://www.oracle.com/asset/web/favicons/favicon-152.png" sizes="152x152">
<link rel="apple-touch-icon" href="https://www.oracle.com/asset/web/favicons/favicon-180.png" sizes="180x180">
<link rel="shortcut icon" type="image/x-icon" href="/ocitutorials/assets/favicon/favicon.ico">
<link rel="manifest" href="/ocitutorials/assets/favicon/site.webmanifest">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ocitutorials/"><img src="/ocitutorials/assets/images/social-og-oracle-badge.jpg" alt="OCI チュートリアル"></a>
        
        <a class="site-title" href="/ocitutorials/">
          OCI チュートリアル
          <span class="site-subtitle">Oracle Cloud Infrastructure を使ってみよう</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/ocitutorials/#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%B3%E3%83%84%E4%B8%80%E8%A6%A7"
                
                
              >チュートリアル一覧</a>
            </li><li class="masthead__menu-item">
              <a
                href="/ocitutorials/about/"
                
                
              >このサイトについて</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">メニュー</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(34, 66, 55, 0.7), rgba(34, 66, 55, 0.7)), url('/ocitutorials/ai-vector-search/ai-vector107-rag-chat-history/1.png');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          107 : 会話履歴保持の仕組みを取り入れたRAGの実装をしてみよう

        
      </h1>
      
        <p class="page__lead">シンプルな検索拡張生成(RAG)の実装に、チャット会話履歴を保持する仕組みを取り入れた構成をご紹介します。
</p>
      
      


      
    </div>
  
  
</div>






  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/" itemprop="item"><span itemprop="name">ホーム</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/ocitutorials/ai-vector-search" itemprop="item"><span itemprop="name">Ai vector search</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">></span>
      
    
      
      
        <li class="current">107 : 会話履歴保持の仕組みを取り入れたRAGの実装をしてみよう</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">メニュー</label>
  <ul class="nav__items">
    <li>
      
      <a href=""><span class="nav__sub-title">Oracle Database編 - AI Vector Search</span></a>
      <ul>
        
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector101-always-free-adb/">101 : Always Freeで23aiのADBインスタンスを作成してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector102-23aifree-install/">102 : 仮想マシンへOracle Database 23ai Freeをインストールしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector103-basics/">103 : Oracle AI Vector Searchの基本操作を試してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector104-file-to-embedding/">104 :ファイル→テキスト→チャンク→ベクトルへの変換およびベクトル検索を使おう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector105-multi-vector-search/">105: マルチベクトル検索で複数のドキュメントを検索してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag/">106 : Oracle Database 23aiとLangChainでRAGを構成してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector107-rag-chat-history/" class="active">107 : 会話履歴保持の仕組みを取り入れたRAGの実装をしてみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector108-select-ai-with-rag/">108 : SELECT AI with RAGを試してみよう</a></li></p>
        
          <p></p><li><a href="/ocitutorials/ai-vector-search/ai-vector109-oracletext/">109 : Oracle Database で全文検索してみよう</a></li></p>
        
      </ul>
    </li>
  </ul>
</nav>
    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="107 : 会話履歴保持の仕組みを取り入れたRAGの実装をしてみよう">
    <meta itemprop="description" content="シンプルな検索拡張生成(RAG)の実装に、チャット会話履歴を保持する仕組みを取り入れた構成をご紹介します。">
    <meta itemprop="datePublished" content="2025-04-15T14:18:46+09:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 目次</h4></header>
              <ul class="toc__menu"><li><a href="#はじめに">はじめに</a></li><li><a href="#構成">構成</a><ul><li><a href="#ドキュメントデータ">ドキュメントデータ</a></li></ul></li><li><a href="#実装">実装</a><ul><li><a href="#python環境のセットアップ">Python環境のセットアップ</a></li><li><a href="#oracle-database-へのデータロード">Oracle Database へのデータ・ロード</a></li><li><a href="#会話履歴保存用データベースpostgresqlのセットアップ">会話履歴保存用データベース(PostgreSQL)のセットアップ</a></li></ul></li><li><a href="#ragの実装">RAGの実装</a></li></ul>
            </nav>
          </aside>
        
        <h1 id="はじめに">はじめに</h1>
<p><a href="/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag" target="_blank">106 : Oracle Database 23aiとLangChainでRAGを構成してみよう</a>ではLangChainを利用したシンプルな検索拡張生成(RAG)の実装をご紹介しました。</p>

<p>今回は、その基本実装にチャット会話履歴を保持する仕組みを取り入れた構成をご紹介します。(※RAGって何ですか？という方は<a href="https://qiita.com/ksonoda/items/ba6d7b913fc744db3d79" target="_blank">こちらの記事</a>を事前にご参照ください。)</p>

<p>ChatGPTを使って沢山の質問を投げていると、無意識に主語を省略したり、「それ」、「あれ」、「彼」、「彼女」など代名詞などを使って以前の質問を指し示すような質問をする場合が多々あります。そんな適当に入力した質問でもLLMがちゃんと応答してくれるのは、そのセッションで入力されたプロンプトと出力された応答テキストをデータベースに保存し、新しい質問が入力されると、その前までの会話と関連性がある質問なのかどうかを判断し、必要に応じて過去の会話から必要なテキストを参照する仕組みがあるからです。</p>

<p><img src="1.png" alt="image.png" /></p>

<p>構成としては、RAGの基本コンポーネント(LLMとベクトルデータベース)に加えて、チャット履歴を保持するデータベースを追加するだけです。上図の例は、プロンプト2で主語を省略した形で質問をしていますが、プロンプト1の質問とその応答テキストがチャット履歴としてデータベースに保存されており、その内容からプロンプト2の主語が何になるかを補完して返答2として正確な応答をしているという例です。</p>

<p>仮に会話履歴が保持されていないと、プロンプト2の主語が何になるのかがわからず、誤った応答をしてしまう可能性が高くなるため、それを回避するためチャットボット系のアプリでは必ずこの仕組みを実装することになります。本チュートリアルではそのサンプル実装をご紹介します。</p>

<h1 id="構成">構成</h1>
<p>今回の実装で利用する構成図が下記になります。</p>

<p><img src="2.png" alt="image.png" /></p>

<ul>
  <li>オーケストレーションツール：LangChain</li>
  <li>ベクトルデータベース：Oracle Database 23ai(AI Vector Search)
    <ul>
      <li>Autonomous Database</li>
      <li>Base Database Service</li>
      <li>Oracle Database 23ai Free(Computeインスタンスへインストール)</li>
    </ul>
  </li>
  <li>大規模言語モデル：OCI Generative AI Service</li>
  <li>会話履歴保持用データベース：OCI PostgreSQL Database Service</li>
</ul>

<p>RAGのフローや上述した会話履歴データベースの参照処理などは全てLangChainにお任せ状態になるためこちらの実装もいたってシンプルです。この構成では、会話履歴保持用データベースにPostgreSQLを使っていますが、データベースを使わずメモリに保持することもできます。その場合、多数のユーザーがたくさん質問するような環境ではメモリを圧迫しますし、システムが落ちてしまうと会話履歴が保持されませんのでやはりデータベースを使うのがよいと思います。</p>

<h2 id="ドキュメントデータ">ドキュメントデータ</h2>
<p>ベクトルデータベースにロードするドキュメントデータは下図のような内容のPDFファイルです。テキストの内容としては架空の製品であるロケットエンジンOraBoosterの説明文章です。企業内のデータを想定し、テキストの内容としては、存在しない製品かつ完全な創作文章、ということでLLMが学習しているはずのないデータということになります。後の手順でこちらのPDFファイルをベクトルデータベースにロードします。</p>

<p><img src="3.png" alt="image.png" /></p>

<p><a href="/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag" target="_blank">106 : Oracle Database 23aiとLangChainでRAGを構成してみよう</a>で使用したPDFファイルと同じものになっているので、すでに実施済みの方はダウンロードしなくて結構です。</p>

<p><a href="/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag/rocket.pdf">本チュートリアルで使用するファイル</a></p>

<p>106を実施していない方は、以下で<code class="language-plaintext highlighter-rouge">/tmp</code>ディレクトリにこちらのPDFをダウンロードしてください。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp
wget https://oracle-japan.github.io/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag/rocket.pdf
</code></pre></div></div>

<h1 id="実装">実装</h1>

<h2 id="python環境のセットアップ">Python環境のセットアップ</h2>

<p>まず必要なパッケージをインストールします。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">pip</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">Uq</span> <span class="n">oracledb</span> <span class="n">pypdf</span> <span class="n">cohere</span> <span class="n">langchain</span> <span class="n">langchain</span><span class="o">-</span><span class="n">community</span> <span class="n">langchain</span><span class="o">-</span><span class="n">core</span> <span class="n">langchain_postgres</span> <span class="n">oci</span> <span class="n">grandalf</span> <span class="n">psycopg</span>
</code></pre></div></div>

<p><br /></p>

<h2 id="oracle-database-へのデータロード">Oracle Database へのデータ・ロード</h2>
<p>次に、データベースへ接続し、pdfファイルの埋め込みとロードを行います。<a href="/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag" target="_blank">106 : Oracle Database 23aiとLangChainでRAGを構成してみよう</a>と同じ処理内容です。</p>

<p>Oracle Database へ接続します。利用するサービスによって、接続文字列が変わりますので以下のサンプルを使って接続してください。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">oracledb</span>

<span class="c1"># Oracle Database 23ai Free版
</span><span class="n">username</span> <span class="o">=</span> <span class="sh">"</span><span class="s">docuser</span><span class="sh">"</span>
<span class="n">password</span> <span class="o">=</span> <span class="sh">"</span><span class="s">docuser</span><span class="sh">"</span>
<span class="n">dsn</span> <span class="o">=</span> <span class="sh">"</span><span class="s">localhost/freepdb1</span><span class="sh">"</span>

<span class="c1"># BaseDB版では以下をコメントアウトして実行します
# oracledb.init_oracle_client()
# username = "docuser"
# password = "WelCome123#123#"
#dsn = "&lt;PDBの接続文字列&gt;" (例) basedb23ai.xxxx.vcn1.oraclevcn.com:1521/pdb1.xxxx.vcn1.oraclevcn.com
</span>
<span class="c1"># Autonomous Database版では以下をコメントアウトして実行します
</span>
<span class="c1"># username = "docuser"
# password = "Welcome12345#"
# dsn = "&lt;ADBの接続文字列&gt;" (例) (description= (retry_count=20)(retry_delay=3)(address=(protocol=tcps)(port=1521)(host=adb.ap-tokyo-1.oraclecloud.com))(connect_data=(service_name=xxxxx_xxx_low.adb.oraclecloud.com))(security=(ssl_server_dn_match=yes)))
</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">oracledb</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">dsn</span><span class="o">=</span><span class="n">dsn</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connection successful!</span><span class="sh">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connection failed!</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>PDFファイルをロードしテキストに変換します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.document_loaders</span> <span class="kn">import</span> <span class="n">PyPDFLoader</span>

<span class="n">loader</span> <span class="o">=</span> <span class="nc">PyPDFLoader</span><span class="p">(</span><span class="sh">"</span><span class="s">/tmp/rocket.pdf</span><span class="sh">"</span><span class="p">)</span>
<span class="n">documents</span> <span class="o">=</span> <span class="n">loader</span><span class="p">.</span><span class="nf">load_and_split</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
</code></pre></div></div>

<p>出力:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='当社が開発したロケットエンジンである OraBooster は、次世代の宇宙探査を支える先進的な推進技術の\n象徴です。その独自の設計は、高性能と革新性を融合させ、人類の宇宙進出を加速させるための革命的\nな一歩となります。\nこのエンジンの核となるのは、量子ダイナミックス・プラズマ・ブースターです。このブースターは、\n量子力学の原理に基づいてプラズマを生成し、超高速で加速させます。その結果、従来の化学反応より\nもはるかに高い推力を発生し、遠く離れた惑星や星系への探査を可能にします。\nさらに、エンジンの外殻にはナノファイバー製の超軽量かつ超強度の素材が使用されています。この素\n材は、宇宙空間の過酷な環境に耐え、高速での飛行中に生じる熱や衝撃からロケットを守ります。\nまた、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維\n持し、目標を追跡します。これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、\nミッションの成功を確保します。\nさらに、バイオニック・リアクション・レスポンダーが統合されています。このシステムは、人工知能\nと生体認識技術を組み合わせ、ロケットの異常な振動や動きを検知し、自己修復機能を活性化します。\n総じて、この新開発のロケットエンジンは、革新的な技術と未来志向の設計によって、宇宙探査の新た\nな時代を切り開くことでしょう。その高い性能と信頼性は、人類の夢を実現するための力強い支援とな\nることでしょう。')]
</code></pre></div></div>

<p>変換されたテキストをチャンクに区切ります。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.text_splitter</span> <span class="kn">import</span> <span class="n">CharacterTextSplitter</span>

<span class="n">text_splitter</span> <span class="o">=</span> <span class="nc">CharacterTextSplitter</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="sh">"</span><span class="s">。</span><span class="sh">"</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">docs</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="p">.</span><span class="nf">split_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
</code></pre></div></div>

<p>出力:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='当社が開発したロケットエンジンである OraBooster は、次世代の宇宙探査を支える先進的な推進技術の\n象徴です'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='その独自の設計は、高性能と革新性を融合させ、人類の宇宙進出を加速させるための革命的\nな一歩となります。\nこのエンジンの核となるのは、量子ダイナミックス・プラズマ・ブースターです'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='このブースターは、\n量子力学の原理に基づいてプラズマを生成し、超高速で加速させます。その結果、従来の化学反応より\nもはるかに高い推力を発生し、遠く離れた惑星や星系への探査を可能にします'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='さらに、エンジンの外殻にはナノファイバー製の超軽量かつ超強度の素材が使用されています。この素\n材は、宇宙空間の過酷な環境に耐え、高速での飛行中に生じる熱や衝撃からロケットを守ります'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維\n持し、目標を追跡します'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、\nミッションの成功を確保します。\nさらに、バイオニック・リアクション・レスポンダーが統合されています'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='このシステムは、人工知能\nと生体認識技術を組み合わせ、ロケットの異常な振動や動きを検知し、自己修復機能を活性化します'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='総じて、この新開発のロケットエンジンは、革新的な技術と未来志向の設計によって、宇宙探査の新た\nな時代を切り開くことでしょう'), Document(metadata={'source': '/tmp/rocket.pdf', 'page': 0}, page_content='その高い性能と信頼性は、人類の夢を実現するための力強い支援とな\nることでしょう')]
</code></pre></div></div>

<p>区切ったチャンクテキストを埋め込みモデル(OCI Generative AI Serviceのembed-multilingual-v3.0)でベクトルに変換し、ベクトル・データベースにロードします。</p>

<p>※service_endpointには大阪リージョンのエンドポイントを指定していますが、サブスクライブしているリージョンによって適宜修正してください。最新のリージョン一覧は<a href="https://docs.oracle.com/ja-jp/iaas/Content/generative-ai/pretrained-models.htm" target="_blank">こちら</a>をご参照ください。例えばロンドンの場合は、service_endpointには<em>https://inference.generativeai.uk-london-1.oci.oraclecloud.com</em>と指定します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.vectorstores.oraclevs</span> <span class="kn">import</span> <span class="n">OracleVS</span>
<span class="kn">from</span> <span class="n">langchain_community.vectorstores.utils</span> <span class="kn">import</span> <span class="n">DistanceStrategy</span>
<span class="kn">from</span> <span class="n">langchain_community.embeddings</span> <span class="kn">import</span> <span class="n">OCIGenAIEmbeddings</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="nc">OCIGenAIEmbeddings</span><span class="p">(</span>
    <span class="n">model_id</span><span class="o">=</span><span class="sh">"</span><span class="s">cohere.embed-multilingual-v3.0</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">service_endpoint</span><span class="o">=</span><span class="sh">"</span><span class="s">https://inference.generativeai.ap-osaka-1.oci.oraclecloud.com</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">compartment_id</span><span class="o">=</span><span class="sh">"</span><span class="s">&lt;compartmentのOCID&gt;</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">vector_store_dot</span> <span class="o">=</span> <span class="n">OracleVS</span><span class="p">.</span><span class="nf">from_documents</span><span class="p">(</span>
    <span class="n">docs</span><span class="p">,</span>
    <span class="n">embeddings</span><span class="p">,</span>
    <span class="n">client</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
    <span class="n">table_name</span><span class="o">=</span><span class="sh">"</span><span class="s">doc_table</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">distance_strategy</span><span class="o">=</span><span class="n">DistanceStrategy</span><span class="p">.</span><span class="n">DOT_PRODUCT</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>特にエラーが出なければ、ドキュメントがベクトル・データベースにロードされた状態です。</p>

<p><strong>注意</strong>: 以下のエラーが出る場合は、APIキーの設定ファイル<code class="language-plaintext highlighter-rouge">~/.oci/config</code>が作成されていません。<a href="https://oracle-japan.github.io/ocitutorials/adb/adb501-ocicli/">501: OCICLIを利用したインスタンス操作</a>を参照して、APIキーを事前に作成してください。</p>

<p>OCIコンソールからAPIキーの作成を行った場合は、<code class="language-plaintext highlighter-rouge">~/.oci</code>ディレクトリを作成し、<code class="language-plaintext highlighter-rouge">config</code>ファイルに構成ファイルスニペットを貼り付け、秘密鍵ファイルへのパスを記述してください。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ValidationError: 1 validation error for OCIGenAIEmbeddings
__root__
  Could not authenticate with OCI client. Please check if ~/.oci/config exists. If INSTANCE_PRINCIPLE or RESOURCE_PRINCIPLE is used, Please check the specified auth_profile and auth_type are valid. (type=value_error)
</code></pre></div></div>

<p><br /></p>

<h2 id="会話履歴保存用データベースpostgresqlのセットアップ">会話履歴保存用データベース(PostgreSQL)のセットアップ</h2>
<p>ここから会話履歴用保存用のデータベースである PostgreSQL の処理を実装します。まず<a href="https://docs.oracle.com/ja-jp/iaas/Content/postgresql/create-db.htm" target="_blank">こちら</a>を参考に、OCI PostgreSQL Serviceのインスタンスを作成します。(もちろんクラウドサービスではないローカルのPostgreSQLでも同じコードになりますのでPosgreSQLは何を使っても大丈夫です。)</p>

<p>以降の処理はデータベースへの接続と会話履歴をロードする表の作成の2つです。</p>

<p>Python用のPostgreSQL接続ドライバ<code class="language-plaintext highlighter-rouge">psycopg</code>を使って、PostgreSQLへ接続します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">psycopg</span>

<span class="n">conn_info</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sh">"</span><span class="s">postgresql://&lt;user&gt;:&lt;passwd&gt;@&lt;id adress&gt;/&lt;database name&gt;</span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">?sslmode=require</span><span class="sh">"</span>
    <span class="sh">"</span><span class="s">&amp;sslrootcert=/home/opc/postgre/CaCertificate-postgresql.pub</span><span class="sh">"</span>
<span class="p">)</span>

<span class="c1"># PostgreSQLに接続
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">sync_connection</span> <span class="o">=</span> <span class="n">psycopg</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">conn_info</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Connection successful!</span><span class="sh">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Connection failed!: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>次に履歴を保存する表を作成します。LangChainで用意されているPostgresChatMessageHistoryクラスのcreate_tables関数で簡単に表が作成できます。今回はPostgreSQLを使いましたが、その他の様々なデータベース用にたくさんのクラスがあります。このクラスの他の関数でベクトルデータベースを更新したり検索したりすることができ、後の処理で再度利用します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_postgres</span> <span class="kn">import</span> <span class="n">PostgresChatMessageHistory</span>

<span class="n">table_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">message_store</span><span class="sh">"</span>
<span class="n">PostgresChatMessageHistory</span><span class="p">.</span><span class="nf">create_tables</span><span class="p">(</span><span class="n">sync_connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
</code></pre></div></div>

<p>念のためPostgreSQLに接続し、表が作成されていることの確認と、その表定義を確認してみます。</p>

<p>PostgreSQLクライアント(psql)で接続します。</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">psql</span> <span class="o">-</span><span class="n">h</span> <span class="o">&lt;</span><span class="n">ip</span> <span class="n">address</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span> <span class="o">&lt;</span><span class="n">user_name</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">d</span> <span class="o">&lt;</span><span class="n">database_name</span><span class="o">&gt;</span>

<span class="n">Password</span> <span class="k">for</span> <span class="k">user</span> <span class="n">xxxx</span><span class="p">:</span> 

<span class="n">psql</span> <span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">server</span> <span class="mi">14</span><span class="p">.</span><span class="mi">11</span><span class="p">)</span>
<span class="n">SSL</span> <span class="k">connection</span> <span class="p">(</span><span class="n">protocol</span><span class="p">:</span> <span class="n">TLSv1</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="n">cipher</span><span class="p">:</span> <span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA384</span><span class="p">,</span> <span class="n">compression</span><span class="p">:</span> <span class="k">off</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span> 
</code></pre></div></div>

<p>作成した表(message_store)を確認してみます。</p>

<p>以下のように出力されれば、表が作成されています。</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">postgres</span><span class="o">=&gt;</span> <span class="err">\</span><span class="n">dt</span>

            <span class="n">List</span> <span class="k">of</span> <span class="n">relations</span>
 <span class="k">Schema</span> <span class="o">|</span>     <span class="n">Name</span>      <span class="o">|</span> <span class="k">Type</span>  <span class="o">|</span>  <span class="k">Owner</span>  
<span class="c1">--------+---------------+-------+---------</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">message_store</span> <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="n">xxxx</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</code></pre></div></div>

<p>クエリを実行します。
現時点ではまだプロンプトの入力は一度も行っていないので履歴件数は当然ゼロ件です。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">postgres</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">message_store</span><span class="p">;</span>

 <span class="n">id</span> <span class="o">|</span> <span class="n">session_id</span> <span class="o">|</span> <span class="n">message</span> <span class="o">|</span> <span class="n">created_at</span> 
<span class="c1">----+------------+---------+------------</span>
<span class="p">(</span><span class="mi">0</span> <span class="k">rows</span><span class="p">)</span>
</code></pre></div></div>

<p>ここまでで、ベクトル・データベース(Oracle Database)と会話履歴保持用データベース(PostgreSQL)の準備が完了しました。</p>

<p><br /></p>

<h1 id="ragの実装">RAGの実装</h1>
<p>ここからがRAGパイプラインの実装になります。
基本的にはいつものRAGの実装とあまり変わらないのですが、会話履歴保持と参照のためいくつかのクラスや関数が追加された処理を実装します。</p>

<p>まずはテキスト生成モデルの定義です。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_community.chat_models.oci_generative_ai</span> <span class="kn">import</span> <span class="n">ChatOCIGenAI</span>

<span class="n">llm</span> <span class="o">=</span> <span class="nc">ChatOCIGenAI</span><span class="p">(</span>
    <span class="c1">#model_id="cohere.command-r-08-2024",
</span>    <span class="n">model_id</span><span class="o">=</span><span class="sh">"</span><span class="s">cohere.command-r-plus-08-2024</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">service_endpoint</span><span class="o">=</span><span class="sh">"</span><span class="s">https://inference.generativeai.ap-osaka-1.oci.oraclecloud.com</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">compartment_id</span><span class="o">=</span><span class="sh">"</span><span class="s">&lt;compartmentのOCID&gt;</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">temperature</span><span class="sh">"</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="sh">"</span><span class="s">max_tokens</span><span class="sh">"</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
<span class="p">)</span>
</code></pre></div></div>

<p>次に、会話コンテキストに沿って回答をするために、もとのプロンプトを変換するためのretrieverを定義します。この実装により、仮に主語が省略されたプロンプトが入力されたりしても、内部的に以前の会話のコンテキストに沿ったプロンプトに変換されます。冒頭で説明した図はかなり簡略化したもので、これ以降の処理は<a href="https://python.langchain.com/v0.1/docs/use_cases/question_answering/chat_history/#tying-it-together" target="_blank">こちら</a>のLangChainの処理フローと一緒に確認するとコードの理解が進みやすいです。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.prompts</span> <span class="kn">import</span> <span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">MessagesPlaceholder</span>
<span class="kn">from</span> <span class="n">langchain.chains</span> <span class="kn">import</span> <span class="n">create_history_aware_retriever</span>

<span class="n">contextualize_q_system_prompt</span> <span class="o">=</span> <span class="sh">"""</span><span class="se">\
</span><span class="s">以下は、ユーザとQAアシスタントの会話です。この会話履歴を考慮して、ベクトルデータベースを検索するための自然言語クエリを生成してください。
</span><span class="sh">"""</span>

<span class="n">contextualize_q_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_messages</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">contextualize_q_system_prompt</span><span class="p">),</span>
        <span class="nc">MessagesPlaceholder</span><span class="p">(</span><span class="sh">"</span><span class="s">history</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">human</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{input}</span><span class="sh">"</span><span class="p">),</span>
        
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">retriever</span> <span class="o">=</span> <span class="n">vector_store_dot</span><span class="p">.</span><span class="nf">as_retriever</span><span class="p">(</span><span class="n">search_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

<span class="n">history_aware_retriever</span> <span class="o">=</span> <span class="nf">create_history_aware_retriever</span><span class="p">(</span>
    <span class="n">llm</span><span class="p">,</span> <span class="n">retriever</span><span class="p">,</span> <span class="n">contextualize_q_prompt</span>
<span class="p">)</span>
</code></pre></div></div>

<p>そして次が質問応答用のプロンプトの定義で、定義したプロンプトとLLMをチェーンにしているLangChainのお決まりのコードです。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.chains.combine_documents</span> <span class="kn">import</span> <span class="n">create_stuff_documents_chain</span>

<span class="n">qa_system_prompt</span> <span class="o">=</span> <span class="sh">"""</span><span class="se">\
</span><span class="s">あなたは質問応答タスクのアシスタントです。
検索された以下のコンテキストの一部を使って質問に丁寧に答えてください。
答えがわからなければ、わからないと答えてください。
最大で3つの文章を使い、簡潔な回答を心がけてください。

コンテキスト:
====
{context}
====</span><span class="se">\
</span><span class="sh">"""</span>

<span class="n">qa_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="p">.</span><span class="nf">from_messages</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="n">qa_system_prompt</span><span class="p">),</span>
        <span class="nc">MessagesPlaceholder</span><span class="p">(</span><span class="sh">"</span><span class="s">history</span><span class="sh">"</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">human</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{input}</span><span class="sh">"</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">question_answer_chain</span> <span class="o">=</span> <span class="nf">create_stuff_documents_chain</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">qa_prompt</span><span class="p">)</span>
</code></pre></div></div>

<p>ここまで定義したプロンプト変換用のretrieverと質問応答チェーンを一つにまとめるチェーンを定義します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain.chains</span> <span class="kn">import</span> <span class="n">create_retrieval_chain</span>

<span class="n">rag_chain</span> <span class="o">=</span> <span class="nf">create_retrieval_chain</span><span class="p">(</span><span class="n">history_aware_retriever</span><span class="p">,</span> <span class="n">question_answer_chain</span><span class="p">)</span>
</code></pre></div></div>

<p>会話セッションのIDを定義(乱数)し、チャット履歴検索を実行する関数get_session_historyを定義します。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.chat_history</span> <span class="kn">import</span> <span class="n">BaseChatMessageHistory</span>
<span class="kn">import</span> <span class="n">uuid</span>

<span class="c1"># 会話セッションのIDを設定
</span><span class="n">session_id</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">get_session_history</span><span class="p">(</span><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseChatMessageHistory</span><span class="p">:</span>
   <span class="k">return</span> <span class="nc">PostgresChatMessageHistory</span><span class="p">(</span>
        <span class="n">table_name</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">,</span>
        <span class="n">sync_connection</span><span class="o">=</span><span class="n">sync_connection</span>
   <span class="p">)</span>
</code></pre></div></div>

<p>ここまで定義した、チェーン(rag_chain)と上記のget_session_history関数をRunnableWithMessageHistoryでまとめて完成です。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">langchain_core.runnables.history</span> <span class="kn">import</span> <span class="n">RunnableWithMessageHistory</span>

<span class="n">conversational_rag_chain</span> <span class="o">=</span> <span class="nc">RunnableWithMessageHistory</span><span class="p">(</span>
    <span class="n">rag_chain</span><span class="p">,</span>
    <span class="n">get_session_history</span><span class="p">,</span>
    <span class="n">input_messages_key</span><span class="o">=</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">history_messages_key</span><span class="o">=</span><span class="sh">"</span><span class="s">history</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">output_messages_key</span><span class="o">=</span><span class="sh">"</span><span class="s">answer</span><span class="sh">"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>まずはシンプルに質問してみます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span> <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>出力はこちらの普通のRAGの応答です。まずベクトルデータベースを参照して応答するというRAGのパイプラインがちゃんと実行され返答されていることがわかります。
出力の各項目の説明が以下になります。</p>

<ul>
  <li>history : 参照した会話履歴(空になっているのは、このプロンプトが一番最初の質問なので参照する履歴がなかったということを表しています。)</li>
  <li>context : ベクトルデータベースから検索してきたチャンクテキスト</li>
  <li>answer : 最終的な返答のテキスト</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">当社が開発したロケットエンジンである OraBooster は、次世代の宇宙探査を支える先進的な推進技術の</span><span class="se">\n</span><span class="s">象徴です</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">OraBooster は、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、そしてハイパーフォトン・ジャイロスコープによる高精度の姿勢制御を特長とします。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>ここでPostgreSQLにクエリを実行して会話履歴を確認してみます。
以下のように、inputとanswerの2件が履歴として追加されていることがわかります。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">postgres</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">message_store</span><span class="p">;</span>
 <span class="n">id</span> <span class="o">|</span>              <span class="n">session_id</span>              <span class="o">|</span>                 <span class="n">message</span>                                                            <span class="o">|</span>          <span class="n">created_at</span>           
<span class="c1">----+--------------------------------------+------------------------------------------------------------------------------------+----------------------------</span>
  <span class="mi">1</span> <span class="o">|</span> <span class="mi">5</span><span class="n">e2a952c</span><span class="o">-</span><span class="mi">59</span><span class="n">a4</span><span class="o">-</span><span class="mi">40</span><span class="n">e1</span><span class="o">-</span><span class="mi">9355</span><span class="o">-</span><span class="n">f688a3dbf27e</span> <span class="o">|</span> <span class="p">{</span><span class="nv">"data"</span><span class="p">:</span> <span class="p">{</span><span class="nv">"id"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"name"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"human"</span><span class="p">,</span> <span class="nv">"content"</span><span class="p">:</span> <span class="nv">"OraBoosterとは何ですか？"</span><span class="p">,</span> <span class="nv">"example"</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="nv">"additional_kw
args"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"response_metadata"</span><span class="p">:</span> <span class="p">{}},</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"human"</span><span class="p">}</span>    <span class="o">|</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">07</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">39</span><span class="p">.</span><span class="mi">320933</span><span class="o">+</span><span class="mi">00</span>
  <span class="mi">2</span> <span class="o">|</span> <span class="mi">5</span><span class="n">e2a952c</span><span class="o">-</span><span class="mi">59</span><span class="n">a4</span><span class="o">-</span><span class="mi">40</span><span class="n">e1</span><span class="o">-</span><span class="mi">9355</span><span class="o">-</span><span class="n">f688a3dbf27e</span> <span class="o">|</span> <span class="p">{</span><span class="nv">"data"</span><span class="p">:</span> <span class="p">{</span><span class="nv">"id"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"name"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"ai"</span><span class="p">,</span> <span class="nv">"content"</span><span class="p">:</span> <span class="nv">"OraBooster は、次世代の宇宙探査を支える先進的な推進技術を備え
ロケットエンジンです。高い性能と信頼性、そしてハイパーフォトン・ジャイロスコープによる極めて高い姿勢制御精度を特長とします。"</span><span class="p">,</span> <span class="nv">"example"</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="nv">"tool_calls"</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">"usage
_metadata"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"additional_kwargs"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"response_metadata"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"invalid_tool_calls"</span><span class="p">:</span> <span class="p">[]},</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"ai"</span><span class="p">}</span> <span class="o">|</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">07</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">39</span><span class="p">.</span><span class="mi">320933</span><span class="o">+</span><span class="mi">00</span>
<span class="p">(</span><span class="mi">2</span> <span class="k">rows</span><span class="p">)</span>
</code></pre></div></div>

<p>次に、oraboosterという主語を省略して質問してみます。(主語を「それ」という指示代名詞に変換した質問でもいいと思います。)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">実在するものですか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>historyでこの一つ前のプロンプトと応答が履歴として参照されていることがわかります。これにより、プロンプトで省略されている主語が「Orabooster」であること判断され、正しい応答がされていることがわかります。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、</span><span class="se">\n</span><span class="s">ミッションの成功を確保します。</span><span class="se">\n</span><span class="s">さらに、バイオニック・リアクション・レスポンダーが統合されています</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。架空の設定に基づいた説明文です。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>再度PostgreSQLでクエリ実行すると2回目のinputとanswerが追加されていることがわかります。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">postgres</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">message_store</span><span class="p">;</span>
 <span class="n">id</span> <span class="o">|</span>    <span class="n">session_id</span>              <span class="o">|</span>         <span class="n">message</span>                                                         <span class="o">|</span>          <span class="n">created_at</span>           
<span class="c1">----+----------------------------+-------------------------------------------------------------------------+-------------------------------------</span>
  <span class="mi">1</span> <span class="o">|</span> <span class="n">e8b3a9c2</span><span class="o">-</span><span class="mi">28</span><span class="n">de</span><span class="o">-</span><span class="mi">4</span><span class="n">f18</span><span class="o">-</span><span class="mi">947</span><span class="n">a</span><span class="o">-</span><span class="mi">2</span><span class="n">e0d7057cf2e</span> <span class="o">|</span> <span class="p">{</span><span class="nv">"data"</span><span class="p">:</span> <span class="p">{</span><span class="nv">"id"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"name"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"human"</span><span class="p">,</span> <span class="nv">"content"</span><span class="p">:</span> <span class="nv">"OraBoosterとは何ですか？"</span><span class="p">,</span> <span class="nv">"example"</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="nv">"additional_kwargs"</span><span class="p">:</span> <span class="p">{},</span><span class="nv">"response_metadata"</span><span class="p">:{}},</span> <span class="nv">"type"</span><span class="p">:</span><span class="nv">"human"</span><span class="p">}</span> <span class="o">|</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span> <span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">45</span><span class="p">.</span><span class="mi">934184</span><span class="o">+</span><span class="mi">00</span>
  <span class="mi">2</span> <span class="o">|</span> <span class="n">e8b3a9c2</span><span class="o">-</span><span class="mi">28</span><span class="n">de</span><span class="o">-</span><span class="mi">4</span><span class="n">f18</span><span class="o">-</span><span class="mi">947</span><span class="n">a</span><span class="o">-</span><span class="mi">2</span><span class="n">e0d7057cf2e</span> <span class="o">|</span> <span class="p">{</span><span class="nv">"data"</span><span class="p">:</span> <span class="p">{</span><span class="nv">"id"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"name"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"ai"</span><span class="p">,</span> <span class="nv">"content"</span><span class="p">:</span> <span class="nv">"OraBoosterは、次世代の宇宙探査を支える先進的な推進技術を誇るロケットエンジンです。高い性能と
頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。"</span><span class="p">,</span> <span class="nv">"example"</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="nv">"tool_calls"</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">"usage_metadata"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"additional_kwargs"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"response_metadata"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"invalid_tool_calls"</span><span class="p">:[]},</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"ai"</span><span class="p">}</span> <span class="o">|</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span> <span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">45</span><span class="p">.</span><span class="mi">934184</span><span class="o">+</span><span class="mi">00</span>
  <span class="mi">3</span> <span class="o">|</span> <span class="n">e8b3a9c2</span><span class="o">-</span><span class="mi">28</span><span class="n">de</span><span class="o">-</span><span class="mi">4</span><span class="n">f18</span><span class="o">-</span><span class="mi">947</span><span class="n">a</span><span class="o">-</span><span class="mi">2</span><span class="n">e0d7057cf2e</span> <span class="o">|</span> <span class="p">{</span><span class="nv">"data"</span><span class="p">:</span> <span class="p">{</span><span class="nv">"id"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"name"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"human"</span><span class="p">,</span> <span class="nv">"content"</span><span class="p">:</span> <span class="nv">"実在するものですか？"</span><span class="p">,</span> <span class="nv">"example"</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="nv">"additional_kwargs"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"response_metadata"</span><span class="p">:</span> <span class="p">{}},</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"human"</span><span class="p">}</span> <span class="o">|</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span> <span class="mi">22</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">59</span><span class="p">.</span><span class="mi">114845</span><span class="o">+</span><span class="mi">00</span>
  <span class="mi">4</span> <span class="o">|</span> <span class="n">e8b3a9c2</span><span class="o">-</span><span class="mi">28</span><span class="n">de</span><span class="o">-</span><span class="mi">4</span><span class="n">f18</span><span class="o">-</span><span class="mi">947</span><span class="n">a</span><span class="o">-</span><span class="mi">2</span><span class="n">e0d7057cf2e</span> <span class="o">|</span> <span class="p">{</span><span class="nv">"data"</span><span class="p">:</span> <span class="p">{</span><span class="nv">"id"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"name"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"type"</span><span class="p">:</span> <span class="nv">"ai"</span><span class="p">,</span> <span class="nv">"content"</span><span class="p">:</span> <span class="nv">"いいえ、OraBooster は架空のロケットエンジンです。"</span><span class="p">,</span> <span class="nv">"example"</span><span class="p">:</span> <span class="k">false</span><span class="p">,</span> <span class="nv">"tool_calls"</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">"usage_metadata"</span><span class="p">:</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"additional_kwargs"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"response_metadata"</span><span class="p">:</span> <span class="p">{},</span> <span class="nv">"invalid_tool_calls"</span><span class="p">:</span> <span class="p">[]},</span><span class="nv">"type"</span><span class="p">:</span><span class="nv">"ai"</span><span class="p">}</span> <span class="o">|</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span> <span class="mi">22</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">59</span><span class="p">.</span><span class="mi">114845</span><span class="o">+</span><span class="mi">00</span>
<span class="p">(</span><span class="mi">4</span> <span class="k">rows</span><span class="p">)</span>
</code></pre></div></div>

<p>次は主語を「それ」(指示代名詞)に変更してみます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">それはいつ開発されましたか</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>主語が「Orabooster」であることをチャット履歴から補完し、最終的なテキストを生成していることがわかります。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">それはいつ開発されましたか</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。宇宙探査の未来を想像してください。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">総じて、この新開発のロケットエンジンは、革新的な技術と未来志向の設計によって、宇宙探査の新た</span><span class="se">\n</span><span class="s">な時代を切り開くことでしょう</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">OraBoosterはまだ開発されていない架空のロケットエンジンなので、開発時期はありません。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>その他、いくつかの質問をしてみます。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">いつ使われる予定ですか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>返答</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">いつ使われる予定ですか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。宇宙探査の未来を想像してください。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">それはいつ開発されましたか</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster はまだ開発されていません。これから生み出される未来の技術です。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">総じて、この新開発のロケットエンジンは、革新的な技術と未来志向の設計によって、宇宙探査の新た</span><span class="se">\n</span><span class="s">な時代を切り開くことでしょう</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">OraBooster の使用時期は未定です。これからの開発次第で、将来の宇宙探査を支える存在となるでしょう。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>質問</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">重量はどれくらいですか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>返答</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">重量はどれくらいですか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。宇宙探査の未来を想像してください。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">それはいつ開発されましたか</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster はまだ開発されていません。これから生み出される未来の技術です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いつ使われる予定ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の使用時期は未定です。これからの開発次第で、将来の宇宙探査を支える存在となるでしょう。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、</span><span class="se">\n</span><span class="s">ミッションの成功を確保します。</span><span class="se">\n</span><span class="s">さらに、バイオニック・リアクション・レスポンダーが統合されています</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">OraBooster の重量は不明です。軽量化素材や推進システムの効率によって変動するでしょう。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>質問</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">姿勢制御に使われている技術は何ですか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>返答</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">姿勢制御に使われている技術は何ですか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。宇宙探査の未来を想像してください。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">それはいつ開発されましたか</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster はまだ開発されていません。これから生み出される未来の技術です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いつ使われる予定ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の使用時期は未定です。これからの開発次第で、将来の宇宙探査を支える存在となるでしょう。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">重量はどれくらいですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の重量は不明です。軽量化素材や推進システムの効率によって変動するでしょう。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、</span><span class="se">\n</span><span class="s">ミッションの成功を確保します。</span><span class="se">\n</span><span class="s">さらに、バイオニック・リアクション・レスポンダーが統合されています</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">姿勢制御にはハイパーフォトン・ジャイロスコープ技術が使用されています。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>質問</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">重要なものですか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>返答</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">重要なものですか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。宇宙探査の未来を想像してください。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">それはいつ開発されましたか</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster はまだ開発されていません。これから生み出される未来の技術です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いつ使われる予定ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の使用時期は未定です。これからの開発次第で、将来の宇宙探査を支える存在となるでしょう。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">重量はどれくらいですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の重量は不明です。軽量化素材や推進システムの効率によって変動するでしょう。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">姿勢制御に使われている技術は何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">姿勢制御にはハイパーフォトン・ジャイロスコープ技術が使用されています。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、</span><span class="se">\n</span><span class="s">ミッションの成功を確保します。</span><span class="se">\n</span><span class="s">さらに、バイオニック・リアクション・レスポンダーが統合されています</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">はい、重要な技術です。ロケットの正確な姿勢制御と目標追跡を可能にし、ミッションの成功に大きく貢献します。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>質問</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span>  <span class="o">=</span> <span class="n">conversational_rag_chain</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span>
   <span class="p">{</span><span class="sh">"</span><span class="s">input</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">それがないと何が起こりますか？</span><span class="sh">"</span><span class="p">},</span>
   <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">configurable</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span><span class="sh">"</span><span class="s">session_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">session_id</span><span class="p">}},</span>
<span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>返答</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">それがないと何が起こりますか？</span><span class="sh">'</span><span class="p">,</span>
 <span class="sh">'</span><span class="s">history</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterとは何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBoosterは、次世代の宇宙探査を支えるために開発された先進的なロケットエンジンです。高い性能と信頼性、ハイパーフォトン・ジャイロスコープによる姿勢制御が特徴です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">実在するものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いいえ、OraBooster は架空のテクノロジーです。宇宙探査の未来を想像してください。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">それはいつ開発されましたか</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster はまだ開発されていません。これから生み出される未来の技術です。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">いつ使われる予定ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の使用時期は未定です。これからの開発次第で、将来の宇宙探査を支える存在となるでしょう。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">重量はどれくらいですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">OraBooster の重量は不明です。軽量化素材や推進システムの効率によって変動するでしょう。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">姿勢制御に使われている技術は何ですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">姿勢制御にはハイパーフォトン・ジャイロスコープ技術が使用されています。</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">重要なものですか？</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sh">'</span><span class="s">はい、重要な技術です。ロケットの正確な姿勢制御と目標追跡を可能にし、ミッションの成功に大きく貢献します。</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">context</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">その高い性能と信頼性は、人類の夢を実現するための力強い支援とな</span><span class="se">\n</span><span class="s">ることでしょう</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">これにより、長時間にわたる宇宙飛行中でも安定した飛行軌道を維持し、</span><span class="se">\n</span><span class="s">ミッションの成功を確保します。</span><span class="se">\n</span><span class="s">さらに、バイオニック・リアクション・レスポンダーが統合されています</span><span class="sh">'</span><span class="p">),</span>
  <span class="nc">Document</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">/tmp/rocket.pdf</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">page</span><span class="sh">'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">page_content</span><span class="o">=</span><span class="sh">'</span><span class="s">また、ハイパーフォトン・ジャイロスコープが搭載されており、極めて高い精度でロケットの姿勢を維</span><span class="se">\n</span><span class="s">持し、目標を追跡します</span><span class="sh">'</span><span class="p">)],</span>
 <span class="sh">'</span><span class="s">answer</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">ロケットは宇宙空間で正確な姿勢制御ができなくなり、軌道が不安定になる可能性があります。その結果、ミッションの失敗や宇宙飛行士の生命の危険につながる恐れがあります。</span><span class="sh">'</span><span class="p">}</span>
</code></pre></div></div>

<p>主語を省略したり、代名詞に置き換えても、過去の会話履歴からそのコンテキストを理解し、返答できることが確認できました。</p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新日時:</strong> <time class="dt-published" datetime="2025-04-15T14:18:46+09:00">April 15, 2025</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">共有</h4>
  

  <a href="https://twitter.com/intent/tweet?text=107+%3A+%E4%BC%9A%E8%A9%B1%E5%B1%A5%E6%AD%B4%E4%BF%9D%E6%8C%81%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF%E3%82%92%E5%8F%96%E3%82%8A%E5%85%A5%E3%82%8C%E3%81%9FRAG%E3%81%AE%E5%AE%9F%E8%A3%85%E3%82%92%E3%81%97%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86%20https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fai-vector-search%2Fai-vector107-rag-chat-history%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Foracle-japan.github.io%2Focitutorials%2Fai-vector-search%2Fai-vector107-rag-chat-history%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://oracle-japan.github.io/ocitutorials/ai-vector-search/ai-vector107-rag-chat-history/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="共有 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ocitutorials/ai-vector-search/ai-vector106-23ai-langchain-rag/" class="pagination--pager" title="106 : Oracle Database 23aiとLangChainでRAGを構成してみよう
">前へ</a>
    
    
      <a href="/ocitutorials/ai-vector-search/ai-vector108-select-ai-with-rag/" class="pagination--pager" title="108 : SELECT AI with RAGを試してみよう
">次へ</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">関連記事</h2>
  <div class="grid__wrapper">
    
  </div>
</div>

  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="検索キーワードを入力してください..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>フォロー</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/#ocijp" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/oracle-japan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/ocitutorials/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://oracle-japan.github.io">Oracle Cloud Infrastructure チュートリアル</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ocitutorials/assets/js/main.min.js"></script>




<script src="/ocitutorials/assets/js/lunr/lunr.min.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-store.js"></script>
<script src="/ocitutorials/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6W7FEC5CEH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6W7FEC5CEH', { 'anonymize_ip': false});
</script>







  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/ocitutorials/assets/js/clipboardrouge.js"></script>
  
    <script src="/ocitutorials/assets/js/tabs.js"></script>
  
    <script src="/ocitutorials/assets/js/sidebar.js"></script>
  


  </body>
</html>
